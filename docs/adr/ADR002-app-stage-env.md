# ADR-002: APP_STAGE 環境変数による環境識別

## ステータス

提案中

## コンテキスト

現在、アプリケーションの実行環境（開発、ステージング、本番など）を識別するための明確で一貫した方法がありません。これにより、環境ごとに異なる設定（データベース接続情報、外部APIのエンドポイント、ログレベルなど）を適用する際に、設定が複雑化したり、手動での切り替えミスが発生したりするリスクがあります。

環境を識別するために、`APP_STAGE` という環境変数を使用するアプローチを検討します。この環境変数の値（例: `dev`, `stg`, `prod`）に基づいて、アプリケーションが自身の実行環境を判断し、適切な設定を自動的に読み込むようにします。

## 決定

`APP_STAGE` 環境変数を使用して、アプリケーションの実行環境を識別する方式を正式に採用します。

- **環境変数の命名**: `APP_STAGE`
- **値の種類**:
  - `dev`: ローカル開発環境
  - `stg`: ステージング環境
  - `prod`: 本番環境
  - `test`: 自動テスト実行環境
- **実装方針**:
  - アプリケーション起動時に `APP_STAGE` 環境変数を読み込みます。
  - 環境変数の値に応じて、対応する設定ファイル（例: `config/dev.json`, `config/prod.json`）をロードします。
  - `APP_STAGE` が未設定の場合は、デフォルトで `dev` として扱います。
  - 各環境（ECSタスク定義、Lambda環境変数など）で `APP_STAGE` を適切に設定します。

## 結果

### ポジティブな影響

- 環境ごとの設定管理が簡素化され、一元化されます。
- デプロイプロセスが自動化しやすくなり、手動での設定ミスが減少します。
- コード内で環境を判定するロジックが統一され、可読性と保守性が向上します。

### ネガティブな影響

- 新しい環境を追加する際に、対応する設定ファイルと `APP_STAGE` の値の定義が必要になります。
- 既存の環境設定ロジックがある場合、`APP_STAGE` を使用する方式への移行コストが発生します。

### 考慮事項

- `NODE_ENV` との使い分け: `NODE_ENV` はライブラリの挙動（例: `express` のエラー表示）に影響を与えることがあるため、アプリケーション固有の環境識別には `APP_STAGE` を使用し、役割を分離します。
