# SOW: CHASE-119: Dashboardに通知一覧を表示する

## プロジェクト概要

**課題ID**: CHASE-119
**作成日**: 2025-10-28
**種別**: 機能追加

## 1. 背景と目的

### 背景

現在のダッシュボードでは「ウォッチ中のリポジトリ一覧」を表示しているが、ユーザーにとってより重要な情報は「新着通知」である。通知機能は既にBackend APIレベルで実装されているが、フロントエンドでは未対応の状態である。

### 目的

ダッシュボードのメインコンテンツを「ウォッチ中のリポジトリ一覧」から「新着通知の通知一覧（未読のもの）」に変更し、ユーザーが最新の更新情報を素早く確認できるようにする。また、罫線を少なめにし、余白を活用したモダンなデザインを採用する。

## 2. 実装スコープ

### 実装対象

- 通知一覧API（BFF層）の実装
- 通知一覧コンポーネントの実装
- ダッシュボードページの更新（リポジトリ一覧 → 通知一覧）
- 無限スクロール機能の実装
- 統計カードの未読通知数の実装

### 表示内容

通知1件あたり以下の内容を表示：

- データソース名
- 通知発生日時
- アクティビティ種別別にアクティビティの一覧（上限：5件など）
  - アクティビティ種別名（Issue/PR/Releaseなど）
  - 翻訳済タイトル
  - 要約
  - アクティビティ発生日時
  - アクティビティURL

### デザイン要件

- 各行を罫線で括るデザインよりも、行と行の間にスペースを開けることで罫線を最小限に抑える
- 背景色はページ背景と同じ「bg-content-default」を使用
- 行と行の間に薄い罫線のみ配置（オプション）

### 実装除外項目

- ウォッチしているデータソース数などの統計カード部分は変更しない（既存のまま）
- 通知の既読/未読の切り替え機能（将来的な拡張）
- 通知の詳細ページへの遷移（将来的な拡張）

## 3. 技術仕様

### API仕様

#### エンドポイント（BFF層）

```
GET /api/notifications
```

#### Backend API仕様（参照）

Backend APIは既に実装済み：

```
GET /api/notifications
```

**クエリパラメータ**:

- `cursor` (string, optional): 次ページ取得用のカーソル（Base64）
- `limit` (integer, optional): 取得件数（1-50、デフォルト: 20）
- `read` (enum, optional): 既読フィルタ（all/read/unread、デフォルト: all）
- `search` (string, optional): タイトル・サマリの部分一致検索キーワード

**レスポンス仕様**:

```typescript
{
  "success": true,
  "data": {
    "items": [
      {
        "notification": {
          "id": "uuid",
          "type": "activity_digest",
          "status": "pending|sent",
          "isRead": boolean,
          "scheduledAt": "ISO8601",
          "sentAt": "ISO8601|null",
          "createdAt": "ISO8601",
          "updatedAt": "ISO8601",
          "lastActivityOccurredAt": "ISO8601",
          "metadata": {}
        },
        "dataSources": [
          {
            "id": "uuid",
            "name": "string",
            "url": "string",
            "sourceType": "github_repository",
            "repository": {
              "fullName": "owner/repo"
            },
            "groups": [
              {
                "activityType": "release|issue|pull_request",
                "entries": [
                  {
                    "activityId": "uuid",
                    "title": "string",
                    "summary": "string",
                    "occurredAt": "ISO8601",
                    "url": "string|null",
                    "displayOrder": number
                  }
                ]
              }
            ]
          }
        ]
      }
    ],
    "pageInfo": {
      "hasNext": boolean,
      "nextCursor": "string|null"
    }
  }
}
```

#### BFF層の実装方針

- Backend APIの `/api/notifications` をプロキシする
- デフォルトで `read=unread` を設定し、未読通知のみ取得
- Zodスキーマでレスポンスのランタイム検証を実施
- エラーハンドリングとステータスコードの適切な変換

### データ取得戦略

#### SSR + 無限スクロール

1. **初回読み込み（SSR）**:
   - `useFetch` で最初の20件を取得
   - `lazy: false` でSSR時に取得完了を待つ

2. **追加読み込み（無限スクロール）**:
   - スクロール位置を監視し、一定位置まで到達したら次ページを取得
   - `nextCursor` を使用してカーソルベースのページネーション
   - `$fetch` で追加データを取得し、既存データに追加

### アーキテクチャ設計

#### BFF層（server/api）

- `server/api/notifications/index.get.ts`: 通知一覧取得エンドポイント
  - Backend APIへのプロキシ
  - クエリパラメータの検証（Zod）
  - レスポンスの検証（Zod）
  - エラーハンドリング

#### コンポーネント層

- `components/pages/dashboard/DashboardPage.vue`: メインページコンポーネント
  - 通知一覧APIの呼び出し（SSR）
  - 無限スクロール処理
  - 統計カードの更新（未読通知数）

- `components/pages/dashboard/parts/NotificationList.vue`: 通知一覧コンポーネント
  - 通知カードの表示
  - ローディング/エラー/空状態の表示
  - デザイン要件に基づいたスタイリング

- `components/pages/dashboard/parts/NotificationCard.vue`: 通知カード（単体）
  - データソース情報の表示
  - アクティビティグループの表示
  - アクティビティエントリの表示（最大5件）

#### Composable層

- `composables/use-infinite-scroll.ts`: 無限スクロール機能
  - スクロール位置の監視
  - 追加データの読み込みトリガー
  - ローディング状態の管理

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/frontend/server/api/notifications/index.get.ts`**
   - Backend API `/api/notifications` のBFFプロキシ
   - クエリパラメータとレスポンスのZod検証
   - 認証必須（`requireUserSession`）

2. **`packages/frontend/components/pages/dashboard/parts/NotificationList.vue`**
   - 通知一覧の表示コンポーネント
   - ローディング/エラー/空状態の処理
   - 無限スクロール対応

3. **`packages/frontend/components/pages/dashboard/parts/NotificationCard.vue`**
   - 通知カード（単体）の表示コンポーネント
   - データソース情報とアクティビティの表示
   - デザイン要件に基づいたレイアウト

4. **`packages/frontend/composables/use-infinite-scroll.ts`**
   - 無限スクロール機能のcomposable
   - スクロール監視とデータ追加読み込み

5. **`packages/frontend/components/pages/dashboard/parts/__tests__/NotificationCard.test.ts`**
   - NotificationCardコンポーネントのユニットテスト

6. **`packages/frontend/components/pages/dashboard/__tests__/NotificationList.test.ts`**
   - NotificationListコンポーネントのユニットテスト

### 更新対象ファイル

1. **`packages/frontend/components/pages/dashboard/DashboardPage.vue`**
   - リポジトリ一覧から通知一覧への変更
   - `/api/notifications` API呼び出しの追加
   - 無限スクロール処理の統合
   - 未読通知数の統計カードへの反映

2. **`packages/frontend/components/pages/dashboard/parts/DashboardStatCard.vue`**
   - 未読通知数の動的表示への対応（必要に応じて）

3. **`packages/frontend/components/pages/dashboard/DashboardPage.stories.ts`**
   - 通知一覧のストーリー追加
   - MSWモックの更新

4. **`packages/frontend/components/pages/dashboard/DashboardPage.vrt.spec.ts`**
   - ビジュアルリグレッションテストの更新

5. **`packages/frontend/tests/dashboard.authenticated.spec.ts`**
   - E2Eテストの更新（通知一覧の確認）

## 5. テスト戦略

### Component Test（コンポーネントテスト）

#### NotificationCard.test.ts

- 通知カードの正常表示
- データソース名の表示
- アクティビティグループ別の表示
- アクティビティエントリの表示（最大5件）
- 空データの場合の表示

#### NotificationList.test.ts

- 通知一覧の正常表示
- ローディング状態の表示
- エラー状態の表示
- 空状態の表示
- 無限スクロールのトリガー

### Unit Test（ユニットテスト）

#### use-infinite-scroll.test.ts

- スクロール位置の監視
- 追加データ読み込みのトリガー
- ローディング状態の管理
- エラー状態の管理

### E2E Test（E2Eテスト）

#### dashboard.authenticated.spec.ts

- ダッシュボードへのアクセス
- 通知一覧の表示確認
- 統計カード（未読通知数）の表示確認
- 無限スクロールの動作確認

### Visual Regression Test

#### DashboardPage.vrt.spec.ts

- デフォルト表示
- 空状態
- エラー状態
- 多数の通知がある場合

## 6. 受け入れ基準

### 機能要件

- [ ] ダッシュボードに通知一覧が表示される
- [ ] 通知は未読のものだけが表示される
- [ ] 通知1件あたりデータソース名、通知発生日時、アクティビティ一覧が表示される
- [ ] アクティビティは種別別にグループ化され、最大5件まで表示される
- [ ] 画面スクロールに応じて追加の通知が自動的に読み込まれる（無限スクロール）
- [ ] 統計カードの未読通知数が動的に表示される

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] SSRで初回20件の通知が取得される
- [ ] 無限スクロールがスムーズに動作する（ちらつきなし）
- [ ] ローディング/エラー/空状態が適切に表示される
- [ ] Tailwindのデザイントークンに準拠したスタイリング

### デザイン要件

- [ ] 罫線を最小限に抑えたデザイン
- [ ] 行と行の間に十分なスペース
- [ ] 背景色は `bg-content-default` を使用
- [ ] レスポンシブデザイン対応

### セキュリティ要件

- [ ] 認証必須（`requireUserSession`）
- [ ] 他ユーザーの通知にはアクセスできない
- [ ] Backend APIレスポンスのランタイム検証（Zod）

## 7. 実装手順

### Phase 1: BFF層実装

- 1-1. `server/api/notifications/index.get.ts` の作成
  - Backend API `/api/notifications` へのプロキシ実装
  - クエリパラメータのZod検証
  - レスポンスのZod検証
  - 認証処理（`requireUserSession`）
  - エラーハンドリング
- 1-2. ローカルでの動作確認（Postman等）
- 1-3. format, lint, コミット

### Phase 2: Composable実装

- 2-1. `composables/use-infinite-scroll.ts` の作成
  - スクロール位置監視ロジック
  - 追加データ読み込みロジック
  - ローディング状態管理
- 2-2. ユニットテストの作成・実行
- 2-3. format, lint, コミット

### Phase 3: コンポーネント実装

- 3-1. `NotificationCard.vue` の作成
  - 通知カードのレイアウト実装
  - データソース情報の表示
  - アクティビティグループの表示
  - デザイン要件に基づいたスタイリング
- 3-2. `NotificationCard.test.ts` の作成・実行
- 3-3. `NotificationList.vue` の作成
  - 通知一覧のレイアウト実装
  - ローディング/エラー/空状態の実装
  - NotificationCardの統合
- 3-4. `NotificationList.test.ts` の作成・実行
- 3-5. format, lint, コミット

### Phase 4: ダッシュボードページ更新

- 4-1. `DashboardPage.vue` の更新
  - `/api/notifications` API呼び出しの追加
  - リポジトリ一覧から通知一覧への切り替え
  - 無限スクロール処理の統合
  - 統計カード（未読通知数）の更新
- 4-2. Storybook更新（`DashboardPage.stories.ts`）
  - 通知一覧のストーリー追加
  - MSWモックの更新
- 4-3. 動作確認（開発サーバーでの確認）
- 4-4. format, lint, コミット

### Phase 5: テスト実装・更新

- 5-1. Visual Regression Testの更新
  - `DashboardPage.vrt.spec.ts` の更新(更新のみで実行はしない)
- 5-2. E2E Testの更新
  - `dashboard.authenticated.spec.ts` の更新(更新のみで実行はしない)
- 5-3. テストの実行・確認
  - VRT, E2Eテストはユーザーによる実行が必要なので、ここでは実行しません。
- 5-4. format, lint, コミット

### Phase 6: 最終確認・PR作成

- 6-1. 全機能の動作確認
- 6-2. デザイン要件の確認
- 6-3. 受け入れ基準のチェック
- 6-4. PR作成・レビュー依頼

## 8. リスク・考慮事項

### 技術的リスク

- **無限スクロール性能**: 大量の通知がある場合のパフォーマンス
- **SSR/CSR境界**: 無限スクロールの実装でSSR/CSRの切り替えが複雑になる可能性
- **Backend API依存**: Backend APIが未実装の場合、開発がブロックされる

### 軽減策

- 仮想スクロールの検討（必要に応じて）
- `useFetch` + `$fetch` の適切な使い分け
- MSWモックによる開発継続
- Backend API実装状況の事前確認

### 今後の拡張性

- 通知の既読/未読切り替え機能
- 通知詳細ページへの遷移
- 通知フィルタリング機能（アクティビティ種別、データソース別）
- 通知検索機能

## 9. 参考資料

### 設計指針

- [フォルダ構成ガイドライン](../../packages/frontend/docs/guidelines/folder-structure.md)
- [ファイル命名規則](../../packages/frontend/docs/guidelines/file-naming-conventions.md)
- [API実装ガイド](../../packages/frontend/docs/guidelines/api-implementation-guide.md)
- [コンポーネント実装ガイド](../../packages/frontend/docs/guidelines/component-implementation-guide.md)
- [ページ実装ガイド](../../packages/frontend/docs/guidelines/page-implementation-guide.md)
- [テスト戦略](../../packages/frontend/docs/testing-strategy.md)

### Backend API仕様

- [openapi.json](../../packages/backend/openapi.json) の `/api/notifications` セクション

### 既存実装の参考

- `packages/frontend/components/pages/dashboard/DashboardPage.vue`
- `packages/frontend/components/pages/dashboard/parts/RepositoryList.vue`
- `packages/frontend/server/api/data-sources/index.get.ts`
