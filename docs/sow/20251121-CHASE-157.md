# SOW: CHASE-157: アクティビティ一覧画面

## プロジェクト概要

**課題ID**: CHASE-157  
**作成日**: 2025-11-21  
**種別**: 機能追加

## 1. 背景と目的

### 背景
- 現状はダッシュボード通知のみでアクティビティを俯瞰しており、時系列で追跡する専用画面が存在しない。
- バックエンドには `/api/activities` が実装済みだが、Nuxt 側に対応する BFF・ページが無いため機能が露出できていない。
- ユーザーからはサイドメニュー経由でアクセスできるアクティビティ一覧ページと無限スクロールのニーズが提示されている。

### 目的
- `/activities` でアクティビティを閲覧できる SSR ページを提供し、アクティビティ発生日時/種別/タイトル/要約を確認できるようにする。
- Nuxt BFF (`/api/activities`) を追加してバックエンド API を安全にプロキシし、ソート順（更新日時降順）とバリデーションを統制する。
- ナビゲーションから直接アクセスできる導線と、一覧表示の視認性向上（ClSection＋区切り線）を実現する。

## 2. 実装スコープ

### 実装対象
- Nuxt サーバールート `GET /api/activities`（BFF）：`getApiActivities` を呼び出し、Zod でクエリ・レスポンスを検証。
- `/activities` ページ：`components/pages/activities/ActivityListPage.vue` を新設し、初回 SSR 取得＋無限スクロールでの追加読み込みを実装。
- UI コンポーネント：ClSection で全体をカード化し、各行を新規 `ClDivider` で区切ったアクティビティ行コンポーネントを描画。
- サイドバーのナビゲーション更新（「アクティビティ一覧」項目の追加）。

### 更新可能な項目
1. `packages/frontend/server/api/activities/index.get.ts`：BFF の認証・パラメータ整形・エラーハンドリング実装。
2. `packages/frontend/components/pages/activities/*`：ページ本体、行コンポーネント、ステート（ローディング/エンプティ/エラー/無限ロード）を実装。
3. `packages/frontend/components/base/ClDivider.vue`（＋Story）：点線スタイルの水平線を追加し複数箇所で再利用可能にする。
4. `packages/frontend/pages/activities.vue`：ルートエントリと `definePageMeta({ middleware: 'auth' })` 設定。
5. `packages/frontend/components/base/layouts/default/ClSidebar.vue`：ナビゲーション配列に `/activities` を追加しハイライト制御を再確認。

### 実装除外項目
- バックエンド API/DB の変更、通知履歴整形ロジックの改修。
- フィルタリング／ソート切り替え UI、検索フィールドなど付加的操作系の実装。
- アクティビティ詳細ページやブックマーク等の派生導線。

## 3. 技術仕様

### API仕様

#### エンドポイント
```
GET /api/activities
```

#### 認証・認可
- `requireUserSession` でログイン必須。未認証は 401 を返却。
- BFF ではステータスコードをそのまま踏襲しつつ、想定外レスポンスは 502/500 へマッピング。

#### リクエスト仕様
```typescript
// event.getQuery() 由来の値を整形し Zod で検証
const params: GetApiActivitiesParams = {
  page: Number(query.page ?? 1),
  perPage: Number(query.perPage ?? 20),
  activityType: query.activityType as GetApiActivitiesActivityType,
  status: (query.status as GetApiActivitiesStatus) ?? 'completed',
  sort: 'updatedAt',
  order: 'desc',
}
```
- `page/perPage` は数値化。`perPage` は 20 を基準として上限 100。
- ソート条件は要件通り `updatedAt desc` を強制。今後 UI で切り替える場合は受け口のみ追加予定。

#### レスポンス仕様
```typescript
interface ActivityListResponse {
  success: true
  data: {
    items: ActivityListResponseDataItemsItem[] // activity: { id, activityType, translatedTitle, summary, source, occurredAt, lastUpdatedAt, ... }
    pagination: {
      page: number
      perPage: number
      total: number
      totalPages: number
      hasNext: boolean
      hasPrev: boolean
    }
  }
}
```
- Orval 生成の `getApiActivitiesResponse` で検証し、失敗時は 502 を返却。

### データベース操作
- フロントエンドから直接 DB アクセスは行わない。バックエンド API のみ利用。

### アーキテクチャ設計
- `pages/activities.vue` → `ActivityListPage` で SSR 初期データを `useAsyncData` 経由取得。
- `ActivityListPage` は `useInfiniteScroll` を利用し `hasNext` が true の際に `page + 1` で追撃フェッチ。
- レイアウト：`ClSection` 内に `ActivityListItem` を縦並びで描画し、`ClDivider` を `v-if="index < list.length - 1"` で挿入。
- `ActivityListItem` では `ClHeading` や `formatDate`/`formatRelativeDate` ユーティリティを再利用し、データソース名・アクティビティ種別バッジ・タイトル・summary・日時を表示。
- エラー／空状態／ローディングをそれぞれ判定し、読み込み中はスケルトン、空データ時は案内文を表示。

## 4. 実装ファイル一覧

### 新規作成ファイル
1. **`packages/frontend/server/api/activities/index.get.ts`**
   - 認証、クエリ整形、`getApiActivities` 呼び出し、Zod バリデーション、エラーハンドリング。
2. **`packages/frontend/components/base/ClDivider.vue`**
   - `<hr>` ラッパーとして `variant="dashed"` 等を props 化し、デフォルトで `border-dashed border-surface-secondary-default my-8` を付与。
3. **`packages/frontend/components/base/ClDivider.stories.ts`**
   - Storybook でスタイルサンプル（標準／スペーシング違い）を定義。
4. **`packages/frontend/components/pages/activities/ActivityListPage.vue`**
   - 画面本体。タイトル、ClSection 包括、状態管理、無限スクロール、`ActivityListItem` の描画。
5. **`packages/frontend/components/pages/activities/parts/ActivityListItem.vue`**
   - 1 行分の UI。項目（発生日時、データソース名、タイプバッジ、translatedTitle、summary、detailリンク）を整理。
6. **`packages/frontend/components/pages/activities/__tests__/ActivityListPage.test.ts`**
   - `mountSuspended`＋MSW モックでレンダリングを検証。ロード時に ClSection が描画されること、`loadMoreActivities` が `hasNext` true 時に 2 ページ目をフェッチすることを確認。
7. **`packages/frontend/pages/activities.vue`**
   - ルートエントリと `definePageMeta({ middleware: 'auth' })` 設定。

### 更新対象ファイル
1. **`packages/frontend/components/base/layouts/default/ClSidebar.vue`**
   - `navigation` 配列に「アクティビティ一覧（/activities）」を追加。アクティブ判定は既存の `route.path === item.href` を利用。
2. **`packages/frontend/composables/use-infinite-scroll.ts`** *(必要なら)*
   - 既存機能で十分だが、ページ内で `enabled` を制御できるよう `ref` を使う前提で設計を確認（追記不要ならスコープ外）。
3. **`packages/frontend/tests/setup/msw-server.ts`** *(必要に応じ)*
   - `getGetApiActivitiesMockHandler` を読み込んでテスト用ハンドラを登録。

## 5. テスト戦略

### Component Test（Presentation層）
- `ActivityListPage` が初期レスポンスを正しく描画すること（タイトル表示、ClSection の存在、activity 要素の件数）。
- `loadMoreActivities` を呼び出した際、MSW 側で 2 ページ目のモックが参照され state が加算されること。
- 空データ／エラー時のメッセージ表示。

### Unit Test（Service/BFF層）
- API ルートはガイドライン通りテスト対象外。

### Storybook Visual Regression
- `ClDivider` は既存パイプラインに沿って story ベースで目視確認（VRT タスクに統合される想定）。

## 6. 受け入れ基準

### 機能要件
- [ ] `/activities` にアクセスすると SSR で最新アクティビティが読み込まれ、発生日時／データソース名／種別／translatedTitle／summary が表示される。
- [ ] リストは `lastUpdatedAt` 降順で並び、下端に到達すると自動的に次ページをフェッチして追記される。
- [ ] 各行の区切りが ClDivider（点線）で描画され、一覧全体が ClSection 内に表示される。
- [ ] サイドメニューに「アクティビティ一覧」が追加され、現在ページでハイライトされる。

### 非機能要件
- [ ] `pnpm format` と `pnpm lint` がエラーなく完了する。
- [ ] BFF でのレスポンス/クエリの Zod バリデーションが通り、エラー時は 4xx/5xx で適切に通知される。
- [ ] 無限スクロール中は二重フェッチを防ぐローディング制御がある。

### セキュリティ要件
- [ ] 認証されていないアクセスは `/api/activities` で拒否される。
- [ ] BFF レスポンスには内部ログ情報を含めない。

## 7. 実装手順

### Phase 1: BFF & UI基盤
- 1-1. `server/api/activities/index.get.ts` を新規作成し、`getApiActivities` 呼び出し＋Zod バリデーション＋エラーハンドリングを実装。
- 1-2. `ClDivider.vue` と Story を追加し、UI トークン準拠の点線スタイルを整える。
- 1-3. format/lint を実行し仮コミット。

### Phase 2: Activitiesページ
- 2-1. `ActivityListPage.vue`・`ActivityListItem.vue` を作成し、`useAsyncData`＋`useInfiniteScroll` によるデータ取得と表示を実装。
- 2-2. 空/ローディング/エラー表示、ClSection レイアウト、ClDivider 区切りの組み込み。
- 2-3. `ActivityListPage.test.ts` を追加し、MSW モックで主要ケースを検証。
- 2-4. format/lint を実行しコミット。

### Phase 3: ルーティング統合
- 3-1. `pages/activities.vue` を追加し、`definePageMeta` とページマウントを実装。
- 3-2. `ClSidebar.vue` にナビゲーション項目を追加して導線を有効化。
- 3-3. E2E/手動動作確認後に最終 format/lint・コミット。

## 9. リスク・考慮事項

### 技術的リスク
- **大量データでのパフォーマンス**: `perPage` の上限やローディング制御が適切でないと、無限スクロールが連続発火して API 呼び出しが暴走する懸念。
- **null値ハンドリング**: `translatedTitle` や `summary` が null の場合に UI が崩れる恐れがあるためフォールバック文言が必要。
- **ナビゲーション整合性**: サイドバーのアクティブ判定が `/activities/` と一致しないとハイライトが機能しない可能性。

### 軽減策
- `isLoading` と `hasNext` を併用し二重フェッチを防止。`enabled` フラグで API エラー時にスクロールを停止。
- null 項目には `-` や空文字列のフォールバックを実装し、アクセシビリティ属性も付与。
- ルートパス比較を厳密にし、Nuxt の `useRoute()` 結果で `/activities` が確実に一致するように確認。
