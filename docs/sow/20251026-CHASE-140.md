# SOW: CHASE-140: Activity保存内容の修正（detection機能／翻訳・要約の保持）

## プロジェクト概要

**課題ID**: CHASE-140
**作成日**: 2025-10-26
**種別**: 機能改善

## 1. 背景と目的

### 背景

現在のdetection機能では、GitHubから取得したActivityデータ（リリース、Issue、PR）を翻訳してDBに保存していますが、以下の課題があります：

- 原文が翻訳結果で上書きされ、原文が失われる
- 本文の要約が生成・保存されていない
- 翻訳済み本文と要約が明確に区別されていない

### 目的

Activityテーブルのスキーマを見直し、原文と翻訳/要約を併存できるようにします。これにより、以下を実現します：

- 原文（タイトル/本文）を保持しながら、翻訳済みタイトル、本文要約、翻訳済み本文を別フィールドで管理
- OpenAI APIを使った翻訳・要約の自動生成
- OpenAI APIキー未設定時のフォールバック動作の実装

## 2. 実装スコープ

### 実装対象

- Activityテーブルのスキーマ拡張（翻訳・要約フィールド追加）
- 要約生成機能の実装（新しいポート・アダプタ）
- 既存の翻訳・保存ロジックの修正（原文を保持するように変更）
- OpenAI APIキー未設定時のフォールバック処理

### 実装除外項目

- 翻訳済み本文の生成機能（今回はNULLとして保存し、別タスクで実装予定）
- 既存Activityデータのマイグレーション処理（新規フィールドはNULLを許可）
- フロントエンドでの表示対応

## 3. 技術仕様

### データベース操作

#### スキーマ変更

`activities`テーブルに以下のカラムを追加：

```sql
-- 翻訳済みタイトル（日本語）
translatedTitle TEXT NULL

-- 本文要約（日本語、AIによる要約）
summary TEXT NULL

-- 翻訳済み本文（日本語、フル翻訳）※今回はNULL
translatedBody TEXT NULL
```

既存カラム：
- `title`: 原文タイトル（英語）
- `body`: 原文本文（英語）

#### マイグレーション方針

- 新規カラムは全てNULL許可
- 既存データには影響なし（新規カラムはNULL）
- Drizzle Kitによる自動マイグレーション生成

### アーキテクチャ設計

既存のdetection機能と同じレイヤード構成を採用：

#### Domain層

- **`Activity`型の拡張**: `translatedTitle`, `summary`, `translatedBody`フィールドを追加

#### Application層（Ports）

- **新規ポート: `SummarizationPort`**
  - `summarize(activityType, title, body): Promise<{ summary: string }>`
  - アクティビティタイプに応じた本文要約を生成

- **既存ポート: `TranslationPort`**（変更なし）
  - `translate(activityType, title, body): Promise<{ translatedTitle, translatedBody }>`

#### Infra層（Adapters）

- **新規アダプタ: `SummarizationAdapter`**
  - OpenAI APIを使った要約生成
  - プロンプト: アクティビティタイプ別の要約指示
  - レスポンスフォーマット: JSON Schema
  - エラーハンドリング: TranslationAdapterと同様の実装

- **新規スタブ: `SummarizationStubAdapter`**
  - テスト用スタブ実装
  - ダミーの要約を返す

#### Infra層（Repositories）

- **`ActivityRepository`の更新**
  - `upsert()`: 翻訳・要約フィールドを含むパラメータを追加（オプション）
  - `upsertMany()`: 同上
  - `updateWithTranslation()`: **廃止** (原文を上書きするため)
  - `updateTranslationAndSummary()`: **新規追加** - 翻訳・要約のみを更新

- **`DrizzleActivityRepository`の更新**
  - `updateTranslationAndSummary(activityId, translatedTitle, summary, status, statusDetail)`を実装
  - `mapToDomain()`で新フィールドをマッピング

#### Application層（Use Cases）

- **`ProcessUpdatesUseCase`の更新**
  - 翻訳に加えて要約も生成
  - 原文を保持したまま、翻訳・要約フィールドのみを更新
  - OpenAI APIキー未設定時は翻訳・要約をNULLのまま処理継続（ステータスはCOMPLETED）

### OpenAI APIキー未設定時のフォールバック処理

```typescript
// getOpenAiConfig()をtry-catchで囲み、失敗時はnullを返す
let openAiConfig: OpenAiConfig | null = null
try {
  openAiConfig = await getOpenAiConfig()
} catch (error) {
  console.warn("OpenAI API key not configured. Translation and summarization will be skipped.")
}

// openAiConfigがnullの場合、翻訳・要約をスキップして処理継続
if (openAiConfig) {
  // 翻訳・要約を実行
} else {
  // ステータスをCOMPLETEDとして保存（翻訳・要約はNULL）
}
```

### データフロー

```
1. DetectUpdateUseCase
   ↓ GitHub APIからデータ取得
   ↓ Activityとして保存（原文のまま、status=PENDING）
   ↓ 新規ActivityのIDリストを返す

2. ProcessUpdatesUseCase
   ↓ ActivityIDリストを受け取る
   ↓ OpenAI設定を取得（失敗時はnull）
   ↓
   ├─ OpenAI設定あり
   │  ↓ 翻訳・要約を生成（TranslationPort, SummarizationPort）
   │  ↓ translatedTitle, summaryを更新（原文は保持）
   │  ↓ status=COMPLETEDで保存
   │
   └─ OpenAI設定なし
      ↓ 翻訳・要約をスキップ
      ↓ status=COMPLETEDで保存（translatedTitle, summaryはNULL）
```

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/backend/src/features/detection/application/ports/summarization.port.ts`**
   - 要約生成のポート定義
   - `SummarizationPort`インターフェース
   - アクティビティタイプ別の要約プロンプト定数

2. **`packages/backend/src/features/detection/infra/adapters/summarization/summarization.adapter.ts`**
   - OpenAI APIを使った要約生成アダプタ
   - エラーハンドリング、レート制限対応

3. **`packages/backend/src/features/detection/infra/adapters/summarization/summarization-stub.adapter.ts`**
   - テスト用スタブ実装

4. **`packages/backend/drizzle/migrations/XXXXXX_add_translation_summary_fields.sql`**
   - スキーママイグレーションSQL（Drizzle Kitにより自動生成）

### 更新対象ファイル

1. **`packages/backend/src/db/schema.ts`**
   - `activities`テーブル定義に`translatedTitle`, `summary`, `translatedBody`カラムを追加

2. **`packages/backend/src/features/activities/domain/activity.ts`**
   - `Activity`型、`ActivityRecord`型に新フィールドを追加

3. **`packages/backend/src/features/detection/domain/repositories/activity.repository.ts`**
   - `upsert()`, `upsertMany()`のパラメータに翻訳・要約フィールドを追加（オプション）
   - `updateWithTranslation()`を削除
   - `updateTranslationAndSummary()`を追加

4. **`packages/backend/src/features/detection/infra/repositories/drizzle-activity.repository.ts`**
   - `updateWithTranslation()`を削除
   - `updateTranslationAndSummary()`を実装
   - `mapToDomain()`で新フィールドをマッピング

5. **`packages/backend/src/features/detection/application/use-cases/process-updates.use-case.ts`**
   - `processActivity()`メソッドを更新
     - 翻訳・要約を生成
     - `updateTranslationAndSummary()`を呼び出し
     - OpenAI設定未取得時のフォールバック処理

6. **`packages/backend/src/features/detection/workers/process-updates/handler.ts`**
   - `SummarizationAdapter`のインスタンス化
   - `ProcessUpdatesUseCase`への依存注入
   - OpenAI設定取得のエラーハンドリング

7. **`packages/backend/src/core/config/open-ai.ts`**
   - `getOpenAiConfig()`が例外をスローしないように修正（または呼び出し側でハンドリング）

### テスト更新対象ファイル

1. **`packages/backend/src/features/detection/workers/process-updates/__tests__/handler.test.ts`**
   - 翻訳・要約フィールドの検証を追加
   - OpenAI設定未取得時のフォールバックテストを追加

## 5. テスト戦略

### Component Test（Worker層）

**`process-updates/__tests__/handler.test.ts`**:

- OpenAI設定取得成功時の翻訳・要約生成テスト
  - Activityに`translatedTitle`, `summary`が保存されること
  - `translatedBody`はNULLであること
  - ステータスが`COMPLETED`であること
  - 原文（`title`, `body`）が保持されていること

- OpenAI設定取得失敗時のフォールバックテスト
  - 翻訳・要約がNULLのまま処理が継続されること
  - ステータスが`COMPLETED`であること
  - エラーが発生しないこと

- 翻訳・要約生成失敗時のエラーハンドリングテスト
  - ステータスが`FAILED`になること
  - `statusDetail`にエラー内容が記録されること

### Unit Test（Adapter層）

**`summarization.adapter.test.ts`** (新規):

- 正常系: OpenAI APIが正しく要約を返すこと
- 異常系: APIエラー時に適切な例外がスローされること
- 異常系: レート制限時のエラーハンドリング

### Unit Test（Repository層）

**`drizzle-activity.repository.test.ts`** (更新):

- `updateTranslationAndSummary()`の正常系テスト
- 新フィールドのマッピングテスト

## 6. 受け入れ基準

### 機能要件

- [ ] Activityに原文（`title`, `body`）と翻訳済みタイトル（`translatedTitle`）、本文要約（`summary`）が同時に保存されること
- [ ] 翻訳済み本文（`translatedBody`）はNULLであること
- [ ] OpenAI APIキー未設定時は翻訳・要約をNULLのまま処理が継続され、ステータスが`COMPLETED`になること
- [ ] 原文が翻訳結果で上書きされないこと
- [ ] 要約がアクティビティタイプに応じた適切な内容であること

### 非機能要件

- [ ] 既存のテストが全て通ること
- [ ] 新規フィールド追加による既存データへの影響がないこと（NULL許可のため）
- [ ] マイグレーションが正常に実行できること

### セキュリティ要件

- [ ] OpenAI APIキーが適切に管理されていること（SSM Parameter Store経由）
- [ ] プロンプトインジェクション対策が実装されていること（既存のTranslationAdapterと同様）

## 7. 実装手順

### Phase 1: スキーマ・ドメイン層実装

- 1-1. `schema.ts`に新フィールド追加
- 1-2. Drizzle Kitでマイグレーションファイル生成
- 1-3. `Activity`型に新フィールド追加
- 1-4. ローカルDBでマイグレーション実行・確認

### Phase 2: 要約機能の実装（Port/Adapter）

- 2-1. `SummarizationPort`の定義
- 2-2. `SummarizationAdapter`の実装
- 2-3. `SummarizationStubAdapter`の実装
- 2-4. Adapterのユニットテスト作成・実行

### Phase 3: Repository層の更新

- 3-1. `ActivityRepository`インターフェースの更新
  - `updateTranslationAndSummary()`の追加
  - `updateWithTranslation()`の削除（または非推奨化）
- 3-2. `DrizzleActivityRepository`の実装更新
- 3-3. `mapToDomain()`の更新
- 3-4. Repositoryのユニットテスト更新・実行

### Phase 4: UseCase層の更新

- 4-1. `ProcessUpdatesUseCase`の更新
  - コンストラクタに`SummarizationPort`を追加
  - `processActivity()`メソッドの更新（翻訳・要約を両方実行）
  - `updateTranslationAndSummary()`呼び出しに変更
- 4-2. OpenAI設定未取得時のフォールバック処理実装

### Phase 5: Worker層の更新

- 5-1. `process-updates/handler.ts`の更新
  - OpenAI設定取得のエラーハンドリング
  - `SummarizationAdapter`のインスタンス化
  - `ProcessUpdatesUseCase`への依存注入
- 5-2. Componentテストの更新・実行

### Phase 6: 統合テスト・動作確認

- 6-1. ローカル環境での動作確認
  - OpenAI APIキー設定あり/なしの両方で確認
- 6-2. 全テストの実行・確認
- 6-3. コードレビュー準備（フォーマット、リント）

## 8. ディレクトリツリー

### 新規作成ファイル

```
packages/backend/src/features/detection/
├── application/
│   └── ports/
│       └── summarization.port.ts (新規)
└── infra/
    └── adapters/
        └── summarization/
            ├── summarization.adapter.ts (新規)
            └── summarization-stub.adapter.ts (新規)
```

### 更新ファイル

```
packages/backend/
├── src/
│   ├── db/
│   │   └── schema.ts (更新)
│   ├── features/
│   │   ├── activities/
│   │   │   └── domain/
│   │   │       └── activity.ts (更新)
│   │   └── detection/
│   │       ├── domain/
│   │       │   └── repositories/
│   │       │       └── activity.repository.ts (更新)
│   │       ├── application/
│   │       │   └── use-cases/
│   │       │       └── process-updates.use-case.ts (更新)
│   │       ├── infra/
│   │       │   └── repositories/
│   │       │       └── drizzle-activity.repository.ts (更新)
│   │       └── workers/
│   │           └── process-updates/
│   │               ├── handler.ts (更新)
│   │               └── __tests__/
│   │                   └── handler.test.ts (更新)
│   └── core/
│       └── config/
│           └── open-ai.ts (必要に応じて更新)
└── drizzle/
    └── migrations/
        └── XXXXXX_add_translation_summary_fields.sql (自動生成)
```

## 9. リスク・考慮事項

### 技術的リスク

- **OpenAI APIの可用性**: APIがダウンした場合の処理継続性
- **トークン制限**: 本文が長い場合のトークン超過エラー
- **既存データへの影響**: マイグレーション時の既存データの整合性
- **パフォーマンス**: 翻訳・要約の両方を実行することによる処理時間の増加

### 軽減策

- OpenAI APIキー未設定時のフォールバック処理により、処理継続性を確保
- TranslationAdapterと同様のエラーハンドリングとリトライ機構
- マイグレーションは新規フィールドをNULL許可とすることで、既存データへの影響を最小化
- 翻訳・要約は並列実行可能な場合は並列化を検討（将来の最適化）
- ステータス管理により、失敗したActivityのみを再処理可能

### 将来の拡張性

- 翻訳済み本文（`translatedBody`）の生成は別タスクで実装予定
- ユーザーからの明示的なリクエストによる翻訳済み本文生成ワーカー
- 要約のカスタマイズ（長さ、詳細度など）
