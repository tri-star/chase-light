# SOW: CHASE-136: 通知一覧・詳細APIの実装

## プロジェクト概要

**課題ID**: CHASE-136
**作成日**: 2025-10-26
**種別**: 機能追加

## 1. 背景と目的

### 背景

- バックエンドではダイジェスト通知を生成して `notifications` / `notification_digest_entries` テーブルに永続化しているが、通知を閲覧するためのHTTP APIが未整備。
- ダッシュボードでの無限スクロール・フィルタ・全文検索に対応した通知一覧が必要になっている。
- 通知カードから詳細を開く画面の設計を進めるため、一覧アイテムと同等の情報を返す詳細APIも同時に求められている。

### 目的

1. JWT認証済みユーザー向けに通知一覧を返却する `GET /api/notifications` を実装し、ページネーション・既読フラグフィルタ・翻訳済みテキストのLIKE検索に対応する。
2. 一覧アイテムと同等の情報を返却する `GET /api/notifications/{notificationId}` を実装し、リソースアクセス制御(ユーザー毎)と404ハンドリングを担保する。

## 2. 実装スコープ

### 実装対象

- `packages/backend/src/features/notification` 配下のドメイン / アプリケーション / プレゼンテーション / インフラレイヤー
- `packages/backend/src/app.ts` へのルート組み込み
- コンポーネントテストと付随するテストデータファクトリ

### 更新可能な項目

1. 通知機能のドメイン定義（一覧・詳細DTO、フィルタ・ソート定義、カーソル構造）
2. 通知クエリ用リポジトリのインターフェースとDrizzle実装
3. `ListNotificationsUseCase` / `GetNotificationDetailUseCase` の追加と依存解決
4. Honoルート・Zodスキーマ・レスポンスマッパーの新規実装
5. 無限スクロール向けのカーソル処理・検索処理・既読フィルタの実装とテスト

### 実装除外項目

- 通知の既読更新APIや更新系ユースケース
- フロントエンド実装／Storybook更新
- ダイジェスト生成ロジックや通知生成ワーカーの改修
- 新規DBカラムの追加（既存列で要件を満たす前提）

## 3. 技術仕様

### API仕様

#### エンドポイント: GET /api/notifications

- **概要**: 認証ユーザーの通知を無限スクロール向けカーソルでページネートして返却
- **認証・認可**: JWT必須。コンテキストの `auth.user.userId` と `notifications.user_id` が一致しないレコードは除外

##### クエリパラメータ

```typescript
type ListNotificationsQuery = {
  cursor?: string; // base64("{iso8601}|{notificationId}")。未指定時は最新から取得
  limit?: number; // 1-50, 既定20
  read?: "all" | "read" | "unread"; // 既定 all
  search?: string; // 最大120文字。ILIKE検索対象: digest entry title/summary, activity translated_title/summary/translated_body
};
```

- `cursor` が不正な形式の場合は `400 BAD_REQUEST`（`NOTIFICATIONS_INVALID_CURSOR`）で応答
- `limit` 上限を超えた場合は `422 UNPROCESSABLE_ENTITY`

##### レスポンス仕様 (200 OK)

```typescript
type NotificationListItem = {
  notification: {
    id: string;
    type: string;
    status: string;
    isRead: boolean;
    scheduledAt: string;
    sentAt: string | null;
    createdAt: string;
    updatedAt: string;
    lastActivityOccurredAt: string; // digest entriesの活動発生日時の最大値。無い場合はscheduled_at
    metadata: {
      digest?: NotificationDigestMetadata; // 既存JSONBを透過
    };
  };
  dataSources: Array<{
    id: string;
    name: string;
    url: string;
    sourceType: string;
    repository?: { fullName: string | null };
    groups: Array<{
      activityType: "issue" | "pull_request" | "release";
      entries: Array<{
        activityId: string;
        title: string;
        summary: string;
        occurredAt: string;
        url: string | null;
        displayOrder: number; // notification_digest_entries.position
      }>;
    }>;
  }>;
};

type ListNotificationsResponse = {
  success: true;
  data: {
    items: NotificationListItem[];
    pageInfo: {
      hasNext: boolean;
      nextCursor?: string;
    };
  };
};
```

- `search` が指定された場合は全文検索の結果に一致した通知のみ返却
- `pageInfo.nextCursor` は次ページが存在する場合のみ返す
- 404は発生しない（空リストで応答）
- 401/403 はJWTミドルウェアが処理

#### エンドポイント: GET /api/notifications/{notificationId}

- **概要**: 指定IDの通知詳細を返却。構造は一覧アイテムと同等
- **認証・認可**: JWT必須。対象通知が存在しない、または他ユーザーの場合は 404

##### パスパラメータ

```typescript
type NotificationDetailParams = {
  notificationId: string; // UUID
};
```

##### レスポンス仕様

- **200 OK**: `ListNotificationsResponse["data"]["items"][0]` 相当の構造を `data.item` に格納
- **404 NOT_FOUND**: `NOTIFICATION_NOT_FOUND` エラーコードで応答

```typescript
type GetNotificationDetailResponse =
  | {
      success: true;
      data: { item: NotificationListItem };
    }
  | {
      success: false;
      error: {
        code: "NOTIFICATION_NOT_FOUND";
        message: string;
      };
    };
```

### データベース操作

- 参照テーブル
  - `notifications`: フィルタ（user_id, is_read）、ソート（scheduled_at, created_at）、メタデータ参照
  - `notification_digest_entries`: 通知に紐づくアクティビティグループの集約、`position` による順序付け
  - `activities`: `created_at`, `translated_title`, `summary`, `translated_body` を検索・発生日時取得に利用
  - `data_sources`: データソース名・URL・種別取得
  - `repositories`: GitHubソース向けに `full_name` を取得
- 検索要件を満たすため、`ILIKE` 検索は `notification_digest_entries` / `activities` を `EXISTS` 句で結合
- カーソルページネーションは `(lastActivityOccurredAt, notifications.id)` の複合ソートで安定化
- 既存インデックス (`idx_notifications_user_id`, `idx_notifications_user_read`, `idx_notification_digest_entries_notification_id`, `idx_notification_digest_entries_activity_id`) を活用。必要に応じて `notifications(user_id, scheduled_at DESC, id DESC)` の追加検討余地を備忘とするが今回の実装では新規作成しない。

### アーキテクチャ設計

- **Domain層**
  - `notification-query.ts` に一覧/詳細DTO、フィルタ・カーソル型、`NotificationGroup` 等の型定義を追加
  - `domain/repositories/notification-query.repository.ts` でクエリポートを定義
- **Application層**
  - `ListNotificationsUseCase`：入力正規化（limit, readフィルタ, cursor decode）、リポジトリ呼び出し、ページ情報組み立て
  - `GetNotificationDetailUseCase`：ID/ユーザー整合性チェック、404判定
- **Infra層**
  - `DrizzleNotificationQueryRepository`：2段階クエリ（ID取得→詳細取得）で集約、グルーピング組み立てを実装
  - サーチ・フィルタ条件はDrizzleのビルダー + `sql` ヘルパーで対応
- **Presentation層**
  - `presentation/routes/notifications/index.ts` で Hono ルートを定義
  - `schemas/*.schema.ts` にリクエスト/レスポンスZodスキーマを作成し OpenAPI メタを付与
  - `utils/response-mapper.ts` でユースケース戻り値からAPIレスポンスへの変換を担う
- **Composition**
  - `app.ts` で通知機能の依存解決（リポジトリ→ユースケース→ルート生成）を行い、`/api/notifications` ルートをマウント

## 4. 実装ファイル一覧

### 新規作成ファイル

1. `packages/backend/src/features/notification/domain/notification-query.ts`
2. `packages/backend/src/features/notification/domain/repositories/notification-query.repository.ts`
3. `packages/backend/src/features/notification/application/use-cases/list-notifications.use-case.ts`
4. `packages/backend/src/features/notification/application/use-cases/get-notification-detail.use-case.ts`
5. `packages/backend/src/features/notification/infra/repositories/drizzle-notification-query.repository.ts`
6. `packages/backend/src/features/notification/presentation/routes/notifications/index.ts`
7. `packages/backend/src/features/notification/presentation/schemas/notification-list-request.schema.ts`
8. `packages/backend/src/features/notification/presentation/schemas/notification-list-response.schema.ts`
9. `packages/backend/src/features/notification/presentation/schemas/notification-detail-response.schema.ts`
10. `packages/backend/src/features/notification/presentation/utils/response-mapper.ts`
11. `packages/backend/src/features/notification/presentation/routes/notifications/__tests__/index.test.ts`
12. 必要に応じたコンポーネントテスト用フィクスチャ（例: `packages/backend/src/test/fixtures/notification.fixture.ts`）

### 更新対象ファイル

1. `packages/backend/src/app.ts`（通知ルートのマウント追加）
2. `packages/backend/src/features/notification/constants/` 配下（ページネーション定数などを定義するファイルを追加/更新）
3. `packages/backend/src/db/factories.ts`（不足するテストデータ生成ヘルパーを追加する場合）

## 5. テスト戦略

### Component Test（Presentation層）

- 正常系: 通知一覧が既定ソートで返却され、カーソルが付与される
- フィルタ: `read=unread` で既読を除外、`search` でタイトル/本文部分一致がヒットする
- 異常系: 不正カーソル指定で400、limit超過で422
- 詳細取得: 所有通知は200、他ユーザーのIDは404

### Unit Test（Application層）

- カーソルデコード・エンコードの境界値（先頭ページ／末尾ページ）
- limitとreadフィルタのデフォルト適用確認

### Unit / Integration Test（Infra層）

- Drizzleクエリでのグルーピング・並び順が期待通りになること（コンポーネントテストで代替しても可）

## 6. 受け入れ基準

### 機能要件

- [ ] `GET /api/notifications` がJWT認証後に期待構造のJSONを返却する
- [ ] `read` パラメータで既読/未読が切り替わる
- [ ] `search` パラメータが翻訳済テキストのLIKE検索に反映される
- [ ] `cursor` を用いた2ページ目取得が可能で、`hasNext` が適切に制御される
- [ ] `GET /api/notifications/{notificationId}` が通知未存在時に404を返す

### 非機能要件

- [ ] 既存のバックエンドテスト（lint, unit, component）が全て成功する
- [ ] 新規コンポーネントテストが追加され、自動テストで検証できる

### セキュリティ要件

- [ ] JWT未付与・無効トークン時は認証エラーを返す
- [ ] 別ユーザーの通知IDを指定した場合でも404で情報を漏らさない

## 7. 実装手順

### Phase 1: ドメイン & リポジトリ定義

- 1-1. ドメインDTO・リポジトリポートを追加
- 1-2. DrizzleNotificationQueryRepository を実装
- 1-3. リポジトリ単体テスト（必要に応じて）／format, lint, commit

### Phase 2: アプリケーション & プレゼンテーション組み立て

- 2-1. `ListNotificationsUseCase` / `GetNotificationDetailUseCase` を実装
- 2-2. HonoルートとZodスキーマ、レスポンスマッパーを作成
- 2-3. ルートを `app.ts` に組み込み、componentテストを実装
- 2-4. format, lint, test, commit

### Phase 3: 仕上げ

- 3-1. OpenAPIドキュメント反映（@hono/zod-openapi での宣言確認）
- 3-2. ドキュメント／コメント調整
- 3-3. 最終テスト実行、コミット

## 9. リスク・考慮事項

### 技術的リスク

- **クエリ複雑化によるパフォーマンス低下**: 大量の通知データで `ILIKE` 検索がボトルネックになる可能性
- **カーソル整合性**: 通知・ダイジェストエントリの更新タイミングによってカーソルが重複/欠損を起こすリスク
- **URL不足**: `notification_digest_entries.url` が空の場合のリンク生成方法が未確定

### 軽減策

- `ILIKE` は `EXISTS` 句 + 必要最小限の結合に絞り、limitを小さめに保つ
- カーソルは `(lastActivityOccurredAt, notificationId)` の複合キーで安定化し、同一キーを含む要素も含めて次ページへ渡さない
- URLが欠落しているケースは `activities.githubData`（JSON）からの補完やフロント側フォールバックを検討し、今回の実装ではnull許容とする
