# SOW: CHASE-150: design-tokens.json: color.semantic に children サブ階層を追加し、Tailwind/Storybook/LLM JSON へ反映

## プロジェクト概要

**課題ID**: CHASE-150  
**作成日**: 2025-11-01  
**種別**: 機能改善

## 1. 背景と目的

### 背景

- `color.semantic` の階層が現在 2 段構成までに限定されており、`sidebar.menu` のような BEM 風サブ階層を定義できない。
- Tailwind 用 CSS 変数、LLM 向け JSON、Storybook ドキュメントが単一階層前提で実装されているため、新しいサブ階層が追加できない。

### 目的

- デザイントークン JSON で `<category>.children.<subcategory>` をネストして定義できるようにする。
- 変換スクリプト全体をサブ階層対応させ、Tailwind CSS 変数・LLM ドキュメント・Storybook 一覧まで齟齬なく反映する。
- 新しい `sidebar.menu` 系トークンを light/dark 双方に追加し、メニューの hover / active / disabled 表現を提供する。

## 2. 実装スコープ

### 実装対象

- フロントエンドのデザイントークン定義、関連する変換スクリプト、デザインシステム Storybook。

### 更新可能な項目

1. `packages/frontend/design-tokens.json` に `children` サブ階層と `sidebar.menu` トークン（light/dark）を追加。
2. `packages/frontend/scripts/design-token-converter` 配下のパーサー／ジェネレーターをサブ階層対応に拡張し、既存の変換出力を維持。
3. `packages/frontend/components/design-systems/colors.stories.ts` を更新し、親・子階層のカラーを判別しやすく表示。
4. `pnpm --filter frontend generate:tailwind-theme` を実行し、Tailwind CSS と `docs/design/tailwind-utilities.json` の生成結果を更新。

### 実装除外項目

- フロントエンドアプリ本体の UI コンポーネントやページ配色の変更。
- Backend / Shared パッケージのロジックと API 定義。
- 新規 Storybook ストーリーの追加（既存ストーリーの表示改善に限定）。
- Storybookページのテスト、UI確認。(ユーザーが行うのでこれは省略してください)
- E2Eテスト(これも、ユーザーが行います)

## 3. 技術仕様

### デザイントークン仕様

- `color.semantic` の各カテゴリで `children` プロパティを受け取り、子カテゴリを多段に保持できるようにする。
- 出力される階層キーは `sidebar.menu.default.bg` のようにドット連結とし、CSS 変数は `--background-color-sidebar-menu-default` 形式で生成。
- Light/Dark 双方で `sidebar.menu` の `default`, `hovered`, `active`, `disabled` を定義。Light 側は青系ガラス UI（透明度付き oklch）、Dark 側は彩度を抑えたネオン風の差し色を想定。

#### Light テーマ例

```json
{
  "color": {
    "semantic": {
      "light": {
        "sidebar": {
          "$description": "Sidebar area",
          "default": { "...": "既存値" },
          "children": {
            "menu": {
              "$description": "Sidebar menu states",
              "default": {
                "bg": { "value": "oklch(88% 0.06 240 / 0.16)" },
                "text": { "value": "{color.primitive.blue.800}" },
                "border": { "value": "oklch(82% 0.05 240 / 0.2)" }
              },
              "hovered": {
                "bg": { "value": "oklch(82% 0.08 240 / 0.22)" },
                "text": { "value": "{color.primitive.blue.900}" },
                "border": { "value": "oklch(74% 0.08 240 / 0.28)" }
              },
              "active": {
                "bg": { "value": "oklch(74% 0.1 240 / 0.28)" },
                "text": { "value": "{color.primitive.white}" },
                "border": { "value": "oklch(64% 0.1 240 / 0.3)" }
              },
              "disabled": {
                "bg": { "value": "oklch(94% 0.01 247 / 0.5)" },
                "text": { "value": "{color.primitive.gray.500}" },
                "border": { "value": "oklch(90% 0.01 247 / 0.4)" }
              }
            }
          }
        }
      }
    }
  }
}
```

### 変換ロジック

- `TokenParser.flattenTokens` は `children` キーを経路に含めず、上位パスを引き継いで再帰（`sidebar > menu > default > bg`）。
- CSS 変数生成は既存ロジックを流用しつつ、多段階層をそのままハイフン連結する。
- `LLMDocGenerator` と `DesignTokenHelper`（Storybook 用）は `children` をスキップしてドット連結キーと Tailwind クラスを組み立てる。
- 既存の `color.semantic.common`（ステータス色）マッピングは後方互換維持。

### Storybook 表示仕様

- `Sidebar Colors` ブロックで `Default` の直後に `Menu Default / Menu Hovered / Menu Active / Menu Disabled` を表示し、親子関係が視覚的に分かるよう余白または小見出しを付与。
- Light/Dark のテーマ切り替えボタンは既存のままで、切り替え時にメニューカラーも更新されることを確認。

### 生成物・コマンド

- `pnpm --filter frontend generate:tailwind-theme` 実行で `assets/css/tailwind.css` と `docs/design/tailwind-utilities.json` を再生成する。
- 生成物の差分レビューでは既存キーの並び順・値が変化していないことを確認（新規キー追加のみ）。

### アーキテクチャ設計

- デザイントークン変換は既存の `DesignTokenConverter` > `TokenParser` > `TailwindGenerator` > `LLMDocGenerator` のレイヤード構造を保持。
- Storybook 表示は `DesignTokenHelper` でパース済みトークンを集約し、ストーリーは UI レイヤーのみを担当。
- 新たな再帰処理はユーティリティ層（パーサー）に閉じ込め、UI 側は出力フォーマットのみに専念。

## 4. 実装ファイル一覧

### 新規作成ファイル

- なし

### 更新対象ファイル

1. `packages/frontend/design-tokens.json`
   - `color.semantic` に `children` サブ階層を追加し、`sidebar.menu` の 4 状態を light/dark 両テーマで定義。
2. `packages/frontend/scripts/design-token-converter/token-parser.ts`
   - `children` を経路に含めない再帰処理と、多段階層の CSS 変数出力をサポート。
3. `packages/frontend/scripts/design-token-converter/llm-doc-generator.ts`
   - `children` を無視したドット連結キー生成、`sidebar.menu.*` クラス生成ロジックを追加。
4. `packages/frontend/scripts/design-token-converter/__tests__/token-parser.test.ts`
   - `children` サブ階層のテストケースを追加し、CSS 変数名が期待通りになることを保証。
5. `packages/frontend/components/design-systems/design-token-helper.ts`
   - セマンティックカラーのグルーピングを多段階層に対応させ、ストーリー向けのラベル生成を調整。
6. `packages/frontend/components/design-systems/colors.stories.ts`
   - `Sidebar` セクションにサブ階層表示を追加し、`DesignTokenHelper` の拡張結果を描画。
7. `packages/frontend/assets/css/tailwind.css`（生成物）
   - `--background-color-sidebar-menu-*` などの変数を含む新しいテーマ CSS を取り込む。
8. `packages/frontend/docs/design/tailwind-utilities.json`（生成物）
   - `color.semantic.tokens` に `sidebar.menu.*` エントリを追加。

## 5. テスト戦略

- **Unit（変換ロジック）**: `vitest` で `TokenParser` の `children` 対応と CSS 変数名生成を検証。必要に応じて LLM 出力の JSON 構造をスポットチェックするテストを追加。
- **Storybook 表示確認**: ユーザーが手動で確認する
- **リグレッション**: `pnpm --filter frontend test` による既存ユニットテストの再実行。

## 6. 受け入れ基準

- [ ] `pnpm --filter frontend generate:tailwind-theme` 実行後、`--background-color-sidebar-menu-*` と `bg-sidebar-menu-*` / `text-` / `border-` クラスが生成される。
- [ ] `docs/design/tailwind-utilities.json` に `color.semantic.tokens.sidebar.menu.*` が追加され、既存キーの値は変わらない。
- [ ] 既存の `color.semantic` 出力（例: `surface`, `common`）に破壊的変更がない。
- [ ] `pnpm --filter frontend test` が成功する

## 7. 実装手順

### Phase 1: 変換ロジック拡張

- 1-1. `TokenParser` / `LLMDocGenerator` / `DesignTokenHelper` をサブ階層対応に改修。
- 1-2. `vitest` でパーサー関連テストを更新／追加し、`children` の期待値を確認。
- 1-3. format, lint, コミット。

### Phase 2: デザイントークン定義と生成物更新

- 2-1. `design-tokens.json` に `sidebar.menu` を追加し、light/dark の値を整理。
- 2-2. `pnpm --filter frontend generate:tailwind-theme` を実行して CSS / LLM JSON を再生成。
- 2-3. 生成物の差分を確認後、format, lint, コミット。

### Phase 3: Storybook 表示調整

- 3-1. `colors.stories.ts` の Sidebar セクションを更新し、サブ階層ラベルを追加。
- 3-2. `pnpm --filter frontend test` を再実行
- 3-3. format, lint, コミット。

## 9. リスク・考慮事項

### 技術的リスク

- **変換後フォーマットの後方互換性**: `children` 処理の追加により既存の CSS 変数名が変更されるリスク。
- **生成物のサイズ・順序変化**: 大量のトークン追加により出力順序が変わる可能性があり、差分レビューが煩雑になる。
- **Storybook 表示崩れ**: サブ階層表示のレイアウト調整を誤ると、既存セクションの視認性が低下する可能性。

### 軽減策

- 既存トークンのスナップショット（JSON 出力）と比較し、変更が新規キーに限定されていることを検証。
- テストで `children` のみを対象にしつつ、既存ケースが通り続けることを示す。
- Storybook のスタイル調整はコンパクトに留め、レイアウト変更時は UI チームにスクリーンショットを共有して確認を受ける。
