# SOW: CHASE-117: DashboardStatCard コンポーネント追加

## プロジェクト概要

**課題ID**: CHASE-117
**作成日**: 2025-10-06
**種別**: 新機能開発

## 1. 背景と目的

### 背景

- `packages/frontend/components/pages/dashboard/DashboardPage.vue` では、統計情報カードを 3 つともインラインで実装しており、Tailwind クラスや SVG が重複している。
- データソース数以外の指標を増やす場合や別ページで統計カードを再利用したい場合に、共通化された UI が無いため整合性が取りづらい。
- デザイン面でも、カード向けのセマンティックトークンが存在せず、`surface` 系トークンを流用しているため、意図したトーンを維持しづらい。

### 目的

- ダッシュボードの KPI/統計表示向けに再利用可能な `DashboardStatCard` コンポーネントを新設し、UI 実装を共通化する。
- カード用のデザイントークンと Tailwind ユーティリティを定義し、ライト/ダーク両テーマで一貫した見た目を確保する。
- 既存ダッシュボードの統計カードを新コンポーネントに置き換え、保守性とアクセシビリティを向上させる。

## 2. 実装スコープ

### 実装対象

- `packages/frontend` 内のコンポーネント、デザインリソース、Storybook/VRT に限定。

### 更新可能な項目

1. デザイントークン: `packages/frontend/design-tokens.json` に card 系トークンを追加。
   - `packages/frontend/docs/design/tailwind-utilities.json` と `packages/frontend/assets/css/tailwind.css` が専用コマンドにより自動更新
2. コンポーネント: `components/pages/dashboard/parts/DashboardStatCard.vue` を新規作成し、必要な props・スタイル・アクセシビリティを実装。
3. テスト/ストーリー: `components/pages/dashboard/parts/__tests__/DashboardStatCard.test.ts`、`DashboardStatCard.stories.ts`（任意だが推奨）を整備。
4. 画面統合: `components/pages/dashboard/DashboardPage.vue`／同 Storybook／VRT を新コンポーネント利用に更新。

### 実装除外項目

- バックエンド (`packages/backend`) の API/DB 変更。
- 新規 API エンドポイントや `/api/data-sources` の仕様変更。
- Skeleton ローディングやトレンド表示など今回の課題で求められていない追加 UI。
- i18n の抜本的な整理やコピーライティング変更（必要最低限のラベルのみ）。

## 3. 技術仕様

### API仕様

- 新規エンドポイントの追加はなし。既存の `GET /api/data-sources`（認証必須）から取得する `pagination.total` を統計値に利用し続ける。
- リクエスト/レスポンス仕様に変更は発生しないため、Orval 生成物への影響はなし。

### データベース操作

- 今回のタスクでは DB への追加・更新は行わない。

### アーキテクチャ設計

#### DashboardStatCard コンポーネント

- 配置: `packages/frontend/components/pages/dashboard/parts/DashboardStatCard.vue`
- `<script setup lang="ts">` で以下の props をサポート:
  - `icon?: string` — `@nuxt/icon` の `Icon` コンポーネントへ渡すアイコン名。未指定時はアイコン領域を非表示にし、レイアウトを調整。
  - `label: string` — 統計項目名。Tailwind CSS 4.1.8 では公式ドキュメントにあるとおり `line-clamp-<number>` ユーティリティ（例: `line-clamp-2`, `line-clamp-3`）が標準提供されているため、`line-clamp-2` を適用して 2 行に収める。より長いラベルが想定される場合は値を調整するか、必要に応じて `title` 属性で全文を補完する。
  - `value: string | number` — 表示する統計値。数値はそのまま描画し、フォーマットが必要な場合は呼び出し側で整形。
  - `disabled?: boolean`（デフォルト `false`）— true の場合はカード全体に `opacity-50`、`cursor-not-allowed`、`aria-disabled="true"` を付与。
  - 参考: Tailwind CSS Docs「line-clamp」(<https://tailwindcss.com/docs/line-clamp>)
- テンプレート構成:
  - カード全体に `rounded-lg`, `p-4`, `border`, `transition` を付与。
  - アイコン／本文を `flex` で横並びにし、アイコンは 40px（`w-10 h-10`）を想定。`aria-hidden="true"` を設定。
  - `value` は `text-2xl font-semibold text-card-value`（値用トークン）、`label` は `text-sm text-card-label`（必要に応じてトークンを定義）を検討。
  - `hover` 時は `bg-card-hovered`、`focus-visible:ring-status-focus-default` を付与しキーボード操作でも視認可。
  - スロット拡張を見据えて `<slot name="suffix">` などの余地を残すか検討（今回必須ではない）。

#### デザイントークンの追加

- `design-tokens.json`：`semantic.light.card` および `semantic.dark.card` に `default`, `hovered`, `disabled` の `bg`・`border`（必要なら `text`）を定義。
  - 例: `light.card.default.bg = {color.primitive.gray.50}`、`dark.card.default.bg = {color.primitive.gray.900}`。
- `docs/design/tailwind-utilities.json`：`semantic.tokens.card.default.bg` などを `bg-card-default` / `border-card-default` / `bg-card-hovered` / `bg-card-disabled` としてマッピング。
- カード内のテキスト色が既存 `content` トークンで足りるか確認し、必要なら `text-card-label` 等のトークンも追加。
- トークン追加後は `pnpm format` により JSON 整形ルールへ追従。
- `design-tokens.json`を更新後は、 `pnpm --filter frontend generate:tailwind-theme` を実行し、以下のファイルを自動更新する
  - `packages/frontend/docs/design/tailwind-utilities.json`
  - `packages/frontend/assets/css/tailwind.css`

#### DashboardPage の更新

- 統計カード部分を `<DashboardStatCard>` のグリッドに置き換える。
  - レイアウト: `grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4` を想定（現状 3 カラム固定のためレスポンシブ改善も兼ねる）。
  - 既存の 3 枚（ウォッチ中リポジトリ数、未読通知数、今日の更新数）を新コンポーネントで表示。
  - 暫定値の 0 は従来どおり固定値で可。
- Task 実装後でも SSR の `useFetch` 部分は変更しない。型の再確認を行い、`dataSources?.data.pagination.total ?? 0` で安全に扱う。

#### Storybook / VRT 更新

- `DashboardStatCard.stories.ts` を追加し、代表的な状態（Default / WithLongLabel / Disabled）を確認可能にする。MSW は不要。
- 既存 `DashboardPage.stories.ts`：統計カードのクエリを調整（`getByText('ウォッチ中リポジトリ')` などが新コンポーネント経由でも成立するか確認）。必要に応じて `within` でアクセシブルロールを利用。
- `DashboardPage.vrt.spec.ts`：UI 変化によりスクリーンショットが変わるため、ベースライン画像 (`dashboard-*.png`) を再生成し差し替える。
  - これは現状CIで実施しているため、更新が必要なことをユーザーに報告する。

#### テスト戦略（詳細は §5 参照）

- コンポーネント単体テストで props・アクセシビリティ・スタイルクラスの付与をチェック。
- Storybook VRT を更新し、UI 回帰を担保。

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/frontend/components/pages/dashboard/parts/DashboardStatCard.vue`**
   - 統計カード UI コンポーネント本体。

2. **`packages/frontend/components/pages/dashboard/parts/__tests__/DashboardStatCard.test.ts`**
   - 単体テスト。props のバリエーション、disabled 時のクラス、アイコン描画などを検証。

3. **`packages/frontend/components/pages/dashboard/parts/DashboardStatCard.stories.ts`**（任意だが作成を推奨）
   - Storybook で状態確認できるようにする。

### 更新対象ファイル

1. **`packages/frontend/design-tokens.json`**
   - card 系セマンティックトークンを追加。

2. **`packages/frontend/docs/design/tailwind-utilities.json`**
   - `pnpm --filter frontend generate:tailwind-theme` により自動更新

3. **`packages/frontend/assets/css/tailwind.css`**
   - `pnpm --filter frontend generate:tailwind-theme` により自動更新

4. **`packages/frontend/components/pages/dashboard/DashboardPage.vue`**
   - インラインの統計カードを `DashboardStatCard` に置き換え、グリッドレイアウトを調整。

5. **`packages/frontend/components/pages/dashboard/DashboardPage.stories.ts`**
   - Storybook 内のレンダリング・インタラクションを新コンポーネントに合わせて更新。

6. **`packages/frontend/components/pages/dashboard/DashboardPage.vrt.spec.ts`** および `DashboardPage.vrt.spec.ts-snapshots/*.png`
   - 新 UI に合わせて VRT を更新。

7. **`packages/frontend/components/pages/dashboard/parts/RepositoryList.vue`**（必要な場合のみ）
   - 直接の変更予定はないが、import 順などを整理する際に差分が生じる可能性がある。

## 5. テスト戦略

### Component Test（DashboardStatCard）

- props 組み合わせで `icon` 有無・`disabled` 有無を検証し、DOM 属性とクラスが期待どおりか確認。
- 長めの `label` を与えた際に `title` 属性や `line-clamp` が適用されるかチェック。
- `value` に数値と文字列を渡した際にそのまま表示されること。
- キーボードフォーカス時のリング（`focus-visible`）の有無を確認（`tabindex="0"` を付与する場合）。

### Storybook / VRT Test

- `DashboardPage` の既存 VRT シナリオ（Default / Empty / Error / ManyRepositories）が新レイアウトでも安定して撮影できるよう期待値を更新。

### 単体テスト（ページ／composable）

- 追加予定なし。既存ユニットテストが回帰しないことを確認。

## 6. 受け入れ基準

### 機能要件

- [ ] DashboardStatCard コンポーネントが props に応じて正しく描画され、アクセシビリティ要件（`aria-hidden`、`aria-disabled` 等）を満たす。
- [ ] DashboardPage の統計カードがすべて DashboardStatCard を利用した実装に置き換わっている。
- [ ] 新規に追加した card 系デザイントークンがライト/ダークテーマ双方で期待通りに適用される。

### 非機能要件

- [ ] `pnpm format && pnpm lint && pnpm test` がエラーなく完了する。

### セキュリティ要件

- [ ] 機微情報の露出や新規 API 呼び出しが追加されていないこと。

## 7. 実装手順

### Phase 1: デザイントークン整備

- 1-1. `design-tokens.json` に card 系トークンを追加し、既存の命名規則に揃える。
- 1-2. `pnpm --filter frontend generate:tailwind-theme` を実行し、`tailwind-utilities.json` と `tailwind.css` を自動更新。
- 1-3. `pnpm format` を実行し JSON を整形。
- 1-4. Tailwindのユーティリティクラスが変化(追加)するので、 packages/frontend/docs/design/tailwind-utilities.json を再確認

### Phase 2: DashboardStatCard コンポーネント実装

- 2-1. `DashboardStatCard.vue` を作成し、props・スタイル・アクセシビリティ要件を満たす。
- 2-2. `DashboardStatCard.test.ts` で主要パスをカバー。
- 2-3. （任意）Storybook を作成し視覚確認。

### Phase 3: DashboardPage 統合

- 3-1. `DashboardPage.vue` でインライン実装を削除し `DashboardStatCard` を導入。
- 3-2. DashboardPage の Storybook/VRT を更新し、スクリーンショットを再キャプチャ。
- 3-3. `pnpm lint && pnpm test`、必要なら `pnpm --filter frontend test:vrt` を実行し動作確認。

## 9. リスク・考慮事項

### 技術的リスク

- **Tailwind line-clamp の可用性**: 現行設定で `line-clamp-2` が利用できない場合、期待するラベル折り返しができない。
- **デザイントークン整合性**: 既存のトークン/ユーティリティ構造と齟齬があると、スタイルが意図通りに適用されない可能性。
- **VRT 差分の肥大化**: グリッド変更により既存スクリーンショットとの差分が大きくなり、レビューが煩雑になるリスク。

### 軽減策

- `line-clamp` が未サポートの場合は `truncate` + `title` 属性で視認性を担保し、必要に応じて Tailwind プラグイン追加を別 Issue で検討する旨を記載。
- トークン追加時は既存の `surface`/`status` トークン定義を参考にし、命名・階層を合わせる。Storybook でライト/ダークテーマを切り替え確認。
- VRT ではアニメーション無効化や待機処理を既存実装と揃え、PR での差分確認をしやすくする。大きな UI 変更はレビューコメントで事前共有する。
