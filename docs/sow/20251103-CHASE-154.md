# SOW: CHASE-154: ダッシュボードからのデータソース追加機能

## プロジェクト概要

**課題ID**: CHASE-154  
**作成日**: 2025-11-03  
**種別**: 新機能開発 / リファクタリング

## 1. 背景と目的

### 背景

- 現状のダッシュボードは通知一覧と統計の閲覧のみで、監視対象リポジトリ（データソース）の追加は別導線に依存している。
- GitHub リポジトリ URL のバリデーションがバックエンドに閉じており、フロントエンドでの入力支援ができていない。
- 成功・失敗通知を示す UI コンポーネント（トースト、モーダル）が未整備で、今後の拡張に耐えられない。

### 目的

- ダッシュボード上の FAB（Floating Action Button）からモーダルを開き、ユーザーが GitHub リポジトリを登録できる動線を提供する。
- フロントエンドとバックエンドで共通の GitHub URL 判定ロジックを利用し、境界を跨いだバリデーション整合性を確保する。
- 通知トーストやモーダルなどの汎用コンポーネントを整備し、以降の UI 実装を効率化する。

## 2. 実装スコープ

### 実装対象

- ダッシュボードページに FAB を追加し、押下でデータソース追加モーダル（ClModalDialog + AddDataSourceModal）を表示。POST `/api/data-sources`（BFF）を呼び出し、成功・失敗トーストを表示。
- `ClToast`、`ClModalDialog`、`ClFabButton` を含む基盤コンポーネントとトーストマネージャ（`useToast`、`ToastContainer`）の整備。
- GitHub リポジトリ URL の解析ユーティリティを shared パッケージへ切り出し、バックエンド use case とフロント入力バリデーションで共用。

### 更新可能な項目

1. フロントエンド UI/UX：`components/base`・`components/common`・`components/pages/dashboard` 配下、Storybook、VRT、Vitest を含む。
2. 共通ロジック：`packages/shared` への GitHub URL ユーティリティ追加とバックエンド use case の差し替え。

### 実装除外項目

- Backend API（POST `/api/data-sources`）のスキーマ変更や新規エンドポイント追加。
- Drizzle スキーマや DB マイグレーションなどサーバー側データモデルの変更。
- ダッシュボード以外のページ/レイアウトでのデータソース追加 UI。
- プッシュ通知やバックエンドのイベント配信ロジックの改修。

## 3. 技術仕様

### API仕様

#### エンドポイント

```
POST /api/data-sources
```

- Nuxt BFF がバックエンドの同名エンドポイントへフォワード（`postApiDataSources`）する。
- 成功時は 201 応答、失敗時は BFF が `createError` で 4xx/5xx を返却。

#### 認証・認可

- `middleware: 'auth'` により Auth0 セッション必須。
- セッションが無い場合は BFF が 401 を返却（既存実装に準拠）。

#### リクエスト仕様

```typescript
{
  repositoryUrl: string;               // 必須: https://github.com/{owner}/{repo}[.git]
  notificationEnabled?: boolean;       // UI デフォルト true
  watchReleases?: boolean;             // UI デフォルト true
  watchIssues?: boolean;               // UI デフォルト true（バックエンド既定 false を上書き）
  watchPullRequests?: boolean;         // UI デフォルト true（バックエンド既定 false を上書き）
  name?: string;                       // 今回の UI では入力欄を用意しない（送付時は undefined）
  description?: string;                // 同上
}
```

#### レスポンス仕様

```typescript
{
  success: boolean;
  data: {
    dataSource: DataSource;
    userWatch: UserWatch;
  }
}
```

- UI 側では `success === true` でトースト表示、`refreshNuxtData('dashboard-data-sources')` を発火。
- バリデーションエラー（400）や認可エラー（401）はエラートースト表示の対象。

### データベース操作

- 直接的な DB 操作は実施しない。バックエンド use case が既存のトランザクションで処理。

### アーキテクチャ設計

- **Shared 層**: `parseGitHubRepositoryUrl` / `isGitHubRepositoryUrl` を `packages/shared` に追加し、共通ライブラリからエクスポート。
- **Backend**: `RegisterDataSourceWatchUseCase` が shared ユーティリティを利用し、不正 URL 時は既存の `InvalidRepositoryUrlError` を再利用。
- **Frontend BFF**: `POST /api/data-sources` ルートは既存関数を流用。UI からのリクエストは Zod でバリデーション後にバックエンド呼び出し。
- **UI レイヤー**:
  - `ClModalDialog` が `<dialog>` をラップし、`v-model:open` で制御・ESC/Backdrop 閉じを提供。
  - `ClToast` + `useToast` + `ToastContainer` で `aria-live="assertive"` の通知表示を実装。
  - `ClFabButton` を固定位置に描画し、モバイル/デスクトップ両対応のヒット領域を確保。
  - `AddDataSourceModal` コンポーネントがフォーム、GitHub URL バリデーション、API 呼び出し、トースト連携を担当。
  - `DashboardPage` が FAB・モーダルを組み込み、成功時にデータソース統計を再取得。
- **デザイン適用方針**:
  - モーダル本体の背景・文字色・枠線は `bg-dialog-default` / `text-dialog-default` / `border-dialog-default` を使用し、ページ背景との差異を明確化。
  - バックドロップには `bg-dialog-backdrop` を利用し、必要なブラー量は Tailwind の `backdrop-blur-*` ユーティリティで指定。
  - トーストの背景・枠線・文字色はステータス用トークン（`bg|text|border-status-{info|success|warn|alert}-{default|subtle|inversed}`）を活用し、色調を統一。
  - エレベーション（shadow）やブラー等の効果は現状トークン化されていないため、Tailwind 標準ユーティリティ（`shadow-*`, `backdrop-blur-*` など）で表現する。

## 4. 実装ファイル一覧

### 新規作成ファイル

1. `packages/shared/src/utils/github.ts`
   - GitHub リポジトリ URL 判定・解析ユーティリティ（throws / safe 判定の両方を用意）。
2. `packages/shared/src/__tests__/github.test.ts`
   - 正常系（HTTPS / `.git` 付き）、異常系（GitHub 以外、owner/repo 欠如）の単体テスト。
3. `packages/frontend/composables/use-toast.ts`
   - `useState` ベースのトーストストア、`showToast`/`dismissToast` ヘルパーを提供。
4. `packages/frontend/components/common/ToastContainer.vue`
   - トーストリストのレンダリング（ポジション固定、`ClToast` 利用、フォーカス管理）。
5. `packages/frontend/components/common/__tests__/ToastContainer.test.ts`
   - トースト配列の描画、閉じる操作、SR 向け属性の検証。
6. `packages/frontend/components/base/ClToast.vue`
7. `packages/frontend/components/base/ClToast.stories.ts`
8. `packages/frontend/components/base/__tests__/ClToast.test.ts`
   - バリアント（success / warn / alert / info）と閉じるハンドラのテスト。
9. `packages/frontend/components/base/ClModalDialog.vue`
10. `packages/frontend/components/base/ClModalDialog.stories.ts`
11. `packages/frontend/components/base/__tests__/ClModalDialog.test.ts`
    - `v-model` 制御、ESC/Backdrop、アクセシビリティ属性のテスト。
12. `packages/frontend/components/base/ClFabButton.vue`
13. `packages/frontend/components/base/ClFabButton.stories.ts`
14. `packages/frontend/components/base/__tests__/ClFabButton.test.ts`
    - キーボード操作、ARIA ラベル、レスポンシブ位置決めの検証。
15. `packages/frontend/components/pages/dashboard/parts/AddDataSourceModal.vue`
16. `packages/frontend/components/pages/dashboard/parts/AddDataSourceModal.stories.ts`
17. `packages/frontend/components/pages/dashboard/parts/__tests__/AddDataSourceModal.test.ts`
    - 入力初期値、GitHub URL バリデーション、成功/失敗分岐、トグル挙動をテスト。
18. `packages/frontend/components/pages/dashboard/parts/DataSourceFabButton.vue`
19. `packages/frontend/components/pages/dashboard/parts/DataSourceFabButton.stories.ts`
20. `packages/frontend/components/pages/dashboard/parts/__tests__/DataSourceFabButton.test.ts`
21. `packages/frontend/components/pages/dashboard/AddDataSourceModal.vrt.spec.ts`
    - Storybook 上でモーダルの主要状態（初期表示／エラー表示）をキャプチャ。

### 更新対象ファイル

1. `packages/shared/src/index.ts`
   - `utils/github` を再エクスポート。
2. `packages/backend/src/features/data-sources/application/use-cases/register-data-source-watch.use-case.ts`
   - `parseGitHubRepositoryUrl` の利用と例外ハンドリングを追加。
3. `packages/frontend/components/base/layouts/default/ClLayoutDefault.vue`
   - `ToastContainer` を読み込み、`<main>` の外で絶対配置する。
4. `packages/frontend/components/pages/dashboard/DashboardPage.vue`
   - FAB/モーダルの状態管理、API 呼び出し、トースト表示、`refreshNuxtData` の呼び出しを追加。
5. `packages/frontend/components/pages/dashboard/DashboardPage.stories.ts`
   - FAB/モーダルのモック操作、POST モックハンドラー、トースト表示確認用の story を追加（Success / Error / Loading）。
6. `packages/frontend/components/pages/dashboard/DashboardPage.vrt.spec.ts`
   - 新しい story ID に対応し、FAB/モーダル表示後のスクリーンショットを追加。
7. `packages/frontend/vitest.config.ts`（必要に応じて）
   - `useToast` テスト用の別名やグローバル設定が必要な場合に調整。
8. `packages/frontend/nuxt.config.ts`（必要時）
   - トースト用 composable の自動インポート設定が必要な場合に追記。

## 5. テスト戦略

### Component / Unit Test（Frontend）

- `ClToast`：バリアントごとのクラス付与、閉じるボタンのイベント、`aria-live` 属性。
- `ClModalDialog`：`v-model` 連動、ESC/Backdrop close、フォーカス管理。
- `ClFabButton`：クリックイベント、キーボード操作、表示位置（モバイル/デスクトップ）の CSS クラス。
- `ToastContainer`：複数トーストのスタック表示、スワイプ/タイムアウトロジック（実装する場合）、SR 向け属性。
- `AddDataSourceModal`：初期フォーム値、GitHub URL バリデーション（成功/失敗）、API 成功時の `showToast` 呼び出し、失敗時のエラー表示/フォーカス戻し。
- `DashboardPage`：MSW を用いた統合テスト（FAB クリックでモーダルが開く、成功時に `refreshNuxtData` が呼ばれる）。

### Unit Test（Shared）

- `parseGitHubRepositoryUrl`：成功パターン（通常/末尾スラッシュ/`.git`）、失敗パターン（GitHub 以外のドメイン、不正フォーマット）。
- `isGitHubRepositoryUrl`：真偽判定のみを行うユーティリティの正規表現カバレッジ。

### E2E Test（Playwright）

- `packages/frontend/tests/dashboard.authenticated.spec.ts` などの既存シナリオにデータソース追加フローを追加し、FAB → モーダル入力 → API 成功 → トースト表示までを確認。
- テストコードの更新は実施するが、Playwright の実行はユーザーに依頼して結果を確認する。

### VRT（Playwright Storybook）

- `DashboardPage` 既存シナリオの更新に加え、FAB 表示状態とモーダル表示状態をスクリーンショット化。
- `AddDataSourceModal` 単体 Story の正常系・バリデーションエラー系を追加（撮影はユーザーに依頼）。

## 6. 受け入れ基準

### 機能要件

- [ ] ダッシュボード右下に FAB が表示され、クリック/Enter/Space でモーダルが開閉できる。
- [ ] GitHub 形式以外の URL を入力するとクライアント側でエラーメッセージを表示し、API リクエストを抑止する。
- [ ] 成功時にモーダルが閉じ、成功トーストが表示され、ウォッチ中リポジトリ数が最新化される。
- [ ] 失敗時にモーダルは開いたままエラートーストが表示される。
- [ ] 通知設定（通知オン/監視対象チェックボックス）は UI 既定値が ON で送信される。

### 非機能要件

- [ ] `pnpm format` と `pnpm lint` がエラーなく完了する。
- [ ] 追加した Vitest/Storybook テストが CI で通過する。 ※VRTのテストコード修正をお願いします。スナップショット更新はユーザーが実行します。
- [ ] モーダル・トーストは WCAG 準拠の aria 属性とフォーカス管理を持つ。
- [ ] Playwright E2E テストにデータソース追加シナリオが追加され、実行はユーザーに依頼して結果を確認する。

### セキュリティ要件

- [ ] 未認証状態での `/api/data-sources` へのアクセスは既存の認証ガードで拒否される。
- [ ] トーストやモーダルに表示するメッセージはサニタイズ済み（既存 API レスポンス）/ハードコードされた文言のみを使用する。
- [ ] GitHub URL 判定ロジックが shared 化され、バックエンドと同じ正規表現を利用する。

## 7. 実装手順

### Phase 1: 共通ユーティリティの切り出し

- 1-1. `packages/shared` に GitHub URL ユーティリティと単体テストを追加。
- 1-2. `RegisterDataSourceWatchUseCase` を shared ユーティリティ利用に差し替え、例外ハンドリングを調整。
- 1-3. format, lint, コミット。

### Phase 2: UI 基盤（トースト／モーダル／FAB）

- 2-1. `useToast`・`ToastContainer`・`ClToast` を実装し、Storybook/テストを整備。
- 2-2. `ClModalDialog`・`ClFabButton` を追加し、アクセシビリティ対応と Storybook/テストを作成。 ※VRTはテストコードの修正をお願いします。スナップショット更新はユーザーが実行します。
- 2-3. `ClLayoutDefault` に `ToastContainer` を組み込み、レイアウト回りのスナップショットを確認。
- 2-4. format, lint, コミット。

### Phase 3: ダッシュボード実装

- 3-1. `AddDataSourceModal`（フォーム + API 呼び出し + トースト連携）と FAB パーツを追加。
- 3-2. `DashboardPage` に FAB/モーダルを統合し、MSW モックを活用した Storybook/Vitest/VRT を更新。 ※VRTはテストコードの修正をお願いします。スナップショット更新はユーザーが実行します。
- 3-3. Playwright E2E シナリオを拡張し、ダッシュボード上でデータソース追加が完了することを自動化。実行自体はユーザーに依頼。
- 3-4. API 成功時の `refreshNuxtData`・失敗時のトースト表示など、UX を仕上げる。
- 3-5. format, lint を実施し、E2E 実行依頼の連絡後にコミット。

## 9. リスク・考慮事項

### 技術的リスク

- **`<dialog>` のブラウザ対応**: Safari 等でのポリフィルが必要になる可能性がある。
- **トーストの SSR 互換性**: `useState` 利用時にクライアント専用 API を参照すると SSR でエラーになるリスク。
- **UI トークン不足**: Tailwind ユーティリティに必要な色/背景クラスが未定義の可能性がある。

### 軽減策

- `<dialog>` 非対応ブラウザ向けに `showModal` 呼び出し前の存在確認・ポリフィル検討を行い、必要に応じてフォールバックを実装。
- `useToast` は SSR セーフな `useState` + `process.client` チェックで実装し、サーバーサイドでは空配列を返却する。
