# SOW: CHASE-128: authのフォルダ構造見直し

## プロジェクト概要

**課題ID**: CHASE-128
**作成日**: 2025-09-23
**種別**: リファクタリング

## 1. 背景と目的

### 背景

- `packages/backend/src/features/auth` がミドルウェア・エラー・型・テストヘルパーを内包しており、他フィーチャーのプレゼンテーション層が直接依存している。
- `packages/backend/src/features/user` はサービス層/リポジトリ直結の旧レイヤー構成で、ドメイン/アプリケーション/インフラの最新ガイドラインと乖離している。
- 結果として、境界づけられたコンテキスト間の依存が循環し、Identity領域の振る舞いを再利用・拡張しにくい構造になっている。

### 目的

- 認証ミドルウェアや共通エラー型を `core` 配下へ移設し、全フィーチャーがフレームワーク層に依存できるようにする。
- Auth/User 機能を統合した `features/identity` を再構成し、ポート&アダプタ／ユースケースベースのレイヤードアーキテクチャへ揃える。
- JWT バリデータをポート経由で差し替え可能にし、テストや将来の認証方式変更に備える。

## 2. 実装スコープ

### 実装対象

- 認証関連ユーティリティ（ミドルウェア、エラー、型、設定）の `core/auth` への移設と API 再設計
- `features/auth` と `features/user` の統合 -> `features/identity` 再構築（domain / application / infra / presentation / testing）
- JWT バリデータポート・スタブ・ファクトリの新設と既存実装の移植
- `app.ts` などアプリケーション合成コードの依存更新
- 既存テストコードのパス・DI 変更

### 更新可能な項目

1. バックエンド `packages/backend` 配下の TypeScript ファイル・ディレクトリ構成
2. Identity 関連ユニット／コンポーネントテスト
3. ドキュメント（必要に応じて `docs/backend` 系ガイドライン）

### 実装除外項目

- DB スキーマおよびマイグレーションの追加・変更
- フロントエンド実装・設定
- 認証ロジック (Auth0) の仕様変更や外部サービス連携追加

## 3. 技術仕様

### API仕様

#### 対象エンドポイント（既存パス・仕様を維持）

- `POST /api/auth/signup`
- `GET /api/users/profile`
- `PUT /api/users/profile`
- `GET /api/users/settings`
- `PUT /api/users/settings`

#### 認証・認可

- すべての `/api/*` ルートに `core/auth` の JWT ミドルウェアを適用（除外リストは `core/auth/middleware/auth-exclusions.ts` で管理）。
- `POST /api/auth/signup` は除外パスとして保持し、ID トークン検証は Identity ユースケースで実施。

#### リクエスト仕様（変更なし）

- `PUT /api/users/profile`
  ```typescript
  {
    name: string; // 1..100 文字
    email: string; // 1..255 文字
    timezone?: string;
  }
  ```
- `PUT /api/users/settings`
  ```typescript
  {
    timezone?: string;
    emailNotifications?: boolean;
    pushNotifications?: boolean;
    language?: "ja" | "en";
  }
  ```

#### レスポンス仕様（例）

- `GET /api/users/profile`
  ```typescript
  {
    user: {
      id: string;
      email: string;
      name: string;
      githubUsername: string | null;
      avatarUrl: string;
      timezone: string;
      createdAt: string;
      updatedAt: string;
    }
  }
  ```
- エラー応答は `core/auth` および `features/identity/presentation/shared/error-handling.ts` に集約されたスキーマを利用

### データベース操作

- `users` テーブルのみを参照・更新。
  - `findById`, `findByAuth0Id`, `findByEmail`, `save`, `delete` など既存クエリを `identity` ドメインのリポジトリポート経由で呼び出す。
- 追加テーブルやカラムの変更は行わない。

### アーキテクチャ設計

```
packages/backend/src
├── core/
│   └── auth/
│       ├── errors/auth.error.ts
│       ├── types/jwt.types.ts
│       ├── config/auth0.config.ts
│       └── middleware/{jwt-auth, exclusive-jwt-auth, auth-exclusions}.ts
└── features/identity/
    ├── domain/
    │   ├── user.ts
    │   ├── user-settings.ts
    │   ├── timezone.ts
    │   └── repositories/user.repository.ts  // Port
    ├── application/
    │   ├── ports/jwt-validator.port.ts
    │   └── use-cases/
    │       ├── sign-up.use-case.ts
    │       ├── get-profile.use-case.ts
    │       ├── update-profile.use-case.ts
    │       ├── get-settings.use-case.ts
    │       └── update-settings.use-case.ts
    ├── infra/
    │   ├── repositories/drizzle-user.repository.ts
    │   └── adapters/jwt-validator/
    │       ├── auth0-jwt-validator.adapter.ts
    │       ├── stub-jwt-validator.adapter.ts
    │       └── jwt-validator.factory.ts
    ├── presentation/
    │   ├── routes/auth/index.ts
    │   ├── routes/users/profile/index.ts
    │   ├── routes/users/settings/index.ts
    │   ├── schemas/*.ts
    │   └── shared/error-handling.ts
    └── testing/auth-test-helper.ts
```

- プレゼンテーション層はユースケースを DI し、ユースケースはドメインポートのみ依存。
- JWT ミドルウェアは `core` に移設し、ポート実装（Auth0/スタブ）は Identity 側で提供。

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/backend/src/core/auth/index.ts`**（エクスポート集約）
2. **`packages/backend/src/core/auth/errors/auth.error.ts`**
3. **`packages/backend/src/core/auth/types/jwt.types.ts`**
4. **`packages/backend/src/core/auth/config/auth0.config.ts`**
5. **`packages/backend/src/core/auth/middleware/{jwt-auth,exclusive-jwt-auth,auth-exclusions}.ts`**
6. **`packages/backend/src/features/identity/domain/repositories/user.repository.ts`**（Port）
7. **`packages/backend/src/features/identity/application/ports/jwt-validator.port.ts`**
8. **`packages/backend/src/features/identity/application/use-cases/*.ts`**
9. **`packages/backend/src/features/identity/infra/repositories/drizzle-user.repository.ts`**
10. **`packages/backend/src/features/identity/infra/adapters/jwt-validator/*`**
11. **`packages/backend/src/features/identity/presentation/routes/*`**（Auth/User 統合）
12. **`packages/backend/src/features/identity/testing/auth-test-helper.ts`**

### 更新対象ファイル

1. **`packages/backend/src/app.ts`** – ミドルウェアとルートの組み立てを新構成へ更新
2. **`packages/backend/src/test/index.ts`** – Auth テストヘルパーの再エクスポート
3. **既存テスト**（データソース含む） – 新しい import パス・DI に合わせて修正

### 削除/移行対象

- `packages/backend/src/features/auth/**`
- `packages/backend/src/features/user/**`
- 旧サービスクラス (`user-profile.service.ts`, `user-settings.service.ts`, `auth-signup.service.ts`)
- 旧ミドルウェア/テストヘルパー配置

## 5. テスト戦略

### Component Test（Presentation層）

- `identity/presentation/routes/users/profile`：認証成功/未認証/存在しないユーザー/重複メールの検証
- `identity/presentation/routes/users/settings`：取得・更新・バリデーション・デフォルト値
- `identity/presentation/routes/auth`：ID トークン検証・既存ユーザー更新・エラー応答
- `core/auth/middleware`：除外パス、認証必須パス、ログ出力の振る舞い確認

### Unit Test（Application層）

アプリケーション層のテストはComponent Testでカバーすることにして、実装しない。
(DBをモックしない場合、テスト全体の時間が延びることや保守コストの懸念があがり、DBをモックした場合はテスト自体の価値が下がるため)

## 6. 受け入れ基準

### 機能要件

- [ ] `/api/auth/signup`・`/api/users/*` のレスポンス仕様に破壊的変更がない
- [ ] JWT ミドルウェアが `core` に移設されても既存の除外設定と挙動が維持される
- [ ] Identity ユースケースがドメインポートを通じて DB 操作を行う
- [ ] テスト用スタブで他フィーチャーのコンポーネントテストが引き続き実行可能

### 非機能要件

- [ ] `pnpm --filter backend test` / `pnpm --filter backend lint` / `pnpm --filter backend format` が成功
- [ ] 重要ファイルの循環参照が解消される（ESLint no-cycle）
- [ ] 新構成に関するドキュメント／README の更新

### セキュリティ要件

- [ ] JWT 検証ロジックが既存と同等以上のチェック（署名/issuer/audience/expiry）を継続
- [ ] 認証情報を保持するコンテキストの取り扱いが変更後も Hono の `Context` 上に限定される
- [ ] テストスタブが本番ビルドへ混入しない

## 7. 実装手順

### Phase 1: Core Auth 移設

- 1-1. 既存ミドルウェア／エラー／型／設定の `core/auth` へのコピーマイグレーション
- 1-2. 新しいエクスポート API を定義し、ビルドが通るか確認
- 1-3. 旧 `features/auth` からの再エクスポートは暫定的に維持（後続フェーズで削除）

### Phase 2: Identity ドメイン再構成

- 2-1. Domain/Constants/Errors を `features/identity` へ移設し、ポートを定義
- 2-2. Drizzle 実装を `infra/repositories` に再配置し、ポートを実装
- 2-3. 旧サービスロジックを UseCase クラスへ移植

### Phase 3: プレゼンテーション＆合成更新

- 3-1. ルートハンドラをユースケース DI 方式に書き換え
- 3-2. `app.ts` で core ミドルウェア＋identity ファクトリを組み立て
- 3-3. 不要になった旧ファイルを削除

### Phase 4: テスト整備

- 4-1. Unit / Component テストの import と依存の整理
- 4-2. Stub JWT バリデータと AuthTestHelper の動作確認
- 4-3. 回帰テスト実行 (`pnpm --filter backend test`)

## 9. リスク・考慮事項

### 技術的リスク

- **循環依存の再発**: core ↔ identity 間の import 設計を誤ると再び循環が起きる恐れ
- **テストスタブとの不整合**: Stub JWT バリデータの API 変更で既存テストが失敗する可能性
- **DI 漏れ**: プレゼンテーション層でユースケースやミドルウェアを正しく組み立てられないとランタイムエラーが発生

### 軽減策

- core 側は interface のみ依存し、実装渡しはアプリケーション合成時に行う
- Stub 実装はポートの共通インターフェースを厳守し、AuthTestHelper 経由で一元管理
- フェーズごとに lint/test を回し、差分が大きくなる前に回帰確認
