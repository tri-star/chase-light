# SOW: CHASE-185: ActivityルートのDI簡素化とテスト初期化の改善

## プロジェクト概要

**課題ID**: CHASE-185
**作成日**: 2025-12-12
**種別**: リファクタリング / 実装改善

## 1. 背景と目的

### 背景

Activity系のルート (`packages/backend/src/features/activities/presentation/routes.ts`) をHono経由でテストする際、`createActivityPresentationRoutes` に全UseCaseインスタンス（現在5つ）を直接渡している。

現状のテストコードでは、各テストファイルで以下のような初期化処理が繰り返されている:

```typescript
const listUserActivitiesUseCase = new ListUserActivitiesUseCase(repository)
const getActivityDetailUseCase = new GetActivityDetailUseCase(repository)
const listDataSourceActivitiesUseCase = new ListDataSourceActivitiesUseCase(repository)
const requestActivityTranslationUseCase = new RequestActivityTranslationUseCase(...)
const getActivityTranslationStatusUseCase = new GetActivityTranslationStatusUseCase(...)

app.route(
  "/",
  createActivityPresentationRoutes(
    listUserActivitiesUseCase,
    getActivityDetailUseCase,
    listDataSourceActivitiesUseCase,
    requestActivityTranslationUseCase,
    getActivityTranslationStatusUseCase,
  ),
)
```

この構造には以下の問題がある:

1. 機能追加でUseCaseが増えるたびに、全テストの呼び出し引数を増やす必要がある
2. テストと無関係なUseCaseまで毎回生成する必要がある
3. 保守コストが高い

### 目的

1. ルートのシグネチャを簡素化し、テスト初期化を短縮する
2. 外部サービス（翻訳クライアント/GitHub）の差し替えの柔軟性を維持する
3. 新規UseCase追加時の修正箇所を1か所に集約する

## 2. 実装スコープ

### 実装対象

1. **依存組み立て関数の新設**: `buildActivityDeps()` を作成し、デフォルトの依存関係を構築
2. **ルート関数のシグネチャ変更**: オプショナルな部分オーバーライドを受け付ける形式に変更
3. **テスト用ヘルパーの作成**: テストでのアプリ初期化を1行で行えるファクトリ関数を提供
4. **既存テストのリファクタリング**: 新しいヘルパーを使用するように更新

### 実装除外項目

- 軽量サービスレジストリ方式（オーバーエンジニアリングを避けるため）
- 他フィーチャー（detection等）への適用（今回はactivitiesフィーチャーのみ）
- UseCase自体のロジック変更
- DBスキーマの変更

## 3. 技術仕様

### アーキテクチャ設計

課題で提示された4つの検討案のうち、**案1「デフォルト依存セット + 部分オーバーライド」と案2「テスト用ハーネス」の組み合わせ**を採用する。

理由:

- シンプルで理解しやすく、TypeScriptの型推論を活かせる
- 既存のコードベースのパターンに近い
- レジストリ方式と比較してオーバーエンジニアリングを避けられる

### 設計概要

#### 依存関係の型定義

```typescript
// activity-deps.types.ts
export type ActivityAdapters = {
  translationJobQueue: TranslationJobQueuePort;
  // 将来的に追加されるアダプタ
};

export type ActivityUseCases = {
  listUserActivities: ListUserActivitiesUseCase;
  getActivityDetail: GetActivityDetailUseCase;
  listDataSourceActivities: ListDataSourceActivitiesUseCase;
  requestActivityTranslation: RequestActivityTranslationUseCase;
  getActivityTranslationStatus: GetActivityTranslationStatusUseCase;
};

export type ActivityDeps = {
  adapters: ActivityAdapters;
  useCases: ActivityUseCases;
};

export type ActivityDepsOverrides = {
  adapters?: Partial<ActivityAdapters>;
  useCases?: Partial<ActivityUseCases>;
};
```

#### 依存組み立て関数

```typescript
// activity-deps.ts
export function buildActivityDeps(
  overrides?: ActivityDepsOverrides,
): ActivityDeps {
  // アダプタの構築（オーバーライド対応）
  const translationJobQueue =
    overrides?.adapters?.translationJobQueue ?? new SqsTranslationJobAdapter();

  // リポジトリの構築
  const activityQueryRepository = new DrizzleActivityQueryRepository();
  const translationStateRepository =
    new DrizzleActivityTranslationStateRepository();

  // UseCaseの構築（オーバーライド対応）
  return {
    adapters: { translationJobQueue },
    useCases: {
      listUserActivities:
        overrides?.useCases?.listUserActivities ??
        new ListUserActivitiesUseCase(activityQueryRepository),
      getActivityDetail:
        overrides?.useCases?.getActivityDetail ??
        new GetActivityDetailUseCase(activityQueryRepository),
      listDataSourceActivities:
        overrides?.useCases?.listDataSourceActivities ??
        new ListDataSourceActivitiesUseCase(activityQueryRepository),
      requestActivityTranslation:
        overrides?.useCases?.requestActivityTranslation ??
        new RequestActivityTranslationUseCase(
          translationStateRepository,
          translationJobQueue,
        ),
      getActivityTranslationStatus:
        overrides?.useCases?.getActivityTranslationStatus ??
        new GetActivityTranslationStatusUseCase(translationStateRepository),
    },
  };
}
```

#### ルート関数のシグネチャ変更

```typescript
// routes.ts (変更後)
export function createActivityPresentationRoutes(
  overrides?: ActivityDepsOverrides,
) {
  const deps = buildActivityDeps(overrides);
  const { useCases } = deps;

  const app = new OpenAPIHono();

  app.route(
    "/activities",
    createActivitiesRoutes(
      useCases.listUserActivities,
      useCases.getActivityDetail,
    ),
  );
  // ...
  return app;
}
```

#### テスト用ヘルパー

```typescript
// test-helpers/create-activity-test-app.ts
export type CreateActivityTestAppOptions = {
  useCaseOverrides?: Partial<ActivityUseCases>;
  adapterOverrides?: Partial<ActivityAdapters>;
};

export function createActivityTestApp(options?: CreateActivityTestAppOptions) {
  const app = new OpenAPIHono();
  app.use("*", globalJWTAuth);

  const deps = buildActivityDeps({
    adapters: options?.adapterOverrides,
    useCases: options?.useCaseOverrides,
  });

  app.route(
    "/",
    createActivityPresentationRoutes({
      adapters: options?.adapterOverrides,
      useCases: options?.useCaseOverrides,
    }),
  );

  return { app, deps };
}
```

### データフロー

```
テストコード
    │
    ├─ createActivityTestApp({ useCaseOverrides: { ... } })
    │       │
    │       ├─ buildActivityDeps(overrides)
    │       │       │
    │       │       ├─ デフォルトアダプタ/リポジトリの構築
    │       │       ├─ オーバーライドがあれば適用
    │       │       └─ UseCases構築（デフォルト or オーバーライド）
    │       │
    │       └─ createActivityPresentationRoutes(deps)
    │               │
    │               └─ 各ルート作成関数にUseCasesを渡す
    │
    └─ app.request() でテスト実行
```

## 4. 実装ファイル一覧

### ディレクトリツリー（変更対象）

```
packages/backend/src/features/activities/
├── application/
│   ├── activity-deps.ts              # 新規: 依存組み立て関数
│   ├── activity-deps.types.ts        # 新規: 依存関係の型定義
│   └── index.ts                      # 更新: 新規エクスポート追加
├── presentation/
│   ├── routes.ts                     # 更新: シグネチャ変更
│   └── routes/
│       ├── test-helpers/
│       │   └── create-activity-test-app.ts  # 新規: テストヘルパー
│       ├── activities/
│       │   └── __tests__/
│       │       └── index.test.ts     # 更新: 新ヘルパー使用
│       └── data-source-activities/
│           └── __tests__/
│               └── index.test.ts     # 更新: 新ヘルパー使用
└── index.ts                          # 更新: 公開API調整
```

### 新規作成ファイル

1. **`packages/backend/src/features/activities/application/activity-deps.types.ts`**
   - `ActivityAdapters`, `ActivityUseCases`, `ActivityDeps`, `ActivityDepsOverrides` の型定義

2. **`packages/backend/src/features/activities/application/activity-deps.ts`**
   - `buildActivityDeps(overrides?: ActivityDepsOverrides): ActivityDeps` 関数
   - デフォルトのアダプタ・リポジトリ・UseCaseの構築ロジック

3. **`packages/backend/src/features/activities/presentation/routes/test-helpers/create-activity-test-app.ts`**
   - `createActivityTestApp(options?: CreateActivityTestAppOptions)` 関数
   - JWT認証ミドルウェア適用済みのHonoアプリを返す

### 更新対象ファイル

1. **`packages/backend/src/features/activities/presentation/routes.ts`**
   - `createActivityPresentationRoutes` のシグネチャを変更
   - 個別のUseCase引数から `ActivityDepsOverrides` を受け取る形式に変更

2. **`packages/backend/src/features/activities/application/index.ts`**
   - `buildActivityDeps`, `ActivityDeps`, `ActivityDepsOverrides` のエクスポート追加

3. **`packages/backend/src/features/activities/index.ts`**
   - 本番コードの依存注入を `buildActivityDeps` を使用する形式に変更
   - `default export` の `activityRoutes` を簡素化

4. **`packages/backend/src/features/activities/presentation/routes/activities/__tests__/index.test.ts`**
   - `createActivityTestApp` を使用したシンプルな初期化に変更

5. **`packages/backend/src/features/activities/presentation/routes/activities/__tests__/translation.test.ts`**
   - `createActivityTestApp` を使用したシンプルな初期化に変更

6. **`packages/backend/src/features/activities/presentation/routes/data-source-activities/__tests__/index.test.ts`**
   - `createActivityTestApp` を使用したシンプルな初期化に変更

## 5. テスト戦略

### Component Test（Presentation層）

既存のテストケースは全て維持し、初期化方法のみを変更する。

**変更前の初期化**:

```typescript
beforeEach(async () => {
  const repository = new DrizzleActivityQueryRepository();
  const listUserActivitiesUseCase = new ListUserActivitiesUseCase(repository);
  const getActivityDetailUseCase = new GetActivityDetailUseCase(repository);
  const listDataSourceActivitiesUseCase = new ListDataSourceActivitiesUseCase(
    repository,
  );
  const translationStateRepository =
    new DrizzleActivityTranslationStateRepository();
  queueStub = new TranslationJobQueueStub();
  const requestActivityTranslationUseCase =
    new RequestActivityTranslationUseCase(
      translationStateRepository,
      queueStub,
    );
  const getActivityTranslationStatusUseCase =
    new GetActivityTranslationStatusUseCase(translationStateRepository);

  app = new OpenAPIHono();
  app.use("*", globalJWTAuth);
  app.route(
    "/",
    createActivityPresentationRoutes(
      listUserActivitiesUseCase,
      getActivityDetailUseCase,
      listDataSourceActivitiesUseCase,
      requestActivityTranslationUseCase,
      getActivityTranslationStatusUseCase,
    ),
  );
});
```

**変更後の初期化**:

```typescript
beforeEach(async () => {
  queueStub = new TranslationJobQueueStub();
  const result = createActivityTestApp({
    adapterOverrides: { translationJobQueue: queueStub },
  });
  app = result.app;
});
```

## 6. 受け入れ基準

### 機能要件

- [ ] `createActivityPresentationRoutes` が `ActivityDepsOverrides` 型の引数を受け取る形式に変更されている
- [ ] `buildActivityDeps` 関数が正しくデフォルト依存関係を構築する
- [ ] テストで必要な依存のみをオーバーライドできる
- [ ] 既存の全テストが引き続きパスする

### 非機能要件

- [ ] 既存のテストが全て通る (`pnpm --filter backend test`)
- [ ] リント・フォーマットが通る (`pnpm --filter backend lint && pnpm --filter backend format:check`)
- [ ] 新規UseCase追加時に `activity-deps.ts` を1か所変更するだけで済む構造になっている

### セキュリティ要件

- [ ] JWT認証の動作に影響がない
- [ ] テスト用ヘルパーが本番コードに漏れ出ない（test-helpersディレクトリに隔離）

## 7. 実装手順

### Phase 1: 型定義と依存組み立て関数の実装

- 1-1. `activity-deps.types.ts` の作成（型定義）
- 1-2. `activity-deps.ts` の作成（buildActivityDeps関数）
- 1-3. `application/index.ts` の更新（エクスポート追加）
- 1-4. `activity-deps.ts` のユニットテスト作成
- 1-5. format, lint, コミット

### Phase 2: ルート関数のシグネチャ変更

- 2-1. `routes.ts` の `createActivityPresentationRoutes` シグネチャ変更
- 2-2. 内部でbuildActivityDepsを呼び出すよう変更
- 2-3. format, lint, コミット

### Phase 3: テストヘルパーの作成と既存テストのリファクタリング

- 3-1. `test-helpers/create-activity-test-app.ts` の作成
- 3-2. `activities/__tests__/index.test.ts` のリファクタリング
- 3-3. `data-source-activities/__tests__/index.test.ts` のリファクタリング
- 3-4. 全テストの実行確認
- 3-5. format, lint, コミット

### Phase 4: 最終確認とドキュメント

- 4-1. 全テスト実行 (`pnpm --filter backend test`)
- 4-2. 必要に応じてREADMEやガイドラインの更新
- 4-3. format, lint, 最終コミット

## 8. リスク・考慮事項

### 技術的リスク

- **後方互換性**: シグネチャ変更により、他で`createActivityPresentationRoutes`を直接呼び出している箇所があれば影響を受ける
- **循環依存**: `activity-deps.ts` がリポジトリとUseCaseの両方を参照するため、循環依存に注意が必要

### 軽減策

- `createActivityPresentationRoutes` の呼び出し箇所を事前に洗い出し、影響範囲を確認する
- 依存グラフを維持し、循環依存が発生しないよう注意する
- 段階的実装により、各フェーズで品質を確認する

### 将来の拡張性

- 新しいUseCaseが追加された場合、`activity-deps.types.ts` と `activity-deps.ts` を更新するだけで済む
- 他のフィーチャー（detection等）にも同様のパターンを適用可能
