# SOW: CHASE-120: アクティビティ一覧APIの追加

## プロジェクト概要

**課題ID**: CHASE-120
**作成日**: 2025-10-05
**種別**: 新機能開発

## 1. 背景と目的

### 背景

データソース監視によって検知されたアクティビティ（GitHub PR/Issue/リリースなどの作成、更新）がDBに保存されていますが、現状ではこの情報にアクセスする手段がありません。フロントエンドからアクティビティ情報を取得・表示できるようにする必要があります。

### 目的

ユーザーが監視中のデータソースに関連するアクティビティを閲覧できるよう、以下のAPIエンドポイントを提供します：

- ユーザーに関連する全アクティビティの一覧取得
- 特定アクティビティの詳細取得
- 特定データソースに関連するアクティビティの一覧取得

## 2. 実装スコープ

### 実装対象

- `features/activities` フィーチャーの新規作成
  - アクティビティ参照に特化した境界づけられたコンテキスト
  - Domain層、Application層、Infrastructure層、Presentation層を含む完全なレイヤー構成
- 3つのRESTful APIエンドポイントの実装
- 既存の `activities` テーブルの活用（新規テーブル作成は不要）

### APIエンドポイント

1. `GET /api/activities` - ユーザーに関連する全アクティビティ一覧
2. `GET /api/activities/:id` - 特定アクティビティの詳細
3. `GET /api/data-sources/:dataSourceId/activities` - 特定データソースのアクティビティ一覧

### 機能要件

- ページネーション対応（デフォルト: 20件/ページ、最大: 100件/ページ）
- フィルタリング機能
  - アクティビティタイプ（release, issue, pull_request）
  - ステータス（pending, completed, failed）
  - 日付範囲（作成日、更新日）
- ソート機能（作成日の昇順・降順、デフォルト: 作成日降順）
- ユーザー認証必須（JWT）
- アクセス権限チェック（ユーザーが監視中のデータソースのアクティビティのみ取得可能）

### 実装除外項目

- アクティビティの作成・更新・削除機能（`features/detection` の責務）
- いいね・ブックマーク機能（将来の拡張）
- 翻訳機能の呼び出し（検知フローの責務）
- アクティビティの統計情報API（将来の拡張）

## 3. 技術仕様

### API仕様

#### エンドポイント1: ユーザーのアクティビティ一覧取得

```
GET /api/activities
```

##### 認証・認可

- JWT認証必須
- ユーザーが監視中のデータソースに関連するアクティビティのみ取得可能

##### リクエスト仕様（クエリパラメータ）

```typescript
{
  activityType?: "release" | "issue" | "pull_request"
  status?: "pending" | "completed" | "failed"
  createdAfter?: string  // ISO 8601形式
  createdBefore?: string
  updatedAfter?: string
  updatedBefore?: string
  page?: number          // デフォルト: 1
  perPage?: number       // デフォルト: 20, 最大: 100
  sortBy?: "createdAt" | "updatedAt"  // デフォルト: "createdAt"
  sortOrder?: "asc" | "desc"          // デフォルト: "desc"
}
```

##### レスポンス仕様

```typescript
{
  success: true,
  data: {
    items: Array<{
      id: string
      dataSource: {
        id: string
        name: string
        url: string
      }
      activityType: ActivityType  // "release" | "issue" | "pull_request"
      title: string
      body: string
      version: string | null
      status: ActivityStatus  // "pending" | "completed" | "failed"
      createdAt: string  // ISO 8601
      updatedAt: string
    }>
    pagination: {
      currentPage: number
      perPage: number
      totalItems: number
      totalPages: number
    }
  }
}
```

#### エンドポイント2: アクティビティ詳細取得

```
GET /api/activities/:id
```

##### 認証・認可

- JWT認証必須
- ユーザーが監視中のデータソースに関連するアクティビティのみ取得可能
- 他ユーザーのアクティビティに対するアクセスは404エラーで拒否

##### リクエスト仕様

- パスパラメータ: `id` (UUID)

##### レスポンス仕様

```typescript
{
  success: true,
  data: {
    id: string
    dataSource: {
      id: string
      name: string
      description: string
      url: string
    }
    activityType: ActivityType  // "release" | "issue" | "pull_request"
    title: string
    body: string
    version: string | null
    status: ActivityStatus  // "pending" | "completed" | "failed"
    statusDetail: string | null
    createdAt: string  // ISO 8601
    updatedAt: string
  }
}
```

#### エンドポイント3: データソース別アクティビティ一覧取得

```
GET /api/data-sources/:dataSourceId/activities
```

##### 認証・認可

- JWT認証必須
- ユーザーが監視中のデータソースのアクティビティのみ取得可能
- 監視していないデータソースへのアクセスは404エラーで拒否

##### リクエスト仕様

- パスパラメータ: `dataSourceId` (UUID)
- クエリパラメータ: エンドポイント1と同様

##### レスポンス仕様

- エンドポイント1と同様

### データベース操作

#### 参照テーブル

- **`activities`テーブル**: アクティビティ情報の取得
- **`data_sources`テーブル**: データソース情報の結合
- **`user_watches`テーブル**: ユーザーのアクセス権限チェック

#### 主要クエリパターン

1. **ユーザーのアクティビティ一覧取得**
   ```sql
   SELECT a.*, ds.*
   FROM activities a
   INNER JOIN data_sources ds ON a.data_source_id = ds.id
   INNER JOIN user_watches uw ON ds.id = uw.data_source_id
   WHERE uw.user_id = :userId
   -- フィルタ条件
   ORDER BY a.created_at DESC
   LIMIT :perPage OFFSET :offset
   ```

2. **アクティビティ詳細取得（権限チェック付き）**
   ```sql
   SELECT a.*, ds.*
   FROM activities a
   INNER JOIN data_sources ds ON a.data_source_id = ds.id
   INNER JOIN user_watches uw ON ds.id = uw.data_source_id
   WHERE a.id = :activityId AND uw.user_id = :userId
   ```

3. **データソース別アクティビティ一覧取得（権限チェック付き）**
   ```sql
   SELECT a.*, ds.*
   FROM activities a
   INNER JOIN data_sources ds ON a.data_source_id = ds.id
   INNER JOIN user_watches uw ON ds.id = uw.data_source_id
   WHERE ds.id = :dataSourceId AND uw.user_id = :userId
   -- フィルタ条件
   ORDER BY a.created_at DESC
   LIMIT :perPage OFFSET :offset
   ```

### アーキテクチャ設計

`features/activities` フィーチャーとして新規作成し、以下のレイヤー構成を採用：

#### Domain層

- **`activity.ts`**: アクティビティのエンティティ型定義
  - `Activity` 型（既存の `features/detection/domain/activity.ts` を参考に、参照用に最適化）
  - `ActivityId` ブランド型
  - `ActivityType`, `ActivityStatus` 列挙型（既存と共通化を検討）
  - データソース情報を含む複合型 `ActivityWithDataSource`

#### Domain/Repositories層

- **`activity.repository.ts`**: リポジトリインターフェース
  - `findByUserId`: ユーザーに関連するアクティビティ一覧取得
  - `findById`: ID指定でのアクティビティ詳細取得（権限チェック付き）
  - `findByDataSourceId`: データソースID指定でのアクティビティ一覧取得（権限チェック付き）
  - `countByUserId`: 総件数取得（ページネーション用）
  - `countByDataSourceId`: データソース別総件数取得

#### Application/Use-cases層

- **`list-user-activities.use-case.ts`**: ユーザーのアクティビティ一覧取得
- **`get-activity-detail.use-case.ts`**: アクティビティ詳細取得
- **`list-data-source-activities.use-case.ts`**: データソース別アクティビティ一覧取得

#### Infrastructure/Repositories層

- **`drizzle-activity.repository.ts`**: Drizzle ORM実装
  - 既存の `features/detection/infra/repositories/drizzle-activity.repository.ts` とは別実装
  - 参照特化のクエリ最適化（JOIN、フィルタリング）

#### Presentation層

- **`presentation/schemas/`**
  - `activity-list-request.schema.ts`: 一覧取得リクエストのZodスキーマ
  - `activity-list-response.schema.ts`: 一覧取得レスポンスのZodスキーマ
  - `activity-detail-response.schema.ts`: 詳細取得レスポンスのZodスキーマ

- **`presentation/routes/activities/index.ts`**: アクティビティルート
  - `GET /` - ユーザーのアクティビティ一覧
  - `GET /:id` - アクティビティ詳細

- **`presentation/routes/data-sources/index.ts`**: データソースルート（既存に追加）
  - `GET /:dataSourceId/activities` - データソース別アクティビティ一覧

- **`presentation/shared/error-handling.ts`**: 共通エラーハンドリング

#### 公開API

- **`index.ts`**: 他フィーチャーへの公開インターフェース
  - 現時点では公開不要（内部完結）

## 4. 実装ファイル一覧

### 新規作成ファイル

#### Domain層

1. **`packages/backend/src/features/activities/domain/activity.ts`**
   - アクティビティのエンティティ型定義
   - Brand型ID定義
   - 列挙型定義

2. **`packages/backend/src/features/activities/domain/repositories/activity.repository.ts`**
   - リポジトリインターフェース定義

#### Application層

3. **`packages/backend/src/features/activities/application/use-cases/list-user-activities.use-case.ts`**
   - ユーザーのアクティビティ一覧取得ロジック

4. **`packages/backend/src/features/activities/application/use-cases/get-activity-detail.use-case.ts`**
   - アクティビティ詳細取得ロジック

5. **`packages/backend/src/features/activities/application/use-cases/list-data-source-activities.use-case.ts`**
   - データソース別アクティビティ一覧取得ロジック

6. **`packages/backend/src/features/activities/application/use-cases/index.ts`**
   - ユースケースのバレルファイル

#### Infrastructure層

7. **`packages/backend/src/features/activities/infra/repositories/drizzle-activity.repository.ts`**
   - Drizzle ORM実装

#### Presentation層

8. **`packages/backend/src/features/activities/presentation/schemas/activity-list-request.schema.ts`**
   - 一覧取得リクエストスキーマ

9. **`packages/backend/src/features/activities/presentation/schemas/activity-list-response.schema.ts`**
   - 一覧取得レスポンススキーマ

10. **`packages/backend/src/features/activities/presentation/schemas/activity-detail-response.schema.ts`**
    - 詳細取得レスポンススキーマ

11. **`packages/backend/src/features/activities/presentation/schemas/index.ts`**
    - スキーマのバレルファイル

12. **`packages/backend/src/features/activities/presentation/shared/error-handling.ts`**
    - 共通エラーハンドリング

13. **`packages/backend/src/features/activities/presentation/routes/activities/index.ts`**
    - アクティビティルート定義

14. **`packages/backend/src/features/activities/presentation/routes/activities/__tests__/index.test.ts`**
    - アクティビティルートのコンポーネントテスト

#### その他

15. **`packages/backend/src/features/activities/index.ts`**
    - フィーチャー公開APIのバレルファイル

### 更新対象ファイル

1. **`packages/backend/src/app.ts`**
   - アクティビティルートの登録

2. **`packages/backend/src/features/data-sources/presentation/routes/data-sources/index.ts`**
   - データソース別アクティビティ一覧エンドポイントの追加

## 5. テスト戦略

### Component Test（Presentation層）

テスト配置: `packages/backend/src/features/activities/presentation/routes/activities/__tests__/index.test.ts`

#### GET /api/activities

- 認証済みユーザーによる正常なアクティビティ一覧取得
- ページネーションの正常動作（page, perPage パラメータ）
- フィルタリングの正常動作（activityType, status, 日付範囲）
- ソート機能の正常動作（sortBy, sortOrder）
- 未認証アクセスに対する401エラー
- 不正なパラメータに対するバリデーションエラー（400エラー）
- 監視中のデータソースのアクティビティのみ取得できることの確認

#### GET /api/activities/:id

- 認証済みユーザーによる正常なアクティビティ詳細取得
- データソース情報が含まれることの確認
- 監視していないデータソースのアクティビティに対する404エラー
- 存在しないアクティビティIDに対する404エラー
- 不正なUUID形式に対するバリデーションエラー（400エラー）
- 未認証アクセスに対する401エラー

#### GET /api/data-sources/:dataSourceId/activities

- 認証済みユーザーによる正常なデータソース別アクティビティ一覧取得
- フィルタリング・ページネーション・ソート機能の動作確認
- 監視していないデータソースに対する404エラー
- 存在しないデータソースIDに対する404エラー
- 不正なパラメータに対するバリデーションエラー（400エラー）

### Unit Test（Use-case層）

今回は実装しない（Component Testで十分にカバー可能）

### Unit Test（Repository層）

今回は実装しない（データベースアクセスはComponent Testで検証）

## 6. 受け入れ基準

### 機能要件

- [ ] `GET /api/activities` でユーザーに関連するアクティビティ一覧が取得できる
- [ ] `GET /api/activities/:id` でアクティビティ詳細が取得できる
- [ ] `GET /api/data-sources/:dataSourceId/activities` でデータソース別アクティビティ一覧が取得できる
- [ ] ページネーション機能が正常に動作する（デフォルト20件、最大100件）
- [ ] フィルタリング機能が正常に動作する（activityType, status, 日付範囲）
- [ ] ソート機能が正常に動作する（createdAt, updatedAtの昇順・降順）
- [ ] レスポンスにデータソース名が含まれる
- [ ] OpenAPI仕様が正しく生成される

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] 新規実装したエンドポイントのComponent Testが全て通る
- [ ] レスポンスタイムが1秒以内（100件取得時）
- [ ] TypeScriptの型安全性が確保されている（any型の濫用なし）
- [ ] Zodスキーマによるランタイム型検証が実装されている
- [ ] コードがリントエラーなく整形されている

### セキュリティ要件

- [ ] JWT認証による適切なアクセス制御
- [ ] ユーザーが監視中のデータソースのアクティビティのみアクセス可能
- [ ] 監視外データソースに対するアクセスで404エラーを返す（403ではなく情報漏洩防止）
- [ ] SQLインジェクション対策（Drizzle ORMのパラメータバインディング）
- [ ] XSS対策（レスポンスの適切なエスケープ）

## 7. 実装手順

### Phase 1: Domain層・Repository層の実装

- 1-1. `features/activities/domain/activity.ts` の作成
  - エンティティ型、Brand型ID、列挙型の定義
- 1-2. `features/activities/domain/repositories/activity.repository.ts` の作成
  - リポジトリインターフェースの定義
- 1-3. `features/activities/infra/repositories/drizzle-activity.repository.ts` の作成
  - Drizzle ORM実装
  - JOINクエリの実装
  - フィルタリング・ページネーション・ソート機能の実装

### Phase 2: Application層の実装

- 2-1. `list-user-activities.use-case.ts` の実装
  - 入力バリデーション
  - リポジトリ呼び出し
  - ページネーション計算
- 2-2. `get-activity-detail.use-case.ts` の実装
  - 権限チェック（リポジトリ層で実施）
  - アクティビティ存在チェック
- 2-3. `list-data-source-activities.use-case.ts` の実装
  - データソースアクセス権限チェック
  - リポジトリ呼び出し

### Phase 3: Presentation層の実装

- 3-1. Zodスキーマの作成
  - リクエストスキーマ（クエリパラメータ、パスパラメータ）
  - レスポンススキーマ
- 3-2. `presentation/routes/activities/index.ts` の実装
  - `GET /` エンドポイント
  - `GET /:id` エンドポイント
  - エラーハンドリング
- 3-3. `presentation/shared/error-handling.ts` の実装
  - 共通エラーハンドリング関数
- 3-4. Component Testの作成・実行
  - 正常系・異常系の網羅的なテスト

### Phase 4: 統合とデプロイ準備

- 4-1. `app.ts` へのルート登録
- 4-2. `features/data-sources` への追加エンドポイント実装
  - `GET /data-sources/:dataSourceId/activities`
- 4-3. 全体テストの実行
  - 既存テストの回帰確認
  - 新規テストの実行
- 4-4. OpenAPI仕様の確認
- 4-5. リントチェック・フォーマット

## 8. 依存関係と前提条件

### 前提条件

- `activities` テーブルが既に存在し、アクティビティデータが格納されている
- `user_watches` テーブルが既に存在し、ユーザーの監視設定が管理されている
- JWT認証ミドルウェアが実装されている（`features/identity/middleware/jwt-auth.middleware.ts`）

### 依存フィーチャー

- `features/identity`: JWT認証ミドルウェア
- `features/data-sources`: データソース情報（型定義は独自に用意）

### 注意事項

- `features/detection` の `Activity` 型とは別に、参照用の `Activity` 型を定義する
  - 理由: 検知フィーチャーと参照フィーチャーで必要な情報が異なる可能性があるため
  - 将来的に共通化する場合は `packages/shared` への移動を検討

## 9. リスク・考慮事項

### 技術的リスク

- **パフォーマンス**: アクティビティ数が増加した場合のクエリ性能劣化
  - 既存インデックスの活用状況確認が必要
  - 特に `idx_activities_data_source_created` の効果的な利用
- **データ整合性**: user_watches と activities の結合による整合性
  - 監視解除後のアクティビティの扱い（現状は取得不可、将来的に要検討）
- **スキーマ重複**: `features/detection` と `features/activities` での型定義重複
  - 初期は許容し、将来的に共通化を検討

### 軽減策

- **パフォーマンス**
  - Component Testで100件取得時のレスポンスタイムを計測
  - 必要に応じてクエリのEXPLAIN ANALYZEを実施
  - インデックスの追加が必要な場合は別途検討
- **データ整合性**
  - 監視解除後のアクティビティ扱いはドキュメント化（SOWに記載）
  - 将来的な要件として「過去に監視していたアクティビティの閲覧」を検討
- **スキーマ重複**
  - 初期実装では各フィーチャー内で独自に型定義
  - 安定後に `packages/shared` への共通化を検討

### セキュリティ考慮事項

- **情報漏洩防止**: 監視外データソースへのアクセスは403ではなく404を返す
  - 理由: データソースの存在を外部に知らせない
- **SQLインジェクション**: Drizzle ORMのパラメータバインディングを使用
- **XSS**: レスポンスの適切なエスケープ（Honoが自動処理）

## 10. 今後の拡張予定

本SOWの範囲外ですが、将来的に以下の機能拡張を検討：

- アクティビティに対するいいね・ブックマーク機能
- アクティビティの統計情報API（タイプ別件数、ステータス別件数など）
- 全文検索機能（タイトル・本文での検索）
- 監視解除後のアクティビティ閲覧機能
- アクティビティの既読・未読管理
- リアルタイム通知との連携
