# SOW: CHASE-120: アクティビティ一覧APIの追加

## プロジェクト概要

**課題ID**: CHASE-120
**作成日**: 2025-10-05
**種別**: 機能追加

## 1. 背景と目的

### 背景

- 検知ワーカー（`features/detection`）がGitHubリポジトリのリリース・Issue・Pull Requestなどを監視し、結果を`activities`テーブルへ蓄積している。
- 現状はバックエンド内部でデータが閉じており、フロントエンドからアクティビティ情報へアクセスする手段が存在しない。
- 通知やダッシュボード表示のためには、ユーザー視点・データソース視点でアクティビティを取得できるAPIが必要。

### 目的

- ユーザーが自分に関連するアクティビティを一覧・詳細参照できるREST APIを提供し、フロントエンド実装の前提となる契約を確立する。
- データソース単位のアクティビティ取得をサポートし、詳細画面や分析画面への展開を容易にする。
- アーキテクチャガイドライン（ドメイン→アプリケーション→入出力層）を踏まえた新規フィーチャーを整備し、今後の拡張に耐えられる構造を構築する。

## 2. 実装スコープ

### 実装対象

- `features/activities` フィーチャーの新規追加（ドメイン／リポジトリ／ユースケース／プレゼンテーション）。
- 以下3つのエンドポイントをOpenAPI対応で実装。
  1. `GET /api/activities`
  2. `GET /api/activities/{id}`
  3. `GET /api/data-sources/{dataSourceId}/activities`
- `app.ts` へのルーティング追加およびOpenAPIカタログへの反映。

### 更新可能な項目

1. `packages/backend/src/features/detection/domain/activity.ts` を新設ドメインへリファクタリングし、活動ステータス／タイプ定義を共通化。
2. `packages/backend/src/features/identity` 配下の認証ミドルウェアを再利用してJWT必須のAPIを構成。
3. `packages/backend/src/db/factories.ts` へActivities用ファクトリを追加し、コンポーネントテストでのデータ投入を簡略化。

### 実装除外項目

- スケジューラや検知ロジック（`features/detection`）の振る舞い変更。
- 通知配信・購読設定の追加や既存ロジックの改修。
- フロントエンド側の実装、およびGraphQL・Webhookなどの別インターフェイス提供。

## 3. 技術仕様

### API仕様

#### GET /api/activities

- **概要**: 認証ユーザーがウォッチしているデータソースに紐づく最新アクティビティを一覧取得する。
- **クエリパラメータ** (すべて任意):
  - `page`: number (default 1, 1以上)
  - `perPage`: number (default 20, 最大100)
  - `activityType`: `'release' | 'issue' | 'pull_request'`
  - `status`: `'pending' | 'processing' | 'completed' | 'failed'` （未指定時は`completed`のみ）
  - `since`: ISO8601文字列（`activities.created_at`下限）
  - `until`: ISO8601文字列（`activities.created_at`上限）
  - `sort`: `'createdAt' | 'updatedAt'`（default `createdAt`）
  - `order`: `'asc' | 'desc'`（default `desc`）
- **認証・認可**: JWT必須。ユーザーがウォッチしていないデータソースのアクティビティは結果に含めない。
- **レスポンス例**:

```typescript
{
  success: true,
  data: {
    items: Array<{
      activity: {
        id: string
        activityType: ActivityType
        title: string
        summary: string | null
        detail?: string
        status: ActivityStatus
        statusDetail?: string | null
        version: string | null
        occurredAt: string
        lastUpdatedAt: string
        source: {
          id: string
          sourceType: string
          name: string
          url: string
          metadata?: {
            repositoryFullName?: string
            repositoryLanguage?: string | null
            starsCount?: number
            forksCount?: number
          }
        }
      }
      notification: {
        hasUnread: boolean
        latestSentAt: string | null
      }
    }>,
    pagination: {
      page: number
      perPage: number
      total: number
      totalPages: number
      hasNext: boolean
      hasPrev: boolean
    }
  }
}
```

- **備考**: 詳細本文（`detail`）は表示用途がある場合に限り含める。`githubData` などの生データは返却しない。
- **エラー**: 401（未認証）、400（バリデーションエラー）。

#### GET /api/activities/{id}

- **概要**: 指定IDのアクティビティ詳細を取得。ユーザーがウォッチしていないデータソースの場合は404。
- **認証・認可**: JWT必須。ウォッチ権限が無い場合は404で秘匿。
- **レスポンス例**:

```typescript
{
  success: true,
  data: {
    activity: {
      id: string
      activityType: ActivityType
      title: string
      summary: string | null
      detail: string
      status: ActivityStatus
      statusDetail: string | null
      version: string | null
      occurredAt: string
      lastUpdatedAt: string
      source: {
        id: string
        sourceType: string
        name: string
        url: string
        metadata?: {
          repositoryFullName?: string
          repositoryLanguage?: string | null
          starsCount?: number
          forksCount?: number
          openIssuesCount?: number
        }
      }
    }
  }
}
```

- **備考**: プロバイダ固有の`githubData`のような生データは含めず、画面表示に必要な要約情報のみ返却する。
- **エラー**: 401、404。

#### GET /api/data-sources/{dataSourceId}/activities

- **概要**: 指定データソースのアクティビティ一覧を取得。リクエストユーザーがウォッチ中かつアクセス可能なデータソースに限定。
- **クエリパラメータ**: `page`, `perPage`, `activityType`, `status`, `since`, `until`, `sort`, `order`（`GET /api/activities`と共通。`status`デフォルトは`completed`）。
- **レスポンス**: `dataSource`情報をレスポンスヘッダ部に含め、`items`配列は上記「GET /api/activities」と同じ `activity` 構造を返却。
- **エラー**: 401、404。

### データベース操作

- **`activities` テーブル**: フィルタリング・ページング対象。`status`, `activity_type`, `created_at`, `data_source_id`を条件に使用。
- **`data_sources` テーブル**: アクティビティと結合し、名称・URL・種別を取得。
- **`repositories` テーブル**: `data_sources`がGitHubの場合にリポジトリメタデータを含める（返却は必要最小限のサマリ情報のみ）。
- **`user_watches` テーブル**: `user_id`×`data_source_id`で絞り込み、ウォッチ権限が無いレコードを排除。
- **`notifications` テーブル**: ユーザー別未読判定と最新送信日時の取得にLEFT JOINまたはサブクエリを用いる。
- すべて読み取り専用。スキーマ変更は不要。

### アーキテクチャ設計

- `features/activities` を新設し、ドメイン→アプリケーション→プレゼンテーション→インフラの順でレイヤーを構築。
  - **Domain**: `Activity`, `ActivitySummary`, `ActivityFilters` などの型定義と、`ACTIVITY_STATUS` / `ACTIVITY_TYPE` 定数を定義。表示向けプロパティ（`summary`, `detail`, `occurredAt` など）を揃える。
  - **Domain/Repositories**: `ActivityQueryRepository` インターフェースを用意し、ユーザー別・データソース別のクエリ契約およびウォッチ権限検証ロジックを表現。
  - **Application/Use-Cases**:
    - `ListUserActivitiesUseCase`
    - `ListDataSourceActivitiesUseCase`
    - `GetActivityDetailUseCase`
    - すべて `ActivityQueryRepository` を通じてデータ取得とアクセス権チェックを行い、フィーチャー内部に依存を閉じ込める。
  - **Infra/Repositories**: Drizzleによる実装 (`DrizzleActivityQueryRepository`) を作成し、`activities`・`data_sources`・`user_watches` など必要テーブルをJOINして取得。ウォッチ権限チェックも当該実装内で完結させる。
  - **Presentation**:
    - `/api/activities` 系は `presentation/routes/activities/index.ts` に実装。
    - `/api/data-sources/{dataSourceId}/activities` は `presentation/routes/data-source-activities/index.ts` に実装し、`createActivityPresentationRoutes` 内で `/data-sources` サブルートとして登録。
    - すべてのルートで `requireAuth` を使用し、ZodスキーマによるバリデーションとOpenAPI記述を同居させる。
  - **Index**: 依存解決を担い、`createActivityPresentationRoutes` をエクスポート。
- 既存`features/detection/domain/activity.ts` は新ドメインに定数/型を委譲し、重複定義を排除。
- `app.ts` で `/api` 配下に `activitiesRoutes` をマウント。

## 4. 実装ファイル一覧

### 新規作成ファイル

1. `packages/backend/src/features/activities/domain/activity.ts`
2. `packages/backend/src/features/activities/domain/repositories/activity-query.repository.ts`
3. `packages/backend/src/features/activities/domain/index.ts`
4. `packages/backend/src/features/activities/application/use-cases/list-user-activities.use-case.ts`
5. `packages/backend/src/features/activities/application/use-cases/list-data-source-activities.use-case.ts`
6. `packages/backend/src/features/activities/application/use-cases/get-activity-detail.use-case.ts`
7. `packages/backend/src/features/activities/application/use-cases/index.ts`
8. `packages/backend/src/features/activities/infra/repositories/drizzle-activity-query.repository.ts`
9. `packages/backend/src/features/activities/infra/index.ts`
10. `packages/backend/src/features/activities/presentation/routes.ts`
11. `packages/backend/src/features/activities/presentation/routes/activities/index.ts`
12. `packages/backend/src/features/activities/presentation/routes/data-source-activities/index.ts`
13. `packages/backend/src/features/activities/presentation/schemas/activity-list-request.schema.ts`
14. `packages/backend/src/features/activities/presentation/schemas/activity-list-response.schema.ts`
15. `packages/backend/src/features/activities/presentation/schemas/activity-detail-response.schema.ts`
16. `packages/backend/src/features/activities/presentation/schemas/index.ts`
17. `packages/backend/src/features/activities/presentation/routes/activities/__tests__/index.test.ts`
18. `packages/backend/src/features/activities/presentation/routes/data-source-activities/__tests__/index.test.ts`
19. `packages/backend/src/features/activities/index.ts`

### 更新対象ファイル

1. `packages/backend/src/app.ts` – 新ルート登録。
2. `packages/backend/src/features/detection/domain/activity.ts` – 定数定義の委譲。
3. `packages/backend/src/db/factories.ts` – テストデータ生成にアクティビティ関連を追加。

## 5. テスト戦略

### Component Test（Presentation層）

- `GET /api/activities` 正常系（ページネーション・フィルタリング）。
- `GET /api/activities` ウォッチ対象が無い場合は空配列を返す。
- `GET /api/activities/{id}` 正常系（詳細取得、ソース情報を含む）。
- `GET /api/activities/{id}` ウォッチ外/存在しないIDで404を返す。
- `GET /api/data-sources/{dataSourceId}/activities` 正常系と404（ウォッチ外）。
- バリデーションエラー（無効なクエリ型）で400を返す。

### Unit Test（Use-Case層）

- `ListUserActivitiesUseCase` がフィルタ設定・ページネーション計算を正しくリポジトリへ委譲する。
- `GetActivityDetailUseCase` がウォッチ権限を正しく評価し、不許可時は例外を投げる。

### Unit Test（Repository層）

- Drizzle実装の主要クエリを`TransactionManager.transaction`で検証（必要最低限）。
- 通知情報のLeft Join結果が期待通りになるかの確認（スタブデータ使用）。

## 6. 受け入れ基準

### 機能要件

- [ ] 認証ユーザーが`GET /api/activities`で自分のウォッチ対象アクティビティを取得できる。
- [ ] `GET /api/activities/{id}`がウォッチ外アクティビティにアクセスした際に404を返却する。
- [ ] `GET /api/data-sources/{dataSourceId}/activities`が指定データソースの最新アクティビティを返し、ページネーション情報を付与する。

### 非機能要件

- [ ] OpenAPIドキュメントに3エンドポイントが自動反映される。
- [ ] 既存の`pnpm --filter backend test`が全て成功する。
- [ ] クエリ実行がインデックスを活用し、100件規模のページングで実用的なレスポンスを維持する。

### セキュリティ要件

- [ ] すべてのエンドポイントがJWT認証を必須とし、`requireAuth`ミドルウェアを利用している。
- [ ] アクセス権の無いアクティビティ／データソースに対して情報漏洩しないレスポンス（404）を返却する。
- [ ] フィルタリングに渡されたパラメータはZodで型検証され、SQLインジェクションの余地を残さない。

## 7. 実装手順

### Phase 1: ドメイン整備とリポジトリ実装

- 1-1. `features/activities` ドメインとリポジトリインターフェースを定義。
- 1-2. Drizzle実装で`activities`テーブルを参照するクエリビルダーを作成。
- 1-3. 既存`features/detection`からアクティビティ定数を移設し、重複を解消。

### Phase 2: ユースケース実装

- 2-1. リスト/詳細ユースケースを作成し、`ActivityQueryRepository` を介してビジネスルールを実装。
- 2-2. ユースケース単体テストでパラメータ変換とエラーハンドリングを検証。

### Phase 3: プレゼンテーション層 & ルーティング

- 3-1. Zodスキーマ・OpenAPI定義を作成し、Honoルートへ組み込む。
- 3-2. `app.ts` に新ルートをマウントし、Swagger表示を確認。
- 3-3. コンポーネントテストを実装し、正常系・異常系を網羅。

### Phase 4: 最終確認

- 4-1. `pnpm format`, `pnpm lint`, `pnpm --filter backend test` を実行。
- 4-2. ドキュメント更新（必要に応じてAPIリファレンスを追記）。

## 9. リスク・考慮事項

### 技術的リスク

- **クエリ性能**: `activities`テーブルが肥大化した際にJOIN数が多くパフォーマンスが低下する懸念。
- **権限漏れ**: ウォッチ判定のバグにより、他ユーザーのアクティビティが取得できてしまう可能性。
- **データ同期**: 検知ワーカーが書き込むデータのステータス更新タイミングと整合性が取れない場合、APIが中途半端な状態を返す可能性。

### 軽減策

- クエリで既存インデックス（`idx_activities_*`, `idx_user_watches_*`）を利用し、必要に応じてEXPLAINで確認。
- ユースケース層で `ActivityQueryRepository` を通じた権限チェックを共通化し、リポジトリテストで境界条件を検証。
- ステータスが`pending`/`processing`のデータはデフォルトで除外し、必要な場合のみフィルタで取得できるようにする。
