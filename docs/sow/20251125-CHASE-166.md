# CHASE-166 データソース・アクティビティ・notificationのSeeder 作業計画 (2025-11-25)

## チケット概要

- backend 向けにローカル用のシード仕組みを追加し、データソース・ユーザーウォッチ・アクティビティ・通知を自動生成する。
- factory を各 feature 配下に用意し、`packages/backend/scripts/seed-local-db.ts` で TEST_USERS と紐付けたデータを投入する。
- TEST_DATA_SOURCES を約20件用意し、DataSource/Repository 情報と整合したランダム生成データを利用する。
- Plane 記載の列指定（各モデルの生成値、固定値、乱数範囲）を満たすことが必須。

## 目的

- Nuxt フロントエンドが動作確認できる十分なバックエンド初期データ（データソース/活動/通知）を一括投入できるようにする。
- factory ベースのデータ生成で再利用性を高め、ローカル検証を高速化する。

## 詳細仕様（列対応）

- **DataSource factory (`createDataSource`)**
  - id/name/githubId/repositoryId/fullName: TEST_DATA_SOURCES から同一要素を選択して利用。
  - sourceType: 'github' 固定。isPrivate: false 固定。
  - url: name から生成（例: `https://github.com/<fullName>`）。
  - description: faker 的ライブラリで日本語文。
  - createdAt/updatedAt: 現在日時。
  - repository: TEST_DATA_SOURCES の同一要素を展開（owner は fullName の手前部分、language 'TypeScript' 固定、stars/forks/openIssues 0〜1000 乱数、isFork false、createdAt/updatedAt 現在）。
- **UserWatch factory (`createUserWatch`)**
  - id: uuidv7。userId/dataSourceId: 入力をそのまま。
  - notificationEnabled/watchReleases/watchIssues/watchPullRequests: すべて true 固定。
  - createdAt/updatedAt: 現在日時。
- **Activity factory (`createActivity`)**
  - id: uuidv7。dataSourceId: 入力。githubEventId: 100000〜999999 乱数。
  - activityType: ActivityType からランダム選択。
  - title/body: 英語文（件名/本文用の長さ）。translatedTitle/translatedBody/summary: 日本語文。
  - version: `v<major.minor.patch>` 形式をランダム生成。status: 'completed' 固定。statusDetail: null。githubData: 空文字。
  - createdAt/updatedAt: 現在日時。保存は drizzle-activity.repository の upsert を利用。
- **Notification factory (`createNotification`)**
  - notification: NotificationDraft
    - userId: 入力。title/message: 日本語文（件名/要約）。notificationType: 'activity_digest'。scheduledAt: 現在＋0〜60 分。status: 'pending'。statusDetail: undefined。metadata/activityId: 省略。
  - entries: DigestNotificationEntryDraft[]
    - dataSourceId/activityType/activityId: activities 配列から取得。position: 1..n 連番。
    - dataSourceName: dataSourceId をもとに TEST_DATA_SOURCES から取得。
    - title/summary: 日本語文。url: dataSourceName から生成（例: `/repos/<dataSourceName>` or GitHub URL）。generator: 'factory' 固定。
  - 保存は drizzle-digest-notification.repository を利用。

## 実装方針

1. **マスタ作成**: `packages/backend/features/data-sources/domain/factories/data-source-factory.ts` に TEST_DATA_SOURCES（約20件、uuidv7/gihubId/name/repositoryId）を定義し、`features/data-sources/index.ts` で再export。
2. **factory 実装**
   - `createDataSource`: TEST_DATA_SOURCES から整合した値を抽出し、faker 的ライブラリで日本語説明/URL/Repository情報を組み立てる（sourceType github、isPrivate false）。
   - `createUserWatch`: uuidv7 発行、watch フラグ true 固定。
   - `createActivity`: githubEventId 乱数、ActivityType から選択、英語タイトル/本文・日本語訳/サマリを faker 生成、status completed。
   - `createNotification`: DigestNotificationDraft/entries を生成。TEST_DATA_SOURCES から dataSource 名を引き、activities の情報を反映。scheduledAt は現在＋0–60分。
3. **保存ロジック**: 既存リポジトリ層の保存/アップサートを利用（data-source.repository.ts、drizzle-user-watch.repository.ts、drizzle-activity.repository.ts、drizzle-digest-notification.repository.ts）。
4. **シードスクリプト**: `packages/backend/scripts/seed-local-db.ts` を作成。
   - TEST_DATA_SOURCES 全件の DataSource を投入。
   - TEST_USERS（`packages/shared/src/constants/test-users.ts`）× 全 DataSource で UserWatch を作成。
   - 各 DataSource に 5–10 件の Activity を作成し保存。
   - ユーザーごとに Activity を5件チャンクし、Notification を作成・保存。
5. **依存・ユーティリティ確認**: faker/uuidv7 の既存利用状況を確認し、未導入なら backend パッケージに追加。ランダム生成範囲（githubId 100000–999999、stars/forks/issues 0–1000）を遵守。
6. **テスト/検証**: シード実行 (`npx tsx scripts/seed-local-db.ts`) 後に主要テーブル件数とサンプル出力を確認。このスクリプトに対するテストは作成しない

## 成果物

- factory 追加: `packages/backend/features/data-sources/domain/factories/data-source-factory.ts`（TEST_DATA_SOURCES 含む）、activity/notification 各 factory。
- 再export: `packages/backend/features/data-sources/index.ts`。
- シード: `packages/backend/scripts/seed-local-db.ts`。

## 確認事項/リスク

- faker ライブラリの種類（@faker-js/faker 等）と既存利用ポリシーを合わせる。
- DB 初期化や既存データとの重複扱い（upsert 対象テーブルのキー要件）を確認。
- ActivityType/NotificationMetadata など enum/型の実在と import パスを確認。
