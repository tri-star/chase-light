# SOW: CHASE-158: アクティビティ詳細画面

## プロジェクト概要

**課題ID**: CHASE-158  
**作成日**: 2025-11-26  
**種別**: 機能追加

## 1. 背景と目的

### 背景

- フロントエンドにはアクティビティ一覧ページ（`/activities`）があるが、個別詳細を表示する画面が未実装。
- バックエンドにはアクティビティ詳細API（`GET /api/activities/{activityId}`）が用意されており、翻訳済みタイトル・本文と原文を取得できる。
- ユーザーが興味のある更新内容を深く確認できる導線と、将来の共有/保存/いいね機能に備えたUI要素が必要。

### 目的

- `/activities/[id]` でアクティビティの詳細を閲覧できるページを提供し、翻訳結果と原文を切り替えられるUXを用意する。
- 共有/保存/いいね用のアイコンボタンUIを提供し、後続の機能実装に備える。

## 2. 実装スコープ

### 実装対象

- フロントBFF: `GET /api/activities/:activityId` を追加し、Backendの `GET /api/activities/{activityId}` を呼び出してスキーマ検証・エラーハンドリングを行う。
- Nuxtページ: 動的ルート `pages/activities/[id].vue` とページ本体コンポーネントを追加し、`<ClSection>` 内で詳細情報を表示する。
- UIコンポーネント: 共有/保存/いいねに使う新規ベースコンポーネント（アイコンボタン）を作成し、ページ内に配置する。
- 翻訳表示の切替: タイトル/本文を「翻訳結果」と「原文」でトグルできるUIを設ける（デフォルトは翻訳表示、未翻訳は原文にフォールバック）。

### 更新可能な項目

1. `packages/frontend/server/api/activities/[id].get.ts`（新規）: Backend呼び出し＋Zod検証＋エラーハンドリング。
2. `packages/frontend/pages/activities/[id].vue`（新規）: ルートエントリとSSR取得。
3. `packages/frontend/components/pages/activity-detail/*`（新規）: ページ本体、パーツ（ヘッダー/本文など）、必要なスタイル構成。
4. `packages/frontend/components/base/ClIconButton.vue`（新規）＋テスト/Story: アイコン付きボタンの共通UI。
5. ページ用テスト（`components/pages/activity-detail/__tests__` など）とMSWモック設定の追加利用。

### 実装除外項目

- Backend API・DBの変更は行わない。
- 共有/保存/いいねの実際のAPI呼び出しや状態管理は実装しない（UIのみ設置）。
- 認証・セッション周りの新規実装は行わない（既存の仕組みを利用）。
- 新たな翻訳生成やバックグラウンドジョブの実装は行わない。

## 3. 技術仕様

### API仕様

#### エンドポイント（BFF）

```
GET /api/activities/:activityId
```

- Backendの `GET /api/activities/{activityId}` に委譲。
- パスパラメータは `getApiActivitiesActivityIdParams`（Zod）でUUIDを検証。
- レスポンスは `getApiActivitiesActivityIdResponse`（Zod）で検証し、200以外は `createError` でステータスを返す。
- 認証: 既存のBearer/セッション連携をそのまま使用（Backend側が認証必須）。

#### レスポンス仕様（Backend準拠・抜粋）

```typescript
{
  success: true,
  data: {
    activity: {
      id: string; // uuid
      source: { id: string; name: string; url: string; sourceType: string; metadata?: { repositoryFullName?: string; repositoryLanguage?: string | null; starsCount?: number; forksCount?: number; openIssuesCount?: number; } };
      activityType: 'release' | 'issue' | 'pull_request';
      title: string;
      translatedTitle: string | null;
      detail: string; // 原文本文
      translatedBody: string | null;
      summary: string | null;
      status: 'pending' | 'processing' | 'completed' | 'failed';
      statusDetail: string | null;
      version: string | null;
      occurredAt: string; // ISO datetime
      lastUpdatedAt: string; // ISO datetime
    }
  }
}
```

### データベース操作

- なし（フロントBFFおよびページ側のみ）。

### アーキテクチャ設計

- ルーティング: `pages/activities/[id].vue` で `useAsyncData` を用いSSRファーストで `/api/activities/:id` を取得。404/401/500は `createError` を利用。
- ページ構成: `<ClSection>` 内に以下を表示
  - ヘッダー: データソース名・リンク、発生日時/最終更新日時（`formatDate`/`formatRelativeDate` 利用想定）、アクティビティ種別バッジ。
  - 翻訳トグル: 右上に「原文を表示 / 翻訳結果を表示」ボタン。翻訳が存在しない場合は無効化または非表示。
  - タイトル: 翻訳済みを優先し、原文/翻訳の切替を反映。
  - アクション群: 共有/保存/いいねのアイコンボタン（新規 `ClIconButton`）。今は動作なしだがアクセシビリティラベルを付与。
  - 本文: 翻訳済み本文を優先し、なければ原文。`whitespace-pre-wrap` などで整形して表示（Markdown解析はせず、テキストとして表示）。
- コンポーネント: ページ本体 + parts（ヘッダー/コンテンツ）の分割を想定。`ClIconButton` はTailwindトークン準拠でサイズ・バリアント（例: ghost/solid）を持たせる。

## 4. 実装ファイル一覧

### 新規作成ファイル

1. `packages/frontend/server/api/activities/[id].get.ts` — BFFエンドポイント実装。
2. `packages/frontend/pages/activities/[id].vue` — 動的ルートエントリ。
3. `packages/frontend/components/pages/activities/detail/ActivityDetailPage.vue` — 詳細ページ本体。
4. `packages/frontend/components/pages/activities/detail/parts/ActivityDetailHeader.vue` — データソース情報・日時・トグル。
5. `packages/frontend/components/pages/activities/detail/parts/ActivityDetailContent.vue` — タイトル/本文/アクション群の表示。
6. `packages/frontend/components/base/ClIconButton.vue` — アイコン専用ボタンのベースコンポーネント。
7. `packages/frontend/components/base/ClIconButton.stories.ts` — Storybook用。
8. `packages/frontend/components/base/__tests__/ClIconButton.test.ts` — 単体テスト。
9. `packages/frontend/components/pages/activities/detail/__tests__/activity-detail.test.ts` — ページのFeatureテスト（MSWモック利用）。
10. `packages/frontend/tests/activities-detail.e2e.ts` — E2Eスモークテスト（正常系表示確認）。

### 更新対象ファイル

1. 必要に応じて `packages/frontend/components/base/index` 系のエクスポートやStorybook設定の追記。
2. 既存ユーティリティ（例: 日付フォーマット）を流用し、追加の補助関数が必要な場合は `packages/frontend/utils/` 配下に追加。

## 5. テスト戦略

- Component Test: `ClIconButton` のARIAラベル、disabled時の挙動、クリックイベント発火、バリアント/サイズクラスの付与を検証。
- Feature Test (ページ): MSWの `getGetApiActivitiesActivityIdMockHandler` を用い、以下を検証
  - 詳細情報（データソース名・最終更新・タイトル・本文）が表示されること
  - 「原文を表示/翻訳結果を表示」トグルでタイトル/本文が切り替わること
  - 翻訳が存在しない場合に原文表示となり、トグルが無効/非表示になること
  - アクションアイコンボタンが所定の位置に3つ表示されること
- E2E Test (スモーク): `/activities/{id}` への遷移で正常表示されることをPlaywrightで確認（`packages/frontend/tests` 配下）。
- APIルートのテストは方針に従い省略（型+Zod検証で担保）。既存スイートへの影響を確認するため `pnpm --filter frontend test` を想定。

## 6. 受け入れ基準

- [ ] `/activities/{id}` にアクセスすると `<ClSection>` 内にデータソース名と最終更新日時が表示される。
- [ ] アクティビティのタイトル・本文が翻訳結果で表示され、トグル操作で原文/翻訳が切り替わる（翻訳がない場合は原文のみ表示し、トグルが無効/非表示）。
- [ ] タイトルと本文の間に共有/保存/いいねのアイコンボタンが3つ表示され、アクセシビリティラベルを持つ（動作は未実装のまま）。
- [ ] Backendが404/401/500を返した場合、Nuxtのエラーハンドリングを介して適切なエラーページ/メッセージに遷移する。
- [ ] 既存のテストが通り、新規追加テストもグリーンである。

## 7. 実装手順

### Phase 1: BFF実装

- 1-1. `server/api/activities/[id].get.ts` を追加し、パスパラメータ/レスポンスをZodで検証。
- 1-2. Backendレスポンスのステータス別に `createError` でハンドリング。
- 1-3. format/lintの確認。

### Phase 2: ベースUI実装

- 2-1. `ClIconButton` を実装（バリアント・サイズ・ARIA対応）。
- 2-2. Storybookと単体テストを追加。
- 2-3. format/lint/テスト実行。

### Phase 3: ページ実装

- 3-1. `pages/activities/[id].vue` と `components/pages/activities/detail/*` を作成し、SSR取得と表示/トグル/UI配置を実装。
- 3-2. Featureテストを作成（MSWモックで正常系・未翻訳・エラー系を確認）。
- 3-3. E2Eスモークテストを `packages/frontend/tests` 配下に追加。
- 3-4. format/lint/テスト実行。

## 9. リスク・考慮事項

- **翻訳フィールドがnull**: トグルを無効化し原文表示にフォールバックする。UIで状態を示す。
- **本文の体裁**: `detail` がMarkdown記法を含む可能性があるが、今回はテキスト表示とし、`whitespace-pre-wrap` で折り返す。必要に応じて後続でMarkdownレンダラ導入を検討。
- **エラーハンドリング**: Backendの404/401/500をBFFが透過させるため、ページ側で`createError`を用いてNuxtエラーページへ委譲する。
- **アクセシビリティ**: アイコンボタンは必須の `aria-label` を要求し、キーボード操作でフォーカス可能にする。
