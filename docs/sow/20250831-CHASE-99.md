# SOW: CHASE-99: ダッシュボードページの仮実装（UI再実装）

## プロジェクト概要

**課題ID**: CHASE-99  
**作成日**: 2025-08-31  
**種別**: 実装改善 / 機能追加（フロントエンドUI）

## 1. 背景と目的

### 背景
- プロジェクトの中核ページである「ダッシュボード」が暫定実装のまま運用されており、デザイントークンやガイドライン（ページ・コンポーネント・フォルダ構成）に準拠していない部分がある。
- ユーザーが最初に触れる体験として、ヘッダー、ナビゲーション（サイドメニュー）、主要コンテンツ（ウォッチ中リポジトリ一覧）が統一されたUI/UXで提供される必要がある。

### 目的
- デザイントークンに準拠したヘッダー／サイドメニューを備えた2カラムレイアウトを導入し、レスポンシブに対応したダッシュボードの土台を構築する。
- BFF経由のデータ取得（/api/data-sources）により、ウォッチ中のリポジトリ一覧を表示できる状態にする。
- ヘッダー右端のユーザーアイコンからドロップダウンメニュー（ログアウト）を提供し、基本的なアクションを統一UIで利用可能にする。

## 2. 実装スコープ

### 実装対象
- ダッシュボードのレイアウトと基盤コンポーネントの新規作成・導入。
- ウォッチ中リポジトリ一覧の取得・表示（BFF→Backend API）。
- ヘッダー右端のユーザーメニュー（ドロップダウン）とログアウト導線。
- サイドメニューのハンバーガー開閉とレスポンシブ対応。

### 更新可能な項目
1. 既存 `pages/dashboard.vue` の責務縮小（ページ薄型化）と新規ページ本体コンポーネントのマウント。
2. 新規 base コンポーネント（ヘッダー、アバターメニュー、ハンバーガー、サイドバー、レイアウトラッパー）の追加。
3. `components/pages/dashboard/*` のページ専用コンポーネント追加（Sidebar / RepositoryList など）。
4. BFF 既存実装（`server/api/data-sources/index.get.ts`）の利用（必要に応じ軽微な補助 util 追加）。

### 実装除外項目
- Backend API の新規エンドポイント追加・DB スキーマ変更（今回は不要）。
- 高度なフィルタリング/ソート UI、無限スクロール等の拡張機能。
- 通知・リアルタイム更新（本タスクでは非対応）。

## 3. 技術仕様

### API仕様（BFF 経由）

#### エンドポイント（利用）
- GET `/api/auth/session`（既存）
  - 目的: ユーザー情報の取得（ヘッダー表示・メニュー内表示）。
- GET `/api/data-sources`（既存）
  - 目的: ウォッチ中リポジトリ一覧の取得。クエリ: `page`, `perPage` ほか任意のフィルタ。

備考:
- BFF から Backend API 呼び出しは Orval 生成クライアント（`generated/api/backend`）およびカスタム mutator（`libs/orval/custom-fetch.ts`）により、サーバセッションからの Bearer 付与を透過的に行う。
- 境界を跨ぐレスポンスは Zod（`generated/api/zod/*`）で検証する。

#### 認証・認可
- ダッシュボードは `definePageMeta({ middleware: 'auth' })` を適用済み。未ログイン時はログインページへ誘導。
- BFF 側はセッションからトークン付与（既存）で Backend API を呼び出す。

### データベース操作
- なし（本タスクでは DB 変更は不要）。

### アーキテクチャ設計（フロントエンド）
- ページ薄型化方針に基づき、主要 UI/ロジックは `components/pages/dashboard/*` に集約。
- 再利用を見込む UI は `components/base/Cl*.vue` として配置。
- データ取得は SSR ファーストで `useAsyncData` を利用し、BFF 経由で取得。子コンポーネントでの重複取得は避け、`props` で配布。

構成要素:
- `ClHeader`（base）: 固定ヘッダー、左にブランド/トグル、右に `ClAvatarMenu`。
- `ClAvatarMenu`（base）: アイコンをクリックでドロップダウン（プロフィール/ログアウトなど）。
- `ClHamburgerButton`（base）: サイドバー開閉トグル。
- `ClSidebar`（base）: メニュー群。モバイル時はオーバーレイ表示、フォーカストラップと `aria-*` 属性でアクセシビリティ配慮。
- `ClLayoutDashboard`（base/layout）: 上部固定ヘッダー＋左サイドバー＋メインの 2 カラムレイアウト。
- `DashboardPage`（page 本体）: 初期データ取得と状態管理、配下パーツを組み立て。
- `DashboardSidebar` / `RepositoryList`（page/parts）: ページ専用 UI。

スタイル:
- Tailwind + デザイントークン（`docs/design/tailwind-utilities.json` の semantic 系クラス）を用い、既存 `dashboard.vue` のトークン利用を踏襲。

## 4. 実装ファイル一覧

### 新規作成ファイル（予定）
1. `packages/frontend/components/base/ClHeader.vue`
2. `packages/frontend/components/base/ClAvatarMenu.vue`
3. `packages/frontend/components/base/ClHamburgerButton.vue`
4. `packages/frontend/components/base/ClSidebar.vue`
5. `packages/frontend/components/base/ClLayoutDashboard.vue`
6. `packages/frontend/components/pages/dashboard/DashboardPage.vue`
7. `packages/frontend/components/pages/dashboard/parts/DashboardSidebar.vue`
8. `packages/frontend/components/pages/dashboard/parts/RepositoryList.vue`
9. （必要なら）`packages/frontend/components/pages/dashboard/use-dashboard-page.ts`

### 更新対象ファイル（予定）
1. `packages/frontend/pages/dashboard.vue`
   - ページ本体を薄型化し、`DashboardPage` をマウント。SSR の `useAsyncData` で BFF から初期データを注入。
2. 既存 BFF 呼び出しの再利用（`server/api/data-sources/index.get.ts`）
   - 必要に応じて軽微なエラーハンドリング強化のみ（原則変更なし）。

## 5. テスト戦略

### Page（統合）テスト（推奨: Playwright + Vitest 組み合わせ）
- ヘッダー表示とユーザー名/アバターの表示確認。
- アバターメニュー開閉と「ログアウト」押下で適切なリクエストが発行されること。
- サイドメニューのハンバーガー開閉（デスクトップ/モバイル）とフォーカス管理の確認。
- `/api/data-sources` のモック応答に基づく一覧表示、空状態の表示、エラー時の表示。
- SSR 初期描画後に CSR へハイドレートしても重複呼び出しが発生しないこと（`useAsyncData` のキー設計）。

### Unit テスト
- Base コンポーネントの単体動作（`ClHamburgerButton` のトグル、`ClAvatarMenu` の開閉）。
- ページ用 composable（`use-dashboard-page`）があれば、そのロジック単体テスト。

（注）API ルートのテストはガイドラインに従い省略し、ページテストで BFF 連携を検証。

## 6. 受け入れ基準

### 機能要件
- [ ] 固定ヘッダーにユーザーアイコンが表示され、クリックでドロップダウン（ログアウト）を開閉できる。
- [ ] ヘッダー直下はサイドメニューありの 2 カラム。ハンバーガーで開閉可能。
- [ ] モバイルではサイドメニューがデフォルト非表示で、ハンバーガー操作で全画面オーバーレイ表示に切替できる。
- [ ] ウォッチ中リポジトリ一覧が `/api/data-sources` から取得され、件数・主要属性が表示される。

### 非機能要件
- [ ] デザイントークン（semantic 系）を用いた配色・余白で統一感がある。
- [ ] ページ本体は薄く、UI は `components/pages/*`、再利用 UI は `components/base/*` に分離されている。
- [ ] SSR ファーストで `useAsyncData` を用い、CSR で重複呼び出しが発生しない。

### セキュリティ/アクセシビリティ
- [ ] 認証ミドルウェア適用済みで未ログイン時は保護される。
- [ ] ドロップダウンとモバイルサイドメニューは `aria-*` 属性とキーボード操作（Esc で閉じる等）に配慮する。

## 7. 実装手順（フェーズ）

### Phase 1: レイアウト基盤
- 1-1. `ClHeader`/`ClAvatarMenu`/`ClHamburgerButton`/`ClSidebar` を作成。
- 1-2. `ClLayoutDashboard` で 2 カラムレイアウトとレスポンシブ挙動を実装。

### Phase 2: ダッシュボード本体
- 2-1. `DashboardPage` と `DashboardSidebar`/`RepositoryList` を作成。
- 2-2. `useAsyncData` で `/api/data-sources` から初期データ取得（Zod 検証）。
- 2-3. `pages/dashboard.vue` を薄型化し、`DashboardPage` をマウント。

### Phase 3: テスト/微調整
- 3-1. Playwright で主要動作（開閉・ログアウト・一覧表示）検証。
- 3-2. 主要コンポーネントの unit テストを追加（必要最低限）。
- 3-3. デザイントークン準拠のスタイル調整とアクセシビリティ改善。

## 9. リスク・考慮事項

### 技術的リスク
- レスポンシブ時のメニュー開閉に伴うフォーカス/スクロール管理の複雑化。
- SSR/CSR 混在時のデータ取得の二重呼び出し、hydrate ミスマッチ。
- ドロップダウン/オーバーレイのアクセシビリティ対応漏れ。

### 軽減策
- `useAsyncData` の安定キー設計と、ページ側での取得一元化（子では再フェッチしない）。
- フォーカス管理と `aria-*` 属性の導入、Esc クローズの徹底。
- E2E テストで主要シナリオ（PC/モバイル）をカバー。

---

参考資料:
- プロジェクト概要: `docs/project-overview.md`
- API 仕様: `packages/backend/openapi.json`、BFF 実装: `packages/frontend/server/api/*`
- ガイドライン: 
  - API: `packages/frontend/docs/guidelines/api-implementation-guide.md`
  - フォルダ構成: `packages/frontend/docs/guidelines/folder-structure.md`
  - 命名規則: `packages/frontend/docs/guidelines/file-naming-conventions.md`
  - ページ/コンポーネント実装: `packages/frontend/docs/guidelines/page-implementation-guide.md`, `component-implementation-guide.md`
  - デザイントークン: `packages/frontend/docs/design/tailwind-utilities.json`
