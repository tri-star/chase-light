# SOW: CHASE-174: アクティビティ本文翻訳リクエストAPI

## プロジェクト概要

**課題ID**: CHASE-174  
**作成日**: 2025-12-08  
**種別**: 機能追加

## 1. 背景と目的

### 背景

- 現行の検知パイプラインではタイトル/要約のみを翻訳し、`activities.translated_body` は基本的に `null` のままになっている。詳細本文の翻訳はトークンコスト・レイテンシが大きく、同期処理には向かない。
- ユーザーが閲覧時に本文の日本語化を要求できるようにし、処理は SQS 経由で非同期化する必要がある。
- 翻訳が進行中か完了済みかを判別する手段がなく、再実行や結果取得の UX が不透明。

### 目的

- アクティビティ本文の翻訳をリクエストする API を追加し、SQS 経由で翻訳ワーカーを起動して `activities.translated_body` に保存する。
- 翻訳ジョブの状態を管理し、クライアントが進行状況や結果を取得できるステータス API を提供する。
- AWS / ローカル（ElasticMQ + SAM Local）を切り替えられるポート/アダプタ構成で実装し、Presentation 層テストではキュー発行をモックできるようにする。

## 2. 実装スコープ

### 実装対象

- Backend `packages/backend` の Activities コンテキスト
- 新規 API 2 本（翻訳リクエスト、翻訳ステータス取得）
- Activities テーブルで翻訳ステータスを管理（ジョブ履歴テーブルなし）
- SQS パブリッシャーと翻訳ワーカー（SQS コンシューマー）

### 更新可能な項目

1. DB スキーマ拡張（activities に翻訳ステータス用カラムを追加）
2. Activities ドメイン: 翻訳ステータスの定義（shared で定数共有）
3. Application: 翻訳リクエスト・ステータス取得ユースケース、ワーカー用ユースケース
4. Infra: Drizzle リポジトリ、SQS パブリッシャーアダプタ、翻訳実行アダプタ（OpenAI/スタブ）
5. Presentation: `/activities` 配下の新規ルート・スキーマ
6. ワーカー: `translate-activity-body` Lambda/SQS ハンドラー + テスト

### 実装除外項目

- フロントエンド実装や API クライアント生成
- インフラのキュー作成・SAM/Terraform 定義（既存のパラメータを参照する前提）
- 翻訳モデルの選定変更や多言語対応（今回は `ja` 固定）

## 3. 技術仕様

### API仕様

#### エンドポイント

1. `POST /activities/{activityId}/translations/body`
   - 役割: アクティビティ本文の翻訳を非同期でリクエストし、ジョブをキューに投入する。
   - 認証・認可: JWT 必須。対象アクティビティのデータソースをウォッチしていない場合は 404（存在/権限を伏せる）。
   - リクエストボディ:
     ```typescript
     {
       force?: boolean       // true の場合、終端ステータスでも再翻訳を許可。省略時は完了済みなら再キューしない。
       targetLanguage?: "ja" // 将来拡張用。省略時は "ja" 固定。
     }
     ```
   - 振る舞い:
     - `translated_body` が既に存在し、`force !== true` かつ進行中ジョブなし: 200 で `translationStatus: "completed"` を返却（キュー投入なし、本文返却はしない）。
     - 進行中ジョブがある場合: 新規投入せず現在のジョブを返却（ステータスは 202、`status: queued|processing`）。
     - 再実行条件を満たす場合: 翻訳ジョブを新規作成し、SQS にエンキュー。レスポンスは 202 でジョブ ID と `translationStatus: "queued"`。
   - レスポンス例（成功時）:
     ```typescript
     {
       success: true,
       data: {
         jobId: string,
         translationStatus: "queued" | "processing" | "completed" | "failed",
         statusDetail?: string | null,
         requestedAt: string,
         startedAt?: string | null,
         completedAt?: string | null
       }
     }
     ```
   - エラーレスポンス: 400（UUID/入力不正）、404（未ウォッチ/存在しない）、409（再実行禁止の状態で force=false かつ非終端ジョブあり）を想定。

2. `GET /activities/{activityId}/translations/body`
   - 役割: 最新の翻訳ジョブ状態のみを取得（本文は返さない）。
   - 認証・認可: 上記と同じ（未ウォッチは 404）。
   - レスポンス: `translationStatus`, 時刻系フィールド、`jobId`。ジョブ履歴は最新のみを返却。

### データベース操作

- **既存テーブル `activities` に翻訳ステータス用カラムを追加**
  - `body_translation_status`: TEXT NOT NULL（`queued | processing | completed | failed` のいずれか。shared 定数で管理）
  - `body_translation_status_detail`: TEXT NULL
  - `body_translation_requested_at`: timestamptz NOT NULL default now
  - `body_translation_started_at`: timestamptz NULL
  - `body_translation_completed_at`: timestamptz NULL
  - `body_translation_message_id`: TEXT NULL（SQS MessageId を任意で保持）
  - 既存の `translated_body` を翻訳結果保存先として利用（完了時のみ更新）。
  - インデックス: `(body_translation_status)`, `(body_translation_requested_at DESC)`（進行中検索と最新取得を高速化）。

### アーキテクチャ設計

- **Domain 層**
  - 新規: `activity-translation.ts`（翻訳ステータス定数・DTO）。定数は `packages/shared` に配置し backend/frontend 共有。
  - インターフェース: `ActivityTranslationStateRepository`（activities テーブルの翻訳ステータス/本文更新をまとめたポート）を定義。

- **Application 層**
  - `RequestActivityTranslationUseCase`: アクセス権チェック → activities の翻訳ステータス確認 → 非終端なら再投入せず 202 で現状返却 → force など条件に応じてステータスを `queued` に更新しキュー発行。
  - `GetActivityTranslationStatusUseCase`: アクセス権チェック → activities の翻訳ステータスのみを返却（`queued/processing/completed/failed` とタイムスタンプ、messageId 任意）。本文は返さない。
  - `ProcessActivityTranslationJobUseCase`（ワーカー用）: activities の翻訳ステータスを `processing → completed/failed` に遷移させつつ `translated_body` を更新。

- **Ports / Adapters**
  - `TranslationJobQueuePort`: `enqueue(jobPayload)`（戻り値: `messageId`）。SQS/ElasticMQ 切替は環境変数 (`TRANSLATION_QUEUE_URL`, `AWS_REGION`, `USE_AWS`) で決定。SQSではハンドラーで delete する。
  - `BodyTranslationPort`: 本文翻訳専用ポート。OpenAI 実装は activities フィーチャー側で新規作成（既存のタイトル/要約用とは分離）。スタブ/Null アダプタも用意。
  - リポジトリアダプタ: Drizzle による `ActivityTranslationStateRepository` 実装（activities テーブルの翻訳カラム更新）。

- **Presentation 層**
  - `/activities` 配下に翻訳ルートを追加。Zod スキーマと OpenAPI 定義を同ファイルで管理。
  - JWT ミドルウェア適用。404 による情報秘匿を既存の Activities API と整合させる。
  - テストでは `TranslationJobQueuePort` をスタブ化し、キュー発行の呼び出しをアサート。

- **Worker**
  - 新規ハンドラー例: `features/activities/workers/translate-activity-body/handler.ts`。SQS イベントの `jobId` を受け取り、UseCase を実行。
  - DB 接続/トランザクションは `TransactionManager` を使用。非終端ジョブのみ処理し、冪等性を確保。
  - 例外時はジョブを `failed` に更新し、エラー内容を `status_detail` に記録。

### データフロー（概要）

1. クライアントが `POST /activities/{id}/translations/body` を呼び出し。
2. UseCase がアクセス権と翻訳ステータスを確認し、必要に応じて activities の翻訳ステータスを `queued` に更新。SQS に `{ activityId, targetLanguage }` を送信。
3. SQS → 翻訳ワーカー起動。翻訳ステータスを `processing` にし、本文を翻訳（OpenAI）。成功時に `activities.translated_body` と翻訳ステータスを更新し `completed` にする。
4. クライアントは `GET /activities/{id}/translations/body` で `translationStatus` のみを取得。進行中なら `queued/processing` を返す。

### テスト方針

- **Presentation コンポーネントテスト**
  - 正常系: ウォッチ済みユーザーが POST でジョブを作成し、キュー発行スタブが 1 回呼ばれる。
  - 完了済み本文あり: `force` なしで POST すると既存結果を返し、キュー未発行。
  - 進行中ジョブあり: 既存ジョブを返し、重複投入しないこと。
  - 認可: 未ウォッチ/他ユーザーは 404。パラメータ不正で 400。
  - GET: ステータスごとのレスポンス（queued/processing/completed/failed）を検証。

- **Worker テスト**
  - ワーカーがジョブを `processing → completed` に更新し、`translated_body` を保存する。
  - 翻訳エラー時に `failed` + `status_detail` を残し、本文を更新しない。
  - ジョブが存在しない/終端の場合は安全に no-op。

## 4. 実装ファイル一覧

### 新規作成ファイル（想定）

1. `packages/shared/src/constants/activity-translation.ts`
   - 翻訳ステータス定数を定義し、backend/frontend 共有。
2. `packages/backend/src/features/activities/domain/activity-translation.ts`
   - 翻訳ステータス/DTO（shared 定数を参照）。
3. `packages/backend/src/features/activities/domain/repositories/activity-translation-state.repository.ts`
   - activities テーブルの翻訳カラム更新用ポート。
4. `packages/backend/src/features/activities/application/ports/translation-job-queue.port.ts`
   - SQS 送信用ポート。
5. `packages/backend/src/features/activities/application/ports/body-translation.port.ts`
   - 本文翻訳ポート（OpenAI/スタブ）。
6. `packages/backend/src/features/activities/application/use-cases/request-activity-translation.use-case.ts`
7. `packages/backend/src/features/activities/application/use-cases/get-activity-translation-status.use-case.ts`
8. `packages/backend/src/features/activities/application/use-cases/process-activity-translation-job.use-case.ts`
9. `packages/backend/src/features/activities/infra/repositories/drizzle-activity-translation-state.repository.ts`
10. `packages/backend/src/features/activities/infra/adapters/translation-job/sqs-translation-job.adapter.ts`
11. `packages/backend/src/features/activities/infra/adapters/translation/body-translation.adapter.ts`（OpenAI 実装）  
    `packages/backend/src/features/activities/infra/adapters/translation/body-translation-stub.adapter.ts`
12. `packages/backend/src/features/activities/presentation/routes/activity-translation/index.ts`（ルート + スキーマ）
13. `packages/backend/src/features/activities/workers/translate-activity-body/handler.ts`  
    `packages/backend/src/features/activities/workers/translate-activity-body/__tests__/handler.test.ts`
14. `packages/backend/src/core/config/sqs.ts`（キュー URL/リージョン取得）※共通化できる場合。

### 更新対象ファイル（想定）

1. `packages/backend/src/db/schema.ts`（activities に翻訳ステータス用カラム追加）
2. `packages/backend/src/features/activities/presentation/routes.ts`（新ルートマウント）
3. `packages/backend/src/features/activities/index.ts`（DI 配線）
4. `packages/backend/src/features/activities/application/use-cases/index.ts`（エクスポート追加）
5. `packages/backend/src/test/factories.ts`（翻訳ジョブ作成ヘルパー追加）
6. `packages/backend/src/features/activities/presentation/routes/activities/__tests__/index.test.ts` ほかテスト追加

## 5. テスト戦略

- Presentation コンポーネントテストで API の入出力とキュー発行有無を確認。
- Worker/UseCase テストで DB 更新とステータス遷移の正当性を確認。
- 既存回帰: `pnpm --filter backend test` を通し、Activities/Detection/Notification への影響を確認。

## 6. 受け入れ基準

### 機能要件

- [ ] POST API がウォッチ済みユーザーからのリクエストでジョブを作成し、SQS（スタブ）へ 1 回キュー投入する。
- [ ] 翻訳完了後、`activities.translated_body` に本文が保存される。
- [ ] GET API で `queued/processing/completed/failed` の各状態を取得できる。
- [ ] 未ウォッチまたは存在しないアクティビティへのアクセスは 404 となる。

### 非機能要件

- [ ] 既存テストがすべて通過する。
- [ ] 新規 Component/Worker テストが追加され、主要分岐を網羅する。

### セキュリティ要件

- [ ] JWT 認証とウォッチ権限チェックで情報漏洩を防止する（404 運用）。
- [ ] キュー投入時に活動 ID 以外の不要情報を含めない（PII 無し）。

## 7. 実装手順

### Phase 1: スキーマ・ドメイン整備

- 1-1. activities に翻訳ステータス関連カラムを追加し、Drizzle スキーマ/マイグレーションを更新。
- 1-2. ドメイン/リポジトリインターフェース/ステータス定数を追加（shared 定数作成含む）。

### Phase 2: ユースケース・インフラ

- 2-1. 翻訳リクエスト/ステータス取得/ワーカー用ユースケースを実装。
- 2-2. SQS パブリッシャー、本文翻訳アダプタ（OpenAI/スタブ）、リポジトリ実装を追加。
- 2-3. DI 配線と index/export を更新。

### Phase 3: Presentation・Worker・テスト

- 3-1. `/activities/{id}/translations/body` ルートを追加し、OpenAPI/バリデーションを実装。
- 3-2. 翻訳ワーカーのハンドラーとテストを追加。
- 3-3. Component テスト/UseCase テストを追加し、`pnpm --filter backend test` を実行。

## 9. リスク・考慮事項

### 技術的リスク

- **重複投入**: クライアントの多重リクエストで同一ジョブが乱立する可能性。アプリ層で非終端ジョブを検知し、再投入を抑止する。
- **翻訳失敗/遅延**: OpenAI 失敗やタイムアウト時の再試行方針が未定。現状は失敗ステータスで返し、手動再実行（force）を想定。
- **SQS 接続設定漏れ**: 環境変数不足で送信に失敗するリスク。`TRANSLATION_QUEUE_URL`/`AWS_REGION`/`USE_AWS` の存在チェックとエラー整形を行う。

### 軽減策

- 非終端ジョブの存在チェックをユースケース内に実装し、必要なら 409/202 で応答。
- 翻訳ポートにエラー分類を持たせ、`status_detail` に原因を記録。必要に応じてリトライ回数をジョブに保持できる設計にする。
- 環境変数バリデーションを起動時に実施し、ローカル/本番でのキュー URL の違いを `core/config/sqs.ts` に集約する。
