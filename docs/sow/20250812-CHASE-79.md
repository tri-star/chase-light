# SOW: CHASE-79: RepositoryRepositoryの見直し

## プロジェクト概要

**課題ID**: CHASE-79  
**作成日**: 2025-08-12  
**種別**: リファクタリング

## 1. 背景と目的

### 背景

現在の実装では、RepositoryはDBテーブルとしては独立しているが、ドメイン設計上はDataSourceの集約の一部として扱うべき構造になっています。しかし、以下の問題があります：

- DataSource型とRepository型が分離されており、関連性が不明確
- DataSourceRepositoryとRepositoryRepositoryが独立して存在し、操作が分散している
- Domain上の型でDiscriminated Unionになっておらず、型安全性に欠ける

### 目的

- DataSourceをDiscriminated Unionにし、sourceType='github'の場合のみRepositoryを持つ設計に変更
- RepositoryRepositoryを廃止し、DataSourceRepositoryを通したRepository操作に統一
- Domain層からPresentation層まで一貫したデータ構造に修正

## 2. 実装スコープ

### 実装対象

- DataSource型のDiscriminated Union化
- DataSourceRepository.saveメソッドでのRepository同時操作対応
- DataSourceListItem型の構造変更
- 関連するService層、Presentation層の修正

### 更新可能な項目

1. Domain層の型定義（DataSource, DataSourceListItem等）
2. DataSourceRepositoryのRepository操作統合
3. Service層のRepository依存関係削除
4. Presentation層のレスポンス構造修正

### 実装除外項目

- データベーススキーマの変更（既存のテーブル構造は維持）
- 新しいAPI仕様の追加（既存API仕様の内部実装変更のみ）

## 3. 技術仕様

### Domain層設計

#### DataSource型のDiscriminated Union化

```typescript
// GitHub DataSource
export type GitHubDataSource = {
  id: string
  sourceType: "github"
  sourceId: string
  name: string
  description: string
  url: string
  isPrivate: boolean
  createdAt: Date
  updatedAt: Date
  repository: Repository
}

// Discriminated Union
export type DataSource = GitHubDataSource
```

#### Repository型の修正

```typescript
export type Repository = {
  id: string
  // dataSourceId: string <- 削除
  githubId: number
  fullName: string
  owner: string
  language: string | null
  starsCount: number
  forksCount: number
  openIssuesCount: number
  isFork: boolean
  createdAt: Date
  updatedAt: Date
}
```

#### DataSourceCreationInput型の変更

```typescript
export type GitHubDataSourceCreationInput = {
  sourceType: "github"
  sourceId: string
  name: string
  description: string
  url: string
  isPrivate: boolean
  repository: RepositoryCreationInput
}

export type DataSourceCreationInput = GitHubDataSourceCreationInput
```

### Repository層設計

#### DataSourceRepository.saveメソッドの拡張

```typescript
async save(data: DataSourceCreationInput): Promise<DataSource> {
  return await TransactionManager.transaction(async () => {
    if (data.sourceType === "github") {
      // 1. data_sourcesテーブルにレコード保存
      // 2. repositoriesテーブルにレコード保存
      // 3. GitHubDataSource型として返す
    }
  })
}
```

### アーキテクチャ設計

既存のレイヤード構成を維持しつつ、以下を変更：

- **Domain層**: DataSource型をDiscriminated Unionに変更、Repository型統合
- **Repository層**: RepositoryRepository廃止、DataSourceRepositoryに統合
- **Service層**: RepositoryRepository依存を削除
- **Presentation層**: レスポンス構造をDataSource内包形式に変更

## 4. 実装ファイル一覧

### 削除対象ファイル

1. **`packages/backend/src/features/data-sources/domain/repository.ts`**
   - data-source.tsに統合

2. **`packages/backend/src/features/data-sources/repositories/repository.repository.ts`**
   - DataSourceRepositoryに統合

### 更新対象ファイル

1. **`packages/backend/src/features/data-sources/domain/data-source.ts`**
   - DataSource型をDiscriminated Unionに変更
   - Repository型定義を統合

2. **`packages/backend/src/features/data-sources/domain/data-source-list.ts`**
   - DataSourceListItem型からrepositoryフィールドを削除

3. **`packages/backend/src/features/data-sources/repositories/data-source.repository.ts`**
   - saveメソッドでRepository操作も実行
   - Repository関連メソッドを統合

4. **`packages/backend/src/features/data-sources/services/data-source-creation.service.ts`**
   - RepositoryRepository依存を削除
   - DataSourceRepository経由でのRepository操作に変更

5. **`packages/backend/src/features/data-sources/presentation/routes/data-sources/index.ts`**
   - レスポンス構造をDataSource内包形式に変更

6. **関連するテストファイル**
   - 上記変更に対応するテスト修正

## 5. テスト戦略

### Component Test（Presentation層）

- 既存のデータソース一覧取得APIのレスポンス構造変更確認
- データソース作成APIの動作確認
- 認証・認可に関する既存テストの継続確認

### Unit Test（Repository層）

- DataSourceRepository.saveメソッドのRepository同時作成確認
- トランザクション処理の正常性確認
- データ変換処理の正確性確認

## 6. 受け入れ基準

### 機能要件

- [ ] DataSource型がDiscriminated Unionとして正しく動作する
- [ ] DataSourceRepositoryを通してRepository操作が実行される
- [ ] RepositoryRepository関連のコードが完全に削除されている
- [ ] APIレスポンスでDataSource内にRepositoryが含まれる

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] 型安全性が保たれている（TypeScriptコンパイルエラーなし）
- [ ] パフォーマンスの劣化がない

### セキュリティ要件

- [ ] 既存の認証・認可機能に影響がない
- [ ] データアクセス権限が適切に維持されている

## 7. 実装手順

### Phase 1: Domain層実装

- 1-1. data-source.tsでDataSource型をDiscriminated Unionに変更
- 1-2. Repository型定義をdata-source.tsに統合
- 1-3. repository.tsファイルを削除
- 1-4. data-source-list.tsのDataSourceListItem型を修正

### Phase 2: Repository層実装

- 2-1. DataSourceRepository.saveメソッドを拡張してRepository操作を統合
- 2-2. repository.repository.tsを削除
- 2-3. Repository層のユニットテストを修正・実行

### Phase 3: Service層実装

- 3-1. DataSourceCreationServiceからRepositoryRepository依存を削除
- 3-2. その他ServiceクラスのRepository関連処理を修正

### Phase 4: Presentation層実装

- 4-1. APIルートのレスポンス構造をDataSource内包形式に変更
- 4-2. スキーマ定義を修正
- 4-3. Componentテストの修正・実行

## 8. リスク・考慮事項

### 技術的リスク

- **破壊的変更**: Domain型の大幅な変更により、既存コードが一時的に動作しなくなる
- **型安全性**: Discriminated Unionの型ガードが適切に実装されないと実行時エラーの可能性
- **データ変換**: 既存のDB構造からの変換処理が複雑になる可能性

### 軽減策

- 段階的実装による品質確保（Phase分けした実装）
- 型ガード関数の適切な実装
- 既存テストによる回帰テスト実施
- トランザクション処理による整合性確保