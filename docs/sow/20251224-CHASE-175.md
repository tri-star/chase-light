# SOW: CHASE-175: アクティビティ本文の翻訳リクエスト機能

## プロジェクト概要

**課題ID**: CHASE-175
**作成日**: 2025-12-24
**種別**: 機能追加

## 1. 背景と目的

### 背景

アクティビティ詳細ページ (`/activities/:id`) では、GitHub リポジトリのリリース/PR/Issue などのアクティビティ内容を表示しています。アクティビティの本文は英語で記載されていることが多く、日本語への翻訳済みコンテンツがある場合はそれを表示しています。しかし、翻訳がまだ完了していない場合に、ユーザーが手動で翻訳をリクエストする手段がありません。

### 目的

アクティビティ詳細ページにおいて、翻訳済み本文がない場合に以下の機能を提供します：

1. 原文を表示したまま、本文上部に「日本語訳がまだありません」というメッセージと「翻訳をリクエスト」ボタンを表示
2. 翻訳リクエスト後は「翻訳中…」という処理中状態を表示
3. 翻訳状態を3秒間隔でポーリングし、完了したら翻訳結果を表示

## 2. 実装スコープ

### 実装対象

- フロントエンド BFF API（翻訳リクエスト/ステータス取得）
- フロントエンド Repository 層（翻訳関連の API 呼び出し）
- フロントエンド UI コンポーネント（翻訳リクエストバナー、処理中表示）
- フロントエンド composable（翻訳状態管理、ポーリングロジック）

### 更新可能な項目

1. アクティビティ詳細ページの翻訳未完了時の表示
2. 翻訳リクエストバナーの表示
3. 翻訳処理中の状態表示
4. 翻訳完了後の自動切り替え

### 実装除外項目

- バックエンド API の実装（既に `/api/activities/{activityId}/translations/body` エンドポイントが存在）
- 翻訳処理自体のロジック（バックエンドで SQS 経由で非同期実行）

## 3. 技術仕様

### API仕様

バックエンド API は既存のものを使用します。フロントエンドの BFF を経由して呼び出します。

#### 翻訳リクエストエンドポイント

```
POST /api/activities/{activityId}/translations/body
```

**リクエスト仕様**

```typescript
{
  "force"?: boolean       // true の場合、完了済みでも再翻訳を許可
  "targetLanguage"?: "ja" // 翻訳対象言語（省略時は ja）
}
```

**レスポンス仕様**

```typescript
{
  "success": true,
  "data": {
    "jobId": string | null,
    "translationStatus": "queued" | "processing" | "completed" | "failed",
    "statusDetail": string | null,
    "requestedAt": string,        // ISO8601
    "startedAt": string | null,   // ISO8601
    "completedAt": string | null  // ISO8601
  }
}
```

- 200: 完了済み翻訳があり、force=false のため再投入しない
- 202: 翻訳ジョブをキューに投入、または進行中ジョブが存在
- 404: アクティビティが存在しない、またはウォッチ外

#### 翻訳ステータス取得エンドポイント

```
GET /api/activities/{activityId}/translations/body
```

**レスポンス仕様**

```typescript
{
  "success": true,
  "data": {
    "jobId": string | null,
    "translationStatus": "queued" | "processing" | "completed" | "failed",
    "statusDetail": string | null,
    "requestedAt": string,
    "startedAt": string | null,
    "completedAt": string | null
  }
}
```

- 200: 翻訳ステータス取得成功
- 404: アクティビティが存在しない、またはウォッチ外

### 認証・認可

- JWT 認証必須（既存の認証ミドルウェアを使用）
- ユーザーがウォッチしているデータソースのアクティビティのみ操作可能

### アーキテクチャ設計

既存のアクティビティ機能と同じレイヤード構成を採用：

```
[ActivityDetailPage]
      ↓ props/composable
[use-activity-detail] + [use-translation-request]
      ↓ Repository
[activity-translation-repository]
      ↓ BFF API
[/api/activities/[id]/translations/body.post.ts]
[/api/activities/[id]/translations/body.get.ts]
      ↓ Backend API（Orval生成クライアント経由）
[Backend API]
```

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/frontend/server/api/activities/[id]/translations/body.post.ts`**
   - 翻訳リクエスト BFF エンドポイント
   - Backend API の POST `/api/activities/{activityId}/translations/body` を呼び出し

2. **`packages/frontend/server/api/activities/[id]/translations/body.get.ts`**
   - 翻訳ステータス取得 BFF エンドポイント
   - Backend API の GET `/api/activities/{activityId}/translations/body` を呼び出し

3. **`packages/frontend/features/activities/repositories/activity-translation-repository.ts`**
   - 翻訳リクエスト/ステータス取得の Repository
   - BFF API を呼び出し、フロントエンド用の型で返却

4. **`packages/frontend/features/activities/domain/translation.ts`**
   - 翻訳関連のフロントエンド用型定義

5. **`packages/frontend/features/activities/composables/use-translation-request.ts`**
   - 翻訳リクエスト/ポーリングロジックを管理する composable
   - 3秒間隔でステータスをポーリング
   - 翻訳完了時にコールバックで親に通知

6. **`packages/frontend/components/pages/activities/detail/parts/TranslationRequestBanner.vue`**
   - 翻訳未完了時に本文上部に表示するバナーコンポーネント
   - 「翻訳をリクエスト」ボタン、処理中状態、エラー状態を表示

### 更新対象ファイル

1. **`packages/frontend/components/pages/activities/detail/ActivityDetailPage.vue`**
   - `use-translation-request` composable を統合
   - 翻訳完了時のデータ再取得ロジックを追加

2. **`packages/frontend/components/pages/activities/detail/use-activity-detail.ts`**
   - `refresh` 関数を返却して外部から再取得可能にする

3. **`packages/frontend/components/pages/activities/detail/parts/ActivityDetailContent.vue`**
   - 翻訳未完了時に `TranslationRequestBanner` を本文上部に表示

## 5. テスト戦略

### Component Test（ページ層）

- 翻訳済みコンテンツがある場合は翻訳内容を表示（バナー非表示）
- 翻訳未完了時に原文が表示され、本文上部に翻訳リクエストバナーが表示される
- 翻訳リクエストボタンをクリックすると翻訳リクエスト API が呼ばれる
- 翻訳中は「翻訳中…」状態がバナーに表示される
- 翻訳完了後にバナーが消え、翻訳結果が表示される

### Unit Test（composable層）

- `use-translation-request` のポーリングロジック
- 翻訳ステータスに応じた状態管理
- エラー発生時のハンドリング
- `onUnmounted` でのタイマークリーンアップ

### Unit Test（Repository層）

- 今回は実装しない（BFF 経由のため、統合テストでカバー）

## 6. 受け入れ基準

### 機能要件

- [ ] 翻訳済み本文がない場合、原文が表示されたまま本文上部に翻訳リクエストバナーが表示される
- [ ] バナーには「日本語訳がまだありません」というメッセージと「翻訳をリクエスト」ボタンが表示される
- [ ] 「翻訳をリクエスト」ボタンをクリックすると翻訳リクエストが送信される
- [ ] 翻訳中は「翻訳中…」という処理中状態がバナーに表示される
- [ ] 3秒間隔で翻訳ステータスをポーリングする
- [ ] 翻訳完了後、バナーが消え、翻訳結果が自動的に表示される
- [ ] 翻訳失敗時はエラーメッセージと再試行ボタンがバナーに表示される

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] ページを離れた場合にポーリングが停止される
- [ ] 翻訳中のUIは適切なフィードバック（スピナーなど）を提供する

### セキュリティ要件

- [ ] JWT 認証による適切なアクセス制御
- [ ] ウォッチしていないアクティビティへのアクセス拒否

## 7. 実装手順

### Phase 1: BFF API 層実装

- 1-1. `packages/frontend/server/api/activities/[id]/translations/body.post.ts` を作成
- 1-2. `packages/frontend/server/api/activities/[id]/translations/body.get.ts` を作成
- 1-3. format, lint, コミット

### Phase 2: Domain/Repository 層実装

- 2-1. `packages/frontend/features/activities/domain/translation.ts` を作成
- 2-2. `packages/frontend/features/activities/repositories/activity-translation-repository.ts` を作成
- 2-3. format, lint, コミット

### Phase 3: Composable 層実装

- 3-1. `packages/frontend/features/activities/composables/use-translation-request.ts` を作成
- 3-2. format, lint, コミット

### Phase 4: UI コンポーネント実装

- 4-1. `packages/frontend/components/pages/activities/detail/parts/TranslationRequestBanner.vue` を作成
- 4-2. `ActivityDetailContent.vue` を更新して翻訳リクエストバナーを本文上部に表示
- 4-3. `use-activity-detail.ts` を更新して `refresh` 関数を返却
- 4-4. `ActivityDetailPage.vue` を更新
- 4-5. format, lint, コミット

### Phase 5: テスト実装

- 5-1. `use-translation-request.ts` の Unit テストを作成
- 5-2. `activity-detail.test.ts` に翻訳リクエスト機能のテストケースを追加
- 5-3. format, lint, コミット

## 8. UI/UX 設計

### 採用パターン: 本文上部にインライン通知バナー（パターンA）

原文を表示したまま、本文表示エリアの上部に小さな通知バナーを表示するパターンを採用。

**設計意図:**
- 原文はそのまま読める状態を維持
- 通知は目立つが邪魔にならない位置に配置
- 翻訳完了後にバナーを消して翻訳/原文トグルに自然に置き換えられる

### 翻訳未完了時の表示

```
┌─────────────────────────────────────────────────────┐
│ 原文                          [原文/翻訳トグル無効] │
├─────────────────────────────────────────────────────┤
│ Release v1.0.0                                     │
├─────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────┐ │
│ │ ℹ️ 日本語訳がまだありません [翻訳をリクエスト]   │ │ ← バナー
│ └─────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────┤
│ This release includes the following changes:       │
│ - Feature A: New functionality for...              │
│ - Bug fix: Fixed issue with...                     │
│ (原文がそのまま表示される)                          │
└─────────────────────────────────────────────────────┘
```

### 翻訳中の表示

```
┌─────────────────────────────────────────────────────┐
│ 原文                          [原文/翻訳トグル無効] │
├─────────────────────────────────────────────────────┤
│ Release v1.0.0                                     │
├─────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────┐ │
│ │ ⏳ 翻訳中... しばらくお待ちください              │ │ ← バナー（ローディング状態）
│ └─────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────┤
│ This release includes the following changes:       │
│ - Feature A: New functionality for...              │
│ (原文がそのまま表示される)                          │
└─────────────────────────────────────────────────────┘
```

### 翻訳失敗時の表示

```
┌─────────────────────────────────────────────────────┐
│ 原文                          [原文/翻訳トグル無効] │
├─────────────────────────────────────────────────────┤
│ Release v1.0.0                                     │
├─────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────┐ │
│ │ ❌ 翻訳に失敗しました           [再試行]        │ │ ← バナー（エラー状態）
│ └─────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────┤
│ This release includes the following changes:       │
│ (原文がそのまま表示される)                          │
└─────────────────────────────────────────────────────┘
```

### 翻訳完了後の表示

バナーは消え、翻訳/原文トグルが有効になり、翻訳結果が表示される（既存の動作）。

```
┌─────────────────────────────────────────────────────┐
│ 翻訳結果                      [原文/翻訳トグル有効] │
├─────────────────────────────────────────────────────┤
│ リリース v1.0.0                                    │
├─────────────────────────────────────────────────────┤
│ このリリースには以下の変更が含まれています：        │
│ - 機能A: 新しい機能として...                        │
│ - バグ修正: ...の問題を修正                         │
│ (翻訳結果が表示される)                              │
└─────────────────────────────────────────────────────┘
```

### TranslationRequestBanner コンポーネント Props

```typescript
interface Props {
  // 現在の翻訳ステータス
  status: 'idle' | 'requesting' | 'polling' | 'completed' | 'failed'
  // エラーメッセージ（failed時）
  errorMessage?: string
}

interface Emits {
  // 翻訳リクエストボタンクリック時
  (e: 'request'): void
  // 再試行ボタンクリック時
  (e: 'retry'): void
}
```

### バナーの表示条件

`ActivityDetailContent.vue` にて以下の条件でバナーを表示：

```typescript
// バナーを表示する条件
const showTranslationBanner = computed(() => {
  // 翻訳済み本文がない場合に表示
  // ただし、翻訳完了状態の場合は非表示（データ再取得後に翻訳結果が表示されるため）
  return !hasTranslatedContent.value && translationStatus.value !== 'completed'
})
```

## 9. ポーリング実装詳細

### use-translation-request.ts の実装仕様

#### 状態管理

```typescript
// 翻訳リクエストの状態
type TranslationRequestStatus =
  | 'idle'        // 初期状態（翻訳リクエスト前）
  | 'requesting'  // 翻訳リクエスト送信中
  | 'polling'     // ポーリング中（queued or processing）
  | 'completed'   // 翻訳完了
  | 'failed'      // 翻訳失敗

interface UseTranslationRequestReturn {
  // 状態
  status: Ref<TranslationRequestStatus>
  errorMessage: Ref<string | null>
  isPolling: Ref<boolean>

  // アクション
  requestTranslation: () => Promise<void>
  stopPolling: () => void

  // コールバック設定
  onTranslationComplete: Ref<(() => void) | null>
}
```

#### ポーリングロジック詳細

```typescript
// packages/frontend/features/activities/composables/use-translation-request.ts

import { ref, onUnmounted } from 'vue'
import { ActivityTranslationRepository } from '../repositories/activity-translation-repository'
import type { TranslationState } from '../domain/translation'

const POLLING_INTERVAL_MS = 3000 // 3秒

export type TranslationRequestStatus =
  | 'idle'
  | 'requesting'
  | 'polling'
  | 'completed'
  | 'failed'

export function useTranslationRequest(activityId: string) {
  const status = ref<TranslationRequestStatus>('idle')
  const errorMessage = ref<string | null>(null)
  const isPolling = ref(false)
  const onTranslationComplete = ref<(() => void) | null>(null)

  let pollingTimer: ReturnType<typeof setInterval> | null = null
  const repository = new ActivityTranslationRepository()

  // ポーリング開始
  const startPolling = () => {
    if (isPolling.value) return
    isPolling.value = true
    status.value = 'polling'

    pollingTimer = setInterval(async () => {
      try {
        const result = await repository.getStatus(activityId)

        if (result.translationStatus === 'completed') {
          // 翻訳完了
          stopPolling()
          status.value = 'completed'
          // 親に通知してアクティビティデータを再取得
          onTranslationComplete.value?.()
        } else if (result.translationStatus === 'failed') {
          // 翻訳失敗
          stopPolling()
          status.value = 'failed'
          errorMessage.value = result.statusDetail || '翻訳処理中にエラーが発生しました'
        }
        // queued / processing の場合は継続
      } catch (error) {
        console.error('Translation status polling failed:', error)
        stopPolling()
        status.value = 'failed'
        errorMessage.value = 'ステータスの取得に失敗しました'
      }
    }, POLLING_INTERVAL_MS)
  }

  // ポーリング停止
  const stopPolling = () => {
    if (pollingTimer) {
      clearInterval(pollingTimer)
      pollingTimer = null
    }
    isPolling.value = false
  }

  // 翻訳リクエスト送信
  const requestTranslation = async () => {
    status.value = 'requesting'
    errorMessage.value = null

    try {
      const result = await repository.request(activityId)

      if (result.translationStatus === 'completed') {
        // 既に完了済み
        status.value = 'completed'
        onTranslationComplete.value?.()
      } else if (result.translationStatus === 'failed') {
        // 失敗状態
        status.value = 'failed'
        errorMessage.value = result.statusDetail || '翻訳リクエストに失敗しました'
      } else {
        // queued or processing -> ポーリング開始
        startPolling()
      }
    } catch (error) {
      console.error('Translation request failed:', error)
      status.value = 'failed'
      errorMessage.value = '翻訳リクエストの送信に失敗しました'
    }
  }

  // コンポーネントアンマウント時にクリーンアップ
  onUnmounted(() => {
    stopPolling()
  })

  return {
    status,
    errorMessage,
    isPolling,
    requestTranslation,
    stopPolling,
    onTranslationComplete,
  }
}
```

#### ActivityDetailPage での統合

```typescript
// packages/frontend/components/pages/activities/detail/ActivityDetailPage.vue

const {
  activity,
  error,
  mode,
  pageTitle,
  hasTranslatedContent,
  displayTitle,
  displayBody,
  handleToggleMode,
  refresh, // ← 追加: データ再取得用
} = await useActivityDetail(props.activityId)

// 翻訳リクエスト機能
const {
  status: translationStatus,
  errorMessage: translationErrorMessage,
  requestTranslation,
  onTranslationComplete,
} = useTranslationRequest(props.activityId)

// 翻訳完了時にアクティビティデータを再取得
onTranslationComplete.value = async () => {
  await refresh()
}
```

#### use-activity-detail.ts の更新

```typescript
// packages/frontend/components/pages/activities/detail/use-activity-detail.ts

export function useActivityDetail(activityId: string) {
  // ... 既存のコード ...

  const { data, error, refresh } = useAsyncData<ActivityDetail>(
    fetchKey.value,
    () => activityDetailRepository.fetch(activityId),
    {
      server: true,
      lazy: false,
    }
  )

  // ... 既存のコード ...

  return {
    activity,
    error,
    mode,
    pageTitle,
    hasTranslatedContent,
    displayTitle,
    displayBody,
    handleToggleMode,
    refresh, // ← 追加
  }
}
```

### ポーリング動作フロー

```
1. ユーザーが「翻訳をリクエスト」ボタンをクリック
   ↓
2. requestTranslation() が呼ばれる
   - status: 'idle' → 'requesting'
   ↓
3. POST /api/activities/{id}/translations/body を呼び出し
   ↓
4. レスポンスの translationStatus を確認
   ├─ 'completed' → status: 'completed', onTranslationComplete() 呼び出し
   ├─ 'failed'    → status: 'failed', エラーメッセージ設定
   └─ 'queued'/'processing' → startPolling()
      ↓
5. ポーリング開始 (status: 'polling')
   - 3秒ごとに GET /api/activities/{id}/translations/body を呼び出し
   ↓
6. ポーリング中のレスポンス確認
   ├─ 'completed' → stopPolling(), status: 'completed', onTranslationComplete()
   ├─ 'failed'    → stopPolling(), status: 'failed', エラーメッセージ設定
   └─ 'queued'/'processing' → 継続
   ↓
7. 翻訳完了時
   - onTranslationComplete() により refresh() が呼ばれる
   - アクティビティデータが再取得される
   - hasTranslatedContent が true になり、バナーが非表示になる
```

### エラーハンドリング

| エラーケース | 対応 |
|-------------|------|
| 翻訳リクエスト送信失敗 | status: 'failed', エラーメッセージ表示, 再試行ボタン表示 |
| ポーリング中のネットワークエラー | ポーリング停止, status: 'failed', エラーメッセージ表示 |
| バックエンドから failed 返却 | ポーリング停止, status: 'failed', statusDetail をエラーメッセージとして表示 |
| 404エラー | status: 'failed', 「アクティビティが見つかりません」表示 |

### クリーンアップ

- `onUnmounted` フックでタイマーを確実にクリア
- ページ遷移時に自動的にポーリングが停止
- 手動で `stopPolling()` を呼び出すことも可能

## 10. リスク・考慮事項

### 技術的リスク

- **ポーリングによるサーバー負荷**: 複数ユーザーが同時にポーリングする場合の負荷
- **ネットワーク断絶時の挙動**: ポーリング中にネットワーク接続が切れた場合のハンドリング
- **コンポーネントアンマウント時のクリーンアップ**: ポーリングタイマーの適切な解除

### 軽減策

- ポーリング間隔を3秒に設定し、過度なリクエストを避ける
- エラー発生時はポーリングを停止し、ユーザーに再試行を促す
- `onUnmounted` フックでタイマーを確実にクリアする
- 翻訳完了またはエラー発生時にポーリングを停止する
