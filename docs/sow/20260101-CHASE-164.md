# SOW: CHASE-164: アクティビティ一覧にフィルター機能追加

## プロジェクト概要

**課題ID**: CHASE-164
**作成日**: 2026-01-01
**種別**: 機能追加

## 1. 背景と目的

### 背景

現在のアクティビティ一覧ページでは、全てのアクティビティが時系列で表示されるのみで、ユーザーが特定のキーワードでフィルタリングする手段がない。ウォッチしているリポジトリが増えると、興味のあるアクティビティを見つけることが困難になる。

Backend APIには既にkeywordパラメータによる検索機能が実装済み（別課題）であり、今回はフロントエンド側でその機能を活用できるようにする。

### 目的

- ユーザーがアクティビティ一覧をキーワードでフィルタリングできるようにする
- Backend APIのkeyword検索機能をフロントエンドから利用可能にする
- ユーザビリティの向上

## 2. 実装スコープ

### 実装対象

- Frontend BFF: keywordパラメータの対応
- 画面: アクティビティ一覧画面上部にテキストフィールドによるフィルター機能を追加
- ClTextField基底コンポーネントの新規作成

### 実装除外項目

- Backend API（別課題で実装済み）
- 高度な検索機能（日付範囲、アクティビティ種別との組み合わせ等）
- 検索履歴の保存

## 3. 技術仕様

### API仕様

#### エンドポイント

```
GET /api/activities
```

#### クエリパラメータ（追加分）

| パラメータ | 型 | 必須 | 説明 |
|---|---|---|---|
| keyword | string | No | 検索キーワード（部分一致、大文字小文字区別なし） |

#### リクエスト例

```
GET /api/activities?page=1&perPage=20&keyword=react
```

#### レスポンス仕様

既存のActivityListResponseと同じ形式（変更なし）

### UI設計

#### フィルター入力フィールド

- アクティビティ一覧の上部に配置
- テキストフィールドでキーワードを入力
- プレースホルダー: 「キーワードで検索...」
- 検索アイコン（虫眼鏡）を左側に配置
- 入力後、デバウンス処理（300ms）を経て検索実行
- 検索中はクリアボタンを表示

#### 動作仕様

1. ユーザーがキーワードを入力
2. 300msのデバウンス後、自動的に検索実行
3. 既存のリストをクリアし、新しい検索結果で置き換え
4. 無限スクロールは引き続き有効（検索結果が多い場合）
5. キーワードをクリアすると全件表示に戻る

### アーキテクチャ設計

#### ClTextField基底コンポーネント

ClSelectの実装パターンを参考に、以下のpropsを持つ汎用テキスト入力コンポーネントを作成：

```typescript
interface Props {
  modelValue?: string
  placeholder?: string
  disabled?: boolean
  ariaLabel?: string
  type?: 'text' | 'search' | 'email' | 'password'
}
```

#### ActivityListPage改修

- フィルター用キーワードの状態管理をページレベルで行う
- ActivityListコンポーネントにkeywordをpropsで渡す

#### ActivityList改修

- keyword propsを受け取り、API呼び出しに追加
- keywordの変更をwatchし、変更時はリストをリセットして再検索

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/frontend/components/base/ClTextField.vue`**
   - 汎用テキスト入力コンポーネント
   - v-model対応、prefix/suffixスロット

2. **`packages/frontend/components/base/__tests__/ClTextField.test.ts`**
   - ClTextFieldのユニットテスト

3. **`packages/frontend/components/base/ClTextField.stories.ts`**
   - ClTextFieldのStorybookストーリー

4. **`packages/frontend/components/pages/activities/__tests__/activity-list.test.ts`**
   - ActivityListPageのフィーチャーテスト

### 更新対象ファイル

1. **`packages/frontend/server/api/activities/index.get.ts`**
   - keywordパラメータの受け取りとBackend APIへの転送

2. **`packages/frontend/components/pages/activities/ActivityListPage.vue`**
   - フィルター用テキストフィールドの追加
   - キーワード状態管理

3. **`packages/frontend/components/pages/activities/parts/ActivityList.vue`**
   - keyword propsの追加
   - API呼び出しへのkeywordパラメータ追加
   - keyword変更時のリスト再読み込み

### 前提作業（必要に応じて）

- Orval再生成: `pnpm --filter frontend generate:api`
  - Backend APIのopenapi.jsonにkeywordパラメータが追加されているため、Orvalを再生成してフロントエンドの型定義を更新する

## 5. テスト戦略

### Unit Test（コンポーネント）

- **ClTextField**
  - 初期値の表示
  - v-modelの双方向バインディング
  - disabledプロパティの動作
  - placeholder表示
  - prefix/suffixスロットの表示

### Feature Test（ページ）

- **ActivityListPage**
  - フィルターテキストフィールドの表示
  - キーワード入力後のAPI呼び出し確認（MSWでモック）
  - 検索結果の表示
  - キーワードクリア時の全件表示復帰

## 6. 受け入れ基準

### 機能要件

- [ ] アクティビティ一覧ページ上部にテキストフィールドが表示される
- [ ] キーワードを入力すると、そのキーワードでアクティビティがフィルタリングされる
- [ ] キーワードをクリアすると全件表示に戻る
- [ ] 無限スクロールがフィルタリング中も正常に動作する
- [ ] 検索結果が0件の場合、適切なメッセージが表示される

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] 入力からAPI呼び出しまでデバウンス処理（300ms）が適用される
- [ ] レスポンシブデザイン（モバイル/デスクトップ両対応）

### セキュリティ要件

- [ ] XSS対策（ユーザー入力値のエスケープ）

## 7. 実装手順

### Phase 1: Orval再生成と型確認

- 1-1. `pnpm --filter frontend generate:api` を実行してOrvalを再生成
- 1-2. GetApiActivitiesParamsにkeywordが追加されていることを確認

### Phase 2: ClTextField基底コンポーネント作成

- 2-1. ClTextField.vue の実装
- 2-2. ClTextField.stories.ts の作成
- 2-3. ClTextField.test.ts のユニットテスト作成・実行
- 2-4. format, lint, コミット

### Phase 3: BFF修正

- 3-1. activities/index.get.ts にkeywordパラメータ対応を追加
- 3-2. format, lint, コミット

### Phase 4: 画面実装

- 4-1. ActivityList.vue にkeyword props追加、API呼び出し修正、keyword変更時のリセット処理
- 4-2. ActivityListPage.vue にフィルターテキストフィールド追加
- 4-3. ActivityListPageのフィーチャーテスト作成・実行
- 4-4. format, lint, コミット

### Phase 5: 最終確認とPR作成

- 5-1. 全テスト実行
- 5-2. 実機での動作確認
- 5-3. PRの作成

## 8. リスク・考慮事項

### 技術的リスク

- **デバウンス処理**: 連続入力時の過剰なAPI呼び出し防止
- **無限スクロールとの整合性**: 検索条件変更時のページネーションリセット

### 軽減策

- デバウンス処理（300ms）を導入し、ユーザー入力中の過剰なリクエストを防止
- keyword変更時は明示的にページとリスト状態をリセットする実装
- 既存テストによる回帰テスト実施

### UX考慮事項

- 検索中の視覚的フィードバック（ローディング表示）
- 検索結果0件時の適切なメッセージ表示
