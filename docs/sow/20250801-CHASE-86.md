# SOW: CHASE-86: ローカル環境用ElasticMQのPoller作成

## プロジェクト概要

**課題ID**: CHASE-86
**作成日**: 2025-08-01
**種別**: 実装改善

## 1. 背景と目的

### 背景

packages/backend配下にはローカル環境でStepFunctionsLocal + ElasticMQによるワークフロー実行環境が整備されているが、ElasticMQを監視してLambdaを実行する機能が不足している状態です。現在、SAM + StepFunctionsLocal + ElasticMQ の環境は出来ていますが、リアルタイムな開発・テスト環境としては不完全な状況です。

### 目的

ElasticMQにエンキューされたメッセージを監視し、メッセージの内容に従ってSAM LocalでLambda関数を自動実行する仕組みを構築することで、ローカル環境でのワークフロー実行を自動化し、開発効率を向上させます。

## 2. 実装スコープ

### 実装対象

- ElasticMQのポーリング機能
- メッセージ受信時のLambda関数自動実行
- 処理成功/失敗時のメッセージ削除
- ログ出力機能

### 実装機能

1. ElasticMQの特定キューを監視し、メッセージを受信
2. 受信したメッセージの内容をログ出力（オプション機能）
3. メッセージの内容に従い、SAM LocalでLambda関数を実行
4. 処理成功/失敗をログ出力
5. 処理後のメッセージ削除

### 実装除外項目

- 本番環境への対応（ローカル環境専用）
- エラーリトライ機能（Lambda関数側で対応）
- メッセージの永続化

## 3. 技術仕様

### アーキテクチャ設計

**1プロセス1キュー方式**を採用：

- **実行環境**: pnpx tsx による実行
- **配置場所**: `packages/backend/scripts/elasticmq-poller.ts`
- **プロセス設計**: 1プロセスで1つのキューを監視（キューごとに独立したプロセス起動）
- **設定管理**: コマンドライン引数 + 設定ファイルの両方をサポート
- **AWS SDKクライアント**: ElasticMQ用SQSクライアント、SAM Local用Lambdaクライアント

### キュー設定の柔軟性

将来的なキュー拡張に対応するため、以下の方法で監視キューを指定可能：

1. **コマンドライン引数**:

   ```bash
   pnpx tsx elasticmq-poller.ts --queue process-updates-queue
   pnpx tsx elasticmq-poller.ts --queue other-queue --interval 3000
   ```

2. **設定ファイル**:
   - `infrastructure/local-variables.json` にキュー設定を追加
   - デフォルト値として使用、コマンドライン引数で上書き可能

### メッセージ処理フロー

1. **ポーリング**: ElasticMQの指定されたキューを監視
2. **メッセージ受信**: SQSのReceiveMessageAPIを使用
3. **ログ出力**: 受信したメッセージ内容を開発者向けに出力
4. **Lambda実行**: SAM Local環境のLambda関数を呼び出し
5. **結果処理**: 成功/失敗をログ出力し、メッセージを削除

### 設定仕様

```typescript
interface PollerConfig {
  elasticMqEndpoint: string; // http://localhost:9324
  samLocalEndpoint: string; // http://localhost:3001
  queueName: string; // 監視対象キュー名（コマンドライン引数で指定）
  pollIntervalMs: number; // 5000 (5秒間隔)
  maxMessages: number; // 1
  waitTimeSeconds: number; // 20 (Long Polling)
}

// キューごとの設定（local-variables.json）
interface QueueConfig {
  [queueName: string]: {
    lambdaFunctionName: string; // 対応するLambda関数名
    pollInterval?: number; // キュー固有のポーリング間隔
    enabled: boolean; // キューの有効/無効
  };
}
```

### エラーハンドリング

- **ElasticMQ接続エラー**: 再接続を試行し、一定回数失敗で終了
- **Lambda実行エラー**: エラーログ出力後、メッセージを削除
- **予期しないエラー**: エラーログ出力後、メッセージは削除せずに継続

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/backend/scripts/elasticmq-poller.ts`**
   - ElasticMQポーラーのメイン実装
   - CLI引数処理、設定読み込み、ポーリングループ

2. **`packages/backend/scripts/lib/elasticmq-poller/`**
   - `poller.ts`: ポーラーコアロジック
   - `message-processor.ts`: メッセージ処理ロジック
   - `config.ts`: 設定管理
   - `logger.ts`: ログ出力機能

3. **`packages/backend/scripts/__tests__/`**
   - `poller-test.ts`: メインテストファイル（`pnpx tsx` で実行）
   - `message-processor.test.ts`: メッセージ処理のテスト
   - `config.test.ts`: 設定管理のテスト
   - `test-utils.ts`: テスト用ユーティリティ

### 更新対象ファイル

1. **`packages/backend/package.json`**
   - `scripts` にポーラー起動コマンドを追加
   - 必要な依存関係（@aws-sdk/client-sqs, @aws-sdk/client-lambda）を追加

2. **`packages/backend/infrastructure/local-variables.json`**
   - キューごとの設定セクションを追加：

   ```json
   {
     "QueueConfig": {
       "process-updates-queue": {
         "lambdaFunctionName": "ProcessUpdatesFunction",
         "pollInterval": 5000,
         "enabled": true
       }
     }
   }
   ```

3. **`packages/backend/scripts/setup-local-environment.mjs`**
   - ポーラー起動の統合（オプション機能として）

## 5. テスト戦略

### Unit Test（純粋TypeScript）

**実行方法**: `pnpx tsx poller-test.ts`

- **対象**: ポーラーコアロジック、メッセージ処理ロジック、設定読み込み機能
- **実装方式**: Vitestを使わず、純粋なTypeScriptでテスト記述
- **理由**: StepFunctionsLocal環境はCI環境で動作しないため、CI依存を回避

**テストファイル構成**:

```
scripts/
├── elasticmq-poller.ts
├── __tests__/
│   ├── poller-test.ts              # メインテストファイル
│   └── message-processor-test.ts   # 個別モジュールテスト
```

**テスト内容**:

- 設定読み込み・バリデーション
- メッセージ処理ロジック（モック使用）
- エラーハンドリング
- コマンドライン引数解析

### 統合テスト（Manual）

- ElasticMQ + SAM Local環境での動作確認
- エラーケース（ElasticMQ停止、SAM Local停止）での動作確認
- 複数キューでの独立動作確認

### 環境テスト（Manual）

- setup-local-environment.mjsによる環境起動
- ポーラー起動・停止の動作確認
- ワークフロー実行との統合動作確認

## 6. 受け入れ基準

### 機能要件

- [ ] コマンドライン引数で指定されたElasticMQキューを継続的に監視できる
- [ ] 複数の異なるキューに対して独立したプロセスで監視できる
- [ ] メッセージ受信時に内容をログ出力できる
- [ ] 受信メッセージに従ってSAM LocalのLambda関数を実行できる
- [ ] Lambda関数の成功/失敗をログ出力できる
- [ ] 処理後にメッセージを削除できる
- [ ] `pnpx tsx elasticmq-poller.ts --queue [キュー名]` で起動できる
- [ ] 設定ファイルによるデフォルト設定をサポートする
- [ ] Ctrl+C で適切に停止できる
- [ ] `pnpx tsx __tests__/poller-test.ts` でテストが実行できる

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] TypeScriptによる型安全な実装
- [ ] 設定ファイルによる柔軟な設定変更が可能
- [ ] 適切なエラーハンドリングが実装されている

### セキュリティ要件

- [ ] ローカル環境専用の実装（本番環境では使用不可）
- [ ] AWS認証情報のハードコード禁止

## 7. 実装手順

### Phase 1: コアポーラー実装

- 1-1. コマンドライン引数処理とキュー設定の抽象化
- 1-2. 基本的なElasticMQポーリング機能の実装
- 1-3. 設定管理とログ機能の実装
- 1-4. 純粋TypeScriptによるユニットテストの作成・実行

### Phase 2: Lambda統合実装

- 2-1. SAM Local Lambda呼び出し機能の実装
- 2-2. メッセージ処理とエラーハンドリングの実装
- 2-3. キューとLambda関数のマッピング機能
- 2-4. 統合テストの実行

### Phase 3: 環境統合と拡張対応

- 3-1. local-variables.jsonへのキュー設定追加
- 3-2. package.jsonスクリプトの追加
- 3-3. 複数キュー対応の動作確認
- 3-4. setup-local-environment.mjsとの統合検討
- 3-5. 全体動作確認とドキュメント整備

## 8. リスク・考慮事項

### 技術的リスク

- **ElasticMQ接続安定性**: ネットワーク障害時の再接続処理
- **SAM Local依存**: SAM Localの起動状態に依存する仕組み
- **メッセージ処理の冪等性**: 同一メッセージの重複処理防止

### 軽減策

- 適切なリトライ機能とタイムアウト設定
- 事前の接続チェック機能
- ログによる処理状況の可視化
- 段階的実装による品質確保

### 開発・運用上の考慮事項

- ポーラーの起動/停止タイミング
- 既存のsetup-local-environment.mjsとの統合方法
- Docker化の検討（将来的なオプション）
