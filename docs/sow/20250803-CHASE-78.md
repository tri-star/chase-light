# SOW: CHASE-78: 全体統合とデプロイ準備

## プロジェクト概要

**課題ID**: CHASE-78
**作成日**: 2025-08-03
**種別**: プロダクション統合 / インフラストラクチャ整備

## 1. 背景と目的

### 背景

CHASE-38での技術設計検討結果により、GitHub リポジトリ監視機能のワーカー実装（StepFunctions + Lambda）が完了しています。現在は以下のコンポーネントが実装済みです：

- `list-datasources`ワーカー：監視対象データソース一覧取得
- `detect-datasource-updates`ワーカー：データソース更新検知
- `process-updates`ワーカー：更新処理とSQS連携
- SAMテンプレート（`packages/backend/infrastructure/sam-template.yaml`）
- StepFunctions ASL定義（`repository-monitoring.asl.json`）

しかし、プロダクション環境での運用に必要な設定が未整備の状態です。

### 目的

全ワーカーを統合し、プロダクション環境での自動運用を可能にするためのインフラストラクチャ整備を行います。具体的には、CI/CDパイプライン、CloudWatch監視・アラート、スケジュール実行、デプロイメントガイドの作成を実施します。

## 2. 実装スコープ

### 実装対象

- GitHub Actions CI/CDパイプライン構築
- CloudWatch監視・アラート設定
- EventBridgeによる1日1回の自動実行設定
- プロダクション環境用設定の統合
- デプロイメントガイドの作成

### 更新可能な項目

1. SAMテンプレートのプロダクション設定追加
2. CloudWatchアラート・ログ設定追加
3. GitHub Actions ワークフロー作成
4. デプロイメント手順書作成

### 実装除外項目

- 既存ワーカー機能の変更（動作確認済みのため）
- 新規API エンドポイント追加
- データベーススキーマ変更

## 3. 技術仕様

### デプロイメント仕様

#### GitHub Actions ワークフロー

- **ビルド**: TypeScript コンパイルとLambda パッケージ作成
- **テスト**: 既存テストスイートの実行
- **デプロイ**: AWS SAM deploy による自動デプロイ

#### 環境設定

```yaml
# プロダクション環境変数
Environment:
  Variables:
    USE_AWS: "true"
    STAGE: "prod"
    # Supabase DB接続（SSMパラメータストア経由）
    # OpenAI API Key（SSMパラメータストア経由）
```

### CloudWatch 監視仕様

#### アラート対象

1. **StepFunctions実行失敗**
   - メトリクス: `AWS/States/ExecutionsFailed`
   - 閾値: 1回以上の失敗で即座にアラート

2. **Lambda 関数エラー率**
   - メトリクス: `AWS/Lambda/Errors`
   - 閾値: エラー率5%以上で警告

3. **SQS デッドレターキュー**
   - メトリクス: `AWS/SQS/ApproximateNumberOfVisibleMessages`
   - 閾値: DLQにメッセージ1件以上で警告

#### ログ保持期間

- StepFunctions ログ: 30日間
- Lambda関数ログ: 30日間

### スケジュール実行仕様

- **実行頻度**: 1日1回
- **実行時間**: 毎日 日本時間 17:00
- **実装方法**: EventBridge Rule によるStepFunctions 起動

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`.github/workflows/deploy.yml`**
   - GitHub Actions CI/CDパイプライン定義
   - プルリクエスト時のテスト実行
   - main ブランチへのマージ時の自動デプロイ

2. **`docs/deployment-guide.md`**
   - プロダクション環境セットアップ手順
   - AWS リソース設定方法
   - トラブルシューティング手順

3. **`packages/backend/infrastructure/cloudwatch-config.yaml`**
   - CloudWatch アラート定義
   - SNS トピック設定（必要に応じて）

### 更新対象ファイル

1. **`packages/backend/infrastructure/sam-template.yaml`**
   - EventBridge Rule追加（1日1回実行）
   - CloudWatch アラート設定追加
   - プロダクション環境用パラメータ設定

2. **`packages/backend/infrastructure/repository-monitoring.asl.json`**
   - エラーハンドリング強化（必要に応じて）
   - CloudWatch ログ出力設定

## 5. テスト戦略

### CI/CD パイプラインテスト

- SAMテンプレート構文検証
- TypeScript ビルド確認
- 既存テストスイート実行
- SAM デプロイドライラン

### 統合テスト

- StepFunctions 手動実行による動作確認
- CloudWatch アラートのテスト送信
- EventBridge スケジュール動作確認

### 監視テスト

- 意図的エラー発生によるアラート確認
- ログ出力とフィルタリング確認
- DLQ メッセージ処理確認

## 6. 受け入れ基準

### 機能要件

- [ ] プロダクション環境用の設定が適切に構成されていること
- [ ] CloudWatchでのモニタリングとアラートが設定されていること
- [ ] デプロイメントガイドが作成されていること
- [ ] 1日一回の自動実行が設定されていること
- [ ] GitHub ActionsでのCI/CDパイプラインが動作すること

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] StepFunctions が正常実行される
- [ ] Lambda 関数のコールドスタート時間が許容範囲内
- [ ] CloudWatch ログが適切に出力される

### セキュリティ要件

- [ ] SSMパラメータストアによるシークレット管理
- [ ] IAM ロールの最小権限設定
- [ ] VPC エンドポイント設定（必要に応じて）

### 運用要件

- [ ] エラー発生時のアラート通知が動作する
- [ ] ログによる障害調査が可能
- [ ] デプロイメント手順が文書化されている

## 7. 実装手順

### Phase 1: SAMテンプレート プロダクション設定

- 1-1. EventBridge Rule 追加（1日1回実行）
- 1-2. CloudWatch アラート設定追加
- 1-3. プロダクション環境用パラメータ整理
- 1-4. SAM構文検証とローカルテスト

### Phase 2: GitHub Actions CI/CD 構築

- 2-1. ワークフロー定義作成
- 2-2. AWS認証設定（OIDC推奨）
- 2-3. ビルド・テスト・デプロイステップ定義
- 2-4. CI/CDパイプライン動作確認

### Phase 3: CloudWatch 監視設定

- 3-1. アラート定義とSNS設定
- 3-2. カスタムメトリクス設定
- 3-3. ダッシュボード作成
- 3-4. アラート動作テスト

### Phase 4: デプロイメントガイド作成

- 4-1. セットアップ手順書作成
- 4-2. トラブルシューティングガイド作成
- 4-3. 運用マニュアル作成
- 4-4. ドキュメント内容検証

### Phase 5: 統合テスト・検証

- 5-1. 全体動作確認
- 5-2. スケジュール実行テスト
- 5-3. 障害シナリオテスト
- 5-4. パフォーマンス確認

## 8. リスク・考慮事項

### 技術的リスク

- **AWS リソース制限**: Lambda同時実行数やStepFunctions実行数の上限
- **コスト管理**: CloudWatch ログやメトリクスによる予期しない課金
- **依存サービス**: GitHub API やSupabase のサービス停止影響

### 運用リスク

- **アラート疲れ**: 過剰なアラート設定による運用負荷
- **デプロイ失敗**: CI/CD パイプライン障害時の手動対応
- **監視盲点**: 重要メトリクスの監視漏れ

### 軽減策

- AWS CloudWatch Billing アラート設定による コスト管理
- StepFunctions リトライ・エラーハンドリング強化
- 段階的デプロイ（カナリアデプロイ検討）
- 運用手順書による標準化
- 定期的な監視設定見直し
