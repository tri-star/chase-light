# SOW: CHASE-201: アクティビティ一覧APIにキーワードのフィルタ機能を追加

## プロジェクト概要

**課題ID**: CHASE-201
**作成日**: 2025-12-31
**種別**: 機能追加

## 1. 背景と目的

### 背景

現在のアクティビティ一覧API (`GET /api/activities`) では、アクティビティ種別、ステータス、期間によるフィルタリングが可能ですが、テキストによるキーワード検索機能がありません。ユーザーが特定のキーワードを含むアクティビティを素早く見つけるための機能が求められています。

### 目的

アクティビティ一覧APIにキーワード検索機能を追加し、ユーザーがウォッチしているデータソースのアクティビティをテキストベースで絞り込めるようにします。

## 2. 実装スコープ

### 実装対象

- `GET /api/activities` エンドポイントに `keyword` クエリパラメータを追加
- `activities` テーブルと `data_sources` テーブル（およびJOINされている `repositories` テーブル）のテキスト系カラムに対するILIKE検索

### 検索対象フィールド

1. **activitiesテーブル**
   - `title` (タイトル)
   - `translated_title` (翻訳タイトル)
   - `translated_body` (翻訳本文)
   - `summary` (要約)
   - `version` (バージョン)

2. **data_sourcesテーブル**
   - `name` (データソース名)

3. **repositoriesテーブル**
   - `full_name` (リポジトリ名: owner/repo形式)

### 実装除外項目

- `body` カラムの検索（英語原文のため、翻訳本文での検索を優先）
- 全文検索インデックスの追加（パフォーマンス問題発生時にpg_searchの導入を検討）
- フロントエンドの検索UI（別タスクとして対応）

## 3. 技術仕様

### API仕様

#### エンドポイント

```
GET /api/activities
```

#### 認証・認可

- JWT認証必須
- ユーザーがウォッチしているデータソースのアクティビティのみ取得可能

#### リクエスト仕様

既存のクエリパラメータに `keyword` を追加：

| パラメータ | 型 | 必須 | 説明 |
|---|---|---|---|
| page | number | No | ページ番号 (デフォルト: 1) |
| perPage | number | No | 1ページあたりの件数 (デフォルト: 20, 最大: 100) |
| activityType | string | No | アクティビティ種別 (release/issue/pull_request) |
| status | string | No | ステータス (pending/processing/completed/failed) |
| since | string | No | 取得期間の開始日時 (ISO8601) |
| until | string | No | 取得期間の終了日時 (ISO8601) |
| sort | string | No | ソート対象 (createdAt/updatedAt) |
| order | string | No | ソート順 (asc/desc) |
| **keyword** | **string** | **No** | **検索キーワード（部分一致、大文字小文字区別なし）** |

#### レスポンス仕様

既存のレスポンス形式に変更なし：

```typescript
{
  "success": true,
  "data": {
    "items": ActivityListItem[],
    "pagination": {
      "page": number,
      "perPage": number,
      "total": number,
      "totalPages": number,
      "hasNext": boolean,
      "hasPrev": boolean
    }
  }
}
```

### データベース操作

- **`activities`テーブル**: title, translated_title, translated_body, summary, versionカラムに対するILIKE検索
- **`data_sources`テーブル**: nameカラムに対するILIKE検索
- **`repositories`テーブル**: full_nameカラムに対するILIKE検索
- 各フィールドに対してOR条件で検索し、いずれかにマッチすれば結果に含める
- インデックスは追加せず、パフォーマンス問題発生時にpg_searchの導入を検討

### アーキテクチャ設計

既存のアクティビティ機能と同じレイヤード構成を維持：

```
Presentation層 (routes/activities/index.ts)
    ↓ keyword パラメータを渡す
Application層 (use-cases/list-user-activities.use-case.ts)
    ↓ filters.keyword として渡す
Domain層 (domain/activity.ts: ActivitiesListFilters)
    ↓
Infra層 (repositories/drizzle-activity-query.repository.ts)
    ↓ ILIKE検索条件を構築
Database (activities + data_sources + repositories JOIN)
```

### データフロー

```
1. クライアント: GET /api/activities?keyword=react
2. Presentation層: クエリパラメータをバリデーション、ユースケースに渡す
3. Application層: normalizeActivitiesListOptionsでkeywordをfiltersに含める
4. Domain層: ActivitiesListFiltersにkeywordが含まれる
5. Infra層: buildWhereClauseでILIKE条件を構築
   - 検索パターン: `%react%`
   - OR条件: title ILIKE '%react%' OR translated_title ILIKE '%react%' OR translated_body ILIKE '%react%' OR ...
6. Database: JOINクエリ実行、結果返却
7. レスポンス: 検索条件にマッチしたアクティビティ一覧
```

## 4. 実装ファイル一覧

### 更新対象ファイル

ファイルツリー:
```
packages/backend/src/features/activities/
├── domain/
│   └── activity.ts                          # ActivitiesListFilters型にkeyword追加
├── application/
│   └── use-cases/
│       └── list-activities.helpers.ts       # ActivitiesListInputOptions型にkeyword追加
├── infra/
│   └── repositories/
│       └── drizzle-activity-query.repository.ts  # buildWhereClauseにILIKE検索追加
└── presentation/
    ├── schemas/
    │   └── activity-list-request.schema.ts  # keywordスキーマ追加
    └── routes/
        └── activities/
            ├── index.ts                     # ユースケースにkeyword渡す
            └── __tests__/
                └── index.test.ts            # キーワード検索テスト追加
```

1. **`packages/backend/src/features/activities/presentation/schemas/activity-list-request.schema.ts`**
   - `keyword` フィールドをスキーマに追加（オプション、文字列、1-100文字）

2. **`packages/backend/src/features/activities/domain/activity.ts`**
   - `ActivitiesListFilters` 型に `keyword?: string` を追加

3. **`packages/backend/src/features/activities/application/use-cases/list-activities.helpers.ts`**
   - `ActivitiesListInputOptions` 型に `keyword?: string` を追加
   - `normalizeActivitiesListOptions` で `keyword` を `filters` に含める

4. **`packages/backend/src/features/activities/infra/repositories/drizzle-activity-query.repository.ts`**
   - `buildWhereClause` メソッドにキーワード検索条件を追加
   - drizzle-ormの `ilike`, `or` 関数を使用

5. **`packages/backend/src/features/activities/presentation/routes/activities/index.ts`**
   - ユースケース呼び出し時に `keyword` パラメータを渡す

6. **`packages/backend/src/features/activities/presentation/routes/activities/__tests__/index.test.ts`**
   - キーワード検索のテストケースを追加

## 5. テスト戦略

### Component Test（Presentation層）

- キーワードでアクティビティタイトルを検索し、該当結果が返ること
- キーワードで翻訳本文を検索し、該当結果が返ること
- キーワードでデータソース名を検索し、該当結果が返ること
- キーワードでリポジトリ名を検索し、該当結果が返ること
- 大文字小文字を区別せずに検索できること（ILIKE動作確認）
- 該当なしの場合は空配列が返ること
- keywordパラメータなしの場合は従来通りの動作をすること
- keywordが空文字の場合は無視されること

### Unit Test

- 今回は実装しない（Component Testでカバー）

## 6. 受け入れ基準

### 機能要件

- [ ] `GET /api/activities?keyword=xxx` でキーワード検索ができる
- [ ] activities.title, activities.translated_title, activities.translated_body, activities.summary, activities.version がOR検索対象となる
- [ ] data_sources.name がOR検索対象となる
- [ ] repositories.full_name がOR検索対象となる
- [ ] 大文字小文字を区別しない検索ができる（ILIKE）
- [ ] 部分一致検索ができる（`%keyword%`パターン）
- [ ] 他のフィルタパラメータ（activityType, status, since, until）と組み合わせて使用できる

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] 新規テストが全て通る
- [ ] lint/formatエラーがない
- [ ] OpenAPI仕様書が更新される

### セキュリティ要件

- [ ] JWT認証による適切なアクセス制御（既存の仕組みを維持）
- [ ] SQLインジェクション対策（Drizzle ORMのパラメータバインディングを使用）

## 7. 実装手順

### Phase 1: Domain層・Application層実装

- 1-1. `domain/activity.ts` の `ActivitiesListFilters` 型に `keyword` を追加
- 1-2. `application/use-cases/list-activities.helpers.ts` の型と正規化ロジックを更新
- 1-3. format, lint, コミット

### Phase 2: Infra層実装

- 2-1. `infra/repositories/drizzle-activity-query.repository.ts` の `buildWhereClause` にILIKE検索条件を追加
- 2-2. format, lint, コミット

### Phase 3: Presentation層実装

- 3-1. `presentation/schemas/activity-list-request.schema.ts` に `keyword` スキーマを追加
- 3-2. `presentation/routes/activities/index.ts` でユースケースに `keyword` を渡す
- 3-3. Component Testの作成・実行
- 3-4. OpenAPI仕様書の更新 (`pnpm openapi:update`)
- 3-5. format, lint, コミット

## 8. リスク・考慮事項

### 技術的リスク

- **パフォーマンス**: ILIKE検索は全文検索に比べて効率が悪い可能性がある。特にtranslated_body（長文フィールド）を含むため、大量データでの性能検証が必要
- **NULL値の扱い**: translated_title, translated_body, summary, versionはNULL許容。NULL値に対するILIKEは結果に含まれない（期待動作）

### 軽減策

- パフォーマンス問題が発生した場合はpg_search（PostgreSQL全文検索拡張）の導入を検討
- キーワードの最大文字数を100文字に制限
- body（英語原文）は検索対象から除外し、translated_body（翻訳本文）のみを対象とする

### 将来の拡張可能性

- フロントエンドでの検索UI追加
- pg_searchによる全文検索インデックスの導入
- 検索キーワードのハイライト機能
- body（英語原文）の検索対象への追加
