# SOW: CHASE-112: ドロップダウンメニューの高機能化とアクセシビリティ改善

## プロジェクト概要

**課題ID**: CHASE-112  
**作成日**: 2025-11-23  
**種別**: 実装改善 / 機能追加（フロントエンドUI）

## 1. 背景と目的

### 背景

- 既存の `ClAvatarMenu` はクリック/ESC/外部クリックでの開閉に留まり、キーボードナビゲーションやフォーカストラップ、ARIAの網羅が不足している。
- アバター以外でも再利用可能なドロップダウン基盤がなく、各所で同等の要件が発生した際に重複実装のリスクがある。
- デザイントークンにグラス効果や各状態のカラー定義がなく、デザイン要件（グラス風背景、滑らかなアニメーション、選択/ホバーの視覚表現）を統一的に適用しづらい。

### 目的

- キーボード操作（上下/Enter/Esc/Tab）を含むアクセシブルなドロップダウン基盤を整備し、`ClAvatarMenu` を安全に高機能化する。
- グラス風背景と状態別カラーをデザイントークンに追加し、UI表現を一貫させる。
- 再利用可能な base コンポーネントと composable を提供し、今後のメニュー系要件にも流用できる状態にする。

## 2. 実装スコープ

### 実装対象

- ドロップダウン基盤（`ClDropdownMenu`, `ClMenuItem`, `useDropdownMenu`）の新規実装。
- `ClAvatarMenu` を新基盤に乗せ換え、キーボードナビゲーション/フォーカストラップ/ARIAを補完。
- デザイントークンにメニュー用 semantic color を追加し、Tailwindテーマ/ユーティリティ生成を反映。
- Storybookとユニットテストで基本挙動とアクセシビリティ要件をカバー。

### 更新可能な項目

1. `packages/frontend/design-tokens.json` と生成物（`docs/design/tailwind-utilities.json`, `assets/css/tailwind.css`）の追加・更新。
2. `packages/frontend/composables/use-dropdown-menu.ts`（新規）および近接テスト。
3. `packages/frontend/components/base/ClDropdownMenu.vue` / `ClMenuItem.vue`（新規）と Storybook・テスト。
4. `packages/frontend/components/base/ClAvatarMenu.vue` と既存 Storybook/テストの置き換え対応。
5. 必要に応じ `components/base/layouts/ClHeader.vue` など既存参照箇所の呼び出し方法調整（破壊的変更が必要な場合のみ）。

### 実装除外項目

- Backend API・BFFの新規エンドポイント追加やスキーマ変更（今回不要）。
- メニュー内容の機能拡張（プロフィール遷移/ログアウト以外の項目追加はスコープ外）。
- 新規ページやルーティング追加。

## 3. 技術仕様

### API仕様

- 今回の実装で新規/変更するAPIはなし。既存の `useAuth` を引き続き利用（プロフィールリンクは既存の `/profile` ルートへ遷移）。

### データベース操作

- なし。

### アーキテクチャ設計

- **デザイントークン**: `color.semantic.light.menu` / `color.semantic.dark.menu` 配下に `bg/text/border`（default）を追加し、`children.item` の各状態（default/disabled/active/selected/hovered）を定義。追加後 `pnpm --filter frontend generate:tailwind-theme` を実行し、Tailwindテーマと `docs/design/tailwind-utilities.json` を同期。
- **Composable (`useDropdownMenu`)**: 開閉状態、アクティブインデックス、アイテム登録のローミングフォーカス管理、キーボードハンドラ（ArrowUp/Down, Enter/Space, Esc, Tab）、フォーカストラップ（メニュー外フォーカスやTab移動でクローズ）、外部クリック/スクロールによるクローズ、`aria-activedescendant` 連携を提供。SSRガードを入れ、クリーンアップを徹底。
- **`ClDropdownMenu.vue` (base)**: トリガースロットとメニュースロットを持つヘッドレス構成。`role="menu"` / `aria-labelledby` / `aria-expanded` / `aria-controls` を適用し、`Transition` でフェード+スケール（滑らかアニメーション）と `backdrop-blur` を付与。位置は右寄せを基本とし、ポータル不要の範囲で実装。
- **`ClMenuItem.vue` (base)**: `type="button" | "link"`、`to/href`、`disabled`、`selected`、`active`、`aria-pressed` 相当の表現を持つ。`role="menuitem"` or `menuitemcheckbox` を適宜適用し、`aria-disabled` を付与。ホバー/アクティブ/選択状態をデザイントークンのクラスで描画し、キーボード操作時のアクティブ行ハイライトを `aria-activedescendant` と連動。
- **`ClAvatarMenu.vue`**: 既存のクリック/ESC/外部クリック実装を `useDropdownMenu` ベースに置換。トリガーボタンに `aria-haspopup="menu"`, `aria-expanded`, `aria-controls` を付与。メニュー項目は `ClMenuItem` を用い、Enter/Space/クリックでプロフィール遷移・ログアウトを発火。メニュークローズ時にフォーカスをトリガーへ戻す。
- **ポジショニング**: `ClDropdownMenu` はコンテキストメニュー利用も見据え、渡された任意の座標（クライアント座標）に基づき表示できる API を提供し、右寄せ/アンカー基準の配置と併存させる。`ClAvatarMenu` から `ClDropdownMenu` を開く際は、`ClAvatarMenu` 自身の座標と高さを取得して下方向にオフセットした位置を基準とし、表示位置を制御する。
- **アクセシビリティ**: フォーカスリングの可視化（トークン準拠）、選択状態のコントラストを WCAG 2.1 AA 以上に確保。スクリーンリーダー向けにメニューラベルを `aria-label` / `aria-labelledby` で提供。ローミングフォーカスは `tabindex="-1"` 管理でTab移動時にメニューを閉じる。

## 4. 実装ファイル一覧

### 新規作成ファイル

1. `packages/frontend/composables/use-dropdown-menu.ts`
   - 開閉/ローミングフォーカス/キーボードハンドリング/外部クリック検知のロジック。
2. `packages/frontend/composables/__tests__/use-dropdown-menu.test.ts`
   - 開閉、ArrowUp/Downの循環、Enter/Space確定、Esc/Tab/外部クリックでのクローズを検証。
3. `packages/frontend/components/base/ClDropdownMenu.vue`
   - トリガーとメニューコンテナ（グラス効果、フェードイン/アウト）を持つベースコンポーネント。
4. `packages/frontend/components/base/ClMenuItem.vue`
   - 役割/状態を持つメニューアイテム。アイコン/ラベル/補助テキストをスロットで受け取れる構造。
5. `packages/frontend/components/base/__tests__/ClDropdownMenu.test.ts`
   - フォーカストラップ、ローミングフォーカス、ARIA属性、選択/ホバーの視覚状態クラス適用をカバー。
6. `packages/frontend/components/base/ClDropdownMenu.stories.ts` / `ClMenuItem.stories.ts`
   - キーボード操作デモ、状態別（default/hover/active/selected/disabled）、グラス背景を含む表示確認。

### 更新対象ファイル

1. `packages/frontend/design-tokens.json`（+生成物: `packages/frontend/docs/design/tailwind-utilities.json`, `packages/frontend/assets/css/tailwind.css`）
   - メニュー関連のsemantic color追加。
2. `packages/frontend/components/base/ClAvatarMenu.vue`
   - 新基盤への置換、ARIA/フォーカス戻し/キーボード操作対応、デザイントークン適用。
3. `packages/frontend/components/base/ClAvatarMenu.stories.ts`
   - 新しい `ClDropdownMenu`/`ClMenuItem` を用いた構成に更新し、操作説明をキーボード対応へ差し替え。
4. `packages/frontend/components/base/__tests__/ClAvatarMenu.test.ts`
   - キーボードナビゲーション（Arrow/Enter/Esc/Tab）とアクティブハイライトの検証を追加。
5. （必要に応じて）`packages/frontend/components/base/layouts/ClHeader.vue`
   - `ClAvatarMenu` の props/emit が変わる場合のみ調整（互換を保つ設計を優先）。

## 5. テスト戦略

### Component Test

- `ClDropdownMenu` と `ClMenuItem` のキーボード操作: ArrowUp/Downで循環、Enter/Spaceで選択、Esc/外部クリック/Tab離脱でクローズ。
- フォーカストラップ: メニュー内でTab移動→外へ出たらメニューが閉じ、トリガーへフォーカスが戻る。
- ARIA: `role="menu"`, `aria-activedescendant`, `aria-haspopup`, `aria-expanded`, `aria-disabled` の付与を検証。
- 視覚状態: active/selected/hovered/disabled でデザイントークン由来のクラスが適用されること。
- `ClAvatarMenu`: プロフィールリンク/ログアウトの発火、ユーザー情報表示の回帰、キーボード経路での実行。

### Unit Test（Composable）

- `useDropdownMenu` のステート遷移（open/close）、アイテム登録/解除、アクティブインデックスの循環、Enter/Space決定時のemit、Esc/Tab/外部クリック検知。

### Storybook

- `ClDropdownMenu` / `ClMenuItem` の状態別ストーリー、アクセシブルラベル、キーボードデモ。視覚的なグラス背景とアニメーションの確認を行う。

## 6. 受け入れ基準

### 機能要件

- [ ] ArrowUp/Down でメニュー項目を移動し、Enter/Space で決定できる。
- [ ] Esc またはメニュー外クリック/Tab離脱でメニューが閉じ、トリガーにフォーカスが戻る。
- [ ] 選択中の項目が視覚的にハイライトされ、ホバー/アクティブ/選択/無効状態がトークン準拠で表示される。
- [ ] `ClAvatarMenu` が新基盤で動作し、プロフィール遷移とログアウトが従来通り機能する。
- [ ] `ClDropdownMenu` が指定された任意の座標（コンテキストメニュー用途）で表示できる。
- [ ] `ClAvatarMenu` から開いた場合、アバターの直下を基準に位置調整される。

### 非機能要件

- [ ] WCAG 2.1 AA 相当のアクセシビリティ（フォーカス可視化、ARIA属性、コントラスト）を満たす。
- [ ] `pnpm format` / `pnpm lint` がエラーなく通る。
- [ ] 既存のテストスイートに回帰がない。

### セキュリティ要件

- [ ] メニューのイベントハンドラは SSR 環境で安全に動作し、不要なグローバルリスナーを残さない。
- [ ] 外部クリック検知で機密情報をログ出力しない。

## 7. 実装手順

### Phase 1: デザイントークン整備

- 1-1. `color.semantic.light.menu` / `dark.menu` と `children.item` の状態色を追加。
- 1-2. `pnpm --filter frontend generate:tailwind-theme` を実行し、生成物を確認。

### Phase 2: 基盤実装（Composable + Base Components）

- 2-1. `useDropdownMenu` を実装し、ユニットテストを作成。
- 2-2. `ClDropdownMenu` / `ClMenuItem` を実装し、コンポーネントテスト/Storybookを用意。

### Phase 3: 既存コンポーネント適用

- 3-1. `ClAvatarMenu` を新基盤に置換し、アクセシビリティ/キーボード対応を追加。
- 3-2. 既存テスト/Storybookを更新し、必要なら `ClHeader` 等の参照を調整。

### Phase 4: 検証・仕上げ

- 4-1. `pnpm format` / `pnpm lint` を実行。pnpm testについては、ユーザーに実行を依頼。

## 9. リスク・考慮事項

### 技術的リスク

- フォーカストラップや外部クリック検知が複数のメニューインスタンスと競合する可能性。
- デザイントークン生成後のユーティリティクラス名称が想定とずれると既存スタイルに影響を与えるリスク。
- SSR環境で `document`/`window` 参照をガードしないとビルド時エラーとなる可能性。

### 軽減策

- Composableでイベントリスナーをインスタンススコープで管理し、onUnmountedで必ず解除。インスタンスIDでの namespace 管理を検討。
- 生成後の `tailwind-utilities.json` を確認し、必要ならクラス名を修正したうえでUIを目視確認。
- `import.meta.client` ガードや `onMounted/onUnmounted` を徹底し、テストで SSR 環境を想定したモックを用意する。
