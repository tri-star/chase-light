# SOW: CHASE-94: ユーザー登録APIのフロントエンドへの組み込み

## プロジェクト概要

**課題ID**: CHASE-94
**作成日**: 2025-08-11
**種別**: 機能追加

## 1. 背景と目的

### 背景

現在のfrontendはAuth0を利用してログインする機能は実装されているものの、backend API上のユーザーを作成するAPIを呼び出していないため、backend APIを呼び出すことができない（Userが見つからないエラーになってしまう）状況です。

### 目的

Auth0での認証成功後、自動的にBackend API の `/api/auth/signup` を呼び出してBackend側にユーザーを登録し、フロントエンドからBackend APIを呼び出せるようにします。

## 2. 実装スコープ

### 実装対象

- Auth0コールバック処理でのBackend API ユーザー登録の追加
- エラーハンドリングとログ出力の実装
- Backend API呼び出し失敗時の適切な処理

### 実装内容

1. `packages/frontend/server/api/auth/callback.get.ts`内でのBackend API呼び出し追加
2. Orval生成のAPI関数`postApiAuthSignup`を利用したユーザー登録処理
3. Backend API呼び出し失敗時のセッション作成防止とログ出力

### 実装除外項目

- Auth0の認証フロー自体の変更
- セッション管理機構の変更
- Backend API側の変更

## 3. 技術仕様

### API仕様

#### 呼び出し先エンドポイント

Backend API: `POST /api/auth/signup`

#### 認証・認可

- Auth0から取得したIDトークンを使用
- フロントエンドのBFF経由でBackend APIを呼び出し

#### リクエスト仕様

```typescript
{
  "idToken": string // Auth0から取得したIDトークン
}
```

#### レスポンス仕様

正常系（200/201）：

```typescript
{
  "user": UserResponse,
  "message": string,
  "alreadyExists"?: boolean
}
```

エラー系（400/401/500）：

```typescript
{
  "success": false,
  "error": {
    "code": string,
    "message": string,
    "details"?: unknown
  }
}
```

### アーキテクチャ設計

既存のAuth0コールバック処理に以下を追加：

1. **Auth0認証成功後**: IDトークンを取得
2. **Backend API呼び出し**: `postApiAuthSignup`関数を使用
3. **成功時**: 既存のセッション作成処理を継続
4. **失敗時**: セッション作成を中止し、適切なエラーレスポンスを返却

## 4. 実装ファイル一覧

### 新規作成ファイル

なし（既存ファイルの修正のみ）

### 更新対象ファイル

1. **`packages/frontend/server/api/auth/callback.get.ts`**
   - Auth0認証成功後にBackend API呼び出し処理を追加
   - エラーハンドリングとログ出力を追加
   - Backend API呼び出し失敗時のセッション作成防止

## 5. テスト戦略

### Component Test（API層）

- Auth0認証成功 → Backend API呼び出し成功 → セッション作成成功
- Auth0認証成功 → Backend API呼び出し失敗 → セッション作成失敗
- Backend API呼び出しでのネットワークエラー処理
- Backend APIからの各種エラーレスポンス処理

### Unit Test

- 今回は実装しない（既存のテスト戦略に従い、APIルートはテスト対象外）

### E2E Test

- 既存の認証フローが正常に動作することを確認
- Backend APIとの連携が正常に動作することを確認

## 6. 受け入れ基準

### 機能要件

- [ ] Auth0認証後、自動的にBackend API `/api/auth/signup` が呼び出される
- [ ] Backend API呼び出し成功時、既存のセッション作成処理が正常に動作する
- [ ] Backend API呼び出し失敗時、セッションが作成されずログイン失敗となる
- [ ] 既存ユーザーの場合も正常に処理される（alreadyExistsフラグの処理）

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] Backend API呼び出しのタイムアウト処理が適切に動作する
- [ ] エラー時の適切なログ出力が行われる

### セキュリティ要件

- [ ] IDトークンが適切にBackend APIに渡される
- [ ] エラー情報にセンシティブな情報が含まれない
- [ ] Auth0ユーザーIDが適切にログに記録される

## 7. 実装手順

### Phase 1: Backend API呼び出し処理の実装

- 1-1. `packages/frontend/server/api/auth/callback.get.ts`にBackend API呼び出し処理を追加
- 1-2. Orval生成の`postApiAuthSignup`関数を利用した実装
- 1-3. IDトークンをリクエストボディに設定

### Phase 2: エラーハンドリングの実装

- 2-1. Backend API呼び出し失敗時のエラーハンドリング追加
- 2-2. Auth0ユーザーIDとエラー詳細のログ出力実装
- 2-3. セッション作成防止処理の実装

### Phase 3: テストとデバッグ

- 3-1. ローカル環境での動作確認
- 3-2. エラーケースの動作確認
- 3-3. 既存テストの実行確認

## 8. リスク・考慮事項

### 技術的リスク

- **Backend API接続エラー**: Backend APIが利用できない場合のユーザー体験の悪化
- **IDトークンの有効性**: IDトークンの形式や有効期限に関する問題
- **タイムアウト処理**: Backend API呼び出しの長時間応答時の処理

### 軽減策

- 適切なエラーメッセージとログ出力による問題の早期発見
- Backend API呼び出しのタイムアウト設定
- 段階的実装による動作確認

### 運用上の考慮事項

- Backend API側でのユーザー登録エラーログの監視が必要
- Auth0とBackend APIの整合性確認が重要
