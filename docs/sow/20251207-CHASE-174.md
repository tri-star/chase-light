# SOW: CHASE-174: アクティビティ本文翻訳リクエストAPI

## プロジェクト概要

**課題ID**: CHASE-174  
**作成日**: 2025-12-07  
**種別**: 新機能開発

## 1. 背景と目的

### 背景

- GitHubイベント検知時の翻訳はタイトル/要約中心で、`activities.translated_body` は空のまま運用されている。  
- 活動詳細閲覧で本文の日本語翻訳をオンデマンド取得したいが、現状はフロントから翻訳状態を確認できず、繰り返し実行やタイムアウトの懸念がある。  
- 既存のアクティビティステータス（`status`）は検知/要約処理の状態管理に使われており、本文翻訳の進行管理を同じフィールドで扱うと表示・通知フローに影響する。

### 目的

- ウォッチ対象のアクティビティ本文を日本語へ翻訳し `activities.translated_body` に保存するAPIを提供する。  
- 翻訳リクエストの進行状況を確認できるステータスAPIを用意し、二重実行・長時間待ちを防ぐ。  
- 既存の検知・通知フローを壊さず、本文翻訳専用の状態管理を追加する。

## 2. 実装スコープ

### 実装対象

- Backend（Hono）: アクティビティ本文翻訳のリクエストAPIとステータスAPI、翻訳実行ワーカーと関連ユースケース/リポジトリ/マイグレーション。

### 更新可能な項目

1. DBスキーマ（本文翻訳専用の状態・タイムスタンプ・エラー格納）とDrizzleスキーマ更新。  
2. ドメインモデル/ポート/ユースケース（翻訳リクエスト、ステータス参照、翻訳処理）。  
3. プレゼンテーション層のルートとZodスキーマ、OpenAPI更新。  
4. 翻訳実行ワーカー（OpenAIアダプタ再利用）とテスト（コンポーネント/ユニット）。  
5. 既存Activity取得系での新ステータス参照（表示/レスポンスへの取り込み範囲を必要最低限で検討）。

### 実装除外項目

- フロントエンドUIの改修。  
- 新しいデータソース種別対応や通知ダイジェストの仕様変更。  
- 多言語切替・翻訳プロバイダのスイッチング機能（今回は日本語固定、既存OpenAI設定を流用）。  
- 本文以外の追加翻訳（添付ファイル/コメントなど）。

## 3. 技術仕様

### API仕様

#### エンドポイント

```
POST /api/activities/{activityId}/translation/body        # 本文翻訳のリクエスト（idempotent、必要に応じ再翻訳）
GET  /api/activities/{activityId}/translation/body/status # 翻訳進行状況の取得
```

#### 認証・認可

- JWT必須（既存 `globalJWTAuth` + `requireAuth`）。  
- `user_watches` に紐づくデータソースのみアクセス可。非ウォッチ対象は404。  
- 権限外リソースや無効IDは404/400でマスクし、情報漏洩を防止。

#### リクエスト仕様（POST）

```typescript
{
  force?: boolean // trueで完了済みでも再翻訳を許可（デフォルト: falseで既存結果を再利用）
}
```

#### レスポンス仕様

- 共通ステータスフィールド（例）  
  `state`: `not_requested | pending | processing | completed | failed`  
  `requestedAt`, `startedAt`, `completedAt`, `error`  

- POST
  - 202: 新規/再翻訳を受理しキュー投入（`state` は `pending` or `processing`）  
  - 200: 既に翻訳済みで再利用 (`state = completed`, `translatedBody` 省略 or 返却)  
  - 409: `processing` 中に再度forceなしで呼ばれた場合の衝突扱い（要検討）

- GET
  - 200: 現在の進行状況を返却。`completed` の場合のみ `translatedBody` を含めるか、既存詳細APIで取得する方針を選択（レスポンス肥大を避けるなら状態のみ）。  
  - 404: 非ウォッチ or 未存在。

### データベース操作

- Drizzle kitでマイグレーションを生成（`pnpm db:generate`）。生成SQLに問題があれば手動修正せず報告。  
- `activities` テーブルに本文翻訳専用の状態管理カラムを追加（既存 `status` と分離）。  
  - `body_translation_status` text NOT NULL DEFAULT 'not_requested'  
  - `body_translation_requested_at` timestamptz  
  - `body_translation_started_at` timestamptz  
  - `body_translation_completed_at` timestamptz  
  - `body_translation_error` text  
  - インデックス: `idx_activities_body_translation_status`、`idx_activities_body_translation_requested_at`（キュー取得向け）  
- 既存カラム `translated_body` を翻訳完了時に更新。  
- 状態値は `not_requested/pending/processing/completed/failed` に限定し、フロント共通定数として `packages/shared` へ定義。

### アーキテクチャ設計

- **Domain**: 本文翻訳ステータス定義・ガード、翻訳ジョブのDTO/エンティティ、既存Activity型へのフィールド追加。  
- **Repository Port**: 本文翻訳状態の更新/ロック、Pending取得、翻訳結果の永続化用メソッドを追加。  
- **Translation Port**: 既存 OpenAI 翻訳ポートを再利用しつつ本文翻訳向けプロンプトを追加（タイトル/要約の既存処理と分岐）。  
- **UseCase**:  
  - `RequestActivityBodyTranslationUseCase`: アクセス権チェック、状態遷移（not_requested→pending/processing、force時の再実行）、キュー登録。  
  - `GetActivityBodyTranslationStatusUseCase`: 状態とタイムスタンプ/エラー/既存翻訳の返却。  
  - `ProcessActivityBodyTranslationUseCase`（ワーカー用）: pending→processing→completed/failed の遷移、翻訳結果保存、リトライ/エラーログ。  
- **Infra**: Drizzleリポジトリで新カラム対応とバルク取得・状態更新。既存 `activity.repository` を新規作成し本文翻訳用メソッドを集約。ワーカーは `features/activities/workers/translate-activity-body` として追加し、`TransactionManager` でトランザクション管理。  
- **Presentation**: `/activities/...` 配下に新ルート追加。Zodでパラメータ/レスポンスを型定義し、OpenAPIを更新。`processing` 中の重複リクエストは 409 を返却。  
- **データフロー（概要）**:  
  1. POSTリクエスト → ユースケースで権限確認 → 状態 `pending/processing` に遷移しジョブ登録 → 202返却。  
  2. ワーカーが `pending` を取得し `processing` へ更新 → OpenAI翻訳（本文まで） → `translated_body` 反映＋`completed`。失敗時は `failed` とエラー文言格納。  
  3. GETステータスで進行状況をポーリング。既存詳細APIで翻訳本文を参照可能にする（必要ならステータスAPIでも返却）。

## 4. 実装ファイル一覧

### 新規作成ファイル

1. `packages/backend/src/db/migrations/00xx_add_activity_body_translation_status.sql` — 追加カラムとインデックスのマイグレーション（Drizzle kit生成物）。  
2. `packages/backend/src/features/activities/domain/activity-body-translation.ts` — ステータス定義とヘルパ。  
3. `packages/backend/src/features/activities/domain/repositories/activity.repository.ts` — 本文翻訳用メソッドを含むリポジトリポート（新規）。  
4. `packages/backend/src/features/activities/infra/repositories/drizzle-activity.repository.ts` — 本文翻訳カラム対応のDrizzle実装（activities配下に新設）。  
5. `packages/backend/src/features/activities/application/ports/activity-body-translation.port.ts` — 本文翻訳向けポート（既存翻訳ポートをactivities配下に配置）。  
6. `packages/backend/src/features/activities/infra/adapters/translation/translation.adapter.ts` ほかスタブ — 翻訳アダプタをactivities配下で管理。  
7. `packages/backend/src/features/activities/application/use-cases/request-activity-body-translation.use-case.ts`  
8. `packages/backend/src/features/activities/application/use-cases/get-activity-body-translation-status.use-case.ts`  
9. `packages/backend/src/features/activities/application/use-cases/process-activity-body-translation.use-case.ts`  
10. `packages/backend/src/features/activities/presentation/routes/activity-body-translation/index.ts` — `/translation/body` ルート群。  
11. `packages/backend/src/features/activities/presentation/schemas/activity-body-translation-request.schema.ts`  
12. `packages/backend/src/features/activities/presentation/schemas/activity-body-translation-status-response.schema.ts`  
13. `packages/backend/src/features/activities/workers/translate-activity-body/handler.ts`  
14. `packages/backend/src/features/activities/workers/translate-activity-body/__tests__/handler.test.ts`  
15. `packages/shared/src/constants/activity-body-translation.ts` — ステータス定義共有。

### 更新対象ファイル

1. `packages/backend/src/db/schema.ts` — 新カラム/インデックスの定義。  
2. `packages/backend/src/features/activities/domain/activity.ts` — Activity型に本文翻訳ステータスを追加。  
3. `packages/backend/src/features/activities/infra/repositories/drizzle-activity-query.repository.ts` — ステータス/翻訳本文の選択・レスポンスマッピング調整。  
4. `packages/backend/src/features/detection/infra/repositories/drizzle-activity.repository.ts` — upsert/updateで新カラムのデフォルト値を保持。  
5. `packages/backend/src/features/detection/application/ports/translation.port.ts` および `infra/adapters/translation/*.ts` — 本文翻訳用プロンプト/出力フィールド対応（共通ポート化を検討）。  
6. `packages/backend/src/features/activities/index.ts` — 新ルート/ワーカーのエクスポート/組み込み。  
7. `packages/backend/src/features/activities/presentation/routes.ts`（ルート集約） — 新ルート登録。  
8. 既存テストファイル（Activity一覧/詳細のレスポンスが新フィールドを持つ場合の更新）。

## 5. テスト戦略

### Component Test（Presentation層）

- ウォッチユーザーが翻訳リクエストを送信し202を受け取る。  
- 非ウォッチ/存在しないIDの場合に404となる。  
- `processing` 中に重複リクエストを送った場合に409を返す。  
- ステータスAPIが `not_requested/pending/processing/completed/failed` を正しく返す。  
- 翻訳完了後に詳細取得APIで `translatedBody` が返却されること（必要に応じて）。

### Worker Component Test（Integration）

- pending→processing→completed の正常系（翻訳ポートをスタブ）。  
- OpenAIエラー時の `failed` 遷移とエラーメッセージ記録。  
- 大きな本文/空本文の扱い（トリミングやバリデーション）。  
- 状態遷移ガード（completed時のforceなし再実行不可、forceありで再実行など）もワーカー経由でカバー。  
- UseCase単体テストはスコープ外（ワーカーcomponentで担保）。

## 6. 受け入れ基準

### 機能要件

- [ ] JWT認証済みかつウォッチ対象のアクティビティに対し、本文翻訳リクエストが行える。  
- [ ] 翻訳処理が完了すると `activities.translated_body` が日本語で更新され、本文翻訳ステータスが `completed` になる。  
- [ ] ステータスAPIが `not_requested/pending/processing/completed/failed` を返し、タイムスタンプとエラー情報を含む。  
- [ ] 非ウォッチ/存在しないアクティビティへのリクエストは404で情報を隠蔽する。  
- [ ] 再リクエスト時の挙動（既にcompletedの再利用、force指定時の再翻訳）が仕様通りである。

### 非機能要件

- [ ] 既存テストに加え、新規テストが追加され `pnpm --filter backend test` が成功する。  
- [ ] OpenAPIドキュメントが新エンドポイントを反映する。  
- [ ] トランザクション/ロギングにより失敗時の調査が可能。

### セキュリティ要件

- [ ] 認可チェックは `user_watches` を基準に行い、権限外リソースの存在を秘匿する。  
- [ ] 翻訳入力はサニタイズし、プロンプトインジェクションを緩和する。  
- [ ] OpenAI APIキーなど機密情報は既存設定を再利用し、新規に露出させない。

## 7. 実装手順

### Phase 1: DB/Domain整理

- 1-1. マイグレーション追加（新カラム・インデックス）。  
- 1-2. Drizzleスキーマとドメイン定義更新（状態定数/型）。  
- 1-3. format, lint（該当部分）。

### Phase 2: UseCase/Infra実装

- 2-1. リポジトリポート/実装とユースケース3種（リクエスト/ステータス/処理）を追加。  
- 2-2. 翻訳ポート/アダプタを本文翻訳対応へ拡張（プロンプト/レスポンス）。  
- 2-3. ワーカー実装とユニットテスト。  
- 2-4. format, lint。

### Phase 3: Presentation/統合テスト

- 3-1. ルートとZodスキーマ追加、OpenAPI更新。  
- 3-2. コンポーネントテスト（ルート + ワーカー連携）を作成。  
- 3-3. `pnpm --filter backend test` 実行で回帰確認。  
- 3-4. format, lint。

## 9. リスク・考慮事項

### 技術的リスク

- OpenAIレスポンス遅延・429による失敗。  
- 本文長がモデル上限を超える場合の失敗。  
- 並列リクエストによる二重翻訳/競合。  
- 既存 `status` との混同による一覧/通知への影響。

### 軽減策

- リトライやバックオフ設定、`processing` 中リクエストの弾き方を定義。  
- モデル入力長のバリデーション/トリミング（事前チェック）を実装。  
- 状態更新をトランザクションで実施し、ユニークな `processing` 移行を保証。  
- 本文翻訳ステータスを既存 `status` と分離し、既存クエリには影響を与えない方針で進める。
