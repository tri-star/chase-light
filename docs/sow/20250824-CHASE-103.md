# SOW: CHASE-103: ダークモード対応

## プロジェクト概要

**課題ID**: CHASE-103
**作成日**: 2025-08-24
**種別**: 新機能開発

## 1. 背景と目的

### 背景

現在のデザイントークンにはライトモードしか存在しない状況です。また、デザインシステムでは「ややプリミティブ寄りのセマンティックなトークン」を定義する方針としており、これを活用したライトモード/ダークモード切り替え対応が求められています。

### 目的

- 既存のデザイントークンシステムを拡張し、ダークモード対応を実現する
- ユーザー設定により、ライトモード/ダークモードの切り替えを可能にする
- セマンティックなカラートークンを活用し、保守性の高い実装を行う

## 2. 実装スコープ

### 実装対象

- ダークモード用のデザイントークン定義
- デザイントークン変換スクリプトの拡張（ダークモード対応）
- フロントエンドでのテーマ切り替えコンポーネント
- ユーザー設定画面でのダークモード設定機能
- 既存コンポーネントのダークモード対応

### 実装内容

1. **デザイントークンの再構造化**
   - `color.semantic`を`light`/`dark`階層に分離
   - 既存トークンのライトモードへの移動
   - ダークモード用トークンの新規定義

2. **デザイントークン変換スクリプトの拡張**
   - テーマ別トークンの解析処理
   - ライト/ダーク別のCSS変数生成
   - Tailwind CSS v4でのダークモード対応

3. **フロントエンド機能**
   - テーマ切り替えComposable (`useTheme`)
   - テーマ切り替えコンポーネント
   - ユーザー設定画面での設定項目追加

### 実装除外項目

- バックエンドAPIの変更（今回はフロントエンド側の設定として扱う）
- 既存コンポーネントの個別ダークモード調整（基本的にはトークンレベルで対応）

## 3. 技術仕様

### デザイントークン設計

#### ダークモード用カラートークンの追加

既存の`color.semantic`構造を拡張し、`light`と`dark`を上位階層に配置してテーマごとに完全分離：

```json
{
  "color": {
    "semantic": {
      "light": {
        "content": {
          "default": {
            "bg": { "value": "{color.primitive.white}" },
            "text": { "value": "{color.primitive.gray.900}" }
          }
        },
        "surface": {
          "primary": {
            "default": {
              "bg": { "value": "{color.primitive.blue.500}" },
              "text": { "value": "{color.primitive.white}" }
            }
          }
        }
      },
      "dark": {
        "content": {
          "default": {
            "bg": { "value": "{color.primitive.gray.900}" },
            "text": { "value": "{color.primitive.gray.100}" }
          }
        },
        "surface": {
          "primary": {
            "default": {
              "bg": { "value": "{color.primitive.blue.400}" },
              "text": { "value": "{color.primitive.white}" }
            }
          }
        }
      }
    }
  }
}
```

#### CSS変数の出力形式

```css
@theme {
  --color-content-default-bg: oklch(100% 0 none);
  --color-content-default-text: oklch(27.85% 0.0132 253.04);
  --color-surface-primary-default-bg: oklch(53.992% 0.19058 257.48);
}

:root[data-theme="dark"] {
  --color-content-default-bg: oklch(27.85% 0.0132 253.04);
  --color-content-default-text: oklch(94.722% 0.00689 247.9);
  --color-surface-primary-default-bg: oklch(64.176% 0.19508 254.98);
}
```

### フロントエンド実装

#### Composable: `useTheme`

```typescript
interface ThemeConfig {
  theme: "light" | "dark" | "system";
  setTheme: (theme: "light" | "dark" | "system") => void;
  currentTheme: "light" | "dark";
}
```

機能：

- ローカルストレージでの設定永続化
- システム設定の自動検出（`prefers-color-scheme`）
- HTML要素への`data-theme`属性の自動適用

#### コンポーネント仕様

- **テーマ切り替えコンポーネント**: ドロップダウンまたはトグルボタン形式
- **ユーザー設定画面**: 既存の設定フォームにテーマ設定を追加

### デザイントークン変換スクリプトの拡張

#### 変更対象ファイル

1. **`types.ts`**: ライト/ダークモード対応の型定義追加
2. **`token-parser.ts`**: ライト/ダークモード別のトークン解析機能
3. **`tailwind-generator.ts`**: `:root[data-theme="dark"]`セレクター内でのCSS変数生成

#### 出力ファイル構成

- packages/frontend/assets/css/tailwind.css
  - TailwindCSS v4 用テーマ定義。ライト/ダーク両方の変数を含む

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/frontend/composables/useTheme.ts`**
   - テーマ切り替えロジック
   - ローカルストレージ管理
   - システム設定検出

2. **`packages/frontend/components/ThemeSelector.vue`**
   - テーマ切り替えUI コンポーネント

### 更新対象ファイル

1. **`packages/frontend/design-tokens.json`**
   - `color.semantic`を`light`/`dark`階層に再構造化
   - 既存セマンティックトークンを`color.semantic.light`配下に移動
   - ダークモード用トークンを`color.semantic.dark`配下に新規作成

2. **`packages/frontend/scripts/design-token-converter/types.ts`**
   - テーマ別処理対応の型定義

3. **`packages/frontend/scripts/design-token-converter/token-parser.ts`**
   - テーマ別トークンの解析機能
   - `light`/`dark`階層での参照解決機能

4. **`packages/frontend/scripts/design-token-converter/tailwind-generator.ts`**
   - テーマ別CSS変数の生成機能
   - `:root[data-theme="dark"]`セレクター対応のCSS生成

5. **`packages/frontend/pages/settings/index.vue`**（存在する場合）
   - テーマ設定項目の追加

6. **`packages/frontend/app.vue`** または **レイアウトファイル**
   - `useTheme`の初期化
   - HTML `data-theme`属性適用

## 5. テスト戦略

### Component Test

- **`ThemeSelector.vue`**: テーマ切り替えの動作確認
- **設定ページ**: テーマ設定の保存・読み込み確認

### Unit Test

- **`useTheme`**:
  - テーマ切り替えロジック
  - ローカルストレージ操作
  - システム設定検出

### デザイントークン変換テスト

- **変換スクリプト**:
  - ライト/ダークモード別のCSS生成確認
  - トークン参照解決の正確性確認

### Visual Regression Test

- 主要ページでのライト/ダークモード表示確認（手動確認）

## 6. 受け入れ基準

### 機能要件

- [ ] ライトモード/ダークモードの切り替えが正常に動作する
- [ ] システム設定（`prefers-color-scheme`）の自動検出が動作する
- [ ] テーマ設定がブラウザ再起動後も保持される
- [ ] 既存のデザイントークンベースのコンポーネントでダークモードが適用される

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] デザイントークン変換処理のパフォーマンスが著しく劣化しない
- [ ] テーマ切り替え時の表示崩れがない

### セキュリティ要件

- [ ] ローカルストレージへの不正な値の注入に対する適切な処理

## 7. 実装手順

### Phase 1: デザイントークン再構造化

- 1-1. 既存の`color.semantic`トークンを`color.semantic.light`へ移動
- 1-2. ダークモード用トークンを`color.semantic.dark`に新規定義
- 1-3. プリミティブカラーでのダークモード調色検討・実装

### Phase 2: デザイントークン変換スクリプト拡張

- 2-1. 型定義の更新（テーマ別構造対応）
- 2-2. `token-parser.ts`のテーマ別解析機能実装
- 2-3. `tailwind-generator.ts`のテーマ別CSS変数生成実装
- 2-4. 変換スクリプトのテスト作成・実行

### Phase 3: フロントエンド機能実装

- 3-1. `useTheme` Composable実装
- 3-2. `ThemeSelector`コンポーネント実装
- 3-3. アプリケーションレイアウトへの統合
- 3-4. ユーザー設定画面への組み込み（存在する場合）

### Phase 4: テスト・検証

- 4-1. 単体テストの実行
- 4-2. 主要ページでの動作確認
- 4-3. 各種ブラウザでの表示確認

## 8. リスク・考慮事項

### 技術的リスク

- **既存コンポーネントへの影響**: セマンティックトークンを使用していないコンポーネントでの表示問題
- **トークン参照の破綻**: `color.semantic`から`color.semantic.light`への参照変更による既存参照の無効化
- **パフォーマンス**: CSS変数の増加による描画パフォーマンスへの影響
- **ブラウザ互換性**: OkLCH形式とダークモード機能の組み合わせ
- **構造一貫性**: light/dark間でのトークン構造の divergence

### 軽減策

- 段階的実装による既存機能への影響最小化
- **バリデーション機能の実装**: light/dark間の構造一貫性チェック
- **テンプレート機能の実装**: 新規トークン追加時のlight/dark自動生成
- 主要ブラウザでの事前検証
- パフォーマンス測定による影響評価

### その他の考慮事項

- **将来拡張**: システム設定以外のテーマ（ハイコントラストモードなど）への対応準備
- **アクセシビリティ**: ダークモードでのコントラスト比確保
- **デザインシステムの一貫性**: ダークモード用デザインガイドライン策定
