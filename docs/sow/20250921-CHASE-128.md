# SOW: CHASE-128: authのフォルダ構造見直し

## プロジェクト概要

**課題ID**: CHASE-128
**作成日**: 2025-09-21
**種別**: リファクタリング

## 1. 背景と目的

### 背景

- `packages/backend/src/features/auth` 配下でグローバルなJWT認証ミドルウェア・エラー・型・設定が管理されており、他フィーチャーが機能境界に依存している。
- 新しいアーキテクチャ方針では境界づけられたコンテキストを縦方向に閉じ、共通基盤は `core` へ集約する必要があるが、現状は `features/auth` が基盤的な役割とユースケースの双方を担い責務が混在している。
- 認証系コードの配置が不統一なため、フォルダ構成ガイドラインとの不整合や命名上の混乱が発生しており、さらに将来的なNPM対応などクロスカッティングな変更に追従しづらい。

### 目的

- 認証ミドルウェア・エラー・型・設定を `core` 配下に移し、全フィーチャーから共有できる基盤として再構成する。
- `features/auth` を `features/identity` に改称し、Identity固有のユースケース（例: サインアップAPI）に責務を限定する。
- JWTバリデータをポート/アダプタ構成へ再整理し、テストスタブを含めた実装差し替えを容易にする。
- 依存方向を整理することで lint/type チェックで検知される循環依存や import 先の不整合を解消する。

## 2. 実装スコープ

### 実装対象

- `packages/backend` 配下の認証/Identity関連コードリファクタリング
- グローバルJWTミドルウェアの `core` への移設と再配線
- Identityフィーチャーのフォルダ構造・エクスポート整理

### 更新可能な項目

1. `features/auth` -> `features/identity` へのディレクトリ改称と index エクスポートの更新
2. JWT認証ミドルウェア・エラー・型・除外設定の `core/auth` への移植とモジュール分割
3. `features/identity/application/ports/jwt-validator.port.ts` と `infra/adapters/jwt-validator/*` の新設（本番/テスト実装・ファクトリ）
4. `AuthSignupService` を新しいレイヤ構成へ移行（`application/use-cases/sign-up.use-case.ts` 相当）し、プレゼンテーション層の依存を更新
5. `app.ts` およびバックエンド各所の import 先・DI 初期化の更新
6. 既存テスト（ミドルウェア、サインアップAPI、E2E補助ルート等）のパス更新と追加テスト整備

### 実装除外項目

- フロントエンド / shared パッケージのコード変更
- 認証APIの入出力仕様変更や追加エンドポイント実装
- DBスキーマの拡張・マイグレーション・データ投入処理
- Auth0設定値・環境変数の新規追加（利用方法の整理のみ）

## 3. 技術仕様

### API仕様

#### エンドポイント

```
POST /api/auth/signup
```

#### 認証・認可

- route自体は引き続きグローバル認証除外（`core/auth` の除外設定にて管理）
- その他のAPIは `core/auth` 提供のJWTミドルウェア経由で保護

#### リクエスト仕様

- 既存の `idToken` を含むJSONボディを維持（スキーマ変更なし）

#### レスポンス仕様

- 既存レスポンス (`user`, `message`, `alreadyExists`) を維持

### データベース操作

- `users` テーブルへの `insert` / `update` 処理フローは従来通り、追加スキーマ変更なし
- トランザクションやRepositoryインターフェースの変更は行わない（呼び出し元の構造整理のみ）

### アーキテクチャ設計

- `core/auth` 配下に以下の構成を新設
  - `middleware/` : `createJWTAuthMiddleware`, `createExclusiveJWTAuthMiddleware`, `auth-exclusions` 等
  - `errors/` : `AuthError`, `AuthErrorCode`
  - `types/` : `JWTPayload`, `AuthenticatedUser`, `AuthContext` など
  - `index.ts` : 外部公開用バレル
- `features/identity` 配下
  - `application/ports/jwt-validator.port.ts` でValidatorポートを定義（`validateAccessToken`, `validateIdToken`）
  - `infra/adapters/jwt-validator/` で本番用アダプタ・スタブ・ファクトリを実装
  - `application/use-cases/sign-up.use-case.ts`（旧 `auth-signup.service.ts`）へ移行し、DIでポート利用
  - `presentation/routes/signup.route.ts` 等へ再配置し、`index.ts` でバレル化
  - `test-helpers/` を `infra` または `application` 配下へ再配置し、モックバリデータを利用
- `core/auth` のミドルウェアは Validator ポートインスタンスを受け取る形に変更し、`features/identity` がファクトリを注入して `globalJWTAuth` を生成

## 4. 実装ファイル一覧

### 新規作成ファイル

1. `packages/backend/src/core/auth/index.ts`
   - core層で公開する認証ミドルウェア・型・エラーをエクスポート
2. `packages/backend/src/core/auth/middleware/jwt-auth.middleware.ts`
   - Validatorポートを受け取る汎用JWTミドルウェアを実装
3. `packages/backend/src/core/auth/middleware/exclusive-jwt-auth.middleware.ts`
   - 除外設定付きミドルウェアと `createGlobalJWTAuth` 相当の組み立てを提供
4. `packages/backend/src/core/auth/middleware/auth-exclusions.ts`
   - 除外設定とENV連携を保持
5. `packages/backend/src/core/auth/errors/auth-error.ts`
   - 認証ドメインのエラー型を移設
6. `packages/backend/src/core/auth/types/auth.types.ts`
   - 認証系共通型を移設し、Honoコンテキスト拡張を維持
7. `packages/backend/src/features/identity/application/ports/jwt-validator.port.ts`
   - JWTバリデータポート／型定義
8. `packages/backend/src/features/identity/application/ports/jwt-validator-factory.port.ts`
   - JWTバリデータのファクトリのポート／型定義
9. `packages/backend/src/features/identity/infra/adapters/jwt-validator/jwt-validator.adapter.ts`
   - 本番用バリデータ（旧 `JWTValidator`）
10. `packages/backend/src/features/identity/infra/adapters/jwt-validator/stub-jwt-validator.adapter.ts`

- テスト用スタブ（旧 `MockJWTValidator`）

11. `packages/backend/src/features/identity/infra/adapters/jwt-validator/jwt-validator.factory.ts`
    - 環境に応じたアダプタ選択
12. `packages/backend/src/features/identity/application/use-cases/signup/sign-up.use-case.ts`
    - サインアップユースケース実装
13. `packages/backend/src/features/identity/presentation/routes/signup/index.ts`
    - サインアップエンドポイント実装（既存ロジックを移設）

### 更新対象ファイル

1. `packages/backend/src/app.ts`
   - `features/identity` / `core/auth` からのエクスポートへ import を更新
2. `packages/backend/src/features/identity/index.ts`（旧 `features/auth/index.ts`）
   - バレル内容と公開関数の再整理
3. `packages/backend/src/features/identity/presentation/index.ts`（必要に応じて新設/更新）
4. `packages/backend/src/features/identity` 以下のテストファイル
   - import パスとDI差し替え方法の更新
5. `packages/backend/src/features/data-sources/.../__tests__/*.test.ts`
   - `globalJWTAuth` の import パスを更新
6. `packages/backend/src/features/user/.../__tests__/*.test.ts`
   - `globalJWTAuth` の import パスを更新
7. `docs/task-logs` などで `features/auth` を参照している設計メモ（必要に応じて更新）
   - OWNER追記： これらのファイルは更新しない
8. ルートエクスポートやビルド設定（`exports` / `tsconfig` 相対パスが影響する場合）

## 5. テスト戦略

### Component Test（Presentation層）

- `POST /api/auth/signup` の正常系 / 既存ユーザー更新 / バリデーションエラー / 認証エラー（スタブ差し替え）
- `globalJWTAuth` を通過するAPIの認証除外設定確認（例: `/health`, `/api/auth/signup`）
- 認証必須ルートに対する401レスポンスの確認（`features/data-sources` 等の既存テストを更新）

### Unit Test（Service/Use-case層）

- サインアップユースケースのIDトークン検証モックを用いた正常系・例外系
- JWTバリデータファクトリの環境変数分岐確認（prod/test）

### Unit Test（Coreミドルウェア）

- `isPathExcluded` の各条件分岐
- オプショナル認証モードでの挙動
- トークン欠如/無効時のエラーラップと `AuthError` へのマッピング

## 6. 受け入れ基準

### 機能要件

- [ ] `POST /api/auth/signup` が従来通り動作し、レスポンス形式・ステータスに変更がない
- [ ] 認証除外パスが `core/auth` の設定で一元管理され、既存除外対象が維持される
- [ ] 認証必須APIで未認証アクセス時に401が返る

### 非機能要件

- [ ] `pnpm --filter backend lint` / `pnpm --filter backend test` が成功する
- [ ] import パスの循環やESLintの依存ルール違反が発生しない
- [ ] 新旧構成のドキュメントが更新され、開発者が差異を理解できる

### セキュリティ要件

- [ ] JWT検証ロジックが `core` 移設後もAuth0署名検証を維持
- [ ] 認証エラー情報の取り扱いが変わらず、詳細情報の漏洩がない
- [ ] テストスタブ利用時でも本番コードにスタブが混入しない（DIで明示的に切り替え）

## 7. 実装手順

### Phase 1: Core抽出

- 1-1. 認証ミドルウェア・エラー・型・除外設定を `core/auth` へ移設
- 1-2. `core/auth/index.ts` を作成し公開APIを定義
- 1-3. 既存テストを一時的に参照できるよう import を修正

### Phase 2: Identityフィーチャー再構成

- 2-1. ディレクトリを `features/identity` へリネームし、レイヤ構成（application/infra/presentation）を整備
- 2-2. JWTバリデータのポート・アダプタ・ファクトリを実装し、ユースケース/プレゼンテーションへ依存注入
- 2-3. サインアップユースケースとスキーマを再配置し、indexエクスポートを更新

### Phase 3: 配線・テスト更新

- 3-1. `app.ts` と他フィーチャーのミドルウェア import を `features/identity`/`core` ベースへ更新
- 3-2. 既存コンポーネントテストを新しいスタブDIに合わせて修正
- 3-3. 新規/更新テストを実行し、lint/testをクリア

### Phase 4: ドキュメント整備

- 4-1. 関連ドキュメント（フォルダ構成ガイドライン等）の `features/auth` 記述を `features/identity` に更新
- 4-2. リファクタリング内容をタスクログへ記載

## 9. リスク・考慮事項

### 技術的リスク

- **依存関係の循環**: `core` と `features/identity` 間でポート型の所在を誤ると循環参照が発生する
- **テストスタブ切替漏れ**: ミドルウェアが常に本番バリデータを生成するとテストが外部Auth0に依存してしまう
- **リネーム差分の取りこぼし**: ディレクトリ改称による import パス更新漏れでビルドが失敗する

### 軽減策

- ポート型を共通で再利用できるよう `core` と `identity` の境界方針を先に確定し、型の所在を明文化
- JWTバリデータはファクトリ経由で注入し、テストセットアップでスタブを明示的に使用
- `rg "features/auth"` 等で旧パスを一括検出し、レビュー時にチェックリスト化
