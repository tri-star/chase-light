# SOW: CHASE-132: eventsテーブルの見直し

## プロジェクト概要

**課題ID**: CHASE-132
**作成日**: 2025-10-01
**種別**: リファクタリング

## 1. 背景と目的

### 背景

従来、GitHubのリリース・PR・Issueなどの情報を「イベント(event)」として表現していましたが、フォルダ構造の見直しに伴い、これらを「アクティビティ(activity)」という用語に変更しました。

現在、アプリケーションコード側（TypeScript）では既にリネームが完了していますが、データベーススキーマでは依然として `events` テーブル、`eventType` カラム、`eventId` カラムなどの命名が残っています。

### 目的

- データベーススキーマとアプリケーションコードの用語を統一する
- `events` テーブルを `activities` テーブルにリネーム
- `eventType` カラムを `activityType` カラムにリネーム
- `eventId` パラメータを `activityId` にリネーム
- ただし、`githubEventId`（GitHubのイベントID）や Lambda/StepFunctions の `event` パラメータ（AWSのイベント）は対象外

## 2. 実装スコープ

### 実装対象

1. **DBスキーマの変更**
   - `events` テーブル → `activities` テーブル
   - `eventType` カラム → `activityType` カラム
   - notifications テーブルの `eventId` → `activityId`
   - リレーション定義のリネーム

2. **TypeScriptコードの変更**
   - schema.ts の export 定義
   - Repository実装でのテーブル参照
   - Repository インターフェースのパラメータ名
   - テストファクトリのメソッド名
   - コメント内の「イベント」→「アクティビティ」

3. **マイグレーションファイルの生成**
   - Drizzle Kit を使用して schema.ts から自動生成
   - テーブル名変更
   - カラム名変更
   - インデックス名変更
   - 外部キー制約の更新

### リネーム対象外

- `githubEventId` フィールド（GitHubのイベントIDを表すため）
- Lambda/StepFunctions ハンドラーの `event` パラメータ（AWSのイベントを表すため）
- DOMイベント関連（フロントエンド）

## 3. 技術仕様

### データベース変更

このプロジェクトでは **Drizzle Kit** を使用しているため、マイグレーションSQLファイルは手動で作成せず、schema.tsの変更から自動生成します。

#### 変更の流れ

1. `packages/backend/src/db/schema.ts` を変更
2. `pnpm --filter backend db:generate` でマイグレーションファイルを自動生成
3. 生成されたマイグレーションファイルの内容を確認
4. `pnpm --filter backend db:migrate` でマイグレーションを実行

#### schema.ts での変更内容

**テーブル名の変更**

```typescript
// Before
export const events = pgTable("events", { ... })

// After
export const activities = pgTable("activities", { ... })
```

**カラム名の変更**

```typescript
// activities テーブル
// Before: eventType: text("event_type")
// After:  activityType: text("activity_type")

// notifications テーブル
// Before: eventId: uuid("event_id")
// After:  activityId: uuid("activity_id")
```

**インデックス名の変更**

Drizzle Kitがテーブル名・カラム名の変更を検出し、適切なマイグレーションSQLを生成します。

```typescript
// Before
dataSourceIdIdx: index("idx_events_data_source_id").on(table.dataSourceId)

// After
dataSourceIdIdx: index("idx_activities_data_source_id").on(table.dataSourceId)
```

### TypeScript コード変更

#### schema.ts の変更

```typescript
// Before
export const events = pgTable(...)
export const eventsRelations = relations(events, ...)

// After
export const activities = pgTable(...)
export const activitiesRelations = relations(activities, ...)
```

#### Repository実装の変更

```typescript
// Before
import { events } from "../../../../db/schema"
.from(events)
.where(eq(events.id, eventId))

// After
import { activities } from "../../../../db/schema"
.from(activities)
.where(eq(activities.id, activityId))
```

#### Repository インターフェースの変更

```typescript
// Before
findByIds(eventIds: string[]): Promise<Activity[]>
updateStatus(eventId: string, ...): Promise<boolean>

// After
findByIds(activityIds: string[]): Promise<Activity[]>
updateStatus(activityId: string, ...): Promise<boolean>
```

## 4. 実装ファイル一覧

### 更新対象ファイル

1. **packages/backend/src/db/schema.ts**
   - `events` テーブル定義を `activities` にリネーム
   - `eventsRelations` を `activitiesRelations` にリネーム
   - `eventType` カラムを `activityType` にリネーム
   - notifications テーブルの `eventId` を `activityId` にリネーム

2. **packages/backend/src/features/detection/infra/repositories/drizzle-activity.repository.ts**
   - `events` インポートを `activities` に変更
   - 全ての `events.` 参照を `activities.` に変更
   - `events.eventType` を `activities.activityType` に変更
   - メソッドパラメータ `eventId` を `activityId` に変更
   - メソッドパラメータ `eventIds` を `activityIds` に変更
   - コメント内の「イベント」を「アクティビティ」に変更

3. **packages/backend/src/features/detection/domain/repositories/activity.repository.ts**
   - メソッドパラメータ `eventId` を `activityId` に変更
   - メソッドパラメータ `eventIds` を `activityIds` に変更
   - コメント内の「イベント」を「アクティビティ」に変更

4. **packages/backend/src/features/data-sources/repositories/data-source.repository.ts**
   - `events` インポートを `activities` に変更
   - SQL内の `events` 参照を `activities` に変更

5. **packages/backend/src/test/factories.ts**
   - `createTestEvent` メソッドを `createTestActivity` にリネーム
   - `events` テーブル参照を `activities` に変更
   - `createTestNotification` メソッドのパラメータ `eventId` を `activityId` に変更

6. **packages/backend/src/features/data-sources/presentation/routes/data-sources/__tests__/index.test.ts**
   - `events` テーブル参照を `activities` に変更

### 自動生成ファイル

1. **packages/backend/src/db/migrations/0007_*.sql**
   - Drizzle Kitが schema.ts の変更から自動生成
   - テーブル名変更のマイグレーション
   - カラム名変更のマイグレーション
   - インデックス名変更のマイグレーション

2. **packages/backend/src/db/migrations/meta/0007_snapshot.json**
   - Drizzle Kitが生成するスキーマスナップショット

## 5. テスト戦略

### マイグレーションテスト

- マイグレーション実行前後でデータが失われないことを確認
- マイグレーション実行後に既存のテストが全て通ることを確認

### Component Test（Presentation層）

- 既存のテストが全て通ることを確認
- データソース削除のテストで activities テーブルが正しく削除されることを確認

### Unit Test（Repository層）

- 既存のテストが全て通ることを確認
- ActivityRepository のメソッドが正しく動作することを確認

## 6. 受け入れ基準

### 機能要件

- [ ] `events` テーブルが `activities` テーブルにリネームされている
- [ ] `eventType` カラムが `activityType` カラムにリネームされている
- [ ] notifications テーブルの `eventId` が `activityId` にリネームされている
- [ ] 既存のデータが全て保持されている
- [ ] `githubEventId` フィールドは変更されていない
- [ ] Lambda/StepFunctions の `event` パラメータは変更されていない

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] 新規マイグレーションが正常に実行できる
- [ ] マイグレーション実行後にロールバック可能（手動確認）
- [ ] lint/format/type チェックが全て通る

### コード品質要件

- [ ] コメント内の「イベント」が「アクティビティ」に統一されている
- [ ] パラメータ名が一貫している（eventId → activityId）
- [ ] インデックス名がテーブル名と一貫している

## 7. 実装手順

### Phase 1: schema.ts の更新とマイグレーション生成

- 1-1. `events` テーブル定義を `activities` にリネーム
- 1-2. `eventsRelations` を `activitiesRelations` にリネーム
- 1-3. `eventType` カラムを `activityType` にリネーム
- 1-4. インデックス名を更新（`idx_events_*` → `idx_activities_*`）
- 1-5. notifications テーブルの `eventId` を `activityId` にリネーム
- 1-6. `pnpm --filter backend db:generate` でマイグレーションファイルを自動生成
- 1-7. 生成されたマイグレーションファイルの内容を確認
- 1-8. ローカル環境で `pnpm --filter backend db:migrate` を実行してテスト
- 1-9. lint/format実行

### Phase 2: Repository実装の更新

- 2-1. drizzle-activity.repository.ts の更新
  - `events` インポートを `activities` に変更
  - 全ての `events.` 参照を `activities.` に変更
  - `activityType` カラムへの参照変更
  - パラメータ名の変更
  - コメントの更新
- 2-2. activity.repository.ts の更新
  - パラメータ名の変更
  - コメントの更新
- 2-3. data-source.repository.ts の更新
  - `events` 参照を `activities` に変更
- 2-4. lint/format実行

### Phase 3: テストコードの更新

- 3-1. factories.ts の更新
  - `createTestEvent` を `createTestActivity` にリネーム
  - `events` 参照を `activities` に変更
- 3-2. テストファイルの更新
  - `events` 参照を `activities` に変更
- 3-3. 全テスト実行・確認

### Phase 4: 最終確認

- 4-1. 全テスト実行
- 4-2. lint/format/type チェック
- 4-3. マイグレーション実行確認（ローカル環境で再度テスト）
- 4-4. コミット・PR作成

## 8. リスク・考慮事項

### 技術的リスク

- **マイグレーション失敗**: テーブルリネーム中にエラーが発生する可能性
- **既存データの損失**: マイグレーション実行中にデータが失われる可能性
- **外部キー制約**: テーブル名変更時に外部キー制約が正しく更新されない可能性

### 軽減策

- マイグレーション実行前にデータベースバックアップを取得
- ローカル環境で十分にマイグレーションをテスト
- マイグレーション実行後に全テストを実行して動作確認
- ロールバック手順の準備（テーブル名を元に戻すSQL）

### 残課題

- コメント内の「イベント」を全て「アクティビティ」に変更する作業は網羅的に実施するが、一部見落としがある可能性がある
- 今後、新規にコードを追加する際は「アクティビティ」という用語を使用することを徹底する

## 9. 実装時の注意点

### リネーム対象の判別基準

以下のルールに従ってリネーム対象を判別：

1. **DB関連**
   - `events` テーブル → リネーム対象
   - `eventType` カラム → リネーム対象
   - `eventId` カラム（notifications テーブル） → リネーム対象

2. **TypeScriptコード**
   - `events` テーブル参照 → リネーム対象
   - `eventId` パラメータ → リネーム対象（ただし、`githubEventId` は除く）
   - `eventIds` パラメータ → リネーム対象
   - コメント内の「イベント」→ リネーム対象（文脈を確認）

3. **リネーム対象外**
   - `githubEventId` フィールド → GitHub API の event を表すため対象外
   - Lambda/StepFunctions の `event` パラメータ → AWS の event を表すため対象外
   - DOMイベント → フロントエンドの event を表すため対象外

### マイグレーション実行時の注意

- **Drizzle Kit** を使用してマイグレーションを生成・実行
  - `pnpm --filter backend db:generate`: schema.tsからマイグレーションファイルを生成
  - 生成されたマイグレーションファイルの内容を必ず確認する
  - `pnpm --filter backend db:migrate`: マイグレーションを実行
- 本番環境では必ずバックアップを取得してから実行
- ダウンタイムが発生する可能性があるため、メンテナンスウィンドウを設定

### テスト実行の注意

- マイグレーション実行後、全てのテストを実行して動作確認
- 特に、ActivityRepository のテストが正しく動作することを確認
- データソース削除のテストで、関連する activities が正しく削除されることを確認
