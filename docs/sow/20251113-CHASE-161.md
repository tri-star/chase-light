# SOW: CHASE-161: ClFabButtonにFABの配置責務とz-indexトークンを追加

## プロジェクト概要

**課題ID**: CHASE-161
**作成日**: 2025-11-13
**種別**: 機能改善 / リファクタリング

## 1. 背景と目的

### 背景

現在、`DataSourceFabButton.vue`では、FAB（Floating Action Button）の配置を親コンポーネント側でラッパーdivを使って制御しています。しかし、FABは画面上に固定配置される性質のUIコンポーネントであるため、この配置責務は`ClFabButton`自身が持つべきです。

また、`DataSourceFabButton.vue`は単に`ClFabButton`をラップして固定配置しているだけで、独自のロジックを持たない薄いコンポーネントです。このような粒度の細かいコンポーネントは不要であり、ダッシュボードページから直接`ClFabButton`を使用する方が適切です。

さらに、z-indexの値が`z-[1050]`のようにハードコードされており、デザイントークンとして管理されていません。

### 目的

1. `ClFabButton`にFABとしての固定配置責務を移し、コンポーネント単体で完結させる
2. 配置位置を柔軟に指定できるようにpropsを追加する
3. デザイントークンにz-indexの`fab`を追加し、一貫性のある管理を実現する
4. `DataSourceFabButton.vue`を削除し、ダッシュボードページから直接`ClFabButton`を使用する

## 2. 実装スコープ

### 実装対象

- `ClFabButton.vue`コンポーネントへの固定配置機能追加
- 配置位置を指定するpropsの追加（position, offsetX, offsetY）
- デザイントークンへのz-index定義追加（fab: 1050）
- デザイントークン変換スクリプトの修正（z-index対応）
- `DataSourceFabButton.vue`の削除
- `DashboardPage.vue`で直接`ClFabButton`を使用するように変更
- Storybookストーリーの更新
- ユニットテストの更新

### 実装する機能

1. **固定配置機能**
   - `position: fixed` をコンポーネント内部で適用
   - 配置位置を`bottom-right` / `bottom-left` / `top-right` / `top-left`で指定可能

2. **オフセット調整機能**
   - `offsetX`、`offsetY` propsで画面端からの距離を調整可能
   - レスポンシブ対応（sm以上でオフセット変更）

3. **z-indexトークン**
   - `design-tokens.json`に`zIndex.fab`を追加（値: 1050）
   - Tailwindテーマに反映され、`z-fab`クラスとして利用可能

### 実装除外項目

- FABのアニメーション効果の追加
- FABの開閉メニュー機能
- 複数FABの配置管理機能

## 3. 技術仕様

### コンポーネント仕様

#### Props仕様

```typescript
interface Props {
  label?: string
  icon?: string
  size?: 'md' | 'lg'
  position?: 'bottom-right' | 'bottom-left' | 'top-right' | 'top-left'  // 新規
  offsetX?: number  // 新規（デフォルト: 5 on mobile, 10 on sm+）
  offsetY?: number  // 新規（デフォルト: 5 on mobile, 10 on sm+）
}
```

#### デフォルト値

- `position`: `'bottom-right'`
- `offsetX`: レスポンシブ（モバイル: 5 / sm以上: 10）
- `offsetY`: レスポンシブ（モバイル: 5 / sm以上: 10）

#### クラス構成

```typescript
// 固定配置用の基本クラス
const positionClasses = {
  'bottom-right': 'fixed right-[var(--offset-x)] bottom-[var(--offset-y)]',
  'bottom-left': 'fixed left-[var(--offset-x)] bottom-[var(--offset-y)]',
  'top-right': 'fixed right-[var(--offset-x)] top-[var(--offset-y)]',
  'top-left': 'fixed left-[var(--offset-x)] top-[var(--offset-y)]',
}

// z-indexはトークンから
const zIndexClass = 'z-fab'
```

### デザイントークン仕様

#### design-tokens.jsonへの追加

```json
{
  "zIndex": {
    "$type": "other",
    "$description": "z-index層定義",
    "fab": {
      "value": "1050",
      "$description": "Floating Action Button用のz-index"
    }
  }
}
```

#### 生成されるTailwindクラス

- `z-fab`: FAB用のz-index（1050）として利用可能

### スクリプト修正仕様

#### types.tsの修正

```typescript
export interface DesignTokens {
  // ... 既存のプロパティ ...
  transition?: TokenGroup
  zIndex?: TokenGroup  // 追加
}
```

#### llm-doc-generator.tsの修正

**1. 型定義の拡張**
```typescript
export interface TailwindUtilitiesDoc {
  // ... 既存のプロパティ ...
  shadows: { ... }
  zIndex: {              // 追加
    description: string
    values: string[]
  }
}
```

**2. 生成メソッドの追加**
```typescript
private static generateZIndex(
  tokens: DesignTokens
): TailwindUtilitiesDoc['zIndex'] {
  const group = tokens.zIndex as TokenGroup | undefined
  const values = this.listKeys(group)
  return {
    description:
      'TailwindCSSで利用可能なz-*などを利用可能。値は以下に挙げる値から選択',
    values,
  }
}
```

**3. generateUtilitiesDocの修正**
```typescript
static generateUtilitiesDoc(tokens: DesignTokens): TailwindUtilitiesDoc {
  // ... 既存のメソッド呼び出し ...
  const zIndex = this.generateZIndex(tokens)  // 追加

  return {
    // ... 既存のプロパティ ...
    shadows,
    zIndex,  // 追加
  }
}
```

### DashboardPage.vueの変更

**変更前:**
```vue
<template>
  <!-- ... -->
  <DataSourceFabButton @click="openAddDataSourceModal" />
</template>

<script setup lang="ts">
import DataSourceFabButton from './parts/DataSourceFabButton.vue'
// ...
</script>
```

**変更後:**
```vue
<template>
  <!-- ... -->
  <ClFabButton
    icon="mdi:plus"
    @click="openAddDataSourceModal"
  />
</template>

<script setup lang="ts">
import ClFabButton from '~/components/base/ClFabButton.vue'
// ...
</script>
```

### アーキテクチャ設計

既存のコンポーネント構成を簡素化：

- **Component層**: `ClFabButton.vue`に固定配置ロジックを追加
- **Design System層**: `design-tokens.json`にz-indexトークンを追加
- **Usage層**: `DashboardPage.vue`が直接`ClFabButton`を使用（中間コンポーネント削除）

## 4. 実装ファイル一覧

### 新規作成ファイル

なし

### 更新対象ファイル

1. **`packages/frontend/design-tokens.json`**
   - z-indexトークンの追加

2. **`packages/frontend/scripts/design-token-converter/types.ts`**
   - `DesignTokens`型に`zIndex?: TokenGroup`を追加

3. **`packages/frontend/scripts/design-token-converter/llm-doc-generator.ts`**
   - `TailwindUtilitiesDoc`型に`zIndex`プロパティを追加
   - `generateZIndex`メソッドを追加
   - `generateUtilitiesDoc`メソッドの戻り値に`zIndex`を追加

4. **`packages/frontend/components/base/ClFabButton.vue`**
   - 固定配置機能の追加
   - position, offsetX, offsetY propsの追加
   - z-indexトークンの適用

5. **`packages/frontend/components/pages/dashboard/DashboardPage.vue`**
   - DataSourceFabButtonのimport削除
   - ClFabButtonを直接使用するように変更
   - position, icon, labelなどのpropsを直接指定

6. **`packages/frontend/components/base/ClFabButton.stories.ts`**
   - 配置位置バリエーションのストーリー追加
   - オフセット調整のストーリー追加

7. **`packages/frontend/components/base/__tests__/ClFabButton.test.ts`**
   - 固定配置クラスの検証テスト追加
   - position propsによるクラス変化のテスト追加

### 削除対象ファイル

1. **`packages/frontend/components/pages/dashboard/parts/DataSourceFabButton.vue`**
   - ClFabButtonをラップしているだけで独自のロジックがないため削除

### 参照ファイル

1. **`packages/frontend/docs/design/tailwind-utilities.json`**
   - トークン生成後に確認（z-fabクラスが追加されているか）

2. **`packages/frontend/assets/css/tailwind.css`**
   - トークン生成後に確認（CSS変数が追加されているか）

## 5. テスト戦略

### Unit Test（Component層）

`packages/frontend/components/base/__tests__/ClFabButton.test.ts`:

- デフォルトでbottom-right配置となることを検証
- position propsによって適切なクラスが適用されることを検証
- z-fabクラスが適用されることを検証
- 既存のラベル、アイコン、サイズ、クリックイベントのテストは維持

### Visual Regression Test（Storybook）

`packages/frontend/components/base/ClFabButton.stories.ts`:

- 4つの配置位置（bottom-right, bottom-left, top-right, top-left）のストーリー追加
- オフセット調整のストーリー追加
- 既存のDefault、Largeストーリーは維持

### Integration Test

`packages/frontend/components/pages/dashboard/DashboardPage.vue`:

- ClFabButtonがダッシュボード画面に表示されることを手動確認
- クリックイベントが正常に発火し、データソース追加モーダルが開くことを確認
- 既存のダッシュボード機能に回帰がないことを確認

## 6. 受け入れ基準

### 機能要件

- [ ] ClFabButton単体でFABとして画面四隅に配置できる
- [ ] propsで配置位置（bottom-right, bottom-left, top-right, top-left）が制御できる
- [ ] propsでオフセット（offsetX, offsetY）が制御できる
- [ ] デフォルトでレスポンシブなオフセット（mobile: 5, sm+: 10）が適用される
- [ ] DataSourceFabButton.vueが削除されている
- [ ] DashboardPage.vueから直接ClFabButtonを使用している
- [ ] クリックイベントが正常に発火し、モーダルが開く

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] 新規テストが追加され、カバレッジが維持される
- [ ] デザイントークンにzIndex.fab = 1050が追加されている
- [ ] `tailwind-utilities.json`にzIndexセクションが追加され、fabが含まれている
- [ ] Tailwindテーマ（`assets/css/tailwind.css`）に`--z-index-fab`変数が生成されている
- [ ] z-fabクラスがTailwindユーティリティとして利用可能になっている
- [ ] 既存のトークンカテゴリ（color, typography等）の生成に影響がない
- [ ] Storybookで4つの配置パターンが確認できる

### セキュリティ要件

- [ ] 該当なし（UIコンポーネントの改善のみ）

### アクセシビリティ要件

- [ ] 既存のaria-label属性が維持される
- [ ] フォーカス可視化が維持される
- [ ] キーボード操作が維持される

## 7. 実装手順

### Phase 1: デザイントークンとスクリプト修正

- 1-1. `scripts/design-token-converter/types.ts`に`zIndex?: TokenGroup`を追加
- 1-2. `scripts/design-token-converter/llm-doc-generator.ts`を修正
  - `TailwindUtilitiesDoc`型に`zIndex`プロパティを追加
  - `generateZIndex`メソッドを追加（spacingやradiusと同様の実装）
  - `generateUtilitiesDoc`メソッドの戻り値に`zIndex`を含める
- 1-3. `design-tokens.json`にzIndexトークンを追加
- 1-4. `pnpm --filter frontend generate:tailwind-theme`を実行
- 1-5. `tailwind-utilities.json`を確認
  - `zIndex`セクションが追加されていること
  - `zIndex.values`に`"fab"`が含まれていること
  - 既存のセクション（color, typography等）に変更がないこと
- 1-6. `assets/css/tailwind.css`を確認
  - `--z-index-fab: 1050;` のようなCSS変数が追加されていること
- 1-7. format, lint実行
- 1-8. コミット（スクリプト修正とトークン追加）

### Phase 2: ClFabButton実装

- 2-1. ClFabButton.vueにposition, offsetX, offsetYのprops定義を追加
- 2-2. 固定配置用のクラス計算ロジックを追加（positionに応じたクラス生成）
- 2-3. z-fabクラスを適用
- 2-4. レスポンシブオフセットの実装（CSS変数とTailwindクラスの組み合わせ）
- 2-5. ユニットテストの更新
- 2-6. format, lint, test実行
- 2-7. コミット

### Phase 3: Storybook更新

- 3-1. ClFabButton.stories.tsに配置位置バリエーションのストーリー追加
- 3-2. オフセット調整のストーリー追加
- 3-3. Storybookで表示確認
- 3-4. format, lint実行
- 3-5. コミット

### Phase 4: DashboardPage.vueの更新とDataSourceFabButton.vueの削除

- 4-1. DashboardPage.vueを更新
  - DataSourceFabButtonのimport文を削除
  - ClFabButtonのimport文を追加
  - template内のDataSourceFabButtonをClFabButtonに置き換え
  - propsを直接指定（icon="mdi:plus", @click="openAddDataSourceModal"）
- 4-2. DataSourceFabButton.vueを削除
- 4-3. 開発サーバーで動作確認
  - ダッシュボード画面にFABが表示されることを確認
  - FABをクリックしてモーダルが開くことを確認
  - 表示位置がDataSourceFabButton使用時と同じであることを確認
- 4-4. format, lint実行
- 4-5. コミット（DashboardPage更新とDataSourceFabButton削除）

### Phase 5: 最終確認

- 5-1. 全テストが通ることを確認（pnpm --filter frontend test）
- 5-2. Storybookで全ストーリーが正常に表示されることを確認
- 5-3. 開発サーバーでダッシュボード画面を表示し、FABが正常に表示・動作することを確認
- 5-4. PRの作成準備

## 8. リスク・考慮事項

### 技術的リスク

- **スクリプト修正の影響範囲**: デザイントークン変換スクリプトの修正が、他のトークンカテゴリの生成にも影響を与える可能性
- **レスポンシブオフセットの実装**: Tailwindのユーティリティクラスとカスタムプロパティの組み合わせで実装する必要があり、やや複雑
- **DashboardPage.vueへの影響**: DataSourceFabButtonを削除してClFabButtonを直接使用することで、importやpropsの指定が必要になる
- **既存の表示位置・動作への影響**: FABの表示位置や動作が変わる可能性があるため、視覚的な確認が重要

### 軽減策

- スクリプト修正は既存パターン（spacing, radius, shadowsと同様）に倣うことで、既存機能への影響を最小化
- Phase 1でトークン生成スクリプトを実行し、`tailwind-utilities.json`の全体を確認することで、他のトークンへの影響をチェック
- CSS変数（`--offset-x`, `--offset-y`）とTailwindクラスの組み合わせで実装することで、レスポンシブ対応を実現
- Phase 4で手動確認を徹底し、表示位置に変更がないことを確認
- 既存のテストを全て実行し、回帰がないことを確認

### その他の考慮事項

- **配置位置のサポート範囲**: 今回の実装では4つの配置位置のみをサポート。中央配置など、より柔軟な配置が必要になった場合は、別途対応を検討
- **z-indexトークンの拡張性**: z-indexトークンは今後、他のFloating UI（モーダル、トースト等）でも利用可能になるため、統一的な層管理の基盤となる
- **コンポーネント粒度の見直し**: `DataSourceFabButton`のような薄いラッパーコンポーネントは削除することで、コードベースの保守性が向上する。今後も同様のケースがあれば、積極的に見直しを検討すべき
