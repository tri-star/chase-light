# SOW: CHASE-128: authのフォルダ構造見直し

## プロジェクト概要

**課題ID**: CHASE-128
**作成日**: 2025-09-24
**種別**: リファクタリング

## 1. 背景と目的

### 背景

現在のpackages/backend/src/featuresフォルダ構造において、以下の課題が存在しています：

- `features/auth`と`features/user`が分離されており、認証・ユーザー管理が断片化している
- 各presentationフォルダが認証ミドルウェアに依存しているため、共通の認証機能が他フィーチャーで利用しづらい
- 旧アーキテクチャ（Service層）を使用しており、新アーキテクチャ（domain/application/infra/presentation）に移行できていない
- JwtValidatorが旧構造のままで、ports/adaptersパターンに移行できていない

### 目的

1. **認証とユーザー管理の統合**: auth/userフィーチャーをidentityフィーチャーに統合し、認証・ユーザー管理を一元化
2. **アーキテクチャの統一**: detectionフィーチャーと同様の新アーキテクチャ（domain/application/infra/presentation）に移行
3. **認証ミドルウェアの共通化準備**: 将来的にcoreに移植するための前段階整備
4. **保守性の向上**: importパスの統一、テストの移植、既存実装の維持

## 2. 実装スコープ

### 実装対象

- features/authフォルダをfeatures/identityに名前変更
- features/userの全機能をfeatures/identityに統合
- JwtValidatorの新アーキテクチャ（ports/adapters）への移行
- User関連のService → UseCase への移行
- 全backendファイルのimportパス調整

### 更新可能な項目

1. **フォルダ構造**: 旧Service層 → 新domain/application/infra/presentation構造
2. **クラス名**: Service → UseCase への命名変更
3. **importパス**: 移動に伴うパス調整
4. **テストファイル**: 同一階層への移動とimportパス調整

### 実装除外項目

- 既存API仕様の変更（エンドポイント、レスポンス形式は維持）
- 認証ロジックの変更（JWT検証、Auth0連携の仕様は維持）
- データベーススキーマの変更
- 新機能の追加

## 3. 技術仕様

### API仕様

#### エンドポイント

既存のエンドポイントを維持：

```
GET /profile          # プロフィール取得
PUT /profile          # プロフィール更新
GET /settings         # 設定取得
PUT /settings         # 設定更新
POST /auth/signup     # サインアップ
```

#### 認証・認可

- JWT認証必須（変更なし）
- Auth0統合（変更なし）
- 認証済みユーザーのみアクセス可能（変更なし）

### アーキテクチャ設計

detectionフィーチャーと同様のレイヤード構成を採用：

- **Domain層**: User, UserSettings, Timezone等のエンティティ
- **Application層**:
  - ports/: JwtValidatorPort（外部サービス抽象化）
  - use-cases/: GetUserProfile, UpdateUserProfile, GetUserSettings, UpdateUserSettings
- **Infra層**:
  - adapters/jwt-validator/: JwtValidator実装、スタブ、ファクトリ
  - repositories/: DrizzleUserRepository
- **Presentation層**: 既存ルート定義（移動のみ）

### データベース操作

- **`users`テーブル**: 既存のCRUD操作を維持
- **`user_preferences`テーブル**: 将来対応（現在は未使用）
- **更新対象外**: sessions, その他のテーブル

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/backend/src/features/identity/application/ports/jwt-validator.port.ts`**
   - JWTValidatorのPort定義（既存JWTValidatorInterfaceを移動）

2. **`packages/backend/src/features/identity/application/use-cases/get-user-profile.use-case.ts`**
   - UserProfileServiceの機能をUseCaseに移行

3. **`packages/backend/src/features/identity/application/use-cases/update-user-profile.use-case.ts`**
   - プロフィール更新ロジックをUseCaseに移行

4. **`packages/backend/src/features/identity/application/use-cases/get-user-settings.use-case.ts`**
   - UserSettingsServiceの取得機能をUseCaseに移行

5. **`packages/backend/src/features/identity/application/use-cases/update-user-settings.use-case.ts`**
   - UserSettingsServiceの更新機能をUseCaseに移行

6. **`packages/backend/src/features/identity/infra/adapters/jwt-validator/jwt-validator.adapter.ts`**
   - 既存JWTValidatorクラスを移動・リネーム

7. **`packages/backend/src/features/identity/infra/adapters/jwt-validator/stub-jwt-validator.adapter.ts`**
   - 既存MockJWTValidatorクラスを移動・リネーム

8. **`packages/backend/src/features/identity/infra/adapters/jwt-validator/jwt-validator-factory.ts`**
   - 環境に応じたJWTValidatorインスタンス生成

9. **`packages/backend/src/features/identity/infra/repositories/drizzle-user.repository.ts`**
   - 既存UserRepositoryをDrizzle用リポジトリに移行

10. **`packages/backend/src/features/identity/constants/identity.constants.ts`**
    - user/constantsの内容を統合

### 移動対象ファイル

1. **`packages/backend/src/features/auth/` → `packages/backend/src/features/identity/`**
   - フォルダ全体の名前変更

2. **`packages/backend/src/features/user/presentation/` → `packages/backend/src/features/identity/presentation/`**
   - routes/profile/, routes/settings/, schemas/, shared/ を移動

3. **`packages/backend/src/features/user/domain/` → `packages/backend/src/features/identity/domain/`**
   - user.ts, user-settings.ts, timezone.ts を移動

4. **`packages/backend/src/features/user/errors/` → `packages/backend/src/features/identity/errors/`**
   - user.error.ts を移動

### 更新対象ファイル

1. **全packageファイルのimportパス調整**
   - features/auth/_ → features/identity/_ への変更
   - features/user/_ → features/identity/_ への変更

## 5. テスト戦略

### Component Test（Presentation層）

- 既存テストの移動とimportパス調整のみ
- profile/settings エンドポイントの動作確認
- 認証フロー確認

### Unit Test（UseCase層）

- UseCaseレベルのテストは実装しない
  - Component Testと重複する部分が多く、保守コストが高いため
  - DBをモックするとテストの意味が薄くなるため

### Unit Test（Repository層）

- 既存UserRepositoryテストの移動
- Drizzle実装への移行確認

## 6. 受け入れ基準

### 機能要件

- [ ] 既存のAPI仕様が全て動作する（GET/PUT /profile, GET/PUT /settings, POST /auth/signup）
- [ ] JWT認証ミドルウェアが正常に動作する
- [ ] Auth0統合が正常に動作する
- [ ] プロフィール取得・更新が正常に動作する
- [ ] 設定取得・更新が正常に動作する

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] lintエラーが発生しない
- [ ] 型エラーが発生しない
- [ ] 新アーキテクチャ（domain/application/infra/presentation）に準拠している

### セキュリティ要件

- [ ] JWT認証による適切なアクセス制御（変更なし）
- [ ] Auth0統合によるセキュリティ（変更なし）
- [ ] トークン検証ロジックが正常に動作する

## 7. 実装手順

### Phase 1: フォルダ構造作成・基盤整備

- 1-1. features/auth → features/identity 名前変更
- 1-2. identityフィーチャーの新フォルダ構造作成（domain/application/infra/presentation）
- 1-3. 基本的なindex.tsファイル作成

### Phase 2: Domain層実装

- 2-1. user/domain/配下のファイルをidentity/domain/へ移動
- 2-2. user/constants/配下をidentity/constants/identity.constants.ts に統合
- 2-3. user/errors/をidentity/errors/に移動
- 2-4. domain/repositories/user.repository.ts（ポート定義）作成

### Phase 3: Application層実装

- 3-1. ports/jwt-validator.port.ts 作成（既存interfaceを移動）
- 3-2. use-cases/配下のUseCaseクラス作成（Service → UseCase移行）
- 3-3. UserProfileService, UserSettingsServiceのロジックをUseCaseに移行

### Phase 4: Infrastructure層実装

- 4-1. infra/repositories/drizzle-user.repository.ts 作成
- 4-2. infra/adapters/jwt-validator/ 配下のアダプタ実装
- 4-3. JWTValidatorのファクトリ関数実装

### Phase 5: Presentation層移動

- 5-1. user/presentation/配下をidentity/presentation/へ移動
- 5-2. ルート定義のimportパス調整（Service → UseCase）
- 5-3. 認証エンドポイント（auth/presentation）の統合

### Phase 6: テスト移植・調整

- 6-1. 既存テストファイルの移動
- 6-2. importパス調整
- 6-3. Service → UseCaseに伴うテスト調整

### Phase 7: 全体調整・cleanup

- 7-1. 全backendファイルのimportパス一括調整
- 7-2. features/userフォルダの削除
- 7-3. lint・型チェック・テスト実行

## 8. リスク・考慮事項

### 技術的リスク

- **大量ファイル移動**: 移動時のimportパス調整漏れ
- **アーキテクチャ移行**: Service → UseCase移行時のロジック変更によるバグ
- **テスト移植**: テスト移動時の実行パス調整漏れ

### 軽減策

- 段階的実装による影響範囲の局所化
- 既存テストによる回帰テスト実施
- lint・型チェックによる静的検証
- 既存実装の維持（なるべく移動・パス調整のみ）

### 将来的な発展

- 認証ミドルウェアのcoreへの移植（別タスク）
- user_preferencesテーブルの活用（別タスク）
- 他フィーチャーでのidentity統合利用（別タスク）
