# SOW: CHASE-163: Lambdaビルド処理の見直しとAPI Gateway追加

## プロジェクト概要

**課題ID**: CHASE-163  
**作成日**: 2025-12-12  
**種別**: 実装改善 / インフラ追加

## 1. 背景と目的

### 背景

- Lambdaビルドで各関数の依存を `lambda-config.mjs` に手書きしており、`^` 指定のまま `npm install` するためバージョンが揺れ、再現性がない。
- 全関数共通で入れる依存と関数固有の依存を分けて管理できず、関数ごとの差分管理が煩雑。
- HonoベースのAPI (`src/index.ts`) をLambda化・デプロイする経路と API Gateway が未整備なため、AWS上でAPIを提供できない。

### 目的

- pnpm-lock.yaml を単一の信頼ソースとして参照し、各Lambdaの package.json を固定バージョンで生成できる仕組みに置き換える。
- 共通依存 + 関数固有依存 + 共通を無効化するフラグの3層で依存を定義できるようにし、設定を見通しよくする。
- API Lambda をビルド・配置し、API Gateway (HttpApi) から既存のHonoルーティングへ到達できるようにする。将来のカスタムドメイン化に向けて追加タスクも整理する。

## 2. 実装スコープ

### 実装対象

- Lambdaビルド設定の刷新（共通依存/個別依存/スキップ指定 + pnpm-lock解析によるバージョン固定）。
- API Lambda (`src/index.ts`) のビルド対象追加とSAMテンプレートへのLambda + HttpApi統合リソース追加。
- 将来のカスタムドメイン対応に必要な追加タスクの洗い出し（実装は対象外）。

### 更新可能な項目

1. `packages/backend/scripts/lambda-config.mjs`（設定構造の見直し、API Lambda追加）
2. `packages/backend/scripts/build-lambda.mjs`（依存解決処理・生成フローの更新）
3. `packages/backend/scripts/utils/lockfile-utils.mjs`（pnpm-lock解析の新規ヘルパー、仮）
4. `packages/backend/infrastructure/sam-template.yaml`（API用のLambda/HttpApi/出力/権限追加）
5. ドキュメント更新（必要に応じ `docs/task-logs` や README的なメモを追加）

### 実装除外項目

- 各Lambda本体のビジネスロジック変更（検知・翻訳・通知処理の挙動には手を入れない）。
- DBスキーマ変更やマイグレーション追加。
- カスタムドメインの実構築（ACM証明書発行、Route53レコード作成、API Gatewayドメイン名設定）は調査のみ。

## 3. 技術仕様

### API仕様（API Gateway側の公開形態）

- **エンドポイント**: HttpApi (payload v2) で `ANY /` および `ANY /{proxy+}` を `BackendApiFunction` に統合。Stage は `Stage` パラメータ（デフォルト `dev`）。
- **認証・認可**: API Gatewayレイヤーでは未設定。アプリ側で既存の JWT ミドルウェア（`globalJWTAuth`）を適用。
- **レスポンス**: LambdaからのHonoレスポンスをそのまま返却。バイナリ設定は既存Hono設定に従う。
- **CORS**: HttpApiのCORSを有効化し、`FRONTEND_URL`（カンマ区切り）またはワイルドカードを設定予定。必要に応じて環境変数化。

### データベース操作

- DBスキーマ変更は無し。API Lambda では既存の `connectDb` により環境変数ベースで接続する前提。

### アーキテクチャ設計

- **依存管理リファクタ**
  - `lambda-config.mjs` に `defaultDependencies` を定義し、各関数に `additionalDependencies` と `skipDefaultDependencies` を設定可能にする。
  - 依存の値はパッケージ名のみ（もしくは明示バージョンを許可）とし、実際のバージョン解決は `pnpm-lock.yaml` を単一ソースにする。
  - `build-lambda.mjs` で lockfile を解析し、各依存の解決済みバージョンを package.json に書き込む。未解決時はエラーで中断し、手動バージョン指定にフォールバックできるようにする。
  - 外部化パッケージ（`externalPackages`）は共通デフォルトを用意しつつ、関数ごとに追加/上書きできるようにする（例: `pg`, `drizzle-orm`, `@aws-sdk/*`, `jsonwebtoken`, `jwks-rsa`）。
  - `pnpm-lock.yaml` の読取り専用ヘルパーを `packages/backend/scripts/lib/pnpm/` 配下の独立モジュール（例: `lockfile.ts`）として実装。カレントから親ディレクトリへ辿って lockfile を探索し、lockfile ディレクトリからの相対で最も近い importer キーを選択する。
  - YAML 解析結果は想定スキーマに対して型アサーションを行い（例: `as { importers: Record<string, { dependencies?: Record<string,string>; devDependencies?: Record<string,string>; optionalDependencies?: Record<string,string>; }>; packages?: Record<string, unknown>; }`）、合致しない場合は明示的に例外を投げる。
  - ロック値が `link:` / `workspace:` の場合は参照先 `package.json` からバージョンを取得し、それ以外は解決済みバージョン文字列を採用。必要に応じ `packages` セクションで厳密解決を行う。

- **API Lambda ビルド**
  - 新たに `api`（仮称）エントリを `lambda-config.mjs` に追加。エントリポイント `./src/index.ts`、デフォルト依存 + API固有依存（`hono`, `@hono/zod-openapi`, `@hono/zod-validator`, `@scalar/hono-api-reference` など）を解決して package.json を生成。
  - Hono の AWS Lambda ハンドラー（`handle(app)`）を既存通り使用。`externalPackages` には DB/認証系などバンドルしたくないものを含める。
  - `build-lambda.mjs` の単体ビルドモードでも `api` を指定できるようにする。

- **SAMテンプレート**
  - `BackendApiFunction`（名称仮）を追加し、CodeUri を `../dist/lambda/api/`、Handler を `index.handler`、必要に応じてメモリ/タイムアウト/環境変数を設定。
  - `Serverless::HttpApi` リソースを追加し、CORS設定・ステージ名を `Stage` パラメータから参照。`ANY /` と `ANY /{proxy+}` イベントで Lambda と統合。
  - 出力に API のエンドポイントURL を追加。CloudWatch Logs ポリシーを既存 Lambda と同程度に付与。

- **カスタムドメインのフォローアップ項目（実装は除外）**
  - us-east-1 で ACM 証明書発行、Route53 ゾーンへの CNAME/A レコード作成。
  - API Gateway カスタムドメイン設定とステージへのマッピング（base path 設定含む）。
  - 証明書自動更新に備えた権限確認と Terraform/SAM での管理方針決定。

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`docs/sow/20251212-CHASE-163.md`** — 本SOW
2. **`packages/backend/scripts/lib/pnpm/lockfile.ts`** — pnpm-lock探索・依存解決ヘルパー（lockfileパーサ）

### 更新対象ファイル

1. **`packages/backend/scripts/lambda-config.mjs`** — 共通/個別依存の設定構造変更、API Lambdaエントリ追加
2. **`packages/backend/scripts/build-lambda.mjs`** — lockfile解決ロジック・package.json生成・外部化設定の見直し（上記ヘルパー利用）
3. **`packages/backend/infrastructure/sam-template.yaml`** — API Lambda と HttpApi リソース、Outputs 追加
4. **（必要に応じて）`packages/backend/scripts/__tests__/*.test.ts`** — 依存解決のユニットテスト
5. **（必要に応じて）ドキュメント類** — 作業ログ/README 更新

### 作成/更新ファイルツリー（イメージ）

```
docs/sow/
  └── 20251212-CHASE-163.md
packages/backend/scripts/
  ├── build-lambda.mjs
  ├── lambda-config.mjs
  └── lib/
      └── pnpm/
          └── lockfile.ts
packages/backend/infrastructure/
  ├── sam-template.yaml
  └── api/ (必要ならイベントテンプレート等を配置)
```

## 5. テスト戦略

### Component / Integration

- `pnpm --filter backend build:lambda`（全体）と `pnpm --filter backend build:lambda api`（単体）で dist 生成を確認し、各 package.json が固定バージョンになっていることを検証。
- `sam validate` でテンプレートの構文チェック。

### Unit

- lockfile解決ヘルパーの単体テスト（存在する依存が正しくバージョン解決されること、未解決時に例外になること、追加/スキップ設定のマージ動作）。

### 既存テスト

- 既存バックエンドテスト `pnpm --filter backend test` を回して回帰を確認（ロジック変更がないことの担保）。

## 6. 受け入れ基準

- [ ] 各Lambdaの package.json に共通依存 + 個別依存が固定バージョンで生成され、pnpm-lock.yaml との差分が無い。
- [ ] `skipDefaultDependencies` などの設定で共通依存の有効/無効を切り替えられる。
- [ ] API Lambda が `build-lambda` の対象となり、`dist/lambda/api/` にバンドル + node_modules が生成される。
- [ ] SAM テンプレートに HttpApi と API Lambda の統合が追加され、`sam validate` が成功する。
- [ ] カスタムドメイン対応に必要な追加タスクがSOWまたは付記に明示されている。
- [ ] 既存のバックエンドテストが全て通る。

## 7. 実装手順

### Phase 1: Lambda依存管理リファクタ

- 1-1. `packages/backend/scripts/lib/pnpm/lockfile.ts` として pnpm-lock を読むヘルパー（依存解決関数）を追加し、ユニットテストを作成。
- 1-2. `lambda-config.mjs` を共通/個別/スキップの構造に整理し、既存関数の設定を移行。
- 1-3. `build-lambda.mjs` で依存解決・package.json生成・npm install フローを置き換え。`externalPackages` の共通デフォルト化も実施。
- 1-4. `pnpm --filter backend build:lambda` を実行して出力と依存バージョンを確認。

### Phase 2: API Lambda + SAM更新

- 2-1. `lambda-config.mjs` に API 用エントリを追加し、ビルドが通ることを確認。
- 2-2. `sam-template.yaml` に API Lambda, HttpApi, Outputs, ポリシーを追加（CORS設定含む）。
- 2-3. `sam validate` および `build:lambda api` の組み合わせでデプロイ物が揃うことを確認。

### Phase 3: ドキュメントと最終確認

- 3-1. 必要な作業ログや README 更新があれば追記。
- 3-2. 受け入れ基準のチェックリストを確認し、未完の項目がないか棚卸し。

## 9. リスク・考慮事項

- **lockfile解決の例外**: `pnpm-lock.yaml` に存在しない依存を指定した場合にビルドが止まるため、明示バージョン指定やロギングで発見しやすくする。
- **workspace依存の扱い**: `shared` などワークスペース依存はバンドル対象となるため、external に含めないよう注意（必要なら別途バージョン解決ロジックを追加）。
- **バンドルサイズ**: API Lambda 追加でアーティファクトサイズが増える可能性がある。external化の粒度で調整し、AWS 上限に留意。
- **CORS/オーセンティケーション**: Gateway 側での追加設定が不要かを確認し、必要なら別タスク化。
- **カスタムドメイン**: Route53/ACM/ApiGateway の組み合わせは us-east-1 固定の証明書発行が必要になるため、運用リージョンと整合性を確認する。
