# SOW: CHASE-156: データソース詳細画面

## プロジェクト概要

**課題ID**: CHASE-156
**作成日**: 2025-12-08
**種別**: 新機能開発

## 1. 背景と目的

### 背景

Chase Lightアプリケーションでは、ユーザーがGitHubリポジトリをデータソースとして登録・監視する機能があります。現在、データソース一覧画面は実装済みですが、個別のデータソースの詳細情報とそのアクティビティを閲覧するための詳細画面が存在しません。

### 目的

- `/data-sources/[id]` でアクセスできるデータソース詳細画面を作成する
- データソースのメタ情報（名前、説明、スター数など）を表示する
- 該当データソースに関連するアクティビティ一覧を表示する
- アクティビティ詳細画面への導線を提供する

## 2. 実装スコープ

### 実装対象

1. **データソース詳細画面のUI**
   - データソースのメタ情報表示（名前、description、スター数、最終更新日時、外部リンク）
   - アクティビティ一覧表示（上位10〜20件、更新日時降順）

2. **フロントエンドAPI（BFF）**
   - `/api/data-sources/[id].get.ts` - データソース詳細取得
   - `/api/data-sources/[id]/activities.get.ts` - データソース別アクティビティ一覧取得

3. **Feature層**
   - Repository: データソース詳細取得、アクティビティ一覧取得
   - Domain: 型定義（既存スキーマをエイリアス）

### 更新可能な項目

1. ページルーティング: `pages/data-sources/[id].vue`
2. ページコンポーネント: `components/pages/data-sources/detail/`
3. Feature: `features/data-sources/repositories/`

### 実装除外項目

- アクティビティの無限スクロール（今回は上位10〜20件固定）
- データソースの編集・削除機能

## 3. 技術仕様

### API仕様

#### エンドポイント1: データソース詳細取得

```
GET /api/data-sources/{id}
```

Backend API: `GET /api/data-sources/{id}` → `DataSourceDetailResponse`

#### エンドポイント2: データソース別アクティビティ一覧取得

```
GET /api/data-sources/{id}/activities
```

Backend API: `GET /api/data-sources/{dataSourceId}/activities` → `DataSourceActivityListResponse`

#### 認証・認可

- JWT認証必須（middleware: auth）
- ウォッチ中のデータソースのみアクセス可能
- 他ユーザーのデータソースに対するアクセスは404エラーで拒否

#### レスポンス仕様

**DataSourceDetailResponse**:

```typescript
{
  success: true,
  data: {
    dataSource: DataSource,
    userWatch: UserWatch
  }
}
```

**DataSourceActivityListResponse**:

```typescript
{
  success: true,
  data: {
    dataSource: { id, sourceType, name, url, metadata },
    items: Array<{ activity: Activity }>,
    pagination: Pagination
  }
}
```

### アーキテクチャ設計

既存のアクティビティ詳細画面と同じレイヤード構成を採用：

```
pages/data-sources/[id].vue (エントリ)
  ↓
components/pages/data-sources/detail/DataSourceDetailPage.vue (ページ本体)
  ├── use-data-source-detail.ts (ページ専用composable)
  └── parts/
      ├── DataSourceDetailHeader.vue (ヘッダー情報)
      ├── DataSourceDetailInfo.vue (メタ情報)
      ├── DataSourceActivityList.vue (アクティビティ一覧)
      └── DataSourceDetailError.vue (エラー表示)
  ↓↑
features/data-sources/domain/
  └── data-source-detail.ts (Repositoryの戻り値はFront独自のDomain型)
  ↓↑
features/data-sources/repositories/
  ├── data-source-detail-repository.ts (詳細取得)
  └── data-source-activities-repository.ts (アクティビティ一覧取得)
  ↓
server/api/data-sources/
  ├── [id].get.ts (データソース詳細BFF)
  └── [id]/
      └── activities.get.ts (アクティビティ一覧BFF)
```

## 4. 実装ファイル一覧

### 新規作成ファイル

#### BFF層（server/api）

1. **`packages/frontend/server/api/data-sources/[id].get.ts`**
   - データソース詳細取得のBFFエンドポイント
   - Orval生成クライアントを利用してBackend APIを呼び出し
   - Zodスキーマによるレスポンス検証

2. **`packages/frontend/server/api/data-sources/[id]/activities.get.ts`**
   - データソース別アクティビティ一覧取得のBFFエンドポイント
   - ページネーションパラメータの処理

#### Repository層（features）

3. **`packages/frontend/features/data-sources/repositories/data-source-detail-repository.ts`**
   - データソース詳細取得Repository
   - `/api/data-sources/{id}` を呼び出し
   - Domain型に詰め替え(Orvalのレスポンス型と実質同じ場合、単にエイリアス化することも可能)

4. **`packages/frontend/features/data-sources/repositories/data-source-activities-repository.ts`**
   - データソース別アクティビティ一覧取得Repository
   - `/api/data-sources/{id}/activities` を呼び出し
   - Domain型に詰め替え(Orvalのレスポンス型と実質同じ場合、単にエイリアス化することも可能)

#### Domain層

5. **`packages/frontend/features/data-sources/domain/data-source-detail.ts`**
   - DataSourceDetailResponse型のエイリアス
   - DataSourceActivityListResponse型のエイリアス

#### ページ層

6. **`packages/frontend/pages/data-sources/[id].vue`**
   - データソース詳細ページのエントリポイント
   - definePageMeta、useSeoMeta設定

#### コンポーネント層

7. **`packages/frontend/components/pages/data-sources/detail/DataSourceDetailPage.vue`**
   - ページ本体コンポーネント

8. **`packages/frontend/components/pages/data-sources/detail/use-data-source-detail.ts`**
   - ページ専用composable
   - データ取得、状態管理

9. **`packages/frontend/components/pages/data-sources/detail/parts/DataSourceDetailHeader.vue`**
   - データソース名
   - 外部リンクボタン

10. **`packages/frontend/components/pages/data-sources/detail/parts/DataSourceDetailInfo.vue`**
    - description、スター数、最終更新日時などのメタ情報

11. **`packages/frontend/components/pages/data-sources/detail/parts/DataSourceActivityList.vue`**
    - アクティビティ一覧（翻訳済タイトル、サマリー、発生日時、種類）
    - アクティビティ詳細ページへのリンク

12. **`packages/frontend/components/pages/data-sources/detail/parts/DataSourceDetailError.vue`**
    - エラー表示コンポーネント

#### テスト

13. **`packages/frontend/components/pages/data-sources/detail/__tests__/data-source-detail.test.ts`**
    - ページコンポーネントのユニットテスト

#### Storybook

14. **`packages/frontend/components/pages/data-sources/detail/DataSourceDetailPage.stories.ts`**
    - ページコンポーネントのStory

## 5. テスト戦略

### ページテスト（Component Test）

既存のActivityDetailPageテストパターンを踏襲し、Repositoryをモック：

- データソース詳細情報が正しく表示される
- アクティビティ一覧が表示される
- アクティビティ詳細ページへのリンクが正しく設定される
- エラー時にエラー表示が行われる
- 空のアクティビティ一覧の場合の表示

### Unit Test（Repository層）

- 今回は実装しない（BFFテスト方針に従い、ページテストでカバー）

## 6. 受け入れ基準

### 機能要件

- [ ] `/data-sources/[id]` でデータソース詳細画面にアクセスできる
- [ ] データソース名が表示される
- [ ] データソースのdescriptionが表示される
- [ ] 最終更新日時が表示される
- [ ] スター数が表示される
- [ ] データソースへの外部リンクが表示される
- [ ] アクティビティ一覧が更新日時降順で表示される（上位10〜20件）
- [ ] 各アクティビティに翻訳済タイトル、翻訳済サマリー、発生日時、種類が表示される
- [ ] アクティビティ詳細画面へのリンクが機能する
- [ ] ClSectionコンポーネントでセクションが構成される

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] Lint/Format エラーがない
- [ ] SSRで正常にレンダリングされる
- [ ] ローディング状態が適切に表示される

### セキュリティ要件

- [ ] JWT認証による適切なアクセス制御
- [ ] ウォッチ対象外のデータソースへのアクセス拒否（404）

## 7. 実装手順

### Phase 1: BFF層実装

- 1-1. `/api/data-sources/[id].get.ts` の作成
- 1-2. `/api/data-sources/[id]/activities.get.ts` の作成
- 1-3. format, lint, コミット

### Phase 2: Feature層実装

- 2-1. `data-source-detail.ts`（Domain型定義）の作成
- 2-2. `data-source-detail-repository.ts` の作成
- 2-3. `data-source-activities-repository.ts` の作成
- 2-4. format, lint, コミット

### Phase 3: ページ・コンポーネント層実装

- 3-1. `pages/data-sources/[id].vue` の作成
- 3-2. `use-data-source-detail.ts` の作成
- 3-3. `DataSourceDetailPage.vue` の作成
- 3-4. `DataSourceDetailHeader.vue` の作成
- 3-5. `DataSourceDetailInfo.vue` の作成
- 3-6. `DataSourceActivityList.vue` の作成
- 3-7. `DataSourceDetailError.vue` の作成
- 3-8. format, lint, コミット

### Phase 4: テスト・Storybook

- 4-1. `data-source-detail.test.ts` の作成
- 4-2. テスト実行・確認
- 4-3. `DataSourceDetailPage.stories.ts` の作成
- 4-4. 全体のformat, lint, test実行
- 4-5. コミット

## 8. UI設計の詳細

### レイアウト構成

```
┌─────────────────────────────────────────────────────────┐
│ [ClSection]                                             │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ ヘッダーエリア                                       │ │
│ │ ┌─────────────────────────────────────────────────┐ │ │
│ │ │ データソース名（H1）                             │ │ │
│ │ └─────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ メタ情報エリア                                       │ │
│ │ ・description                                        │ │
│ │ ・★ スター数  ・最終更新日時  ・[外部リンク]         │ │
│ └─────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ アクティビティ一覧                                   │ │
│ │ ┌─────────────────────────────────────────────────┐ │ │
│ │ │ [Release] 翻訳済タイトル                         │ │ │
│ │ │ 翻訳済サマリー...                               │ │ │
│ │ │ 2024/01/15                                      │ │ │
│ │ └─────────────────────────────────────────────────┘ │ │
│ │ ┌─────────────────────────────────────────────────┐ │ │
│ │ │ [Issue] 翻訳済タイトル                           │ │ │
│ │ │ 翻訳済サマリー...                               │ │ │
│ │ │ 2024/01/14                                      │ │ │
│ │ └─────────────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 使用するベースコンポーネント

- `ClSection`: セクションの囲み
- `ClHeading`: 見出し
- `Icon`: 各種アイコン表示

### アクティビティ種類のバッジ

既存の `ActivityDetailHeader.vue` のパターンを踏襲：

- release: `bg-status-info-subtle text-status-info-default`
- issue: `bg-status-warn-subtle text-status-warn-default`
- pull_request: `bg-status-success-subtle text-status-success-default`

## 9. リスク・考慮事項

### 技術的リスク

- **データ取得タイミング**: データソース詳細とアクティビティ一覧を並列で取得するか、逐次取得するかの判断
- **ローディング状態**: 2つのAPIを呼び出すため、部分的なローディング表示の検討

### 軽減策

- データソース詳細を先に取得し、アクティビティ一覧はlazy取得とする（ユーザー体験優先）
- 既存テストによる回帰テスト実施
- 段階的実装による品質確保

### 今後の拡張性

- アクティビティの無限スクロール対応
- データソース編集機能への導線追加
