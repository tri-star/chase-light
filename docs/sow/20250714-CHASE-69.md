# SOW: CHASE-69: TransactionManagerの導入

## プロジェクト概要

**課題ID**: CHASE-69
**作成日**: 2025-07-14
**種別**: 実装改善

## 1. 背景と目的

### 背景

現在のバックエンドアプリケーションでは、リポジトリ層の各メソッドで Drizzle の db インスタンスを直接使用しており、トランザクション制御が不十分な状況があります。

特に以下の問題が発生しています：

- 複数のデータベース操作を一つのトランザクションで包括的に管理できない
- サービス層でのトランザクション制御が困難
- データの整合性が保証されない可能性がある

### 目的

TransactionManager クラスを実装し、以下を実現する：

- 複数のデータベース操作を一つのトランザクションで包括的に管理
- サービス層でのトランザクション制御の簡素化
- データの整合性とトランザクション制御の向上
- AsyncLocalStorage を活用した状態管理による透過的なトランザクション制御

## 2. 実装スコープ

### 実装対象

- TransactionManager クラスの実装
- リポジトリ層での TransactionManager 対応
- サービス層でのトランザクション制御の実装
- 既存のデータベース操作コードの改修

### 更新可能な項目

1. データベース接続の取得方法（TransactionManager 経由）
2. トランザクション制御の統一化
3. サービス層でのトランザクション管理

### 実装除外項目

- 既存のドメイン型定義の変更
- データベーススキーマの変更
- API エンドポイントの変更
- プレゼンテーション層の変更

## 3. 技術仕様

### API仕様

#### エンドポイント

既存のAPIエンドポイントは変更しません。

#### 認証・認可

既存の認証・認可機能は変更しません。

#### リクエスト仕様

既存のAPIリクエスト仕様は変更しません。

#### レスポンス仕様

既存のAPIレスポンス仕様は変更しません。

### データベース操作

- **TransactionManager**: 新規作成、PgTransaction の状態管理
- **既存のリポジトリ**: TransactionManager 経由でのデータベース接続取得に変更

### アーキテクチャ設計

#### TransactionManager クラス

```typescript
export class TransactionManager {
  // AsyncLocalStorage を使用した状態管理
  private static asyncLocalStorage = new AsyncLocalStorage<PgTransaction>();

  // 現在のデータベース接続を取得
  static getConnection(): PgDatabase | PgTransaction;

  // トランザクション実行
  static async transaction<T>(
    callback: (db: PgTransaction) => Promise<T>
  ): Promise<T>;
}
```

#### リポジトリ層の変更

- 直接 db インスタンスを使用する代わりに TransactionManager.getConnection() を使用
- 既存のメソッドシグネチャは維持

#### サービス層の変更

- トランザクションが必要な処理では TransactionManager.transaction() を使用
- 既存のサービス層の InputDto/OutputDto は変更しない

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/backend/src/shared/db/transaction-manager.ts`**

   - TransactionManager クラスの実装
   - AsyncLocalStorage による状態管理

2. **`packages/backend/src/shared/db/index.ts`**
   - TransactionManager のエクスポート

### 更新対象ファイル

1. **`packages/backend/src/features/data-sources/repositories/data-source.repository.ts`**

   - db インスタンスの直接使用を TransactionManager.getConnection() に変更

2. **`packages/backend/src/features/data-sources/repositories/repository.repository.ts`**

   - db インスタンスの直接使用を TransactionManager.getConnection() に変更

3. **`packages/backend/src/features/data-sources/repositories/user-watch.repository.ts`**

   - db インスタンスの直接使用を TransactionManager.getConnection() に変更

4. **`packages/backend/src/features/user/repositories/user.repository.ts`**

   - db インスタンスの直接使用を TransactionManager.getConnection() に変更

5. **`packages/backend/src/features/data-sources/services/data-source-creation.service.ts`**

   - データソース作成処理をトランザクション内で実行

6. **`packages/backend/src/features/data-sources/services/data-source-update.service.ts`**
   - データソース更新処理をトランザクション内で実行

## 5. テスト戦略

### Component Test（Presentation層）

- 既存のComponent Testが引き続き動作することを確認
- トランザクション実行後の結果が正しく反映されることを確認

### Unit Test（Repository層）

- TransactionManager.getConnection() を使用したデータベース操作の正常系テスト
- トランザクション内外での接続取得の動作確認

### Unit Test（TransactionManager）

- AsyncLocalStorage による状態管理の正常性確認
- TransactionManager.transaction() メソッドが戻り値を返した場合の動作確認
  - callback内で返した値を取得できること
- ネストしたトランザクション処理の動作確認
- 並行処理時の状態分離確認

## 6. 受け入れ基準

### 機能要件

- [ ] TransactionManager クラスが正常に動作する
- [ ] リポジトリ層が TransactionManager 経由でデータベース接続を取得する
- [ ] サービス層でトランザクション制御が可能になる
- [ ] 既存のAPI機能が正常に動作する
- [ ] データの整合性が保証される

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] 新規作成したテストが全て通る
- [ ] パフォーマンスが既存実装と同等以上である
- [ ] メモリリークが発生しない

### セキュリティ要件

- [ ] AsyncLocalStorage の状態が適切に分離されている
- [ ] トランザクション情報が他のリクエストに漏洩しない
- [ ] 既存のセキュリティ機能が正常に動作する

## 7. 実装手順

### Phase 1: TransactionManager 実装

- 1-1. TransactionManager クラスの基本構造実装
- 1-2. AsyncLocalStorage を使用した状態管理実装
- 1-3. getConnection() メソッドの実装
- 1-4. transaction() メソッドの実装
- 1-5. TransactionManager のユニットテスト作成・実行

### Phase 2: Repository層対応

- 2-1. DataSourceRepository の TransactionManager 対応
- 2-2. RepositoryRepository の TransactionManager 対応
- 2-3. UserWatchRepository の TransactionManager 対応
- 2-4. UserRepository の TransactionManager 対応
- 2-5. 各リポジトリのユニットテスト実行

### Phase 3: Service層対応

- 3-1. DataSourceCreationService のトランザクション対応
- 3-2. DataSourceUpdateService のトランザクション対応
- 3-3. サービス層のユニットテスト作成・実行
- 3-4. 全体のComponent Test実行

## 9. リスク・考慮事項

### 技術的リスク

- **AsyncLocalStorage の理解不足**: Node.js の AsyncLocalStorage の動作を正しく理解していない場合、状態管理が不正確になる可能性
- **ネストしたトランザクション**: 既にトランザクション内で transaction() を呼び出した場合の動作
- **エラーハンドリング**: トランザクション内でのエラー発生時の適切なロールバック処理
- **パフォーマンス**: AsyncLocalStorage の使用によるオーバーヘッド

### 軽減策

- AsyncLocalStorage の公式ドキュメントとベストプラクティスを参考に実装
- ネストしたトランザクションの場合は既存のトランザクションを継続する仕様とする
- 包括的なエラーハンドリングとテストによる品質確保
- パフォーマンステストによる影響度測定
- 段階的実装による品質確保
