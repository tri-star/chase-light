# SOW: CHASE-153: チェックボックスコンポーネントの作成

## プロジェクト概要

**課題ID**: CHASE-153
**作成日**: 2025-11-02
**種別**: 新機能開発（UIコンポーネント）

## 1. 背景と目的

### 背景

現在のプロジェクトには、標準化されたチェックボックスコンポーネント（ClCheckbox）が存在しません。今後のフォーム実装や設定画面などで統一されたチェックボックスUIが必要となります。

### 目的

- デザイントークンに準拠したカスタムチェックボックスコンポーネントの提供
- v-modelによる単一値および配列値の制御に対応
- アクセシビリティとキーボード操作に対応したUI提供
- Tailwind CSSを活用した状態別スタイルの実装（hover, focus, disabled）
- アニメーション付きのチェック状態切り替え

## 2. 実装スコープ

### 実装対象

- **ClCheckboxコンポーネント**: カスタムスタイルのチェックボックスUI
- **Storybookストーリー**: 各状態を確認できるインタラクティブなドキュメント
- **ユニットテスト**: チェック状態、disabled、v-model制御、キーボード操作、aria属性の検証

### 機能要件

1. **v-model対応**
   - 単一の値（boolean）を受け取り、チェック状態を管理
   - 配列（string[] | number[]）を受け取り、グループ制御を実現

2. **状態管理**
   - チェックON/OFF
   - インデターミネート状態（一部選択状態）
   - disabled状態
   - hover状態
   - focus状態

3. **アクセシビリティ**
   - タブキーによるフォーカス移動
   - スペースキーによるトグル操作
   - aria-checked属性による状態の明示
   - aria-label属性によるスクリーンリーダー対応

4. **スタイル**
   - デザイントークンに準拠した色使い
   - チェックマークの色：`bg-surface-primary-default`
   - disabled時：`bg-surface-primary-disabled`, `opacity-50`
   - hover時：`bg-surface-primary-hovered`
   - focus時：`ring-2 ring-status-focus-default`
   - チェック時・チェック解除時のアニメーション（`transition-all duration-200`）

### 実装除外項目

- ラジオボタン機能（別コンポーネントとして実装）
- カスタムチェックマークアイコン（標準のチェックマークのみ）

## 3. 技術仕様

### コンポーネントProps

```typescript
interface Props {
  // v-model用の値（単一の場合はboolean、グループの場合は配列）
  modelValue?: boolean | string[] | number[]

  // チェックボックスの値（グループ使用時に必須）
  value?: string | number

  // インデターミネート状態（一部選択状態）
  indeterminate?: boolean

  // 無効化状態
  disabled?: boolean

  // ラベルテキスト
  label?: string

  // HTML id属性
  id?: string

  // HTML name属性（グループで共通化）
  name?: string

  // アクセシビリティラベル
  ariaLabel?: string
}
```

### コンポーネントEmits

```typescript
interface Emits {
  // v-model更新イベント
  (e: 'update:modelValue', value: boolean | string[] | number[]): void
}
```

### スタイル設計

#### 基本スタイル
- チェックボックス本体：`w-5 h-5 rounded border-2`
- チェックマーク：SVGアイコン（Heroicons check）
- インデターミネートマーク：SVGアイコン（Heroicons minus、水平線）

#### 状態別クラス

**デフォルト（未チェック）**
```css
border-surface-outlined-default
bg-surface-outlined-default
```

**チェック時**
```css
bg-surface-primary-default
border-surface-primary-default
text-white (チェックマーク)
```

**インデターミネート時**
```css
bg-surface-primary-default
border-surface-primary-default
text-white (ハイフンマーク)
```
※インデターミネート状態はチェック状態より優先される

**hover時**
```css
bg-surface-primary-hovered (チェック時/インデターミネート時)
border-surface-primary-hovered (未チェック時)
```

**disabled時**
```css
bg-surface-primary-disabled
opacity-50
cursor-not-allowed
```

**focus時**
```css
focus:outline-none
focus:ring-2
focus:ring-status-focus-default
```

**アニメーション**
```css
transition-all duration-200
```

### アクセシビリティ仕様

1. **セマンティクス**
   - カスタムチェックボックス（div + role="checkbox"）を使用
   - または、ネイティブinput[type="checkbox"]をラップして視覚的にカスタマイズ

2. **ARIA属性**
   - `role="checkbox"` （カスタム実装の場合）
   - `aria-checked="true|false|mixed"`
     - `true`: チェック時
     - `false`: 未チェック時
     - `mixed`: インデターミネート時
   - `aria-label` または `aria-labelledby`
   - `aria-disabled="true"` （disabled時）

3. **キーボード操作**
   - `tabindex="0"` でフォーカス可能
   - スペースキーでトグル（`@keydown.space.prevent`）

4. **ラベル関連付け**
   - `<label for="...">`で明示的に関連付け
   - クリック可能領域の拡大

## 4. 実装ファイル一覧

### 新規作成ファイル

1. **`packages/frontend/components/base/ClCheckbox.vue`**
   - チェックボックスコンポーネント本体
   - Props定義、Emits定義、スタイル、ロジック

2. **`packages/frontend/components/base/ClCheckbox.stories.ts`**
   - Storybookストーリー定義
   - ストーリー：Default, Checked, Indeterminate, Disabled, WithLabel, Group, Interactive

3. **`packages/frontend/components/base/__tests__/ClCheckbox.test.ts`**
   - ユニットテスト
   - テストケース：チェックON/OFF、インデターミネート状態、disabled状態、単一値制御、配列値制御、aria属性、キーボード操作

## 5. テスト戦略

### ユニットテスト（Component Test）

#### テストケース一覧

1. **基本レンダリング**
   - コンポーネントが正常にマウントされる
   - デフォルトのPropsが適用される

2. **チェックON/OFF**
   - クリックでチェック状態が切り替わる
   - スペースキーでトグルできる
   - `update:modelValue`イベントが発火する
   - イベントの引数が正しい

3. **インデターミネート状態**
   - indeterminate prop が true の場合、ハイフンマークが表示される
   - indeterminate 時の aria-checked 属性が "mixed" になる
   - indeterminate はチェック状態より優先される
   - indeterminate 時のクリックで通常のチェックON/OFFに遷移する

4. **disabled状態**
   - disabled時はクリックできない
   - disabled時はスタイルが変わる（opacity-50等）
   - disabled時はキーボード操作が無効

5. **単一の値の制御（boolean）**
   - v-modelでboolean値を制御
   - 初期値が正しく反映される
   - チェックONでtrue、OFFでfalse

6. **配列の値の制御（グループ）**
   - v-modelで配列を制御
   - 複数のチェックボックスでグループ制御
   - チェックON時に配列に値が追加される
   - チェックOFF時に配列から値が削除される
   - 既存の配列値を保持したまま更新される

7. **aria属性**
   - `aria-checked`属性が正しく設定される（true/false/mixed）
   - `aria-label`が設定される
   - `role="checkbox"`が設定される（カスタム実装の場合）
   - disabled時に`aria-disabled="true"`が設定される

8. **キーボード操作**
   - タブキーでフォーカス移動
   - スペースキーでトグル
   - フォーカス時にring-2が表示される

9. **境界値テスト**
   - 空配列の場合
   - modelValueがundefinedの場合
   - 不正な型の場合のデフォルト動作

#### テスト実装パターン

```typescript
// 例：Parameterized test
test.each([
  [false, 'メニューを開閉', false],
  [true, 'カスタムラベル', true],
])(
  'propsが正常に動作する: checked=%s, ariaLabel=%s',
  (checked, ariaLabel, expected) => {
    const wrapper = mount(ClCheckbox, {
      props: { modelValue: checked, ariaLabel },
    })

    expect({
      ariaChecked: wrapper.attributes('aria-checked') === 'true',
      ariaLabel: wrapper.attributes('aria-label'),
    }).toEqual({
      ariaChecked: expected,
      ariaLabel,
    })
  }
)
```

## 6. 受け入れ基準

### 機能要件

- [ ] チェックボックスがクリックでON/OFF切り替え可能
- [ ] インデターミネート状態（indeterminate prop）の表示と動作が正しい
- [ ] disabled状態で操作不可
- [ ] v-modelでboolean値と配列の両方に対応
- [ ] hover, focus, disabled時のスタイル変更が正しく適用される
- [ ] チェック時のアニメーション表示（transition-all duration-200）
- [ ] タブキー移動、スペースキーでのトグルが可能
- [ ] ラベルクリックでチェック状態が切り替わる

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] 新規テストが全て通る（カバレッジ目標：90%以上）
- [ ] Storybookで各状態を確認可能
- [ ] デザイントークンに準拠したスタイル
- [ ] コンポーネント実装ガイドラインに準拠
- [ ] ファイル命名規則に準拠

### アクセシビリティ要件

- [ ] WAI-ARIA準拠のaria属性設定（aria-checked="true|false|mixed"）
- [ ] インデターミネート状態でaria-checked="mixed"が設定される
- [ ] キーボード操作（Tab, Space）が正常に動作
- [ ] フォーカスリングが視覚的に確認可能
- [ ] スクリーンリーダー対応（aria-label等）

## 7. 実装手順

### Phase 1: コンポーネント本体実装

- 1-1. ClCheckbox.vueファイルを作成
- 1-2. Props、Emits定義（indeterminate含む）
- 1-3. 基本的なチェックボックスUIの実装（HTML構造、スタイル）
- 1-4. v-model制御ロジックの実装（boolean対応）
- 1-5. v-model制御ロジックの実装（配列対応）
- 1-6. インデターミネート状態の実装（ハイフンマーク表示、優先度制御）
- 1-7. disabled状態の実装
- 1-8. キーボード操作の実装（Space）
- 1-9. aria属性の実装（aria-checked="mixed"含む）
- 1-10. format, lint, コミット

### Phase 2: Storybook実装

- 2-1. ClCheckbox.stories.tsファイルを作成
- 2-2. Defaultストーリーの作成
- 2-3. Checkedストーリーの作成
- 2-4. Indeterminateストーリーの作成
- 2-5. Disabledストーリーの作成
- 2-6. WithLabelストーリーの作成
- 2-7. Groupストーリーの作成（配列制御）
- 2-8. Interactiveストーリーの作成
- 2-9. argTypesとdescriptionの記述（indeterminate含む）
- 2-10. Storybookで動作確認
- 2-11. format, lint, コミット

### Phase 3: テスト実装

- 3-1. ClCheckbox.test.tsファイルを作成
- 3-2. 基本レンダリングのテスト作成
- 3-3. チェックON/OFFのテスト作成
- 3-4. インデターミネート状態のテスト作成
- 3-5. disabled状態のテスト作成
- 3-6. 単一値制御（boolean）のテスト作成
- 3-7. 配列値制御のテスト作成
- 3-8. aria属性のテスト作成（aria-checked="mixed"含む）
- 3-9. キーボード操作のテスト作成
- 3-10. 境界値テストの作成
- 3-11. テストの実行・確認
- 3-12. format, lint, コミット

### Phase 4: 最終確認とドキュメント更新

- 4-1. すべてのテストが通ることを確認
- 4-2. Storybookで全ストーリーが正常に動作することを確認
- 4-3. デザイントークン準拠の確認
- 4-4. アクセシビリティ要件の確認
- 4-5. Planeの課題を更新（進捗、関連PR）
- 4-6. PR作成、レビュー依頼

## 8. リスク・考慮事項

### 技術的リスク

- **ブラウザ互換性**: カスタムチェックボックスのフォーカスリング表示がブラウザによって異なる可能性
- **アクセシビリティ**: role="checkbox"を使用する場合、ネイティブinputと比べてスクリーンリーダー対応が複雑になる可能性
- **v-model制御**: 配列とbooleanの両方に対応するため、型安全性の確保が必要
- **インデターミネート状態**: indeterminate状態とmodelValueの関係性が複雑になる可能性（indeterminateは表示のみ、modelValueは値を保持）

### 軽減策

- **ブラウザ互換性**:
  - Playwrightテストで主要ブラウザでの動作確認
  - focus-visibleポリフィルの検討（必要に応じて）

- **アクセシビリティ**:
  - WAI-ARIAのCheckbox Patternに準拠した実装
  - スクリーンリーダーでの手動テスト実施
  - 可能であればネイティブinputをラップする方式を優先検討

- **v-model制御**:
  - TypeScriptの型ガードを活用
  - 実装時に型チェックを厳密に行う
  - ユニットテストで境界値を網羅

- **インデターミネート状態**:
  - indeterminateは表示制御のみで、modelValueとは独立して管理
  - ドキュメントとStorybookで使用例を明示
  - テストでindeterminateとmodelValueの組み合わせパターンを網羅

### 追加の考慮事項

- **デザイントークンの利用**: 既存のtailwind-utilities.jsonに定義されている色のみを使用
- **アニメーション**: transition-all duration-200を使用し、パフォーマンスへの影響を最小化
- **再利用性**: 他のフォーム要素（ラジオボタン、トグルスイッチ等）との一貫性を考慮した設計
- **インデターミネート状態の使用例**:
  - 親チェックボックスで子チェックボックスの一部のみが選択されている場合
  - リスト全体で一部のアイテムのみが選択されている場合
  - 「全て選択」チェックボックスの中間状態表現
