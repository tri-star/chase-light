# SOW: CHASE-131: data-source機能の構造見直し

## プロジェクト概要

**課題ID**: CHASE-131
**作成日**: 2025-09-28
**種別**: リファクタリング

## 1. 背景と目的

### 背景

- `packages/backend/src/features/data-sources` は旧来の service/repository 構成のままで、docs のフォルダ構成ガイドラインと乖離している
- サービス層が `TransactionManager` を直接扱い、GitHub API・DB を横断するため、責務境界が曖昧になっている
- identity 機能の Drizzle 実装を直接 import しており、コンテキスト間依存の整理が不十分
- E2E 制御用のスタブ切り替えがサービス層に埋め込まれており、プレゼンテーション層以外での依存注入が困難

### 目的

- data-sources 機能を Domain / Application / Infra / Presentation に再編し、依存方向を明確にする
- ドメインが公開するリポジトリインターフェースを定義し、インフラ実装を差し替え可能にする
- GitHub API 呼び出しを application port + infra adapter に切り出し、スタブ制御点を整理する
- app.ts などのコンポジションレイヤーで依存注入を完結させ、他フィーチャーとの結合を最小化する

## 2. 実装スコープ

### 実装対象

- `packages/backend/src/features/data-sources` 配下のフォルダ構造とコード
- `packages/backend/src/app.ts` の data-sources ルート組み込み処理
- data-sources に依存するテスト（特に detection フィーチャーのハンドラーテスト）
- GitHub API スタブ制御ルート（`presentation/routes/e2e-control`）

### 更新可能な項目

1. Domain 層に `domain/repositories` を新設し、DataSource / UserWatch のリポジトリ契約を定義する
2. Application 層に `application/use-cases` を新設し、既存サービス (`watch`, `list`, `detail`, `update`, `delete`) をユースケースクラスへ移行する
3. Application 層に `application/ports/github-repository.port.ts` を追加し、GitHub リポジトリ取得を抽象化する
4. Infra 層に Drizzle 実装と GitHub Adapter（Octokit / Stub + Factory）を配置する
5. Presentation 層のルートファクトリをユースケース依存に置き換え、index.ts での依存注入を再構成する
6. 関連テストの import / DI を新しい公開 API に合わせて更新する

### 実装除外項目

- API のエンドポイント URL・リクエスト/レスポンススキーマの変更
- データベーススキーマやマイグレーションの追加・変更
- 新規ユースケースや外部サービス連携の追加
- Frontend や他フィーチャー（identity/detection 以外）での改修

## 3. 技術仕様

### API仕様

#### エンドポイント

- `POST /api/data-sources` : GitHub リポジトリの監視登録（既存挙動を維持）
- `GET /api/data-sources` : データソース一覧取得（フィルタ・ソート・ページネーション対応）
- `GET /api/data-sources/{id}` : 監視中データソース詳細取得
- `PUT /api/data-sources/{id}` : データソース基本情報とウォッチ設定の更新
- `DELETE /api/data-sources/{id}` : ウォッチ解除と関連イベント削除
- `POST /api/e2e-control/github/*` : GitHub スタブ制御（スタブ利用時のみ有効）

#### 認証・認可

- 全ての `/api/data-sources` 系エンドポイントは `requireAuth` による JWT 認証を必須とする
- リソース所有者チェックは `UserRepository.findByAuth0Id` と `DataSourceRepository.findByIdWithUserAccess` を介して実施する
- E2E 制御ルートはスタブ実行時のみ公開し、テスト以外では利用しない

#### リクエスト/レスポンス仕様

- 既存の Zod スキーマ（`presentation/schemas`）を流用し、構造・フィールドは変更しない
- レスポンスは `success + data` 形式を維持し、ドメインから返る Date 型は ISO8601 string に整形する

### データベース操作

- `data_sources` テーブル: 新規登録、更新、削除、参照
- `repositories` テーブル: GitHub リポジトリ情報の upsert / 参照
- `user_watches` テーブル: 監視設定の作成・更新・削除・参照
- `events`, `notifications` テーブル: ウォッチ解除時の関連レコード一括削除（既存ロジックを移管）
- 既存トランザクション境界（`TransactionManager.transaction`）をユースケース内に維持する

### アーキテクチャ設計

- Domain 層: データソース / ユーザーウォッチの型定義とリポジトリ契約 (`domain/repositories/*.ts`)
- Application 層: 各ユースケースクラス (`register-data-source-watch`, `list-data-sources`, `get-data-source`, `update-data-source`, `remove-data-source-watch`) と GitHub ポート定義
- Infra 層: Drizzle 実装 (`infra/repositories/drizzle-*.repository.ts`) と GitHub Adapter (`infra/adapters/github-repository/*`)
- Presentation 層: ルートファクトリをユースケースベースに組み直し、Error ハンドリングは既存ロジックを再利用
- Index: `index.ts` で依存組み立てを行い、app.ts からは公開 API 経由でルートを取得する
- コンポジション: app.ts で `DrizzleUserRepository` を生成し、data-sources フィーチャーに注入する（直接 import は app.ts に限定）
- E2E 制御: GitHub スタブアダプタが `setStubResponse` / `resetStubs` を提供し、ルートから依存注入する

## 4. 実装ファイル一覧

### 新規作成ファイル

1. `packages/backend/src/features/data-sources/domain/repositories/data-source.repository.ts`
2. `packages/backend/src/features/data-sources/domain/repositories/user-watch.repository.ts`
3. `packages/backend/src/features/data-sources/application/ports/github-repository.port.ts`
4. `packages/backend/src/features/data-sources/application/use-cases/register-data-source-watch.use-case.ts`
5. `packages/backend/src/features/data-sources/application/use-cases/list-data-sources.use-case.ts`
6. `packages/backend/src/features/data-sources/application/use-cases/get-data-source.use-case.ts`
7. `packages/backend/src/features/data-sources/application/use-cases/update-data-source.use-case.ts`
8. `packages/backend/src/features/data-sources/application/use-cases/remove-data-source-watch.use-case.ts`
9. `packages/backend/src/features/data-sources/infra/repositories/drizzle-data-source.repository.ts`
10. `packages/backend/src/features/data-sources/infra/repositories/drizzle-user-watch.repository.ts`
11. `packages/backend/src/features/data-sources/infra/adapters/github-repository/github-repository.adapter.ts`
12. `packages/backend/src/features/data-sources/infra/adapters/github-repository/stub-github-repository.adapter.ts`
13. `packages/backend/src/features/data-sources/infra/adapters/github-repository/github-repository.factory.ts`
14. `packages/backend/src/features/data-sources/presentation/routes/index.ts`（再配置）
15. `packages/backend/src/features/data-sources/presentation/composition.ts`（ユースケース束ね用の補助ファイル ※必要に応じて）

### 更新対象ファイル

1. `packages/backend/src/features/data-sources/index.ts`
2. `packages/backend/src/features/data-sources/domain/*.ts`
3. `packages/backend/src/features/data-sources/errors/*.ts`
4. `packages/backend/src/features/data-sources/presentation/routes/data-sources/index.ts`
5. `packages/backend/src/features/data-sources/presentation/routes/e2e-control/index.ts`
6. `packages/backend/src/features/data-sources/presentation/schemas/*.ts`
7. `packages/backend/src/features/data-sources/presentation/shared/error-handling.ts`
8. `packages/backend/src/features/data-sources/presentation/__tests__/index.test.ts`（コンポーネントテスト）
9. `packages/backend/src/app.ts`
10. `packages/backend/src/features/detection/workers/process-updates/__tests__/handler.test.ts`
11. `packages/backend/src/test/factories.ts`（data-sources 関連ヘルパーがある場合）

## 5. テスト戦略

### Component Test（Presentation層）

- 既存の `presentation/routes/data-sources/__tests__/index.test.ts` を保持し、DI 変更に合わせてセットアップを更新する
- GitHub スタブを新しい adapter factory から注入し、正常系/異常系シナリオを継続確認する
- E2E 制御ルートの疎通確認を追加する（スタブ時のみ）

### Unit Test（UseCase/Infra）

- 今回は新規追加しない（課題指示に従い、必要最低限の import 修正に留める）
- 既存の repository テストが存在する場合はパス更新のみとする

### その他

- detection フィーチャーのハンドラーテストで使用している DataSourceRepository を新しい Drizzle 実装に差し替える
- `pnpm --filter backend test` を実行し、リファクタ後の回帰を確認する

## 6. 受け入れ基準

### 機能要件

- [ ] `POST /api/data-sources` が既存と同じ応答を返し、重複登録時も 200 / 409 の挙動が保たれている
- [ ] `GET /api/data-sources` のフィルタ・ページネーション結果が変わらない
- [ ] `GET /api/data-sources/{id}` がアクセス権限チェックを維持したまま詳細を返す
- [ ] `PUT /api/data-sources/{id}` がデータソース情報とウォッチ設定を一貫して更新する
- [ ] `DELETE /api/data-sources/{id}` が関連イベント/通知を削除し 204 を返す
- [ ] GitHub スタブ制御 API がスタブ有効時にのみ利用でき、実装が分離されている

### 非機能要件

- [ ] `pnpm lint` / `pnpm --filter backend lint` / `pnpm --filter backend test` が成功する
- [ ] 既存のコンポーネントテストが全て通過する
- [ ] 依存注入の組み立てが単一箇所に集約され、他フィーチャーからの直接依存が解消されている

### セキュリティ要件

- [ ] JWT 認証ミドルウェア（`requireAuth`）が全ての data-sources API に適用されている
- [ ] 認可エラーが 404 / 403 ではなく既存ロジック通りの振る舞いを維持している
- [ ] スタブ制御ルートが本番環境では無効化される

## 7. 実装手順

### Phase 1: Domain & Port 整備

- 1-1. 既存ドメイン型を整理し、ブランド ID や DTO を確認する
- 1-2. リポジトリインターフェースを `domain/repositories` に切り出す
- 1-3. GitHub ポート定義と DTO を `application/ports` に追加する

### Phase 2: UseCase / Infra 実装

- 2-1. 既存サービスロジックをユースケースクラスへ移植し、トランザクション境界を維持する
- 2-2. Drizzle リポジトリ実装を Infra 層に移動し、ポートを実装する
- 2-3. GitHub Adapter（Octokit / Stub）の factory を構築する

### Phase 3: Presentation / Composition

- 3-1. ルートファクトリを新しいユースケース DI に対応させる
- 3-2. `index.ts` / `app.ts` での依存注入を整理し、テストを更新する
- 3-3. E2E 制御ルートと関連スタブロジックを接続し直し、回帰テストを実行する

## 9. リスク・考慮事項

### 技術的リスク

- TransactionManager の呼び出し位置を移動することで、予期せぬネストやコミット漏れが発生する可能性
- detection フィーチャーなど、DataSourceRepository に依存する既存コードが新しい公開 API に追従できないリスク
- GitHub スタブ制御の依存注入を誤ると、スタブ/本番の切り替えが壊れる可能性

### 軽減策

- ユースケース移行後に段階的にコンポーネントテストを実行し、API レベルでの回帰を検知する
- 依存先（detection テストなど）の import を早期に確認し、ビルドエラーで検出する
- スタブと実アダプタを同一ポートで扱い、スタブ専用メソッドは型ガード付きで提供する
- app.ts での依存注入に単体テスト（コンポーネントテスト）を通すことで、本番設定を検証する
