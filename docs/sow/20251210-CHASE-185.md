# SOW: CHASE-185: ActivityルートのDI簡素化とテスト初期化の改善

## プロジェクト概要

**課題ID**: CHASE-185
**作成日**: 2025-12-10
**種別**: リファクタリング / 実装改善

## 1. 背景と目的

### 背景

Activity系のルート (`packages/backend/src/features/activities/presentation/routes.ts`) をHono経由でテストする際、`createActivityPresentationRoutes` に全UseCaseインスタンスを直渡ししている。

現状の問題点:

1. **テスト初期化の肥大化**
   - `createActivityPresentationRoutes` のシグネチャが3つのUseCaseを個別に要求
   - テストごとに `DrizzleActivityQueryRepository` と3つのUseCaseをインスタンス化
   - テストで使用しないUseCaseも初期化が必要

2. **保守コストの増大**
   - 機能追加でUseCaseが増えるたび、全テストの呼び出し引数を増やす必要がある
   - 例えば翻訳機能用UseCaseを追加すると、全テストファイルに影響

3. **外部サービス差し替えの柔軟性維持**
   - 翻訳クライアント/GitHubなどの外部サービスをスタブで差し替える柔軟さは維持したい

### 目的

1. ルートのシグネチャを簡素化し、テスト初期化を短縮
2. 外部サービス差し替えの柔軟性を維持
3. 新規UseCase追加時の修正箇所を1か所に集約

## 2. 実装スコープ

### 実装対象

- **デフォルト依存セット + 部分オーバーライド方式** の採用
  - 依存組み立て関数 `buildActivityDeps()` を新設
  - `createActivityPresentationRoutes(overrides?: Partial)` へシグネチャ変更
  - テスト用ファクトリ関数 `createActivityTestApp()` の新設

### 更新可能な項目

1. `createActivityPresentationRoutes` の引数形式変更
2. 既存テストの初期化コード簡素化

### 実装除外項目

- 外部アダプタ（翻訳クライアント等）のスタブ化（現時点でActivityルートでは外部APIを直接使用していない）
- 軽量サービスレジストリ方式（オーバーエンジニアリングを避ける）
- データベースやUseCaseのロジック変更

## 3. 技術仕様

### API仕様

本タスクはAPI仕様の変更なし（内部リファクタリング）。

### データベース操作

本タスクはデータベース操作の変更なし。

### アーキテクチャ設計

#### 採用方式: デフォルト依存セット + 部分オーバーライド

Plane課題の検討案1と2を組み合わせた方式を採用:

1. **依存組み立て関数 (`buildActivityDeps`)**: デフォルトの依存関係を構築
2. **テスト用ファクトリ (`createActivityTestApp`)**: テスト用アプリのセットアップを1行化

#### 依存関係フロー

```
[本番環境]
index.ts
  └── buildActivityDeps() → デフォルト依存セット
       └── createActivityPresentationRoutes(deps)
            └── Honoルート

[テスト環境]
test.ts
  └── createActivityTestApp({ useCaseOverrides: { someUseCase: fake } })
       └── buildActivityDeps({ useCaseOverrides }) → オーバーライド適用
            └── createActivityPresentationRoutes(deps)
                 └── Honoルート + globalJWTAuth
```

## 4. 実装ファイル一覧

### 新規作成ファイル

```
packages/backend/src/features/activities/
├── application/
│   └── activity-deps.ts                 # 依存組み立て関数
│       - buildActivityDeps({ useCaseOverrides }?: Partial)
│       - ActivityDeps型定義
│       - デフォルト依存セットの構築
│
└── presentation/
    └── test-helpers/
        └── create-activity-test-app.ts  # テスト用ファクトリ
            - createActivityTestApp(overrides?: Partial)
            - OpenAPIHono + globalJWTAuth + routes セットアップ
```

### 更新対象ファイル

```
packages/backend/src/features/activities/
├── index.ts
│   - buildActivityDepsのre-export
│   - createActivityPresentationRoutesの呼び出し方法変更
│
├── presentation/
│   ├── routes.ts
│   │   - シグネチャを createActivityPresentationRoutes(deps: ActivityDeps) に変更
│   │
│   └── routes/
│       ├── activities/
│       │   ├── index.ts
│       │   │   - createActivitiesRoutes の引数を deps: Pick<ActivityDeps, "..."＞ に変更
│       │   └── __tests__/
│       │       └── index.test.ts
│       │           - createActivityTestApp() を使用した初期化に変更
│       │
│       └── data-source-activities/
│           ├── index.ts
│           │   - createDataSourceActivitiesRoutes の引数を deps: Pick<ActivityDeps, "..."＞ に変更
│           └── __tests__/
│               └── index.test.ts
│                   - createActivityTestApp() を使用した初期化に変更
```

## 5. テスト戦略

### Component Test（Presentation層）

既存のテストケースはそのまま維持。初期化部分のみ変更:

**変更前:**
```typescript
const repository = new DrizzleActivityQueryRepository()
const listUserActivitiesUseCase = new ListUserActivitiesUseCase(repository)
const getActivityDetailUseCase = new GetActivityDetailUseCase(repository)
const listDataSourceActivitiesUseCase = new ListDataSourceActivitiesUseCase(repository)

app = new OpenAPIHono()
app.use("*", globalJWTAuth)
app.route(
  "/",
  createActivityPresentationRoutes(
    listUserActivitiesUseCase,
    getActivityDetailUseCase,
    listDataSourceActivitiesUseCase,
  ),
)
```

**変更後:**
```typescript
app = createActivityTestApp()
```

### Unit Test（Service層）

- 今回は実装しない（既存テストで十分カバレッジあり）

### Unit Test（Repository層）

- 今回は実装しない（変更なし）

### テストファイルの検証

- 既存テストが全て通ることを確認
- テスト初期化コードが簡素化されていることを確認

## 6. 受け入れ基準

### 機能要件

- [ ] `buildActivityDeps()` が全UseCaseのデフォルトインスタンスを返す
- [ ] `createActivityPresentationRoutes(deps)` が依存オブジェクトを受け取る形式に変更されている
- [ ] `createActivityTestApp()` がテスト用Honoアプリを返す
- [ ] `createActivityTestApp({ useCaseOverrides })` で特定のUseCaseを差し替えできる
- [ ] 既存のAPIエンドポイントの動作に変更がない

### 非機能要件

- [ ] 既存のテストが全て通る
- [ ] lint/formatエラーがない
- [ ] TypeScript型エラーがない
- [ ] テスト初期化コードが短縮されている

### セキュリティ要件

- [ ] 本タスクはセキュリティに関する変更なし

## 7. 実装手順

### Phase 1: 依存組み立て関数の作成

- 1-1. `ActivityDeps` 型を定義
- 1-2. `buildActivityDeps()` 関数を実装
- 1-3. format, lint, コミット

### Phase 2: ルート関数のシグネチャ変更

- 2-1. `createActivityPresentationRoutes` を `deps: ActivityDeps` 引数に変更
- 2-2. `createActivitiesRoutes` を `deps: Pick<ActivityDeps, ...>` 引数に変更
- 2-3. `createDataSourceActivitiesRoutes` を `deps: Pick<ActivityDeps, ...>` 引数に変更
- 2-4. `index.ts` の呼び出し方法を更新
- 2-5. format, lint, コミット

### Phase 3: テストファクトリの作成と既存テスト更新

- 3-1. `createActivityTestApp()` 関数を実装
- 3-2. `routes/activities/__tests__/index.test.ts` を更新
- 3-3. `routes/data-source-activities/__tests__/index.test.ts` を更新
- 3-4. 全テスト実行・確認
- 3-5. format, lint, コミット

## 8. 型定義詳細

### ActivityDeps型

```typescript
export interface ActivityDeps {
  listUserActivitiesUseCase: ListUserActivitiesUseCase
  getActivityDetailUseCase: GetActivityDetailUseCase
  listDataSourceActivitiesUseCase: ListDataSourceActivitiesUseCase
}
```

### buildActivityDeps関数

```typescript
export interface BuildActivityDepsOptions {
  useCaseOverrides?: Partial<ActivityDeps>
}

export function buildActivityDeps(
  options?: BuildActivityDepsOptions,
): ActivityDeps {
  const activityQueryRepository = new DrizzleActivityQueryRepository()

  return {
    listUserActivitiesUseCase:
      options?.useCaseOverrides?.listUserActivitiesUseCase ??
      new ListUserActivitiesUseCase(activityQueryRepository),
    getActivityDetailUseCase:
      options?.useCaseOverrides?.getActivityDetailUseCase ??
      new GetActivityDetailUseCase(activityQueryRepository),
    listDataSourceActivitiesUseCase:
      options?.useCaseOverrides?.listDataSourceActivitiesUseCase ??
      new ListDataSourceActivitiesUseCase(activityQueryRepository),
  }
}
```

### createActivityTestApp関数

```typescript
export interface CreateActivityTestAppOptions {
  useCaseOverrides?: Partial<ActivityDeps>
}

export function createActivityTestApp(
  options?: CreateActivityTestAppOptions,
): OpenAPIHono {
  const deps = buildActivityDeps({
    useCaseOverrides: options?.useCaseOverrides,
  })

  const app = new OpenAPIHono()
  app.use("*", globalJWTAuth)
  app.route("/", createActivityPresentationRoutes(deps))

  return app
}
```

## 9. リスク・考慮事項

### 技術的リスク

- **シグネチャ変更の影響範囲**: ルート関数のシグネチャ変更が他の呼び出し箇所に影響を与える可能性
- **型安全性**: オーバーライド時の型チェックが正しく機能するか

### 軽減策

- 段階的実装: 依存関数 → ルート変更 → テスト更新の順で実装
- 各フェーズ後にテスト実行で回帰確認
- TypeScriptの型システムによる安全性確保

### 将来の拡張性

本方式は以下の拡張に対応可能:

1. **新規UseCase追加時**: `ActivityDeps` 型と `buildActivityDeps` に追加するだけ
2. **外部アダプタのスタブ化**: `options.adapterOverrides` を追加して対応可能
3. **リポジトリの差し替え**: `options.repositoryOverrides` を追加して対応可能
