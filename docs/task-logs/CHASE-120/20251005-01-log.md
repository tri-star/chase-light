# CHASE-120 実装ログ

**作業日**: 2025-10-05
**課題**: アクティビティ一覧APIの追加
**参照SOW**: docs/sow/20251005-CHASE-120.md

## 実装計画

### Phase 1: ドメイン整備とリポジトリ実装

- [x] 1-1. `features/activities` ドメインを作成し、活動タイプ・ステータス定義を共通化
- [x] 1-2. `ActivityQueryRepository` ポートとDTOを定義
- [x] 1-3. Drizzle実装(`drizzle-activity-query.repository.ts`)で一覧・詳細・データソース別クエリを実装
- [x] 1-4. `features/detection/domain/activity.ts` の定数を新ドメインへ移設

### Phase 2: ユースケース実装

- [x] 2-1. `ListUserActivitiesUseCase` を実装し、フィルタ・ページネーションロジックを委譲
- [x] 2-2. `GetActivityDetailUseCase` を実装し、ウォッチ権限チェックを組み込む
- [x] 2-3. ユースケースのユニットテストを追加

### Phase 3: プレゼンテーション層 & ルーティング

- [x] 3-1. リクエスト/レスポンスZodスキーマとOpenAPI宣言を作成
- [x] 3-2. `GET /api/activities`, `GET /api/activities/{id}`, `GET /api/data-sources/{dataSourceId}/activities` ルートを実装
- [x] 3-3. `app.ts` にルートをマウントし、`index.ts` で公開
- [x] 3-4. コンポーネントテストで正常系・異常系を網羅

### Phase 4: サポート更新と最終確認

- [x] 4-1. `db/factories.ts` にアクティビティ関連ファクトリを追加
- [x] 4-2. ログ用チェックリスト更新・懸念事項整理
- [x] 4-3. `pnpm format`, `pnpm lint`, `pnpm --filter backend test` を実行し結果を記録

## メモ

- 認証は既存 `requireAuth` ミドルウェアを流用する。
- レスポンスの`summary`と`detail`は`activities`テーブルの`body`から派生する想定だが、SOW指示に従いリポジトリで整形ロジックを検討する。
- 通知情報は `notifications` テーブルをLEFT JOINし、最新送信日時と未読有無を返却する。

## 作業ログ

### セッション1 (2025-10-05)

- [x] SOW確認と既存コードの把握
- [x] 実装フォルダとテンプレートの調査
- [x] 実装計画を記録 (本ログ)

### セッション2 (2025-10-05)

- [x] activities ドメインとDrizzleクエリリポジトリを実装
- [x] リスト/詳細ユースケース＋ユニットテストを追加
- [x] OpenAPIスキーマ・ルート・コンポーネントテストを実装
- [x] `packages/backend/src/db/factories.ts` にアクティビティ用ファクトリを追加
- [x] `pnpm format`, `pnpm lint` 実行 (frontend lint 中に Storybook 用ポート取得エラー発生するが処理は継続)
- [x] Presentation層テストを実DBを使うコンポーネントテストに更新
- [ ] `pnpm test` / `pnpm --filter backend test` 実行 → PostgreSQL への接続権限不足で `test:migrate` が失敗、frontend test も `uv_interface_addresses` エラーで停止

