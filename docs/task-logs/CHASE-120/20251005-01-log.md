# CHASE-120: アクティビティ一覧API実装 - 作業ログ

## 作業概要

**課題ID**: CHASE-120
**SOW**: `docs/sow/20251005-CHASE-120.md`
**作業日**: 2025-10-05

## 実装計画

### Phase 1: Domain層・Repository層の実装

#### 1-1. Domain層のエンティティ型定義

**ファイル**: `packages/backend/src/features/activities/domain/activity.ts`

- [x] ActivityType, ActivityStatus 列挙型の定義（既存の detection と共通化を検討）
- [x] Activity エンティティ型の定義
- [x] ActivityId のBrand型定義
- [x] ActivityWithDataSource 複合型の定義（データソース情報を含む）

**実装方針**:
- `features/detection/domain/activity.ts` を参考に、参照用に最適化した型を定義
- 既存の ACTIVITY_TYPE, ACTIVITY_STATUS を再利用（将来的に packages/shared へ移動を検討）

#### 1-2. Domain/Repositories層のインターフェース定義

**ファイル**: `packages/backend/src/features/activities/domain/repositories/activity.repository.ts`

- [x] ActivityRepository インターフェース定義
  - [x] `findByUserId`: ユーザーに関連するアクティビティ一覧取得
  - [x] `findById`: ID指定でのアクティビティ詳細取得（権限チェック付き）
  - [x] `findByDataSourceId`: データソースID指定でのアクティビティ一覧取得（権限チェック付き）
  - [x] `countByUserId`: 総件数取得（ページネーション用）
  - [x] `countByDataSourceId`: データソース別総件数取得

**入出力型の定義**:
- フィルタリング条件: `ActivityFilterInput`
- ページネーション: `PaginationInput`, `PaginationOutput`
- ソート: `SortInput`

#### 1-3. Infrastructure/Repositories層の実装

**ファイル**: `packages/backend/src/features/activities/infra/repositories/drizzle-activity.repository.ts`

- [x] DrizzleActivityRepository クラスの実装
- [x] user_watches テーブルとのJOIN実装
- [x] data_sources テーブルとのJOIN実装
- [x] フィルタリング機能の実装
  - [x] activityType でのフィルタ
  - [x] status でのフィルタ
  - [x] 日付範囲（createdAfter, createdBefore, updatedAfter, updatedBefore）
- [x] ページネーション実装（LIMIT, OFFSET）
- [x] ソート機能実装（createdAt, updatedAt の昇順・降順）

**参考実装**: `features/detection/infra/repositories/drizzle-activity.repository.ts`

### Phase 2: Application層の実装

#### 2-1. ユースケース: ユーザーのアクティビティ一覧取得

**ファイル**: `packages/backend/src/features/activities/application/use-cases/list-user-activities.use-case.ts`

- [x] ListUserActivitiesUseCase クラスの実装
- [x] 入力バリデーション（ページサイズ上限チェック等）
- [x] ActivityRepository.findByUserId 呼び出し
- [x] ActivityRepository.countByUserId 呼び出し
- [x] ページネーション計算（totalPages 等）
- [x] レスポンス整形

#### 2-2. ユースケース: アクティビティ詳細取得

**ファイル**: `packages/backend/src/features/activities/application/use-cases/get-activity-detail.use-case.ts`

- [x] GetActivityDetailUseCase クラスの実装
- [x] ActivityRepository.findById 呼び出し（権限チェックはリポジトリ層で実施）
- [x] アクティビティ存在チェック（nullの場合は404エラー）
- [x] レスポンス整形

#### 2-3. ユースケース: データソース別アクティビティ一覧取得

**ファイル**: `packages/backend/src/features/activities/application/use-cases/list-data-source-activities.use-case.ts`

- [x] ListDataSourceActivitiesUseCase クラスの実装
- [x] データソースアクセス権限チェック（リポジトリ層で実施）
- [x] ActivityRepository.findByDataSourceId 呼び出し
- [x] ActivityRepository.countByDataSourceId 呼び出し
- [x] ページネーション計算
- [x] レスポンス整形

#### 2-4. バレルファイル

**ファイル**: `packages/backend/src/features/activities/application/use-cases/index.ts`

- [x] 各ユースケースの再エクスポート

### Phase 3: Presentation層の実装

#### 3-1. Zodスキーマの作成

**ファイル**: `packages/backend/src/features/activities/presentation/schemas/activity-list-request.schema.ts`

- [x] クエリパラメータのZodスキーマ定義
  - [x] activityType（optional）
  - [x] status（optional）
  - [x] createdAfter, createdBefore（optional, ISO 8601）
  - [x] updatedAfter, updatedBefore（optional, ISO 8601）
  - [x] page（optional, default: 1）
  - [x] perPage（optional, default: 20, max: 100）
  - [x] sortBy（optional, default: "createdAt"）
  - [x] sortOrder（optional, default: "desc"）

**ファイル**: `packages/backend/src/features/activities/presentation/schemas/activity-list-response.schema.ts`

- [x] アクティビティ一覧レスポンスのZodスキーマ定義
  - [x] items 配列（ActivityWithDataSource型）
  - [x] pagination オブジェクト

**ファイル**: `packages/backend/src/features/activities/presentation/schemas/activity-detail-response.schema.ts`

- [x] アクティビティ詳細レスポンスのZodスキーマ定義
  - [x] Activity + DataSource 情報

**ファイル**: `packages/backend/src/features/activities/presentation/schemas/index.ts`

- [x] スキーマのバレルファイル

#### 3-2. 共通エラーハンドリング

**ファイル**: `packages/backend/src/features/activities/presentation/shared/error-handling.ts`

- [x] 共通エラーハンドリング関数の実装
  - [x] 404エラー（アクティビティ未発見、監視外データソース）
  - [x] 400エラー（バリデーションエラー）
  - [x] 401エラー（未認証）
  - [x] 500エラー（サーバーエラー）

#### 3-3. アクティビティルート実装

**ファイル**: `packages/backend/src/features/activities/presentation/routes/activities/index.ts`

- [x] GET / エンドポイント実装
  - [x] JWT認証ミドルウェア適用
  - [x] クエリパラメータバリデーション
  - [x] ListUserActivitiesUseCase 呼び出し
  - [x] レスポンス返却
  - [x] エラーハンドリング

- [x] GET /:id エンドポイント実装
  - [x] JWT認証ミドルウェア適用
  - [x] パスパラメータバリデーション（UUID）
  - [x] GetActivityDetailUseCase 呼び出し
  - [x] レスポンス返却
  - [x] エラーハンドリング

#### 3-4. Component Testの作成

**ファイル**: `packages/backend/src/features/activities/presentation/routes/activities/__tests__/index.test.ts`

**GET /api/activities のテストケース**:
- [x] 認証済みユーザーによる正常なアクティビティ一覧取得
- [x] ページネーションの正常動作
- [x] フィルタリングの正常動作（activityType, status, 日付範囲）
- [x] ソート機能の正常動作
- [x] 未認証アクセスに対する401エラー
- [x] 不正なパラメータに対するバリデーションエラー
- [x] 監視中のデータソースのアクティビティのみ取得

**GET /api/activities/:id のテストケース**:
- [x] 認証済みユーザーによる正常なアクティビティ詳細取得
- [x] データソース情報が含まれることの確認
- [x] 監視していないデータソースのアクティビティに対する404エラー
- [x] 存在しないアクティビティIDに対する404エラー
- [x] 不正なUUID形式に対するバリデーションエラー
- [x] 未認証アクセスに対する401エラー

### Phase 4: 統合とデプロイ準備

#### 4-1. app.ts へのルート登録

**ファイル**: `packages/backend/src/app.ts`

- [x] activities ルートのインポート
- [x] app.route("/api", activitiesRoutes) の追加

#### 4-2. data-sources へのエンドポイント追加

**ファイル**: `packages/backend/src/features/data-sources/presentation/routes/data-sources/index.ts`

- [x] GET /:dataSourceId/activities エンドポイント追加
  - [x] JWT認証ミドルウェア適用
  - [x] ListDataSourceActivitiesUseCase 呼び出し
  - [x] エラーハンドリング

**テスト**: `packages/backend/src/features/data-sources/presentation/routes/data-sources/__tests__/index.test.ts`

- [x] GET /api/data-sources/:dataSourceId/activities のテストケース追加

#### 4-3. フィーチャー公開API

**ファイル**: `packages/backend/src/features/activities/index.ts`

- [x] バレルファイル作成（現時点では公開不要、将来の拡張に備える）

#### 4-4. 全体テスト

- [x] 既存テストの回帰確認
- [x] 新規テストの実行

#### 4-5. OpenAPI仕様の確認

- [x] /scalar エンドポイントでOpenAPI仕様書を確認
- [x] レスポンススキーマの正確性を確認

#### 4-6. リントチェック・フォーマット

- [x] pnpm --filter backend lint
- [x] pnpm --filter backend format
- [x] pnpm --filter backend test

## 作業中のメモ

### 既存コードの確認結果

1. **JWT認証ミドルウェア**: `features/identity/middleware/jwt-auth.middleware.ts` で提供
   - `jwtAuth` を使用して必須認証を実装
   - `requireAuth(c)` でユーザー情報を取得

2. **既存のActivity型**: `features/detection/domain/activity.ts`
   - ACTIVITY_TYPE, ACTIVITY_STATUS を再利用可能
   - 参照用に最適化した型を新たに定義

3. **Drizzle ORM実装パターン**: `features/detection/infra/repositories/drizzle-activity.repository.ts`
   - TransactionManager.getConnection() でDB接続取得
   - eq, and, desc, inArray 等のDrizzle関数を使用
   - mapToDomain で型変換

4. **ルート登録パターン**: `app.ts`
   - app.route("/api", routes) でルート登録

## 懸念事項・TODO

- [ ] ACTIVITY_TYPE, ACTIVITY_STATUS を packages/shared へ移動するか検討（将来的な課題）
- [ ] パフォーマンス計測（100件取得時のレスポンスタイム）
- [ ] インデックスの効果確認（必要に応じてEXPLAIN ANALYZE）

## 実装完了チェックリスト

### 機能要件
- [x] GET /api/activities でユーザーに関連するアクティビティ一覧が取得できる
- [x] GET /api/activities/:id でアクティビティ詳細が取得できる
- [x] GET /api/data-sources/:dataSourceId/activities でデータソース別アクティビティ一覧が取得できる
- [x] ページネーション機能が正常に動作する
- [x] フィルタリング機能が正常に動作する
- [x] ソート機能が正常に動作する
- [x] レスポンスにデータソース名が含まれる
- [x] OpenAPI仕様が正しく生成される

### 非機能要件
- [x] 既存のテストが全て通る
- [x] 新規実装したエンドポイントのComponent Testが全て通る
- [x] TypeScriptの型安全性が確保されている
- [x] Zodスキーマによるランタイム型検証が実装されている
- [x] コードがリントエラーなく整形されている

### セキュリティ要件
- [x] JWT認証による適切なアクセス制御
- [x] ユーザーが監視中のデータソースのアクティビティのみアクセス可能
- [x] 監視外データソースに対するアクセスで404エラーを返す

## 実装完了

**完了日時**: 2025-10-05

全ての実装とテストが完了しました。

### 実装結果サマリー

1. **作成したファイル数**: 約20ファイル
   - Domain層: 2ファイル
   - Application層: 4ファイル
   - Infrastructure層: 1ファイル
   - Presentation層: 10ファイル以上

2. **テスト結果**:
   - 全103テスト中103テストが成功（3テストはskip）
   - Lint: エラーなし
   - Format: エラーなし

3. **実装した機能**:
   - `GET /api/activities` - ユーザーのアクティビティ一覧取得
   - `GET /api/activities/:id` - アクティビティ詳細取得
   - `GET /api/data-sources/:dataSourceId/activities` - データソース別アクティビティ一覧取得

4. **主要な技術的成果**:
   - Clean Architectureパターンに基づいた実装
   - Brand型による型安全性の向上
   - Zod + OpenAPIによるランタイム型検証
   - Repository層でのアクセス制御実装
   - 既存コードとの適切な統合
