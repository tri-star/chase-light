# CHASE-102: デザイントークンのプレビューページ、LLM用デザイントークンJSONの作成 - 作業ログ

## 作業日

2025-08-25

## 課題概要

デザイントークンからTailwindのテーマ定義を作成するシステムが導入されたが、以下の課題を解決する：

- デザイントークンをメンテナンスする際の目視確認可能なプレビュー画面が不足
- LLM向けのTailwindユーティリティクラス使用指針が不足
- デザイントークンとTailwindクラスの不整合を早期発見する仕組みが不足

## 実装対象

1. Storybookデザインシステムプレビューページの作成（7カテゴリ）
2. LLM向けTailwindユーティリティドキュメントJSONの自動生成

## 既存コードの把握結果

### デザイントークンコンバーター

- パス: `packages/frontend/scripts/design-token-converter/`
- メインクラス: `DesignTokenConverter` (`index.ts`)
- 型定義: `types.ts` で `DesignTokens`, `ParsedToken`, `ThemedTokens` を定義
- パーサー: `TokenParser` (`token-parser.ts`)
- ジェネレーター: `TailwindGenerator` (`tailwind-generator.ts`)
- 実行スクリプト: `convert.ts`

### Storybook設定

- 設定ファイル: `.storybook/main.ts`
- ストーリー検索パス: `../components/**/*.mdx`, `../components/**/*.stories.@(js|jsx|ts|tsx|mdx)`
- アドオン: `@chromatic-com/storybook`, `@storybook/addon-docs`

### デザイントークン構造

`packages/frontend/design-tokens.json` に以下のカテゴリが定義済み：

- **color**: primitive (gray, blue, green, yellow, red, black, white) + semantic (light/dark theme対応)
- **typography**: font-family, scale, semantic
- **spacing**: 0, px, 0.5〜96
- **size**: spacing + auto, 1/2, full
- **border**: width, style
- **radius**: none〜full
- **shadow**: sm〜xl
- **effect**: backdrop-blur
- **transition**: duration, easing, property

## 実装計画

### Phase 1: 基盤構築 ✅

- [x] `components/design-systems/`ディレクトリ作成
- [x] 共通レイアウトパターンの検討
- [x] Storybookでのディレクトリ構成確認

### Phase 2: カラーシステム実装

- [x] `colors.stories.mdx`の実装
  - [x] プリミティブカラー（gray, blue, green, yellow, red, black, white）の表示
  - [x] セマンティックカラー（light/dark theme別）の表示
  - [x] カラーコード、Tailwindクラス名、用途の併記
  - [x] Light/Darkテーマ切り替えボタンの実装
  - [x] セマンティックカラーの実用例（ボタン、フォーム、アラート状態）表示
  - [x] bg, text, borderを組み合わせた四角形での視覚表現
- [x] TailwindのJIT問題の解決
  - [x] Storybook用Tailwind CSS生成機能の実装
  - [x] `@theme static`を利用した静的CSS生成
  - [x] 環境変数による条件分岐CSS読み込み
- [x] 表示確認とスタイル調整

### Phase 3: タイポグラフィシステム実装

- [ ] `typography.stories.mdx`の実装
  - [ ] フォントファミリー（sans, mono）の表示
  - [ ] スケール（xs〜4xl）の表示
  - [ ] セマンティックタイポグラフィ（heading-1〜4, body, body-sm, caption, code）の表示

### Phase 4: スペーシング・サイジングシステム実装

- [ ] `spacing.stories.mdx`の実装
  - [ ] スペーシングスケール（0〜96）の視覚化
  - [ ] 視覚的なゲージによる大きさ表現
- [ ] `sizing.stories.mdx`の実装
  - [ ] サイズスケールの視覚化
  - [ ] レスポンシブサイズ（1/2, full等）の表示

### Phase 5: その他要素システム実装

- [ ] `borders.stories.mdx`の実装
  - [ ] ボーダー幅（0〜8px）の表示
  - [ ] ボーダー角丸（none〜full）の表示
- [ ] `shadows.stories.mdx`の実装
  - [ ] ドロップシャドウ（sm〜xl）の表示
  - [ ] 実際のカードサンプルによる効果の可視化
- [ ] `transitions.stories.mdx`の実装
  - [ ] トランジションデュレーション（75〜1000ms）の表示
  - [ ] イージングカーブ（ease-in, ease-out, ease-in-out）の視覚化
  - [ ] プロパティグループ（colors, opacity, shadow, transform）の表示

### Phase 6: LLMドキュメント生成機能実装

- [ ] `llm-doc-generator.ts`の実装
  - [ ] `LLMDocGenerator`クラスの作成
  - [ ] `generateUtilitiesDoc()`メソッド
  - [ ] カテゴリ別ドキュメント生成ロジック（color, typography, spacing, sizing, borders, shadows, transitions）
- [ ] 既存コンバーターへの統合
  - [ ] `index.ts`の`convert()`メソッドにLLMドキュメント生成を追加
  - [ ] `convert.ts`に実行フローを追加
- [ ] 自動生成テストと動作確認
  - [ ] `docs/design/tailwind-utilities.json`の出力確認

### Phase 7: 統合テスト・調整

- [ ] 全体のStorybook表示確認
- [ ] 不整合検出の動作確認（Tailwindクラス未対応トークンの視覚的検出）
- [ ] LLMドキュメント自動生成の統合テスト
- [ ] ドキュメントの最終調整

## 技術的考慮事項

### Tailwindクラスの必須化

- 全てのスタイリングはTailwindユーティリティクラスを使用
- インラインCSSの使用は禁止
- デザイントークンに対応するTailwindクラスが存在しない場合、スタイル未適用で不整合を視覚的に検出可能

### LLMドキュメントJSON仕様

```typescript
interface TailwindUtilitiesDoc {
  color: {
    primitive: {
      [tokenName: string]: {
        tailwindClass: string;
        usage: string;
        description: string;
      };
    };
    semantic: {
      [tokenName: string]: {
        tailwindClass: string;
        usage: string;
        description: string;
      };
    };
  };
  typography: {
    [tokenName: string]: {
      tailwindClass: string;
      usage: string;
      context: string;
    };
  };
  spacing: {
    /* 同様の構造 */
  };
  sizing: {
    /* 同様の構造 */
  };
  borders: {
    /* 同様の構造 */
  };
  shadows: {
    /* 同様の構造 */
  };
  transitions: {
    /* 同様の構造 */
  };
}
```

## 進捗状況

- ✅ 既存コード把握完了
- ✅ 実装計画策定完了
- ✅ Phase 2: カラーシステム実装完了
- ✅ TailwindのJIT問題解決完了

## 次のアクション

1. Phase 3: タイポグラフィシステム実装
2. Phase 4: スペーシング・サイジングシステム実装
3. Phase 5: その他要素システム実装

## JIT問題の解決策（実装済み）

### 問題
StorybookでTailwindクラスが動的に生成される際、JITコンパイルが実行時にクラスを検出できない問題が発生。

### 解決策
1. **Storybook専用CSS生成**: `@theme static`を使用した静的CSS生成
2. **環境判定**: `NUXT_STORYBOOK`環境変数での条件分岐
3. **デュアル出力**: 通常版とStorybook版の2つのCSSファイル生成

### 実装ファイル
- `scripts/design-token-converter/tailwind-generator.ts`: `generateStorybookTailwindCSS()`追加
- `scripts/design-token-converter/index.ts`: `generateStorybookTailwindCSS()`呼び出し追加
- `nuxt.config.ts`: 環境変数による条件分岐CSS読み込み
- `package.json`: Storybookコマンドに`NUXT_STORYBOOK=1`設定

## CSS変数命名の問題と解決策（実装済み）

### 問題
デザイントークン `color.semantic.content.default.bg` が CSS変数 `--color-semantic-content-default-bg` にマップされると、Tailwindが矛盾したユーティリティクラス（例：`text-semantic-content-default-bg`や`border-semantic-content-default-bg`）を生成してしまう。

### 解決策
デザイントークンを以下のようにセマンティックにマッピング：
- bg系: `color.semantic.content.default.bg` → `--background-color-content-default` → `bg-content-default`
- text系: `color.semantic.content.default.text` → `--text-color-content-default` → `text-content-default`  
- border系: `color.semantic.content.default.border` → `--border-color-content-default` → `border-content-default`

### 実装ファイル
- `scripts/design-token-converter/token-parser.ts`: `generateSemanticCSSVarName()`メソッド追加

## Storybook colors.stories.ts の修正（実装中）

### 問題
1. **プリミティブカラー**: `bg-gray-100`形式 → `bg-color-primitive-gray-100`に変更が必要
2. **セマンティックカラー**: 新しいユーティリティクラス形式への変更が必要

### 修正内容
- プリミティブカラー: `bg-primitive-xxx`形式に統一（意図的に使いにくくする）
- セマンティックカラー: 新CSS変数に対応した`bg-content-default`等の形式に変更

### 実装ファイル  
- `components/design-systems/colors.stories.ts`: 全カラークラス名を修正

## 現在の作業状況（2025-08-25 現在）
- ✅ JIT問題解決
- ✅ CSS変数命名問題解決  
- ✅ プリミティブカラークラス修正（`bg-primitive-blue-500`形式）
- ✅ セマンティックカラークラス修正（`bg-surface-primary-default`形式）
- ✅ Storybookでの色表示確認完了
- 🚧 追加機能要求対応中：
  1. Semantic Colorsセクションの説明文改善（Light/Dark統一、クリッカブル化）
  2. 不足カテゴリ追加（content, header, sidebar, dialog）
  3. useTheme対応のテーマ切り替え実装

## 次のステップ
1. ThemeToggleコンポーネントの`useTheme`対応
2. SemanticColorsの表示改善とクリッカブル化
3. 不足しているセマンティックカテゴリの追加
4. プリミティブカラークラス名の統一（`bg-primitive-xxx`形式）

## メモ・注意点

- デザイントークン自体の変更・追加は実装除外項目
- 既存のデザイントークン変換スクリプトの改修は最小限に留める
- 新しいTailwindクラスの追加は実装除外項目
- Storybookの既存設定（`.storybook/main.ts`）では`../components/**/*.mdx`が検索対象に含まれているため、`components/design-systems/`配下のmdxファイルは自動認識される
- `@theme static`により全デザイントークンが静的に生成され、JIT問題が解決される
