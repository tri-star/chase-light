# CHASE-102 作業ログ (Phase-3以降)

- Issue: CHASE-102 デザイントークンのプレビューページ、LLM用デザイントークンJSONの作成
- SOW: docs/sow/20250825-CHASE-102.md
- 前回ログ: docs/task-logs/CHASE-102/20250825-01-log.md
- このログ: docs/task-logs/CHASE-102/20250830-01-log.md

## 0. コンテキスト要約

- Phase-1, Phase-2 は前回セッションで完了（colors のStoryおよびCSS変数ベース方針への転換、`design-token-helper.ts` 実装済み）。
- 本ログでは Phase-3 以降（Typography/Spacing/Sizing/Borders/Shadows/Transitions、LLMドキュメント生成、統合確認）に着手する。
- SOWのMDX提案に対し、既存はCSF(TypeScript)ベース（`colors.stories.ts`）。一貫性を優先して Phase-3 以降もCSFで追加実装する方針。

## 1. 進め方チェックリスト（今回セッション）

- [x] 1.  プロジェクトの概要把握（docs/project-overview.md 確認）
- [x] 2.  API仕様・設計指針把握（packages/backend/openapi.json、packages/frontend/docs/guidelines/api-implementation-guide.md 確認）
- [x] 3.  既存実装の把握（packages/frontend/server/api 配下、design-systems 既存実装の方向性確認）
- [x] 4.  実装計画の記録（本ログに記載）
- [ ] 5.  実装（Phase-3 以降）
- [ ] 6.  実装結果の記録（本ログへ追記）
- [ ] 7.  Lint, Format, Test（pnpm format/lint/test）

## 2. 対象フェーズと到達目標

- Phase-3: Typography システム
  - フォントファミリー／スケール（サイズ・行高）
  - セマンティックタイポグラフィ（heading/body/caption 等）
- Phase-4: Spacing / Sizing システム
  - スペーシングスケールの視覚化、ピクセル値とユーティリティ併記
  - サイズスケール、レスポンシブサイズの視覚化
- Phase-5: その他要素（Borders / Shadows / Transitions）
  - ボーダー幅・角丸、シャドウ段階、トランジション（duration/easing）
- Phase-6: LLM ドキュメント生成
  - `LLMDocGenerator` 実装、コンバーター統合、JSON 自動生成
- Phase-7: 統合テスト・調整
  - Storybook表示・整合性確認、LLM JSON の構文チェック

### Typography システム

TypographyはTailwindテーマ生成にあたり次のように生成をお願いします。

- フォントファミリー
  - 例: トークン(JSON)=`typography.font-family.sans.value` の場合
    - CSS変数：--font-sans
- スケール **スケールのトークンは、内部にfontFamily,fontSize,fontWeight,lineHeightを持っている**
  - 例：トークン(JSON)=`typography.font-family.scale.xs` の場合
    - CSS変数とTailwind Utilityを定義

      ```css
      @theme {
        --font-family-scale-xs: "xxx";
        --font-size-scale-xs: xxx;
        --font-weight-scale-xs: xxx;
        --line-height-scale-xs: xxx;

        <!-- xs以外も続けて定義 -->
      }
      @utility font-scale-* {
        font-family: var(--font-family-scale-*);
        font-size: var(--font-size-scale-*);
        font-weight: var(--font-weight-scale-*);
        line-height: var(--line-height-scale-*);
      }
      ```

- セマンティック
  - 例：トークン(JSON)=`typography.semantic.heading-1` の場合 **セマンティックのトークンはスケールのエイリアスのため、内部にfontFamily,fontSize,fontWeight,lineHeightを持っている**
    - CSS変数とTailwind Utilityを定義

      ```css
      @theme {
        --font-family-semantic-heading-1: "xxx";
        --font-size-semantic-heading-1: xxx;
        --font-weight-semantic-heading-1: xxx;
        --line-height-semantic-heading-1: xxx;

        <!-- heading-1以外も続けて定義 -->
      }
      @utility font-semantic-* {
        font-family: var(--font-family-semantic-*);
        font-size: var(--font-size-semantic-*);
        font-weight: var(--font-weight-semantic-*);
        line-height: var(--line-height-semantic-*);
      }
      ```

### LLM ドキュメント生成

**LLM用ドキュメントでは、semantic colorはlight/darkを区別せずに出力してください。(lightの値だけ出力するなど)**

```typescript
interface TailwindUtilitiesDoc {
  color: {
    primitive: {
      description: string; // descriptionはデザイントークンの$descriptionをそのまま出力
      tokens: {
        [tokenName: string]: {
          // tokenNameの例： "gray.50"
          tailwindClasses: string[]; // 例: ["bg-gray-50", "text-gray-50", "border-gray-50"]
          description?: string;
        };
      };
    };
    semantic: {
      description: string;
      tokens: {
        [tokenName: string]: {
          // tokenNameの例： "surface.primary.default.bg"
          tailwindClass: string; // 例: "bg-surface-primary-default"
          description?: string;
        };
      };
    };
  };
  typography: {
    description: string;
    tokens: {
      [tokenName: string]: {
        // tokenNameの例： "font-family.sans", "scale.xs", "semantic.heading-1"
        tailwindClass: string;
        // tailwindClassの例： "font-sans", "font-scale-xs", "font-semantic-heading-1"
        description?: string;
      };
    };
  };
  spacing: {
    description: string; // spacingでは、固定文字列で"TailwindCSSで利用可能なw-*,h-*,gap-*などを利用可能。値は以下に挙げる値から選択" を出力
    values: string[]; // デザイントークンにある値を列挙。例：0,px,0.5,1,2,3,...
  };
  sizing: {
    description: string; // sizingでは、固定文字列で"TailwindCSSで利用可能なw-*,h-*,gap-*などを利用可能。値は以下に挙げる値から選択" を出力
    values: string[]; // デザイントークンにある値を列挙。例：0,px,0.5,1,2,3,auto,1/2,full...
  };
  borders: {
    description: string;
    width: {
      values: string[]; // デザイントークンにある値を列挙。例：0,1,2,4...
    };
    styles: {
      values: string[]; // デザイントークンにある値を列挙。例：solid,dashed,dotted,...
    };
  };
  radius: {
    description: string; // 固定文字列で"TailwindCSSで利用可能なborder-*などを利用可能。値は以下に挙げる値から選択" を出力
    values: string[]; // デザイントークンにある値を列挙。none,sm,default,md,lg,full,...
  };
  shadows: {
    description: string; // 固定文字列で"TailwindCSSで利用可能なborder-*などを利用可能。値は以下に挙げる値から選択" を出力
    values: string[]; // デザイントークンにある値を列挙。sm,default,md,lg,xl,...
  };
}
```

## 3. ファイル変更計画（追加/更新）

- 追加（CSF: TypeScript Stories）
  - packages/frontend/components/design-systems/typography.stories.ts
  - packages/frontend/components/design-systems/spacing.stories.ts
  - packages/frontend/components/design-systems/sizing.stories.ts
  - packages/frontend/components/design-systems/borders.stories.ts
  - packages/frontend/components/design-systems/shadows.stories.ts
  - packages/frontend/components/design-systems/transitions.stories.ts
  - 必要に応じ `packages/frontend/components/design-systems/parts/` に表示用小コンポーネント追加

- 既存ヘルパの再利用/拡張
  - packages/frontend/components/design-systems/design-token-helper.ts
    - タイポグラフィ／スペーシング／サイジング／ボーダー／シャドウ／トランジション向けの取得ヘルパ追加（CSS変数→表示データ化）

- LLM ドキュメント生成
  - 追加: packages/frontend/scripts/design-token-converter/llm-doc-generator.ts
  - 更新: packages/frontend/scripts/design-token-converter/index.ts（generateAll に統合）
  - 更新: packages/frontend/scripts/design-token-converter/convert.ts（実行フローに追加）
  - 出力: packages/frontend/docs/design/tailwind-utilities.json（自動生成）

## 4. 実装タスク詳細（チェックリスト）

- Phase-3 Typography
  - [x] `typography.stories.ts` 作成（フォント、スケール、セマンティック）
  - [x] `DesignTokenHelper` にタイポグラフィ系取得メソッドを追加
  - [x] CSS変数ベース表示（`font: var(--typography-scale-*)` / `font: var(--typography-semantic-*)`、font-familyは `fontFamily: var(--typography-font-family-*)`）

- Phase-4 Spacing / Sizing
  - [x] `spacing.stories.ts` 作成（ゲージ表示 + 値/クラス併記）
  - [x] `sizing.stories.ts` 作成（矩形表示 + 値/クラス併記）
  - [x] ヘルパの取得ロジック追加（`getSpacingScale`/`getSizeScale`）

- Phase-5 Borders / Shadows / Transitions
  - [ ] `borders.stories.ts` 作成（幅・角丸バリエーション）
  - [ ] `shadows.stories.ts` 作成（段階表現、カード例）
  - [ ] `transitions.stories.ts` 作成（duration/easing、インタラクション）

- Phase-6 LLM Doc 生成
  - [ ] `llm-doc-generator.ts` 実装（カテゴリ別ドキュメント生成）
  - [ ] `index.ts`/`convert.ts` 統合（既存生成フローに追加）
  - [ ] `tailwind-utilities.json` 出力検証（構文/含有項目）

- Phase-7 統合確認
  - [ ] Storybook 表示確認（7カテゴリ）
  - [ ] デザイントークンとユーティリティの整合性（スタイル外れ検出）
  - [ ] LLM JSON チェック（構文・期待構造）

## 5. 既存実装の前提/考慮

- Tailwind v4 JIT 制約 → CSS変数を直接参照し、Tailwind クラスは表示上のガイドとして併記。
- 既存 `colors.stories.ts` と同様に、`v-for` 的動的列挙でも崩れない方式を踏襲。
  - `colors.stories.ts` は反省点があり、1ファイルに全てを記述するのは失敗だったと考えています。
    - 今後作成するページでは、パーツ化出来そうな要素はpartsサブディレクトリの中に小コンポーネントとして切り出すことを検討してください。
- Orval/Zod 等の API 連携は今回スコープ外（BFF 層の設計指針は踏まえつつ Storybook 側で完結）。

## 6. リスクと対策

- ユーティリティ欠如: 一部デザイントークンに対応ユーティリティが無い → クラス併記はガイド扱い、CSS変数で視覚表示は担保。
- 変数の欠落/命名差: 既存 `generateFallbackCssVar` を活用してフォールバック生成・表示を継続。
- Storybook 負荷: 表示項目が多い → 段階追加、最小限の例示に留める。

## 7. 実装メモ（随時更新）

決定事項・議論ログは本節に追記していく。

### 2025-08-30 Phase-3 進捗

- 追加: `packages/frontend/components/design-systems/typography.stories.ts`（Fonts/Scales/Semantic をCSFで実装）
- 追加: `DesignTokenHelper` にタイポグラフィ取得API（`getTypographyFonts`/`getTypographyScales`/`getTypographySemantic`）
- 表示は合意通り、スケール/セマンティックで `font: var(--typography-...)` を利用。
- 必要に応じて `pnpm --filter frontend generate:tailwind-theme` を実行して `assets/css/tailwind.css` を更新。

- デザイントークンのプレビューのように動的にHTMLを出力する画面ではtailwind.cssのCSS変数がJITによりほとんど出力されないことが分かった。
  これへの対策として、tailwind.cssでテーマのCSS変数を出力する際、`@theme static`で出力するように変更した。

## 8. 参考

- プロジェクト概要: docs/project-overview.md
- API 仕様: packages/backend/openapi.json
- フロントエンド API 実装ガイド: packages/frontend/docs/guidelines/api-implementation-guide.md
- テスト戦略: packages/frontend/docs/testing-strategy.md

---

この計画で進めて問題なければ、Phase-3 Typography から実装を開始します。レビュー・補足指示があればお願いします。
