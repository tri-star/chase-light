# CHASE-122 実装ログ

## タスク概要

**課題ID**: CHASE-122
**作成日**: 2025-10-16
**種別**: 新機能開発
**タイトル**: アクティビティからNotification一覧を生成する仕組みの実装

## 目的

- アクティビティ情報から購読ユーザーを解決し、ユーザーごとのNotificationレコードを生成するバッチ処理を実装
- 通知の実送信は別課題とし、本課題では通知候補データの作成までを対象
- ユーザーの通知設定（ダイジェスト通知時刻）を考慮し、適切な`scheduled_at`を計算してNotificationに設定

## 実装計画

### Phase 1: DBスキーマ更新とマイグレーション

- [x] 1-1. `packages/backend/src/db/schema.ts`の更新
  - `notifications`テーブルに`scheduledAt`と`status`カラムを追加
  - `user_preferences`テーブルに`digestNotificationTimes`カラムを追加
  - インデックスの追加
- [x] 1-2. Drizzle Kitでマイグレーションファイルを生成
- [x] 1-3. マイグレーションファイルの内容確認
- [x] 1-4. マイグレーション実行
- [x] 1-5. スキーマ変更の動作確認
- [x] 1-6. Phase 1完了後、コミット

### Phase 2: Domain層の実装

- [x] 2-1. `notification.ts` の実装（Notificationエンティティ型定義）
- [x] 2-2. `recipient.ts` の実装（Recipientエンティティ型定義）
- [x] 2-3. `notification-schedule.ts` の実装（通知時刻計算ロジック）
- [x] 2-4. `notification-schedule.test.ts` の作成・実行（Unit Test）
- [x] 2-5. `domain/repositories/` 配下のポートインターフェース定義
  - `notification.repository.ts`
  - `recipient.repository.ts`
  - `activity-subscriber.repository.ts`
- [x] 2-6. Phase 2完了後、コミット

### Phase 3: Infra層の実装

- [x] 3-1. `drizzle-notification.repository.ts` の実装
- [x] 3-2. `drizzle-recipient.repository.ts` の実装
- [x] 3-3. `drizzle-activity-subscriber.repository.ts` の実装
- [x] 3-4. Phase 3完了後、コミット

### Phase 4: Application層の実装

- [x] 4-1. `constants/notification.constants.ts` の作成
- [x] 4-2. `create-notifications.use-case.ts` の実装
- [x] 4-3. ユースケースのロジック確認
- [x] 4-4. Phase 4完了後、コミット

### Phase 5: Workers層の実装

- [ ] 5-1. `workers/create-notifications/handler.ts` の実装
- [ ] 5-2. `workers/create-notifications/index.ts` の作成
- [ ] 5-3. `workers/create-notifications/__tests__/handler.test.ts` の作成・実行
- [ ] 5-4. Phase 5完了後、コミット

### Phase 6: Lambda設定とデプロイ準備

- [ ] 6-1. `scripts/lambda-config.mjs` に`create-notifications`を追加
- [ ] 6-2. `infrastructure/sam-template.yaml` に`CreateNotificationsFunction`を追加
- [ ] 6-3. Lambda関数のビルド確認
- [ ] 6-4. Phase 6完了後、コミット

### Phase 7: 統合テストと最終確認

- [ ] 7-1. 全テストの実行
- [ ] 7-2. Lint・Formatの実行
- [ ] 7-3. 型チェックの実行
- [ ] 7-4. 受け入れ基準の確認
- [ ] 7-5. 最終コミット
- [ ] 7-6. リモートにpush
- [ ] 7-7. PR作成

## 実装詳細

### ディレクトリ構成

```
packages/backend/src/features/notification/
├── domain/
│   ├── notification.ts
│   ├── recipient.ts
│   ├── notification-schedule.ts
│   └── repositories/
│       ├── notification.repository.ts
│       ├── recipient.repository.ts
│       └── activity-subscriber.repository.ts
├── application/
│   └── use-cases/
│       └── create-notifications.use-case.ts
├── infra/
│   └── repositories/
│       ├── drizzle-notification.repository.ts
│       ├── drizzle-recipient.repository.ts
│       └── drizzle-activity-subscriber.repository.ts
├── workers/
│   └── create-notifications/
│       ├── handler.ts
│       ├── index.ts
│       └── __tests__/handler.test.ts
├── constants/
│   └── notification.constants.ts
└── index.ts
```

## 実装メモ

### スキーマ変更内容

#### notificationsテーブル

- `scheduledAt`: ダイジェスト通知の予定送信時刻
- `status`: 通知の状態（'pending' | 'sent' | 'failed'）

#### user_preferencesテーブル

- `digestNotificationTimes`: 通知時刻のリスト（例: ['18:00', '18:30']）

### 重要な実装ポイント

1. **UPSERT処理**
   - 既に`status='sent'`または`status='failed'`のレコードは更新しない
   - `status='pending'`のレコードのみ更新対象
   - ON CONFLICT時の更新条件: `WHERE notifications.status = 'pending'`

2. **通知時刻計算**
   - ユーザーのタイムゾーンを考慮
   - 現在時刻より後の最も近い時刻を選択
   - 該当する時刻が今日中にない場合は翌日の最初の時刻を選択

3. **購読ユーザーの解決**
   - `user_watches`テーブルから`notification_enabled=true`かつ該当のアクティビティタイプを監視しているユーザーを抽出

## 懸念事項・TODO

なし

## 進捗状況

### 完了したフェーズ

- ✅ Phase 1: DBスキーマ更新とマイグレーション
  - `notifications`テーブルに`scheduledAt`と`status`カラムを追加
  - `user_preferences`テーブルに`digestNotificationTimes`カラムを追加
  - マイグレーションファイル生成・実行完了
  - コミット: 96b9158

- ✅ Phase 2: Domain層の実装
  - `notification.ts`: Notificationエンティティ、Brand型、型定義
  - `recipient.ts`: Recipientエンティティ
  - `notification-schedule.ts`: 通知時刻計算ロジック
  - `repositories/`: 3つのリポジトリポート定義
  - Unit test実装と全テスト成功
  - コミット: 95407f8

- ✅ Phase 3: Infra層の実装
  - `drizzle-notification.repository.ts`: NotificationRepositoryポートの実装
  - `drizzle-recipient.repository.ts`: RecipientRepositoryポートの実装
  - `drizzle-activity-subscriber.repository.ts`: ActivitySubscriberRepositoryポートの実装
  - Lint、Format実行完了
  - コミット: 3507b0a

- ✅ Phase 4: Application層の実装
  - `notification.constants.ts`: デフォルト値、制限値、エラーメッセージ、通知テンプレート定義
  - `create-notifications.use-case.ts`: アクティビティから購読ユーザーを解決し、Notificationレコードを生成するユースケース
  - 未処理アクティビティの取得と購読ユーザーの解決
  - 通知時刻の計算とNotificationレコードの一括UPSERT
  - Lint、Format実行完了
  - コミット: 576ba08

### 次回セッションで実装予定
- Phase 5: Workers層の実装
- Phase 6: Lambda設定とデプロイ準備
- Phase 7: 統合テストと最終確認

## 完了日時

進行中（Phase 4まで完了）
