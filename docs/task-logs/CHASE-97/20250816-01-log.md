# CHASE-97: Auth0トークンの再発行処理 - 作業ログ

## 作業概要

**課題ID**: CHASE-97  
**種別**: 機能改善  
**作業日**: 2025-08-16  

Auth0のアクセストークンが期限切れになった際の自動再発行機能の実装

## 実装計画

### Phase 1: セッション管理機能の拡張
- [ ] 1-1. `UserSession`インターフェースに`accessTokenExpiresAt`追加
- [ ] 1-2. `getAccessTokenFromSession()`関数の実装
- [ ] 1-3. `setUserSession()`の更新（トークン有効期限保存）
- [ ] 1-4. ユニットテストの作成・実行

### Phase 2: Auth0コールバック処理の更新
- [ ] 2-1. `callback.get.ts`でトークン有効期限の計算・保存
- [ ] 2-2. 統合テストの実行

### Phase 3: 認証ミドルウェアの実装
- [ ] 3-1. `auth.ts`ミドルウェアの作成
- [ ] 3-2. トークン期限チェック + 自動更新ロジック
- [ ] 3-3. ログインエンドポイント除外処理
- [ ] 3-4. ミドルウェアのテスト作成・実行

### Phase 4: 既存コードのリファクタリング
- [ ] 4-1. 各APIルートから`requireUserSession(event)`削除
- [ ] 4-2. `custom-fetch.ts`の関数呼び出し変更
- [ ] 4-3. `session-als.ts`の削除
- [ ] 4-4. 全体的な回帰テスト実行

### Phase 5: データベースマイグレーション
- [ ] 5-1. Drizzleスキーマ更新（sessionsテーブルにaccess_token_expires_atカラム追加）
- [ ] 5-2. Drizzle Kitでマイグレーション生成（意味のある名前指定）
- [ ] 5-3. マイグレーション実行
- [ ] 5-4. データベースカラム追加の動作確認

## 実装ファイル一覧

### 新規作成ファイル
1. `packages/frontend/server/api/middleware/auth.ts` - 認証ミドルウェア

### 更新対象ファイル
1. `packages/frontend/server/api/auth/callback.get.ts` - トークン有効期限追加
2. `packages/frontend/server/utils/session.ts` - セッション管理機能拡張
3. `packages/frontend/server/api/data-sources/index.get.ts` - 個別認証処理削除
4. `packages/frontend/server/api/data-sources/index.post.ts` - 個別認証処理削除
5. `packages/frontend/server/api/protected/test.get.ts` - 個別認証処理削除
6. `packages/frontend/libs/orval/custom-fetch.ts` - 関数呼び出し変更

### 削除対象ファイル
1. `packages/frontend/server/utils/session-als.ts` - 機能を`session.ts`に統合後削除

## セッション情報の拡張仕様

```typescript
export interface UserSession {
  id: string
  userId?: string
  email?: string
  name?: string
  avatar?: string
  provider?: string
  accessToken?: string
  refreshToken?: string
  accessTokenExpiresAt?: Date  // 新規追加
  expiresAt?: Date
  createdAt: Date
  updatedAt: Date
  loggedInAt: Date
  [key: string]: unknown
}
```

## トークン更新フロー

1. ミドルウェアでセッション情報を取得
2. アクセストークンの有効期限をチェック
3. 期限が1分未満の場合、リフレッシュトークンでアクセストークンを再発行
4. 新しいトークンをセッションに保存
5. リフレッシュ失敗時は401エラーを返す

## 作業進捗

### 完了した作業
- [x] SOWの内容確認と実装計画の立案
- [x] 作業ログの作成
- [x] API仕様書と設計指針の把握
- [x] 既存のコードの実装把握
- [x] Phase 1: セッション管理機能の拡張
  - [x] `UserSession`インターフェースに`accessTokenExpiresAt`追加
  - [x] `getAccessTokenFromSession()`関数の実装
  - [x] `updateUserSession()`関数の実装
- [x] Phase 2: Auth0コールバック処理の更新
  - [x] `callback.get.ts`でトークン有効期限の計算・保存
- [x] Phase 3: 認証ミドルウェアの実装
  - [x] `auth.ts`ミドルウェアの作成（正しい場所：`server/middleware/auth.ts`）
  - [x] トークン期限チェック + 自動更新ロジック
  - [x] ログインエンドポイント除外処理
- [x] Phase 4: 既存コードのリファクタリング
  - [x] 各APIルートから`requireUserSession(event)`削除
  - [x] `custom-fetch.ts`の関数呼び出し変更（`getAccessTokenFromALS`→`getAccessTokenFromSession`）
  - [x] `session-als.ts`の削除
  - [x] 不要な認証チェック処理の削除（ミドルウェアで処理済みのため）
- [x] Phase 5: データベースマイグレーション
  - [x] Drizzleスキーマ更新（sessionsテーブルにaccess_token_expires_atカラム追加）
  - [x] Drizzle Kitでマイグレーション生成（意味のある名前：`add_access_token_expires_at_to_sessions`）
  - [x] マイグレーション実行（0006_add_access_token_expires_at_to_sessions.sql）
  - [x] データベースカラム追加の動作確認

### 現在進行中の作業
- なし

### 次に取り組む作業
- 動作確認
- 最終ドキュメント更新

## 実装の詳細

### 新規作成ファイル
- `packages/frontend/server/middleware/auth.ts` - 認証ミドルウェア

### 更新したファイル
1. `packages/frontend/server/utils/session.ts`
   - `UserSession`インターフェースに`accessTokenExpiresAt`追加
   - `getAccessTokenFromSession()`関数追加
   - `updateUserSession()`関数追加
   - セッション作成時にアクセストークン有効期限を保存

2. `packages/frontend/server/api/auth/callback.get.ts`
   - アクセストークン有効期限の計算と保存処理追加

3. `packages/frontend/server/api/data-sources/index.get.ts`
   - `requireUserSession(event)`削除
   - 不要な認証チェック削除

4. `packages/frontend/server/api/data-sources/index.post.ts`
   - `requireUserSession(event)`削除
   - 不要な認証チェック削除

5. `packages/frontend/server/api/protected/test.get.ts`
   - `requireUserSession(event)`を`getUserSession(event)`に変更
   - 不要なnullチェック削除（ミドルウェアで認証済み）

6. `packages/frontend/libs/orval/custom-fetch.ts`
   - `getAccessTokenFromALS()`を`getAccessTokenFromSession(useEvent())`に変更

### 削除したファイル
- `packages/frontend/server/utils/session-als.ts` - 機能を`session.ts`に統合後削除

### データベースマイグレーション
- `packages/backend/src/db/migrations/0006_add_access_token_expires_at_to_sessions.sql` - 新規作成
  - `sessions`テーブルに`access_token_expires_at`カラム追加

## 懸念事項・備考

- 同時並列リクエスト時の競合状態対策：Auth0のリフレッシュトークンLeeway（10秒程度）を活用
- トークン更新タイミング：有効期限1分前に設定してレート制限を回避
- セッション管理の一元化により、既存の個別認証判定ロジックを削除
- ミドルウェアの配置場所修正：`server/api/middleware/` → `server/middleware/`
- ~~データベースにaccess_token_expires_atカラムが必要（マイグレーション要確認）~~ → Phase 5で対応完了

## 完了したPhase 5の詳細

### データベースマイグレーション作業

1. **Drizzleスキーマ更新**
   - `packages/backend/src/db/schema.ts`の`sessions`テーブルに`accessTokenExpiresAt`フィールドを追加
   - 型: `timestamp("access_token_expires_at", { withTimezone: true })`

2. **マイグレーション生成**
   - コマンド: `pnpm --filter backend db:generate --name add_access_token_expires_at_to_sessions`
   - 生成ファイル: `0006_add_access_token_expires_at_to_sessions.sql`
   - 実行内容: `ALTER TABLE "sessions" ADD COLUMN "access_token_expires_at" timestamp with time zone;`

3. **マイグレーション実行**
   - コマンド: `pnpm --filter backend db:migrate`
   - 結果: マイグレーション実行成功、データベースに新しいカラムが追加済み

## まとめ

Auth0のアクセストークン自動再発行機能の実装が完了しました。

### 実装した機能
- トークンの有効期限を監視し、1分前になると自動でトークンを更新
- ミドルウェアによる一元的な認証管理
- セッション情報の拡張とデータベースマイグレーション

### アーキテクチャの改善点
- 各APIルートでの個別認証チェックを削除し、ミドルウェアで一元管理
- セッション管理機能の統合と強化
- データベーススキーマの拡張（access_token_expires_atカラム追加）

### セキュリティとユーザビリティの向上
- ユーザーがログアウトされることなく、シームレスにアプリを利用可能
- トークンリフレッシュ失敗時の適切なエラーハンドリング
- Auth0のベストプラクティスに従った実装