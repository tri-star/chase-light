# CHASE-154 作業ログ 2025-11-05 01

## 今日の目的
- SOW `docs/sow/20251103-CHASE-154.md` に基づき、ダッシュボードからのデータソース追加フローを段階的に実装する。

## 参照メモ
- プロジェクト概要: `docs/project-overview.md`
- API仕様: `packages/backend/openapi.json`
- 実装ガイド: `packages/frontend/docs/guidelines/*`
- 既存実装の主な参照:
  - `packages/frontend/pages/dashboard.vue`
  - `packages/frontend/components/pages/dashboard/DashboardPage.vue`
  - `packages/frontend/server/api/data-sources/index.post.ts`

## 実装計画 (初版)
- [x] Step 1: Phase 1 — Shared GitHub URLユーティリティ
  - [x] `packages/shared/src/utils/github.ts` を新規作成し、`parseGitHubRepositoryUrl` / `isGitHubRepositoryUrl` を実装
  - [x] `packages/shared/src/index.ts` からユーティリティを再エクスポート
  - [x] `packages/shared/tests/utils/github.test.ts` でユニットテスト追加
  - [x] `packages/backend/src/features/data-sources/application/use-cases/register-data-source-watch.use-case.ts` で shared ユーティリティを利用
- [x] Step 2: Phase 2 — UI基盤 (トースト / モーダル / FAB)
  - [x] `packages/frontend/composables/use-toast.ts`（仮）で `useToast` ストアとAPIを実装
  - [x] `packages/frontend/components/common/ToastContainer.vue` とテスト、ストーリーを実装
  - [x] `packages/frontend/components/base/ClToast.vue` + stories + tests を追加
  - [x] `packages/frontend/components/base/ClModalDialog.vue` + stories + tests を追加
  - [x] `packages/frontend/components/base/ClFabButton.vue` + stories + tests を追加
  - [x] `packages/frontend/components/base/layouts/default/ClLayoutDefault.vue` に `ToastContainer` を組み込み
- [ ] Step 3: Phase 3 — ダッシュボード統合
  - [ ] `packages/frontend/components/pages/dashboard/parts/AddDataSourceModal.vue` と関連テスト/Stories/VRTを実装
  - [ ] `packages/frontend/components/pages/dashboard/parts/DataSourceFabButton.vue` と関連テスト/Storiesを実装
  - [ ] `packages/frontend/components/pages/dashboard/DashboardPage.vue` を更新し、FAB/モーダル制御、API呼び出し、トースト表示、`refreshNuxtData` を結線
  - [ ] `packages/frontend/tests/dashboard.authenticated.spec.ts` を拡張してデータソース追加シナリオを追加（実行はユーザーに依頼）
  - [ ] Storybook/VRT テストコードを更新して新しいUIをカバー

## 今後のメモ
- Lint/Format/Test (`pnpm format`, `pnpm lint`, `pnpm test`) は各フェーズ完了時に実行予定。
- Playwright 実行と VRT スナップショット更新はユーザーへ依頼する予定。

## 作業ログ

### 2025-11-05 Phase 1
- shared に `parseGitHubRepositoryUrl` / `isGitHubRepositoryUrl` を実装し、`globalThis.URL` を使った URL 解析で `.git` / 末尾スラッシュ対応を統一化。
- `packages/shared/tests/utils/github.test.ts` を追加し、正常系3パターン + 異常系4パターンをカバー。
- backend `RegisterDataSourceWatchUseCase` を shared ユーティリティ経由に変更し、正規表現を除去。
- ルートの `pnpm test` に shared テストを含めるよう更新。
- `pnpm format` / `pnpm lint` / `pnpm test`（＋ `pnpm --filter shared test` 再実行）を完了、全て成功。

### 2025-11-05 Phase 2
- Nuxt composable `useToast` を作成し、`showToast` / `dismissToast` / `clearToasts` と自動クローズ（デフォルト5秒・NULLで無効化）を実装。`useState` モックでテスト (`vi.useFakeTimers`) を整備。
- `ClToast` base コンポーネントを新設し、バリアント別のアクセント色、`aria-live` 切替、閉じるボタン、ストーリー/単体テストを追加。
- `ToastContainer` を `Teleport` + `TransitionGroup` で実装し、SR 向け属性 (`aria-live="assertive"`, `aria-atomic`) を付与。テストでは Teleport をスタブし close 操作を検証。
- `<dialog>` ベースの `ClModalDialog` を実装し、`v-model:open`、ESC/backdrop 閉じ、フォーカス復帰をカバー。JSDOM向け `showModal` ポリフィルで単体テストを整備。
- `ClFabButton` を追加し、サイズバリアント/アクセシビリティ (`aria-label`) を持つ FAB UI を提供。
- `ClLayoutDefault` に `ToastContainer` を組み込み、レイアウト全体でトーストが表示できるように接続。
- コマンド実行: `pnpm --filter frontend format`, `pnpm --filter frontend lint`, `pnpm --filter frontend test`。
