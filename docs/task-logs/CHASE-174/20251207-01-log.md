# CHASE-174 作業ログ 2025-12-07-01

- SOW: `docs/sow/20251207-CHASE-174.md`
- ブランチ: `feature/CHASE-174-activity-body-translate-api`

## 今日の進め方
- Phase1のDB/ドメイン整備から着手し、本文翻訳ステータスの基盤を追加する。
- マイグレーションはDrizzle生成物を利用し、手動修正は行わない。
- 作業ごとにlint/format/testを確認する。

## チェックリスト（SOW対応）
- [x] Phase1: DB/Domain整理
  - [x] 1-1. 本文翻訳用の新カラム・インデックスのマイグレーション追加
- [x] 1-2. Drizzleスキーマ・ドメイン定義・共有定数の更新
- [x] 1-3. format / lint の実行
- [ ] Phase2: UseCase/Infra実装
- [ ] Phase3: Presentation/統合テスト

## 実装計画（本フェーズ）
- [x] `packages/shared/src/constants` に本文翻訳ステータス定義を追加し共有できるようにする。
- [x] `packages/backend/src/db/schema.ts` に本文翻訳用カラム・インデックスを追加する。
- [x] `packages/backend/src/features/activities/domain/activity.ts` に本文翻訳ステータス/タイムスタンプ/エラーを取り込む。
- [x] 上記変更を基に `pnpm --filter backend db:generate` でマイグレーションを生成する。
- [x] `pnpm format` / `pnpm lint` / `pnpm test` を実行し結果を確認する。
- [x] 本文翻訳ユースケース/ポート/リポジトリ/ワーカーの骨組みを追加し、OpenAI翻訳アダプタを用意する。

## 懸念点・メモ
- 既存の`status`との混同を避けるため、翻訳専用ステータスを分離した設計を維持する。
- マイグレーションは生成物のため手動編集しない方針。

## 作業ログ
- packages/shared に本文翻訳ステータス定数 (`ACTIVITY_BODY_TRANSLATION_STATUS`) と型を追加し、activitiesドメインとdetectionドメインで再利用できるようにした。
- activitiesスキーマに本文翻訳専用カラム（状態/タイムスタンプ/エラー）とインデックスを追加し、ドメイン型・Query/Detectionリポジトリ・テストデータファクトリを新フィールド対応へ更新。
- Drizzleのマイグレーションを生成：`packages/backend/src/db/migrations/0011_tense_the_twelve.sql`（metaスナップショットも更新）。
- `pnpm format` / `pnpm lint` / `pnpm test` を実行し完了（lint初回で型エラーが出たためテストデータを補完して解消、テストは全パッケージ成功・一部ログ出力のみ）。
- 本文翻訳向けドメイン状態・リポジトリポートを追加し、Drizzle実装でステータス遷移/ロック/ペンディング取得を実装。
- 翻訳ポートとOpenAIアダプタ（スタブ/Null含む）をactivities配下に追加。
- 本文翻訳のリクエスト/ステータス取得/処理ユースケースを実装し、Lambdaワーカー `translate-activity-body` のハンドラーを追加。
