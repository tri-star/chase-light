# CHASE-174 アクティビティ本文翻訳リクエストAPI 作業ログ (2025-12-08)

- SOW: `docs/sow/20251208-CHASE-174.md`
- フェーズ: Implement
- 本フェーズ方針: SOWに沿ってBackend側の翻訳リクエスト/ステータスAPIとワーカーを段階的に実装する。まずスキーマ・ドメインの基盤を整備する。

## 実装計画 (今回セッション)
- [x] Phase1-1: `activities` テーブルに翻訳ステータス関連カラムとインデックスを追加する
- [x] Phase1-2: 翻訳ステータス定数を `packages/shared` に追加し、Backendのドメイン/リポジトリポートを整備する
- [ ] Phase1-3: 関連箇所の型エクスポートやDI配線を確認（必要に応じて後続フェーズで対応）
- [x] Phase2-1: 翻訳リクエスト/ステータス取得/ワーカー用ユースケースを追加
- [x] Phase2-2: TranslationJobQueuePort・BodyTranslationPort、Drizzleリポジトリ実装、OpenAI/Stubアダプタを追加
- [x] Phase2-3: DI配線、翻訳APIルート追加、テスト下準備
- [x] Phase3-1: 翻訳ワーカーハンドラー追加（SQSコンシューマー想定、スタブ翻訳をデフォルト利用）
- [ ] Phase3-2: OpenAPI更新・サーバー全体への配線確認（次セッション）

## 本日の作業メモ
- 新マイグレーション `0011_bitter_ares.sql` で翻訳ステータス列を追加。
- shared に `activity-translation` 定数を追加し、Activitiesドメインに翻訳ステート/ポート定義を追加。
- ユースケース: `request-activity-translation`, `get-activity-translation-status`, `process-activity-translation-job` を作成。
- ポート/アダプタ: SQSキュー用ポート・アダプタ、本文翻訳ポート＋OpenAI実装/スタブを追加。
- Drizzleリポジトリ: `drizzle-activity-translation-state.repository.ts` を追加し翻訳カラム更新/取得をまとめた。
- テスト: `pnpm test` まで完走（フロント/バックエンド/共有）。
- プレゼンテーション: `/activities/{id}/translations/body` POST/GET を追加、コンポーネントテストも追加。DIでTRANSLATION_QUEUE_URL未設定時はスタブキューを利用するように調整。
- ワーカー: `translate-activity-body/handler.ts` を追加。OPENAI_API_KEYが無い/スタブ指定時はスタブ翻訳で本文を翻訳し、ドメインステータスを更新。ワーカーテスト追加。
- 未着手: OpenAPI反映は次フェーズで対応予定。

## メモ
- 参考ガイドライン: `packages/backend/docs/guidelines/*`（フォルダ構成、命名規則、テスト方針など）
- DBスキーマ現状: `packages/backend/src/db/schema.ts`
