# CHASE-128 authのフォルダ構造見直し

## 作業概要

- 既存の`features/auth`がミドルウェアやユースケースを混在させており、境界づけられたコンテキスト方針と乖離している。
- 認証基盤（ミドルウェア、型、例外）を`core`へ移し、`features/identity`はサインアップなどアイデンティティ固有の責務に限定する。
- JWTバリデータをポート/アダプタ経由で差し替え可能にし、テストスタブを整理する。

## 実装計画

### フェーズ1: Core抽出

1. `core/auth`ディレクトリを新設し、ミドルウェア・エラー・型・設定ユーティリティを移管。
2. `core/auth/index.ts`で公開APIを整理し、既存機能の再エクスポートを提供。
3. 既存参照先を一時的に`core`へ向け、ビルドが通ることを確認。

### フェーズ2: Identityフィーチャー再構成

1. `features/auth`を`features/identity`へリネームし、新しいレイヤ構成（domain/application/infra/presentation）を整備。
2. `application/ports/jwt-validator.port.ts`と`infra/adapters/jwt-validator`配下の本番実装・スタブ・ファクトリを作成。
3. 旧`AuthSignupService`を`application/use-cases/sign-up.use-case.ts`へ移し、新しいポートを利用する形に更新。
4. プレゼンテーション層（サインアップルート/スキーマ）を新構成に合わせて再配置。

### フェーズ3: 配線とテスト更新

1. `app.ts`や他フィーチャーからのミドルウェア参照を新パスへ更新。
2. 既存コンポーネントテストのDIを新しいバリデータスタブへ差し替え。
3. 認証除外設定のテストやサインアップAPIテストを更新して緑に戻す。

### フェーズ4: ドキュメント・仕上げ

1. ガイドライン類で`features/auth`への参照がある場合は`features/identity`へ更新。
2. 作業ログを更新し、懸念点や残タスクを記録。
3. `pnpm format && pnpm lint && pnpm test`を実行し、エラーを確認。

## チェックリスト

- [x] フェーズ1: Core抽出
  - [x] ミドルウェア/型/エラー/設定の移設完了
  - [x] `core/auth/index.ts`公開範囲の定義
- [x] フェーズ2: Identity再構成
  - [x] ディレクトリリネームとレイヤー整備
  - [x] JWTバリデータポート・アダプタ作成
  - [x] サインアップユースケース移行
  - [x] プレゼンテーション層更新
- [x] フェーズ3: 配線・テスト
  - [x] `app.ts`と他フィーチャーの参照更新
  - [x] テスト差し替え（スタブ/除外設定/サインアップ）
- [x] フェーズ4: ドキュメント・仕上げ
  - [x] ガイドライン参照更新
  - [x] 作業ログ更新
  - [x] フォーマット/リンタ/テスト実行 ※テストは環境依存エラーで失敗（後述）

## 作業記録

- `core/auth`配下を新設し、JWTミドルウェア・例外・型・設定を移設。エクスポートを整理して全フィーチャーから利用できるようにした。
- `features/identity`へフォルダを移行し、`application/ports`, `application/use-cases`, `infra/adapters`, `presentation`などレイヤー構成を再構築。サインアップ用ユースケースとルートをDI対応に刷新。
- `createGlobalJwtAuth`を通じてJWTバリデータファクトリを注入する構成に更新し、`app.ts`や各フィーチャーのミドルウェア参照を新APIへ差し替え。
- 既存コンポーネントテストを新しいスタブ(`StubJwtValidatorAdapter`)に合わせて修正し、認証除外・サインアップ系のテストカバレッジを維持。
- ガイドライン文書の`features/auth`表記を`features/identity`へ更新。

## 実行コマンド結果

- `pnpm format`: 正常終了。
- `pnpm lint`: 正常終了（frontend lint 実行時に Storybook セットアップの権限警告ログあり）。
- `pnpm test`: frontend が `uv_interface_addresses` の環境依存エラーで失敗。backend 側はテストDB接続 (`127.0.0.1:5432`) が許可されず `EPERM` により `test:migrate` が停止。開発環境での再実行が必要。

## メモ

- 依存循環を防ぐため、`core`から`identity`へは依存しない構成を維持する。
- JWTバリデータ本番実装はAuth0設定を`core`で読み込み、テストではスタブを明示的に注入する。
