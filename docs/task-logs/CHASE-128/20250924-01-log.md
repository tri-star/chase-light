# CHASE-128: authのフォルダ構造見直し - 実装ログ

**課題ID**: CHASE-128
**作業日**: 2025-09-24
**SOW**: docs/sow/20250924-CHASE-128.md

## 作業概要

authとuserフィーチャーをidentityフィーチャーに統合し、新アーキテクチャ（domain/application/infra/presentation）に移行する。

## 実装計画チェックリスト

### Phase 1: フォルダ構造作成・基盤整備
- [x] 1-1. features/auth → features/identity 名前変更
- [x] 1-2. identityフィーチャーの新フォルダ構造作成（domain/application/infra/presentation）
- [x] 1-3. 基本的なindex.tsファイル作成

### Phase 2: Domain層実装
- [x] 2-1. user/domain/配下のファイルをidentity/domain/へ移動
- [x] 2-2. user/constants/配下をidentity/constants/identity.constants.ts に統合
- [x] 2-3. user/errors/をidentity/errors/に移動
- [x] 2-4. domain/repositories/user.repository.ts（ポート定義）作成

### Phase 3: Application層実装
- [x] 3-1. ports/jwt-validator.port.ts 作成（既存interfaceを移動）
- [x] 3-2. use-cases/配下のUseCaseクラス作成（Service → UseCase移行）
- [x] 3-3. UserProfileService, UserSettingsServiceのロジックをUseCaseに移行

### Phase 4: Infrastructure層実装
- [x] 4-1. infra/repositories/drizzle-user.repository.ts 作成
- [x] 4-2. infra/adapters/jwt-validator/ 配下のアダプタ実装
- [x] 4-3. JWTValidatorのファクトリ関数実装

### Phase 5: Presentation層移動
- [x] 5-1. user/presentation/配下をidentity/presentation/へ移動
- [x] 5-2. ルート定義のimportパス調整（Service → UseCase）
- [x] 5-3. 認証エンドポイント（auth/presentation）の統合

### Phase 6: テスト移植・調整
- [x] 6-1. 既存テストファイルの移動
- [x] 6-2. importパス調整
- [x] 6-3. Service → UseCaseに伴うテスト調整

### Phase 7: 全体調整・cleanup
- [x] 7-1. 全backendファイルのimportパス一括調整
- [x] 7-2. features/userフォルダの削除
- [x] 7-3. lint・型チェック・テスト実行

## 実装対象ファイル詳細

### 新規作成ファイル
1. `features/identity/application/ports/jwt-validator.port.ts`
2. `features/identity/application/use-cases/get-user-profile.use-case.ts`
3. `features/identity/application/use-cases/update-user-profile.use-case.ts`
4. `features/identity/application/use-cases/get-user-settings.use-case.ts`
5. `features/identity/application/use-cases/update-user-settings.use-case.ts`
6. `features/identity/infra/adapters/jwt-validator/jwt-validator.adapter.ts`
7. `features/identity/infra/adapters/jwt-validator/stub-jwt-validator.adapter.ts`
8. `features/identity/infra/adapters/jwt-validator/jwt-validator-factory.ts`
9. `features/identity/infra/repositories/drizzle-user.repository.ts`
10. `features/identity/constants/identity.constants.ts`

### 移動対象ファイル
- `features/auth/` → `features/identity/`（フォルダ名変更）
- `features/user/presentation/` → `features/identity/presentation/`
- `features/user/domain/` → `features/identity/domain/`
- `features/user/errors/` → `features/identity/errors/`

## 受け入れ基準

### 機能要件
- [x] 既存のAPI仕様が全て動作する（GET/PUT /profile, GET/PUT /settings, POST /auth/signup）
- [x] JWT認証ミドルウェアが正常に動作する
- [x] Auth0統合が正常に動作する
- [x] プロフィール取得・更新が正常に動作する
- [x] 設定取得・更新が正常に動作する

### 非機能要件
- [x] 既存のテストが全て通る
- [x] lintエラーが発生しない
- [x] 型エラーが発生しない
- [x] 新アーキテクチャ（domain/application/infra/presentation）に準拠している

### セキュリティ要件
- [x] JWT認証による適切なアクセス制御（変更なし）
- [x] Auth0統合によるセキュリティ（変更なし）
- [x] トークン検証ロジックが正常に動作する

## 作業メモ

### 開始時の状況
- SOW確認完了
- 既存のauth/userフィーチャーの構造把握が必要

### 注意事項
- 既存API仕様は変更しない
- 認証ロジックの変更は行わない
- データベーススキーマの変更は行わない
- 段階的実装による影響範囲の局所化を心がける

### 実装完了状況（2025-09-25現在）
- **全フェーズ完了**: Phase 1-7 すべて完了
- **Phase 5-2 追加完了**: settings/index.tsの Service → UseCase移行
  - UseCaseクラス（GetUserProfileUseCase, GetUserSettingsUseCase, UpdateUserSettingsUseCase）を直接使用するよう変更
  - 依存性注入をファクトリ関数内で解決するアーキテクチャに変更
  - 全テスト通過、lint通過を確認

### 最終結果
**CHASE-128完了**: 全ての受け入れ基準を満たし、アーキテクチャ移行が完了