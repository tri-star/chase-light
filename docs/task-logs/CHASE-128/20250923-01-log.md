# CHASE-128 authのフォルダ構造見直し

## 作業概要
- `features/auth` と `features/user` を統合し、SOWに沿って `core/auth` + `features/identity` の新構成へ再編する。
- 既存の認証ミドルウェア／エラー／設定を `core/auth` へ移管し、JWTバリデータのポート実装を差し替え可能にする。
- `/api/auth/signup` と `/api/users/*` のエンドポイント群を新しいIdentityユースケースに付け替え、既存挙動を維持する。

## 実装計画
- [x] Phase 0: 現状調査
  - [x] `features/auth` / `features/user` / 既存 `identity` の責務と依存を整理し、移設対象と残すべき資産を棚卸しする
  - [x] 既存テスト（auth, user）と共通テストヘルパーの利用箇所を洗い出す
- [x] Phase 1: `core/auth` への移設
  - [x] エラー・型・設定・ミドルウェアを `core/auth` 配下へコピー＋型調整し、`index.ts` で公開する
  - [x] 旧 `features/auth` 経由の import を段階的に `core/auth` へ張り替える（テストヘルパー含む）
  - [x] JWT検証サービスをポート化する下準備として、新しいDIポイントの設計をまとめる
- [x] Phase 2: Identityドメイン再構成
  - [x] Domain: `user` エンティティ／値オブジェクト／設定値を定義、`user.repository.ts` ポートを用意
  - [x] Infra: DrizzleユーザリポジトリとJWTバリデータアダプタ（本番＋スタブ）を実装
  - [x] Application: `sign-up` / `get-profile` / `update-profile` / `get-settings` / `update-settings` ユースケースを実装
  - [x] constants/errors を新構成へ移設し `features/identity/index.ts` で公開対象を整理
- [ ] Phase 3: プレゼンテーション・合成更新
  - [x] `/api/auth/signup` と `/api/users/*` ルートを `features/identity/presentation/routes` へ移植し、ユースケースDIを組み直す
  - [x] `app.ts` のミドルウェア登録とルートマウントを `core/auth` + `identity` 新構成へ更新
  - [ ] 除外パスやミドルウェアの初期化を `core/auth` のAPIに統一
- [ ] Phase 4: テスト・移行・クリーンアップ
  - [x] 既存コンポーネントテスト／テストヘルパーのimport・DI・スタブ差し替えを実施
  - [x] 新構成に沿ったテストケースを補完、必要に応じてスタブを追加
  - [ ] 旧 `features/auth` / `features/user` 残骸を削除し、参照が残っていないことを確認
- [ ] Phase 5: ドキュメントと最終確認
  - [ ] Identity構成の要約と利用方法を関連ドキュメントへ反映（必要箇所をSOWに従い更新）
  - [ ] `pnpm format`, `pnpm lint`, `pnpm test` を実行してエラーを確認

## 今日の進捗
- Identity向けAuth/Userコンポーネントテストを `createIdentityContext` + `StubJWTValidatorAdapter` ベースで再構成し、旧テストはskip扱いで残骸確認待ちとした。
- `core/auth` を新設し、エラー／型／設定／ミドルウェアを移設、依存先の再エクスポートを整備。
- `features/identity` 配下にドメイン・アプリケーション・インフラ層を構築し、JWTバリデータのAuth0/Stubアダプタとファクトリを実装。
- 新しいプレゼンテーション層（Auth/Users）を構成し、ユースケースDI経由でレスポンススキーマを再利用。
- `identity/index.ts` でユースケースとルートファクトリを公開し、`app.ts` から新構成へ差し替え。
- `AuthTestHelper` を `features/identity/testing` に再配置し、テストユーティリティの再エクスポートを更新。

## 次のアクション候補
1. Identity用ルートテスト・コンポーネントテストを新構成向けに移植し、スタブDIを適用する。
2. 旧 `features/auth` / `features/user` 配下のファイルを新実装へ移し終えた段階で削除し、import漏れを解消する。
3. ドキュメント（フォルダ構成・APIガイド等）をIdentity構成へ更新し、`pnpm format/lint/test` を実行して整合性を確認する。

## メモ
- JWTバリデータのDIは `createIdentityContext` → `createExclusiveJWTAuthMiddleware` で受け渡し済み。除外パス設定の見直し（環境設定経由のパラメータ公開）が未着手。
- Authルート／ユーザールート向けの既存テストは旧サービスに依存しているため、Identityユースケースを直接モック可能な形で再実装する必要あり。
