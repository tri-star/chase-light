# CHASE-135 実装作業ログ

**作成日**: 2025-10-21
**SOW**: docs/sow/20251020-CHASE-135.md

## 目的

AI要約ダイジェスト通知への一本化（前回実行以降の集約）を実装する。

## 実装計画

### Phase 1: データベース設計とマイグレーション

- [x] 1-1. `schema.ts` に `userDigestExecutionLogs` テーブル定義を追加
- [x] 1-2. `schema.ts` に `notificationActivities` テーブル定義を追加
- [x] 1-3. `notifications.activityId` を nullable に変更
- [x] 1-4. リレーション定義を追加
- [x] 1-5. `pnpm --filter backend db:generate` でマイグレーションファイルを生成
- [x] 1-6. マイグレーションファイルの内容を確認
- [x] 1-7. `pnpm --filter backend db:migrate` でマイグレーションを実行

### Phase 2: Domain層の実装

- [x] 2-1. `user-digest-execution-log.ts` の作成
- [x] 2-2. `digest-activity-summary.ts` の作成（構造化データ型定義）
- [x] 2-3. `repositories/user-digest-execution-log.repository.ts` の作成
- [x] 2-4. `notification.ts` の `NotificationMetadata` 拡張
- [x] 2-5. `notification.ts` の `NotificationDraft` 型変更
- [x] 2-6. `repositories/notification-preparation.repository.ts` にメソッド追加
- [x] 2-7. 定数ファイル `constants/notification.constants.ts` の作成

### Phase 3: Infrastructure層の実装（Repository）

- [x] 3-1. `drizzle-user-digest-execution-log.repository.ts` の実装
- [x] 3-2. `drizzle-notification-preparation.repository.ts` に `findActivitiesForDigest` 実装
- [x] 3-3. `drizzle-notification.repository.ts` の改修（notification_activities 対応）

### Phase 4: Application層の実装（Port）

- [x] 4-1. `ports/summarization.port.ts` の作成
- [x] 4-2. `infra/adapters/summarization/summarization-stub.adapter.ts` の実装

### Phase 5: Application層の実装（UseCase）

- [x] 5-1. `generate-digest-notifications.use-case.ts` の大幅改修

### Phase 6: Infrastructure層の実装（Adapter）

- [x] 6-1. `infra/adapters/summarization/summarization.adapter.ts` の実装

### Phase 7: Worker層の実装とテスト

- [x] 7-1. `workers/generate-digest-notifications/handler.ts` の改修
- [ ] 7-2. `handler.ts` のコンポーネントテスト作成・実行（Phase 8で対応）

### Phase 8: 統合テストと最終検証

- [ ] 8-1. 既存テストファイルの更新
- [ ] 8-2. 全テストの実行（`pnpm --filter backend test`）
- [ ] 8-3. lint・format の実行
- [ ] 8-4. 受け入れ基準の確認
- [ ] 8-5. ドキュメントの更新（必要に応じて）

## 実装詳細

### Phase 1: データベース設計とマイグレーション

#### 1-1. userDigestExecutionLogs テーブル定義

- ユーザー単位でワーカーの実行履歴を管理
- user_id, worker_name, last_successful_run_at, created_at, updated_at
- UNIQUE(user_id, worker_name)

#### 1-2. notificationActivities テーブル定義

- 通知とアクティビティの多対多関係を管理
- notification_id, activity_id, created_at
- PRIMARY KEY (notification_id, activity_id)

#### 1-3. notifications.activityId を nullable に変更

- 複数アクティビティを集約するため

### Phase 2: Domain層の実装

#### 2-1. user-digest-execution-log.ts

- UserDigestExecutionLog エンティティ定義
- Brand型でのID管理

#### 2-2. digest-activity-summary.ts

- DigestActivitySummary 型定義（構造化データ）
- DataSourceGroup, ActivityGroup 型定義

#### 2-3. repositories/user-digest-execution-log.repository.ts

- getLastSuccessfulRunAt(userId, workerName) メソッド
- updateLastSuccessfulRunAt(userId, workerName, timestamp) メソッド

#### 2-4. notification.ts の NotificationMetadata 拡張

- 構造化されたdigest情報を含む型定義

#### 2-5. notification.ts の NotificationDraft 型変更

- activityId を optional に変更

#### 2-6. repositories/notification-preparation.repository.ts にメソッド追加

- findActivitiesForDigest メソッド

#### 2-7. constants/notification.constants.ts の作成

- MAX_DAYS_LOOKBACK = 7
- MAX_ACTIVITIES_PER_DATA_SOURCE_AND_TYPE = 3
- MAX_SUMMARY_TOKENS = 1000
- SUMMARIZATION_TIMEOUT_MS = 30000
- DEFAULT_FALLBACK_SUMMARY = "(要約なし)"

### Phase 3: Infrastructure層の実装（Repository）

#### 3-1. drizzle-user-digest-execution-log.repository.ts

- Drizzle を使った永続化実装

#### 3-2. drizzle-notification-preparation.repository.ts

- findActivitiesForDigest の実装
- ユーザー単位での時間範囲フィルタ
- データソース＋種別ごとに最大3件まで取得

#### 3-3. drizzle-notification.repository.ts

- notification_activities の作成を含む改修

### Phase 4: Application層の実装（Port）

#### 4-1. ports/summarization.port.ts

- SummarizationPort インターフェース定義
- データソース＋種別単位でのバッチ要約生成
- OpenAI Structured Outputs 用のスキーマ定義

#### 4-2. summarization-stub.adapter.ts

- テスト用スタブ実装
- 決定的な出力を返す

### Phase 5: Application層の実装（UseCase）

#### 5-1. generate-digest-notifications.use-case.ts

- ユーザー単位の時間範囲を入力として受け取る
- データソース＋種別ごとにグルーピング（各最大3件）
- グループ単位でAI要約をバッチ呼び出し（Structured Outputs使用）
- 構造化されたmetadataを作成
- フォールバック処理

### Phase 6: Infrastructure層の実装（Adapter）

#### 6-1. summarization.adapter.ts

- OpenAI Structured Outputs の統合
- データソース＋種別単位でのバッチ処理
- JSON形式での構造化レスポンス取得
- タイムアウト、リトライ、トークン制限

### Phase 7: Worker層の実装とテスト

#### 7-1. handler.ts の改修

- 通知対象ユーザー一覧の取得
- ユーザーごとの lastSuccessfulRunAt 取得
- 時間範囲の計算（最大7日制限）
- ユーザーごとにユースケースを実行
- ユーザーごとに lastSuccessfulRunAt を更新（成功時のみ）
- エラーハンドリング

#### 7-2. handler.ts のコンポーネントテスト

- 正常系テスト
- 境界値テスト
- 冪等性テスト
- エラーハンドリングテスト
- ユーザー設定フィルタテスト

## 作業メモ

### Phase 1-7 完了時点での重要情報

#### コミット履歴
1. **コミット1 (fbd8493)**: Phase1-5完了 - DB設計〜ユースケース実装
2. **コミット2 (f4ae3bd)**: Phase6-7完了 - AI要約アダプタとWorker実装

#### 実装した主要ファイル

**Domain層**
- `packages/backend/src/features/notification/domain/user-digest-execution-log.ts`
- `packages/backend/src/features/notification/domain/digest-activity-summary.ts`
- `packages/backend/src/features/notification/domain/repositories/user-digest-execution-log.repository.ts`
- `packages/backend/src/features/notification/constants/notification.constants.ts`

**Application層**
- `packages/backend/src/features/notification/application/ports/summarization.port.ts`
- `packages/backend/src/features/notification/application/use-cases/generate-digest-notifications.use-case.ts` (大幅改修)

**Infrastructure層**
- `packages/backend/src/features/notification/infra/repositories/drizzle-user-digest-execution-log.repository.ts`
- `packages/backend/src/features/notification/infra/repositories/drizzle-notification-preparation.repository.ts` (findActivitiesForDigest追加)
- `packages/backend/src/features/notification/infra/repositories/drizzle-notification.repository.ts` (notification_activities対応)
- `packages/backend/src/features/notification/infra/adapters/summarization/summarization.adapter.ts`
- `packages/backend/src/features/notification/infra/adapters/summarization/summarization-stub.adapter.ts`

**Worker層**
- `packages/backend/src/features/notification/workers/generate-digest-notifications/handler.ts` (大幅改修)

**Database**
- `packages/backend/src/db/schema.ts` (userDigestExecutionLogs, notificationActivities追加)
- `packages/backend/src/db/migrations/0009_salty_korvac.sql`

#### 重要な実装の詳細

**ユースケースの変更点**
- 旧: `execute()` メソッドで全ユーザーを一括処理
- 新: `executeForUser()` メソッドでユーザー単位処理
- データソース＋種別ごとにグルーピング（各最大3件）
- AI要約をバッチ呼び出し
- 構造化されたmetadata作成（DigestActivitySummary型）

**Workerハンドラーの変更点**
- 処理対象ユーザー一覧を取得（digestEnabled=trueのユーザー）
- 各ユーザーに対してループ処理
- lastSuccessfulRunAt取得・更新
- 時間範囲計算（最大7日遡り）
- ユーザーごとに独立してエラーハンドリング

**NotificationDraftの構造変更**
- `activityId`: optional（ダイジェスト通知ではnull）
- `activityIds`: string[] 追加（関連アクティビティIDの配列）
- `metadata.digest`: DigestActivitySummary 追加

#### 技術的な課題と解決

**1. OpenAI SDK の型エラー**
- 問題: `zodResponseFormat` と `beta.chat.completions.parse` の型が合わない
- 解決: `response_format: { type: "json_object" }` を使用し、レスポンスをZodでパース

**2. DrizzleUserDigestExecutionLogRepository の型エラー**
- 問題: `PostgresJsDatabase` 型と `NodePgDatabase` 型の不一致
- 解決: `TransactionManager.getConnection()` を直接使用するシンプルな実装に変更

**3. notifications.activityId のnullable化**
- 問題: 既存の UNIQUE(user_id, activity_id) 制約との競合
- 解決: マイグレーションでUNIQUE制約を削除、notification_activitiesで関連を管理

#### 環境変数

必要な環境変数:
- `OPENAI_API_KEY`: OpenAI APIキー（summarization.adapter.tsで使用）

## 懸念事項

### Phase 8で対応が必要な項目

1. **テストファイルの更新**
   - `packages/backend/src/features/notification/workers/generate-digest-notifications/__tests__/handler.test.ts`
   - 型エラーが発生中（Input/Output型の変更に伴う）
   - 新しいハンドラーの仕様に合わせたテストケースの再実装が必要

2. **OpenAI API の実際の動作確認**
   - summarization.adapter.ts は実装したが、実際のOpenAI APIとの統合テストは未実施
   - JSON形式でのレスポンスパースが正しく動作するか要確認

3. **パフォーマンス考慮**
   - findActivitiesForDigest のSQLクエリ（ROW_NUMBER() OVER使用）のパフォーマンス
   - 多数のユーザーがいる場合のワーカー実行時間

4. **データ整合性**
   - notification_activities テーブルへの挿入が正しく行われるか
   - userDigestExecutionLogs の更新タイミング（トランザクション内で正しく動作するか）

5. **エラーハンドリングの網羅性**
   - AI要約失敗時のフォールバック処理は実装済み
   - DB接続エラー、トランザクションエラーなどの考慮が必要
