# CHASE-135 実装作業ログ

**作成日**: 2025-10-21
**SOW**: docs/sow/20251020-CHASE-135.md

## 目的

AI要約ダイジェスト通知への一本化（前回実行以降の集約）を実装する。

## 実装計画

### Phase 1: データベース設計とマイグレーション

- [x] 1-1. `schema.ts` に `userDigestExecutionLogs` テーブル定義を追加
- [x] 1-2. `schema.ts` に `notificationActivities` テーブル定義を追加
- [x] 1-3. `notifications.activityId` を nullable に変更
- [x] 1-4. リレーション定義を追加
- [x] 1-5. `pnpm --filter backend db:generate` でマイグレーションファイルを生成
- [x] 1-6. マイグレーションファイルの内容を確認
- [x] 1-7. `pnpm --filter backend db:migrate` でマイグレーションを実行

### Phase 2: Domain層の実装

- [x] 2-1. `user-digest-execution-log.ts` の作成
- [x] 2-2. `digest-activity-summary.ts` の作成（構造化データ型定義）
- [x] 2-3. `repositories/user-digest-execution-log.repository.ts` の作成
- [x] 2-4. `notification.ts` の `NotificationMetadata` 拡張
- [x] 2-5. `notification.ts` の `NotificationDraft` 型変更
- [x] 2-6. `repositories/notification-preparation.repository.ts` にメソッド追加
- [x] 2-7. 定数ファイル `constants/notification.constants.ts` の作成

### Phase 3: Infrastructure層の実装（Repository）

- [x] 3-1. `drizzle-user-digest-execution-log.repository.ts` の実装
- [x] 3-2. `drizzle-notification-preparation.repository.ts` に `findActivitiesForDigest` 実装
- [x] 3-3. `drizzle-notification.repository.ts` の改修（notification_activities 対応）

### Phase 4: Application層の実装（Port）

- [x] 4-1. `ports/summarization.port.ts` の作成
- [x] 4-2. `infra/adapters/summarization/summarization-stub.adapter.ts` の実装

### Phase 5: Application層の実装（UseCase）

- [ ] 5-1. `generate-digest-notifications.use-case.ts` の大幅改修

### Phase 6: Infrastructure層の実装（Adapter）

- [ ] 6-1. `infra/adapters/summarization/summarization.adapter.ts` の実装

### Phase 7: Worker層の実装とテスト

- [ ] 7-1. `workers/generate-digest-notifications/handler.ts` の改修
- [ ] 7-2. `handler.ts` のコンポーネントテスト作成・実行

### Phase 8: 統合テストと最終検証

- [ ] 8-1. 全テストの実行（`pnpm --filter backend test`）
- [ ] 8-2. lint・format の実行
- [ ] 8-3. 受け入れ基準の確認
- [ ] 8-4. ドキュメントの更新（必要に応じて）

## 実装詳細

### Phase 1: データベース設計とマイグレーション

#### 1-1. userDigestExecutionLogs テーブル定義

- ユーザー単位でワーカーの実行履歴を管理
- user_id, worker_name, last_successful_run_at, created_at, updated_at
- UNIQUE(user_id, worker_name)

#### 1-2. notificationActivities テーブル定義

- 通知とアクティビティの多対多関係を管理
- notification_id, activity_id, created_at
- PRIMARY KEY (notification_id, activity_id)

#### 1-3. notifications.activityId を nullable に変更

- 複数アクティビティを集約するため

### Phase 2: Domain層の実装

#### 2-1. user-digest-execution-log.ts

- UserDigestExecutionLog エンティティ定義
- Brand型でのID管理

#### 2-2. digest-activity-summary.ts

- DigestActivitySummary 型定義（構造化データ）
- DataSourceGroup, ActivityGroup 型定義

#### 2-3. repositories/user-digest-execution-log.repository.ts

- getLastSuccessfulRunAt(userId, workerName) メソッド
- updateLastSuccessfulRunAt(userId, workerName, timestamp) メソッド

#### 2-4. notification.ts の NotificationMetadata 拡張

- 構造化されたdigest情報を含む型定義

#### 2-5. notification.ts の NotificationDraft 型変更

- activityId を optional に変更

#### 2-6. repositories/notification-preparation.repository.ts にメソッド追加

- findActivitiesForDigest メソッド

#### 2-7. constants/notification.constants.ts の作成

- MAX_DAYS_LOOKBACK = 7
- MAX_ACTIVITIES_PER_DATA_SOURCE_AND_TYPE = 3
- MAX_SUMMARY_TOKENS = 1000
- SUMMARIZATION_TIMEOUT_MS = 30000
- DEFAULT_FALLBACK_SUMMARY = "(要約なし)"

### Phase 3: Infrastructure層の実装（Repository）

#### 3-1. drizzle-user-digest-execution-log.repository.ts

- Drizzle を使った永続化実装

#### 3-2. drizzle-notification-preparation.repository.ts

- findActivitiesForDigest の実装
- ユーザー単位での時間範囲フィルタ
- データソース＋種別ごとに最大3件まで取得

#### 3-3. drizzle-notification.repository.ts

- notification_activities の作成を含む改修

### Phase 4: Application層の実装（Port）

#### 4-1. ports/summarization.port.ts

- SummarizationPort インターフェース定義
- データソース＋種別単位でのバッチ要約生成
- OpenAI Structured Outputs 用のスキーマ定義

#### 4-2. summarization-stub.adapter.ts

- テスト用スタブ実装
- 決定的な出力を返す

### Phase 5: Application層の実装（UseCase）

#### 5-1. generate-digest-notifications.use-case.ts

- ユーザー単位の時間範囲を入力として受け取る
- データソース＋種別ごとにグルーピング（各最大3件）
- グループ単位でAI要約をバッチ呼び出し（Structured Outputs使用）
- 構造化されたmetadataを作成
- フォールバック処理

### Phase 6: Infrastructure層の実装（Adapter）

#### 6-1. summarization.adapter.ts

- OpenAI Structured Outputs の統合
- データソース＋種別単位でのバッチ処理
- JSON形式での構造化レスポンス取得
- タイムアウト、リトライ、トークン制限

### Phase 7: Worker層の実装とテスト

#### 7-1. handler.ts の改修

- 通知対象ユーザー一覧の取得
- ユーザーごとの lastSuccessfulRunAt 取得
- 時間範囲の計算（最大7日制限）
- ユーザーごとにユースケースを実行
- ユーザーごとに lastSuccessfulRunAt を更新（成功時のみ）
- エラーハンドリング

#### 7-2. handler.ts のコンポーネントテスト

- 正常系テスト
- 境界値テスト
- 冪等性テスト
- エラーハンドリングテスト
- ユーザー設定フィルタテスト

## 作業メモ

（作業中にメモや議論の結論を記録）

## 懸念事項

（実装完了後、残っている懸念事項を記録）
