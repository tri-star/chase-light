# CHASE-163 作業ログ (2025-12-12)

- SOW: `docs/sow/20251212-CHASE-163.md`
- フェーズ: 実装開始

## 予定とチェックリスト

- [x] Phase 1: Lambda 依存管理リファクタ  
  - [x] lockfile ヘルパー `packages/backend/scripts/lib/pnpm/lockfile.ts` 追加＋テスト  
  - [x] `lambda-config.ts` へ移行し、共通/個別/スキップ構造へ整理（既存関数を移行）  
  - [x] `build-lambda.ts` で lockfile 解決・package.json 生成フロー更新（external デフォルト化含む）
- [x] Phase 2: API Lambda + SAM 更新  
  - [x] `lambda-config.ts` に API エントリ追加、ビルド対象化  
  - [x] `sam-template.yaml` に API Lambda + HttpApi + Outputs 追加（CORS/権限設定）
- [ ] Phase 3: ドキュメント・最終確認  
  - [x] 必要な追記（作業ログ更新、必要なら README 等）  
  - [x] `pnpm --filter backend build:lambda` / `build:lambda api` / `sam validate` 実行  
  - [x] `pnpm --filter backend test` 実行（失敗時は2回までリトライの方針）  
  - [ ] 受け入れ基準の最終確認

## 本セッションのメモ

- 初回セッションで SOW/ガイドラインを確認し、Phase1〜2 を実施。
- 依存解決ヘルパーを TypeScript で追加し、pnpm-lock の `version/specifier` から固定版を生成。`link:`/`workspace:` は参照 package.json から解決。
- Lambda ビルドスクリプトと設定を `.ts` 化（`build-lambda.ts`, `lambda-config.ts`）。共通依存のデフォルト + 関数固有追加 + skip フラグで組み立て、外部化リストもデフォルト＋追加をマージする形に変更。API 用エントリを追加。
- SAM テンプレートに `BackendHttpApi` と `BackendApiFunction` を追加。CORS はパラメータ化した `FrontendUrl` を使用し、ANY / と ANY /{proxy+} をマッピング。Globals に `FRONTEND_URL` を追加。
- コマンド実行結果  
  - `pnpm lint` ✅  
  - `pnpm format` ✅（Biomeで一部自動整形あり）  
  - `pnpm test` ✅（frontend/backend/shared すべて緑、警告のみ）  
  - `pnpm --filter backend build:lambda api` / `pnpm --filter backend build:lambda` ✅（npm の Unknown env config warning と一部 moderate vuln warning あり）  
  - `sam validate --template-file infrastructure/sam-template.yaml --region us-east-1` ✅（AllowCredentials と wildcard の衝突を条件化して解消）
- 今後: 受け入れ基準の棚卸とコミット準備（必要に応じてREADME/設計メモを追記）。
