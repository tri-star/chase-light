# 作業ログ: CHASE-140 Activity保存内容の修正

**作業日**: 2025-10-26
**課題ID**: CHASE-140
**SOW**: docs/sow/20251026-CHASE-140.md

## 概要

Activityテーブルのスキーマを拡張し、原文と翻訳/要約を併存できるようにする。
- 原文（タイトル/本文）を保持
- 翻訳済みタイトル、本文要約、翻訳済み本文を別フィールドで管理
- OpenAI APIを使った要約生成機能の追加
- OpenAI APIキー未設定時のフォールバック処理

## 実装計画

### Phase 1: スキーマ・ドメイン層実装

- [ ] 1-1. `schema.ts`に新フィールド追加
  - ファイル: `packages/backend/src/db/schema.ts`
  - 追加フィールド: `translatedTitle`, `summary`, `translatedBody`（全てTEXT NULL）

- [ ] 1-2. Drizzle Kitでマイグレーションファイル生成
  - コマンド: `pnpm --filter backend db:generate`

- [ ] 1-3. `Activity`型に新フィールド追加
  - ファイル: `packages/backend/src/features/activities/domain/activity.ts`
  - 追加フィールド: `translatedTitle`, `summary`, `translatedBody`（全てオプショナル）

- [ ] 1-4. ローカルDBでマイグレーション実行・確認
  - コマンド: `pnpm --filter backend db:push`

### Phase 2: 要約機能の実装（Port/Adapter）

- [ ] 2-1. `SummarizationPort`の定義
  - ファイル: `packages/backend/src/features/detection/application/ports/summarization.port.ts`
  - 内容: `summarize(activityType, title, body): Promise<{ summary: string }>`

- [ ] 2-2. `SummarizationAdapter`の実装
  - ファイル: `packages/backend/src/features/detection/infra/adapters/summarization/summarization.adapter.ts`
  - OpenAI APIを使った要約生成
  - TranslationAdapterと同様のエラーハンドリング

- [ ] 2-3. `SummarizationStubAdapter`の実装
  - ファイル: `packages/backend/src/features/detection/infra/adapters/summarization/summarization-stub.adapter.ts`
  - テスト用スタブ実装

### Phase 3: Repository層の更新

- [ ] 3-1. `ActivityRepository`インターフェースの更新
  - ファイル: `packages/backend/src/features/detection/domain/repositories/activity.repository.ts`
  - `updateTranslationAndSummary()`の追加
  - `upsert()`、`upsertMany()`のパラメータに翻訳・要約フィールドを追加（オプション）

- [ ] 3-2. `DrizzleActivityRepository`の実装更新
  - ファイル: `packages/backend/src/features/detection/infra/repositories/drizzle-activity.repository.ts`
  - `updateTranslationAndSummary()`の実装
  - `mapToDomain()`の更新（新フィールドのマッピング）

### Phase 4: UseCase層の更新

- [ ] 4-1. `ProcessUpdatesUseCase`の更新
  - ファイル: `packages/backend/src/features/detection/application/use-cases/process-updates.use-case.ts`
  - コンストラクタに`SummarizationPort`を追加
  - `processActivity()`メソッドの更新（翻訳・要約を両方実行）
  - `updateTranslationAndSummary()`呼び出しに変更
  - OpenAI設定未取得時のフォールバック処理実装

### Phase 5: Worker層の更新

- [ ] 5-1. `process-updates/handler.ts`の更新
  - ファイル: `packages/backend/src/features/detection/workers/process-updates/handler.ts`
  - OpenAI設定取得のエラーハンドリング
  - `SummarizationAdapter`のインスタンス化
  - `ProcessUpdatesUseCase`への依存注入

### Phase 6: テストの更新・実行

- [ ] 6-1. Componentテストの更新
  - ファイル: `packages/backend/src/features/detection/workers/process-updates/__tests__/handler.test.ts`
  - 翻訳・要約フィールドの検証を追加
  - OpenAI設定未取得時のフォールバックテストを追加

- [ ] 6-2. 全テストの実行・確認
  - コマンド: `pnpm --filter backend test`

- [ ] 6-3. Lint/Format
  - コマンド: `pnpm --filter backend lint`
  - コマンド: `pnpm --filter backend format`

## 実装の詳細

### Phase 1: スキーマ・ドメイン層実装

#### 1-1. schema.ts の変更内容

```typescript
// activities テーブルに以下を追加:
translatedTitle: text("translated_title"),
summary: text("summary"),
translatedBody: text("translated_body"),
```

#### 1-3. Activity型の変更内容

```typescript
// Activity型に以下を追加（全てオプショナル）:
translatedTitle?: string
summary?: string
translatedBody?: string
```

### Phase 2: 要約機能の実装

#### SummarizationPort の仕様

- メソッド: `summarize(activityType: ActivityType, title: string, body: string): Promise<{ summary: string }>`
- アクティビティタイプ別のプロンプトを使用
- JSON Schemaによるレスポンス形式の指定

#### SummarizationAdapter の仕様

- OpenAI APIの`gpt-4o-mini`モデルを使用（TranslationAdapterと同様）
- プロンプト: アクティビティタイプに応じた要約指示
- エラーハンドリング: TranslationAdapterと同様の実装
- リトライ機構: TranslationAdapterと同様

### Phase 3: Repository層の更新

#### updateTranslationAndSummary() の仕様

```typescript
updateTranslationAndSummary(
  activityId: ActivityId,
  translatedTitle: string | null,
  summary: string | null,
  status: ActivityStatus,
  statusDetail: string | null
): Promise<void>
```

### Phase 4: UseCase層の更新

#### processActivity() の更新内容

1. OpenAI設定の取得（try-catch）
2. OpenAI設定がある場合:
   - 翻訳を実行（TranslationPort）
   - 要約を実行（SummarizationPort）
   - updateTranslationAndSummary()で更新
3. OpenAI設定がない場合:
   - 翻訳・要約をスキップ
   - status=COMPLETEDで保存（translatedTitle, summaryはNULL）

## 実装完了内容

### Phase 1: スキーマ・ドメイン層実装 ✅

- `schema.ts`に新フィールド追加（translatedTitle, summary, translatedBody）
- Drizzle Kitでマイグレーションファイル生成（0010_volatile_typhoid_mary.sql）
- `Activity`型に新フィールド追加
- ローカルDBでマイグレーション実行・確認

### Phase 2: 要約機能の実装（Port/Adapter） ✅

- `SummarizationPort`の定義
- `SummarizationAdapter`の実装（OpenAI APIを使った要約生成）
- `SummarizationStubAdapter`の実装（テスト用）

### Phase 3: Repository層の更新 ✅

- `ActivityRepository`インターフェースの更新
  - `upsert()`、`upsertMany()`のパラメータに翻訳・要約フィールドを追加
  - `updateWithTranslation()`を`updateTranslationAndSummary()`に置き換え
- `DrizzleActivityRepository`の実装更新
  - 新フィールドのマッピング対応
  - `mapToDomain()`の更新

### Phase 4: UseCase層の更新 ✅

- `ProcessUpdatesUseCase`の更新
  - コンストラクタに`SummarizationPort`を追加
  - `processActivity()`メソッドで翻訳・要約を両方実行
  - OpenAI設定未取得時のフォールバック処理実装

### Phase 5: Worker層の更新 ✅

- `process-updates/handler.ts`の更新
  - OpenAI設定取得のエラーハンドリング
  - `SummarizationAdapter`のインスタンス化
  - `ProcessUpdatesUseCase`への依存注入

### Phase 6: テストの更新・実行 ✅

- `handler.test.ts`の更新
  - 新フィールドのテストデータ追加
  - SummarizationAdapterのモック追加
  - OpenAI APIキー未設定時のテストを仕様に合わせて修正
- lint、format、test全て成功

## 懸念事項・メモ

### 現時点での懸念

なし（全ての実装とテストが完了し、正常に動作しています）

### 実装時の注意点

1. 原文（title, body）は保持され、翻訳済みタイトル（translatedTitle）、要約（summary）は別フィールドで管理
2. translatedBodyは今回はNULLとして保存（将来の拡張用）
3. OpenAI APIキー未設定時は翻訳・要約をスキップし、status=COMPLETEDで処理継続
4. 既存データへの影響なし（新規フィールドは全てNULL許可）

## 作業履歴

### 2025-10-26

- 作業ログ作成
- 実装計画の策定
- Phase 1-6 全て完了
- lint、format、test 全て成功
