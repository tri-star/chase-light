# CHASE-79: RepositoryRepositoryの見直し - 実装ログ

## セッション情報

- **開始日時**: 2025-08-12
- **セッション番号**: 01
- **対応者**: Claude Code

## SOWと実装計画の概要

### SOWの要点

- DataSource型をDiscriminated Unionに変更
- RepositoryRepositoryを廃止し、DataSourceRepositoryに統合
- Domain層からPresentation層まで一貫したデータ構造に修正
- 既存のDBスキーマは変更せず、アプリケーション層のみ変更

### 実装スコープ

```typescript
// 目標の型構造
export type GitHubDataSource = {
  id: string;
  sourceType: "github";
  sourceId: string;
  name: string;
  description: string;
  url: string;
  isPrivate: boolean;
  createdAt: Date;
  updatedAt: Date;
  repository: Repository; // Repository情報を内包
};

export type DataSource = GitHubDataSource;
```

## 実装計画 (5 Phases)

### Phase 1: Domain層実装 (約30分)

- [ ] 1-1. data-source.tsをGitHubDataSource discriminated unionに変更
- [ ] 1-2. repository.tsファイルを削除、Repository型をdata-source.tsに統合
- [ ] 1-3. data-source-list.tsの構造変更

### Phase 2: Repository層実装 (約45分)

- [ ] 2-1. DataSourceRepository.save()メソッドでRepository操作も実行
- [ ] 2-2. クエリメソッドをGitHubDataSource型返却に更新
- [ ] 2-3. repository.repository.tsを削除
- [ ] 2-4. Repository層テストを修正

### Phase 3: Service層実装 (約30分)

- [ ] 3-1. DataSourceCreationServiceからRepositoryRepository依存を削除
- [ ] 3-2. 他のServiceクラスの戻り値型を調整

### Phase 4: Presentation層実装 (約30分)

- [ ] 4-1. APIレスポンス構造をdataSource内包形式に変更
- [ ] 4-2. スキーマ定義を修正
- [ ] 4-3. Componentテストを修正

### Phase 5: 最終確認・修正 (約15分)

- [ ] 5-1. Lint/Format/Testの実行
- [ ] 5-2. 動作確認

## 現在の実装状況

### 完了済み項目

- [x] SOWの理解とプロジェクト概要の把握
- [x] 既存コードの構造分析
- [x] 実装計画の策定
- [x] 作業ログの作成

### 進行中の項目

- 実装開始前

### 次セッションで開始する項目

- Phase 1.1: data-source.tsの更新から開始

## ファイル変更計画

### 削除対象ファイル

```
packages/backend/src/features/data-sources/domain/repository.ts
packages/backend/src/features/data-sources/repositories/repository.repository.ts
```

### 更新対象ファイル

```
packages/backend/src/features/data-sources/domain/data-source.ts
packages/backend/src/features/data-sources/domain/data-source-list.ts
packages/backend/src/features/data-sources/repositories/data-source.repository.ts
packages/backend/src/features/data-sources/services/data-source-creation.service.ts
packages/backend/src/features/data-sources/presentation/routes/data-sources/index.ts
packages/backend/src/features/data-sources/repositories/__tests__/data-source.repository.test.ts
packages/backend/src/features/data-sources/presentation/routes/data-sources/__tests__/index.test.ts
```

## 技術的考慮事項

### 破壊的変更への対応

- 段階的実装により、一度にすべての型エラーが発生する可能性
- 各Phaseごとにコンパイルエラーを解消しながら進行
- テスト実行で回帰テストを継続実行

### 重要な実装ポイント

1. **型安全性**: discriminated unionの型ガードを適切に実装
2. **トランザクション**: Repository操作は必ずtransaction内で実行
3. **後方互換性**: データベース構造は変更せず、アプリケーション層のみ変更
4. **エラーハンドリング**: 既存のエラーハンドリングパターンを維持

### データベーススキーマ (変更なし)

```sql
-- data_sources テーブル (既存)
data_sources: id, source_type, source_id, name, description, url, is_private, created_at, updated_at

-- repositories テーブル (既存)
repositories: id, data_source_id, github_id, full_name, language, stars_count, forks_count, open_issues_count, is_fork, created_at, updated_at
```

## セッション間引き継ぎ情報

### 次セッション開始時の確認事項

1. SOW文書の再確認: `docs/sow/20250812-CHASE-79.md`
2. 現在のTodoの状況確認
3. Phase 1.1から開始: `packages/backend/src/features/data-sources/domain/data-source.ts`の更新

### 実装開始コマンド

```bash
# バックエンドのテスト実行
pnpm --filter backend test

# 型チェック
pnpm --filter backend lint

# 実装開始後のテスト実行
pnpm --filter backend test src/features/data-sources
```

## 懸念事項・注意点

- 大規模な型変更のため、コンパイルエラーが多発する可能性
- Repository層とService層の依存関係が複雑なため、順序立てた実装が必要
- 既存テストの大幅な修正が必要になる可能性

## 次回セッション予定

Phase 1.1のdata-source.ts更新から開始し、可能な限りPhase 1を完了させる予定。
