# CloudWatch 監視設定
# この設定はSAMテンプレートに統合済みですが、参考資料として残しています

CloudWatchAlerts:
  StepFunctionsExecutionFailed:
    Description: "Step Functions実行失敗時のアラート"
    MetricName: "ExecutionsFailed"
    Namespace: "AWS/States"
    Statistic: "Sum"
    Period: 300  # 5分
    EvaluationPeriods: 1
    Threshold: 1
    ComparisonOperator: "GreaterThanOrEqualToThreshold"
    AlarmActions:
      - SNS Topic ARN
    TreatMissingData: "notBreaching"

  LambdaErrorRate:
    Description: "Lambda エラー率5%超過時のアラート"
    MetricName: "ErrorRate"
    Namespace: "AWS/Lambda"
    Statistic: "Average"
    Period: 300  # 5分
    EvaluationPeriods: 2
    Threshold: 5  # 5%
    ComparisonOperator: "GreaterThanThreshold"
    AlarmActions:
      - SNS Topic ARN
    TreatMissingData: "notBreaching"

  DeadLetterQueueMessages:
    Description: "DLQにメッセージが蓄積された時のアラート"
    MetricName: "ApproximateNumberOfVisibleMessages"
    Namespace: "AWS/SQS"
    Statistic: "Maximum"
    Period: 300  # 5分
    EvaluationPeriods: 1
    Threshold: 1
    ComparisonOperator: "GreaterThanOrEqualToThreshold"
    AlarmActions:
      - SNS Topic ARN
    TreatMissingData: "notBreaching"

MonitoringDashboard:
  Widgets:
    - Type: "Metric"
      Properties:
        Title: "Step Functions 実行状況"
        Metrics:
          - ["AWS/States", "ExecutionsSucceeded"]
          - ["AWS/States", "ExecutionsFailed"]
          - ["AWS/States", "ExecutionsStarted"]
        Period: 300
        Region: "ap-northeast-1"

    - Type: "Metric"
      Properties:
        Title: "Lambda 関数パフォーマンス"
        Metrics:
          - ["AWS/Lambda", "Duration"]
          - ["AWS/Lambda", "Errors"]
          - ["AWS/Lambda", "Invocations"]
        Period: 300
        Region: "ap-northeast-1"

    - Type: "Metric"
      Properties:
        Title: "SQS キュー状況"
        Metrics:
          - ["AWS/SQS", "ApproximateNumberOfVisibleMessages"]
          - ["AWS/SQS", "NumberOfMessagesSent"]
          - ["AWS/SQS", "NumberOfMessagesReceived"]
        Period: 300
        Region: "ap-northeast-1"

LogRetentionPolicies:
  StepFunctions: 30  # 30日間
  Lambda: 30  # 30日間
  ApplicationLogs: 90  # 90日間

AlertingGuidelines:
  CriticalAlerts:
    - "Step Functions実行失敗"
    - "DLQメッセージ蓄積"
    
  WarningAlerts:
    - "Lambda エラー率5%超過"
    - "実行時間異常"

  NotificationChannels:
    - Type: "SNS"
      Description: "メール通知"
      Endpoints:
        - "Email addresses configured in SNS topic"
    
    - Type: "CloudWatch Logs Insights"
      Description: "ログ分析クエリ"
      Queries:
        ErrorAnalysis: |
          fields @timestamp, @message
          | filter @message like /ERROR/
          | sort @timestamp desc
          | limit 100
        
        PerformanceAnalysis: |
          fields @timestamp, @duration
          | filter @type = "REPORT"
          | stats avg(@duration), max(@duration), min(@duration) by bin(5m)